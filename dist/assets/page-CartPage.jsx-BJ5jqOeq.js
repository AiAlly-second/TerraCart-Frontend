import{r as A,j as t,u as Ee,f as je,d as Oe,g as se,h as oe,i as ie}from"./vendor-react-ObuVvEbY.js";import{g as Re,s as Me,H as qe}from"./page-Billing.jsx-e1iYcKyK.js";/* empty css                          */import{A as Le,m as ne}from"./vendor-motion-PmperX3c.js";import"./vendor-socket-B6ltA_3q.js";const De=async(i,m={},n=3e4)=>{const l=new AbortController,r=setTimeout(()=>l.abort(),n);try{const p=await fetch(i,{...m,signal:l.signal});return clearTimeout(r),p}catch(p){throw clearTimeout(r),p.name==="AbortError"?new Error(`Request timeout: The server did not respond within ${n}ms. Please check your connection and try again.`):p}},ue=async(i,m={},n={})=>{const{maxRetries:l=3,retryDelay:r=1e3,timeout:p=3e4,shouldRetry:y=(h,u)=>h.message?.includes("timeout")||h.message?.includes("Network error")||h.message?.includes("Failed to fetch")||h.message?.includes("CORS")?!0:h.status>=400&&h.status<500&&h.status!==429?!1:h.status>=500?!0:u<l}=n;let g,b;for(let h=0;h<=l;h++)try{const u=await De(i,m,p);if(u.ok||u.status===423)return u;const E=new Error(`HTTP ${u.status}: ${u.statusText}`);if(E.status=u.status,E.response=u,!y(E,h))return u;if(b=u,g=E,h<l){const v=r*Math.pow(2,h);await new Promise(R=>setTimeout(R,v))}}catch(u){if(g=u,!y(u,h))throw u;if(h<l){const E=r*Math.pow(2,h);await new Promise(v=>setTimeout(v,E))}}if(b)return b;throw g||new Error("Request failed after all retries")},et=async(i,m={},n={})=>ue(i,{...m,method:"GET"},n),Ke=async(i,m,n={},l={})=>ue(i,{...n,method:"POST",headers:{"Content-Type":"application/json",...n.headers},body:JSON.stringify(m)},l),ce=[{name:"Mumbai Vada Pav",price:45,category:"Street Snacks",image:"https://images.unsplash.com/photo-1633432666601-1fa7f4ff64c4?auto=format&fit=crop&w=800&q=80",isAvailable:!0},{name:"Punjabi Samosa Chaat",price:95,category:"Street Snacks",image:"https://images.unsplash.com/photo-1618512496248-0baaae45d818?auto=format&fit=crop&w=800&q=80",isAvailable:!0},{name:"Paneer Kathi Roll",price:165,category:"Street Snacks",image:"https://images.unsplash.com/photo-1597676071890-b90e42fb3ab4?auto=format&fit=crop&w=800&q=80",isAvailable:!0},{name:"Paneer Butter Masala",price:280,category:"North Indian Curries",image:"https://images.unsplash.com/photo-1604908177636-45e883dafe14?auto=format&fit=crop&w=800&q=80",isAvailable:!0},{name:"Amritsari Chole",price:210,category:"North Indian Curries",image:"https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=800&q=80",isAvailable:!0},{name:"Dal Tadka",price:190,category:"North Indian Curries",image:"https://images.unsplash.com/photo-1562967916-eb82221dfb36?auto=format&fit=crop&w=800&q=80",isAvailable:!0},{name:"Garlic Butter Naan",price:55,category:"Breads & Rice",image:"https://images.unsplash.com/photo-1548946526-f69e2424cf45?auto=format&fit=crop&w=800&q=80",isAvailable:!0},{name:"Tandoori Roti",price:35,category:"Breads & Rice",image:"https://images.unsplash.com/photo-1525755662778-989d0524087e?auto=format&fit=crop&w=800&q=80",isAvailable:!0},{name:"Veg Dum Biryani",price:240,category:"Breads & Rice",image:"https://images.unsplash.com/photo-1601050690597-df2411e7f1fb?auto=format&fit=crop&w=800&q=80",isAvailable:!0},{name:"Hyderabadi Chicken 65",price:265,category:"Regional Specials",image:"https://images.unsplash.com/photo-1612874472173-62c91e1882b7?auto=format&fit=crop&w=800&q=80",isAvailable:!0},{name:"Goan Fish Curry",price:320,category:"Regional Specials",image:"https://images.unsplash.com/photo-1512058564366-18510be2db19?auto=format&fit=crop&w=800&q=80",isAvailable:!0},{name:"Kerala Parotta Combo",price:210,category:"Regional Specials",image:"https://images.unsplash.com/photo-1623689046244-cd827872e252?auto=format&fit=crop&w=800&q=80",isAvailable:!0},{name:"Classic Gulab Jamun",price:110,category:"Desserts & Beverages",image:"https://images.unsplash.com/photo-1603899129807-3b5c9b35c97e?auto=format&fit=crop&w=800&q=80",isAvailable:!0},{name:"Kulfi Falooda",price:160,category:"Desserts & Beverages",image:"https://images.unsplash.com/photo-1612874742349-e06c61a4c9b8?auto=format&fit=crop&w=800&q=80",isAvailable:!0},{name:"Masala Chaas",price:60,category:"Desserts & Beverages",image:"https://images.unsplash.com/photo-1515003197210-e0cd71810b5f?auto=format&fit=crop&w=800&q=80",isAvailable:!0}],$e=i=>String(i||"").replace(/^\(\s*\+\s*\)\s*/u,"").trim()||"Add-on";function ze(i,m={}){const{serviceType:n="DINE_IN",orderType:l,tableId:r,tableNumber:p,menuCatalog:y={},sessionToken:g,customerName:b,customerMobile:h,customerEmail:u,cartId:E,customerLocation:v,specialInstructions:R,selectedAddons:Y=[]}=m,j=Object.entries(i).filter(([s,_])=>{const L=Number(_);return s&&s.trim()!==""&&Number.isFinite(L)&&L>0}).map(([s,_])=>{const L=(s||"").toString().trim().toLowerCase(),M=y[s]||Object.values(y).find($=>$?.name?$.name.toString().trim().toLowerCase()===L:!1);M?M.price?console.log(`[OrderUtils] Item found: "${s}", Price: ${M.price}`):console.warn(`[OrderUtils] Item found but has NO price: "${s}"`,M):console.warn(`[OrderUtils] Item not found in catalog: "${s}" (safe: "${L}")`,{catalogKeys:Object.keys(y).slice(0,10),catalogSize:Object.keys(y).length});const D=M?.price??0,x=Number(_);if(!s||typeof s!="string"||s.trim()==="")return console.warn(`[orderUtils] Invalid item name: ${s}`),null;if(!Number.isFinite(x)||x<=0)return console.warn(`[orderUtils] Invalid quantity for ${s}: ${_}`),null;if(!Number.isFinite(D)||D<0)return console.warn(`[orderUtils] Invalid price for ${s}: ${D}`),null;const K={name:s.trim(),quantity:x,price:Number(D)};return M?._id&&(K.itemId=M._id),K}).filter(s=>s!==null);if(j.length===0)throw console.error("[orderUtils] No valid items in cart after validation"),new Error("Cart is empty or contains only invalid items");let B=0,q=[];Array.isArray(Y)&&Y.length>0&&(q=Y.map(s=>({addonId:s.addonId||s._id||s.id,name:$e(s.name),price:Number(s.price)||0})).filter(s=>s.name),B=q.reduce((s,_)=>s+_.price,0));const V=j.reduce((s,_)=>s+_.price*_.quantity,0),Q=0,W=V+B,d={serviceType:n,items:j,selectedAddons:q,subtotal:V,gst:Q,totalAmount:W};if(R&&R.trim()&&(d.specialInstructions=R.trim()),n==="DINE_IN")r&&(d.tableId=r),p!=null&&(d.tableNumber=String(p)),g&&typeof g=="string"&&g.trim().length>0?d.sessionToken=g.trim():n==="DINE_IN"&&console.warn("[orderUtils] DINE_IN order missing or invalid sessionToken:",{sessionToken:g,sessionTokenType:typeof g,sessionTokenLength:g?g.length:0}),d.customerName&&delete d.customerName,d.customerMobile&&delete d.customerMobile,d.customerEmail&&delete d.customerEmail,d.customerLocation&&delete d.customerLocation,d.cartId&&delete d.cartId;else if(n==="TAKEAWAY"||n==="PICKUP"||n==="DELIVERY"){const s=l==="PICKUP"||l==="DELIVERY"?l:n==="PICKUP"||n==="DELIVERY"?n:null;s?(d.serviceType=s==="PICKUP"?"PICKUP":"DELIVERY",d.orderType=s):d.serviceType="TAKEAWAY",b&&(d.customerName=b),h&&(d.customerMobile=h),u&&(d.customerEmail=u),v&&(d.customerLocation={latitude:v.latitude,longitude:v.longitude,address:v.address||v.fullAddress||""}),g&&(d.sessionToken=g),E&&(d.cartId=E)}else d.tableNumber=String(p||"TAKEAWAY");return d}function Ue({open:i,title:m="Processing your order",steps:n=[]}){return A.useEffect(()=>{},[n]),t.jsx(Le,{children:i&&t.jsx(ne.div,{className:"process-overlay",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},"aria-live":"polite","aria-atomic":"true",children:t.jsxs(ne.div,{className:"process-panel",initial:{y:30,opacity:0},animate:{y:0,opacity:1},exit:{y:30,opacity:0},role:"dialog","aria-label":m,children:[t.jsx("h3",{className:"process-title",children:m}),t.jsx("ul",{className:"process-steps",children:n.map((l,r)=>t.jsxs("li",{className:`process-step ${l.state}`,children:[t.jsxs("span",{className:"icon",children:[l.state==="done"&&t.jsx("span",{className:"tick","aria-hidden":"true"}),l.state==="active"&&t.jsx("span",{className:"dot","aria-hidden":"true"}),l.state==="error"&&t.jsx("span",{className:"cross","aria-hidden":"true"}),l.state==="pending"&&t.jsx("span",{className:"bullet","aria-hidden":"true"})]}),t.jsx("span",{className:"label",children:l.label})]},r))}),t.jsx("div",{className:"progress-bar",children:t.jsx("div",{className:"progress-fill",style:{width:`${n.filter(l=>l.state==="done").length/n.length*100}%`}})}),t.jsx("p",{className:"process-hint",children:"Please wait… we’ll take you to the summary when done."})]})})})}const Ye={stepCheckingOrder:"Checking your order",stepConfirmingItems:"Confirming selected items",stepPlacingOrder:"Placing your order",stepSendingKitchen:"Sending to kitchen",stepPreparingDetails:"Preparing order details",clearCartConfirm:"Clear cart?",cartEmpty:"Your cart is empty.",cartInvalidItems:"Your cart has no valid items.",customerNameRequired:"Customer name is required for pickup and delivery orders.",customerMobileRequired:"Customer mobile number is required for pickup and delivery orders.",storeSelectionMissing:"Store selection is missing. Please select a store and try again.",deliveryLocationMissing:"Customer location (latitude and longitude) is required for delivery orders.",failedCreateOrder:"Failed to create order.",errorPrefix:"Order processing failed:",yourCart:"Your Cart",cartEmptyMessage:"Your cart is empty.",goToMenu:"Go to Menu",addonsRequireMenuItem:"Add-ons are extras and can only be ordered with at least one menu item. Please add an item from the menu to place the order.",total:"Total",reset:"Reset",confirmOrder:"Confirm Order",customizationsExtras:"Customizations & Extras",loadingAddons:"Loading add-ons...",noAddonsAvailable:"No add-ons available",removeAddonAria:"Remove one {name}",addAddonAria:"Add one {name}",specialInstructionsTitle:"Special Instructions / Extra Items",specialInstructionsPlaceholder:"Type any extra requirements or items here...",processOrderTitle:"Processing your order"},We={stepCheckingOrder:"Aapka order check ho raha hai",stepConfirmingItems:"Chune hue items confirm ho rahe hain",stepPlacingOrder:"Aapka order place ho raha hai",stepSendingKitchen:"Order kitchen ko bheja ja raha hai",stepPreparingDetails:"Order details tayyar ho rahi hain",clearCartConfirm:"Cart saaf karna hai?",cartEmpty:"Aapka cart khali hai.",cartInvalidItems:"Aapke cart me valid items nahi hain.",customerNameRequired:"Pickup aur delivery order ke liye customer naam zaruri hai.",customerMobileRequired:"Pickup aur delivery order ke liye customer mobile number zaruri hai.",storeSelectionMissing:"Store select nahi hua. Kripya store select karke fir try karein.",deliveryLocationMissing:"Delivery order ke liye customer location (latitude aur longitude) zaruri hai.",failedCreateOrder:"Order create nahi ho paya.",errorPrefix:"Order process fail hua:",yourCart:"Aapka Cart",cartEmptyMessage:"Aapka cart khali hai.",goToMenu:"Menu par jao",addonsRequireMenuItem:"Add-ons extra hain aur kam se kam ek menu item ke saath hi order ho sakte hain. Kripya order place karne ke liye menu se item add karein.",total:"Kul Rakam",reset:"Reset",confirmOrder:"Order Confirm karein",customizationsExtras:"Customizations aur Extras",loadingAddons:"Add-ons load ho rahe hain...",noAddonsAvailable:"Koi add-ons available nahi hain",removeAddonAria:"{name} me se ek kam karein",addAddonAria:"{name} me ek add karein",specialInstructionsTitle:"Special Instructions / Extra Items",specialInstructionsPlaceholder:"Apni extra requirements ya items yahan likhein...",processOrderTitle:"Aapka order process ho raha hai"},Fe={stepCheckingOrder:"Tumcha order tapast aahot",stepConfirmingItems:"Nivadlele items confirm hot ahet",stepPlacingOrder:"Tumcha order place hot aahe",stepSendingKitchen:"Order kitchen kade pathavla jat aahe",stepPreparingDetails:"Order details tayar hot ahet",clearCartConfirm:"Cart clear karaycha ka?",cartEmpty:"Tumcha cart rikama aahe.",cartInvalidItems:"Tumchya cart madhye valid items nahi.",customerNameRequired:"Pickup ani delivery order sathi customer nav avashyak aahe.",customerMobileRequired:"Pickup ani delivery order sathi customer mobile number avashyak aahe.",storeSelectionMissing:"Store select zala nahi. Krupaya store nivda ani punha prayatna kara.",deliveryLocationMissing:"Delivery order sathi customer location (latitude ani longitude) avashyak aahe.",failedCreateOrder:"Order tayar karne apayashi jhale.",errorPrefix:"Order process fail jhala:",yourCart:"Tumcha Cart",cartEmptyMessage:"Tumcha cart rikama aahe.",goToMenu:"Menu var ja",addonsRequireMenuItem:"Add-ons he extra ahet ani kamit kami eka menu item sobatanch order karta yetat. Order place karanyasathi menu madhun item add kara.",total:"Ekun",reset:"Reset",confirmOrder:"Order Confirm kara",customizationsExtras:"Customizations ani Extras",loadingAddons:"Add-ons load hot ahet...",noAddonsAvailable:"Kontehi add-ons upalabdh nahi",removeAddonAria:"{name} madhun ek kami kara",addAddonAria:"{name} madhye ek add kara",specialInstructionsTitle:"Special Instructions / Extra Items",specialInstructionsPlaceholder:"Tumchya extra requirements kiwa items ithe liha...",processOrderTitle:"Tumcha order process hot aahe"},Ve={stepCheckingOrder:"Tamaro order check thai rahyo chhe",stepConfirmingItems:"Pasand karel items confirm thai rahya chhe",stepPlacingOrder:"Tamaro order place thai rahyo chhe",stepSendingKitchen:"Order kitchen sudhi moklaya chhe",stepPreparingDetails:"Order details taiyar thai rahi chhe",clearCartConfirm:"Cart saaf karvo chhe?",cartEmpty:"Tamaro cart khali chhe.",cartInvalidItems:"Tamara cart ma valid items nathi.",customerNameRequired:"Pickup ane delivery order mate customer nu naam jaruri chhe.",customerMobileRequired:"Pickup ane delivery order mate customer no mobile number jaruri chhe.",storeSelectionMissing:"Store select nathi thayu. Krupaya store select kari ne fari prayatna karo.",deliveryLocationMissing:"Delivery order mate customer location (latitude ane longitude) jaruri chhe.",failedCreateOrder:"Order create karva ma asafal.",errorPrefix:"Order process fail thayu:",yourCart:"Tamaro Cart",cartEmptyMessage:"Tamaro cart khali chhe.",goToMenu:"Menu par jao",addonsRequireMenuItem:"Add-ons extra chhe ane ochama ochha ek menu item sathe j order thai shake. Krupaya order mate menu mathi item add karo.",total:"Kul",reset:"Reset",confirmOrder:"Order Confirm karo",customizationsExtras:"Customizations ane Extras",loadingAddons:"Add-ons load thai rahya chhe...",noAddonsAvailable:"Koi add-ons available nathi",removeAddonAria:"{name} mathi ek ochhu karo",addAddonAria:"{name} ma ek add karo",specialInstructionsTitle:"Special Instructions / Extra Items",specialInstructionsPlaceholder:"Tamari extra requirements ke items ahi lakho...",processOrderTitle:"Tamaro order process thai rahyo chhe"},le={en:Ye,hi:We,mr:Fe,gu:Ve},U="https://api.terracart.in".replace(/\/$/,""),de="terra_takeaway_token_preview",J=i=>String(i||"").replace(/^\(\s*\+\s*\)\s*/u,"").trim()||"Add-on";function Je(i){return i?i.startsWith("http://")||i.startsWith("https://")?i:i.startsWith("/")?`${U}${i}`:`${U}/uploads/${i}`:null}async function me(i){try{const m=i?.get("cart")||i?.get("cartId");if(m)return console.log("[CartPage] getCartId - from URL params:",m),m;const n=localStorage.getItem("terra_selectedCartId");if(n)return console.log("[CartPage] getCartId - from terra_selectedCartId:",n),n;const l=localStorage.getItem("terra_takeaway_cartId");if(l)return console.log("[CartPage] getCartId - from terra_takeaway_cartId:",l),l;const r=JSON.parse(localStorage.getItem("terra_selectedTable")||localStorage.getItem("terra_table_selection")||"{}");let p=r.cartId||r.cafeId||"",y="";if(p!=null&&p!==""){if(typeof p=="string")y=p;else if(typeof p=="object"){const b=p._id??p.id??p;y=typeof b=="string"?b:b?.toString?.()||""}}if(y)return console.log("[CartPage] getCartId - from table data:",y,"raw:",p),y;const g=i?.get("table");if(g){console.log("[CartPage] getCartId - table ID in URL, fetching cartId from API:",g);try{const b=await fetch(`${U}/api/tables/public-cart-id/${encodeURIComponent(g)}`);if(b.ok){const u=(await b.json()).cartId||"";if(u)return console.log("[CartPage] getCartId - got cartId from table API:",u),u}}catch(b){console.error("[CartPage] getCartId - failed to fetch cartId by table ID:",b)}}return console.warn("[CartPage] getCartId - no cartId found anywhere"),""}catch(m){console.error("[CartPage] getCartId error:",m)}return""}function Be(){const i=Ee(),[m]=je(),[n,l]=A.useState(Re()),r=e=>le[n]?.[e]||le.en?.[e]||e,p=(e,a={})=>{let c=r(e);return Object.entries(a).forEach(([o,S])=>{c=c.replace(new RegExp(`\\{${o}\\}`,"g"),String(S))}),c},[y,g]=A.useState({}),[b,h]=A.useState(ce.map(e=>({...e,price:e.price*100}))||[]),[u,E]=A.useState(localStorage.getItem("accessibilityMode")==="true"),[v,R]=A.useState([]),[Y,j]=A.useState([]),[B,q]=A.useState(!0),[V,Q]=A.useState(""),[W,d]=A.useState(""),s=()=>[{label:r("stepCheckingOrder"),state:"pending"},{label:r("stepConfirmingItems"),state:"pending"},{label:r("stepPlacingOrder"),state:"pending"},{label:r("stepSendingKitchen"),state:"pending"},{label:r("stepPreparingDetails"),state:"pending"}],[_,L]=A.useState(!1),[M,D]=A.useState(s),x=(e,a)=>D(c=>c.map((o,S)=>S===e?{...o,state:a}:o)),K=e=>new Promise(a=>setTimeout(a,e)),$={validate:1500,order:1500,beforeSend:1e3,kitchen:1500,error:2e3};A.useEffect(()=>Me(a=>{l(a)}),[]),A.useEffect(()=>{D(s())},[n]),A.useEffect(()=>{try{const e=JSON.parse(localStorage.getItem("terra_cart")||"{}");g(e)}catch(e){console.error("Error loading cart",e)}me(m).then(e=>{d(e),console.log("[CartPage] Using cartId:",e);const a=async o=>{try{const S=o?`${U}/api/menu/public?cartId=${o}`:`${U}/api/menu/public`,C=await fetch(S);if(C.ok){const k=await C.json(),z=[];Array.isArray(k)&&k.forEach(f=>{f.items&&z.push(...f.items)}),h([...z,...ce])}}catch(S){console.error("Failed to fetch menu",S)}},c=async(o,S)=>{q(!0);const C=S||m?.get("table")||"";if(!o&&!C){console.log("[CartPage] No cartId or tableId found for add-ons"),j([]),localStorage.removeItem("terra_global_addons"),q(!1);return}try{const k=new URLSearchParams;o&&k.set("cartId",o),C&&k.set("tableId",C);const z=`${U}/api/addons/public?${k.toString()}`;console.log("[CartPage] Fetching add-ons from:",z,"cartId:",o,"tableId:",C);const f=await fetch(z);if(console.log("[CartPage] Add-ons response status:",f.status),f.ok){const N=await f.json();if(console.log("[CartPage] Add-ons response:",N),N.success===!1){console.warn("[CartPage] API returned success: false, message:",N.message),j([]),localStorage.removeItem("terra_global_addons"),q(!1);return}const w=(N.data||N||[]).map(O=>({id:(O._id||O.id||"").toString(),name:J(O.name),price:Number(O.price)||0,icon:O.icon||""}));console.log("[CartPage] Parsed add-ons list:",w),j(w),w.length>0?(localStorage.setItem("terra_global_addons",JSON.stringify(w)),console.log("[CartPage] ✅ Set",w.length,"add-ons from API:",w.map(O=>O.name))):(localStorage.removeItem("terra_global_addons"),console.warn("[CartPage] ⚠️ No add-ons found for cartId/tableId:",o||C,"- Admin should create add-ons in Global Add-ons page"))}else{let N=`HTTP ${f.status}`;try{const w=await f.json();N=w.message||N,console.error("[CartPage] Add-ons API error response:",w)}catch{console.error("[CartPage] Add-ons fetch failed with status:",f.status,"Could not parse error")}f.status===400?(console.warn("[CartPage] Bad request (400) - cartId might be invalid. Using empty add-ons list."),j([]),localStorage.removeItem("terra_global_addons")):(console.warn("[CartPage] API failed:",N),j([]),localStorage.removeItem("terra_global_addons"))}}catch(k){console.error("[CartPage] Failed to fetch add-ons (network error):",k),console.warn("[CartPage] Using empty add-ons due to network error"),j([]),localStorage.removeItem("terra_global_addons")}finally{q(!1)}};a(e),c(e,m.get("table")||"")})},[m]);const X=e=>{g(e),localStorage.setItem("terra_cart",JSON.stringify(e))},Z=e=>{const a=localStorage.getItem("terra_cart_addons")||"{}";let c={};try{const o=JSON.parse(a);c=Array.isArray(o)?{}:o}catch{}if(W)c[W]=e;else{localStorage.setItem("terra_cart_addons",JSON.stringify(e));return}localStorage.setItem("terra_cart_addons",JSON.stringify(c))},pe=()=>{if(!W){localStorage.removeItem("terra_cart_addons");return}const e=localStorage.getItem("terra_cart_addons")||"{}";try{const a=JSON.parse(e);if(Array.isArray(a))return;delete a[W],localStorage.setItem("terra_cart_addons",JSON.stringify(a))}catch{}},te=(e,a)=>{const c={...y},S=(c[e]||0)+a;S<=0?delete c[e]:c[e]=S,X(c)},he=()=>{window.confirm(r("clearCartConfirm"))&&(X({}),R([]),pe())},ge=async()=>{if(Object.keys(y).length===0)return alert(r("cartEmpty"));Z(v),D(s().map(e=>({...e,state:"pending"}))),L(!0);try{x(0,"active"),await K($.validate),x(0,"done"),x(1,"active"),await K($.order),x(1,"done"),x(2,"active"),await K($.beforeSend);const e=localStorage.getItem("terra_serviceType")||"DINE_IN",a=localStorage.getItem("terra_orderType"),c=e==="PICKUP"||e==="DELIVERY",o=a==="PICKUP"||a==="DELIVERY"?a:c?e:void 0,S=o==="PICKUP"||o==="DELIVERY",C=e==="TAKEAWAY"||c,k=JSON.parse(localStorage.getItem("terra_selectedTable")||"{}"),z=C?localStorage.getItem("terra_orderId_TAKEAWAY"):localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId");let f="";C?(f=localStorage.getItem("terra_takeaway_sessionToken"),f||(f=`TAKEAWAY-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("terra_takeaway_sessionToken",f))):(f=localStorage.getItem("terra_sessionToken"),f||(k&&k.sessionToken?(f=k.sessionToken,localStorage.setItem("terra_sessionToken",f)):(f=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("terra_sessionToken",f))));let N=null;const w=C?localStorage.getItem("terra_customerLocation"):null;if(w)try{N=JSON.parse(w)}catch(P){console.warn("[CartPage] Failed to parse terra_customerLocation:",P),N=null}const O=JSON.parse(localStorage.getItem("terra_global_addons")||"[]"),ke=Array.isArray(O)?O:[],Ce=v.map(P=>{const F=ke.find(Te=>Te.id===P);return F?{addonId:P,name:J(F.name),price:F.price}:null}).filter(Boolean),Ae=await me(m),xe=V?.trim()||localStorage.getItem("terra_specialInstructions")||"",I=ze(y,{serviceType:o==="PICKUP"||o==="DELIVERY"?o:e,orderType:o==="PICKUP"||o==="DELIVERY"?o:void 0,tableId:k.id||k._id,tableNumber:k.number||k.tableNumber,menuCatalog:b,sessionToken:f,customerName:S?localStorage.getItem("terra_takeaway_customerName"):void 0,customerMobile:S?localStorage.getItem("terra_takeaway_customerMobile"):void 0,customerLocation:N,cartId:Ae,specialInstructions:xe,selectedAddons:Ce});if(!I.items||I.items.length===0)throw new Error(r("cartInvalidItems"));const Ne=I.serviceType==="PICKUP"||I.serviceType==="DELIVERY"||I.orderType==="PICKUP"||I.orderType==="DELIVERY",we=I.serviceType==="DELIVERY"||I.orderType==="DELIVERY";if(Ne){if(!I.customerName||!I.customerName.trim())throw new Error(r("customerNameRequired"));if(!I.customerMobile||!I.customerMobile.trim())throw new Error(r("customerMobileRequired"));if(!I.cartId)throw new Error(r("storeSelectionMissing"))}if(we){const P=Number(I?.customerLocation?.latitude),F=Number(I?.customerLocation?.longitude);if(!Number.isFinite(P)||!Number.isFinite(F))throw new Error(r("deliveryLocationMissing"));I.customerLocation={...I.customerLocation,latitude:P,longitude:F}}const ae=C?localStorage.getItem("terra_orderStatus_TAKEAWAY"):localStorage.getItem("terra_orderStatus_DINE_IN")||localStorage.getItem("terra_orderStatus"),Pe=["Paid","Cancelled","Returned","Completed","Finalized"];let H=z;z&&Pe.includes(ae)&&(console.log("[CartPage] Previous order status is",ae,"- starting new order"),H=null);const ee=Number(localStorage.getItem(de));C&&o!=="DELIVERY"&&!H&&Number.isInteger(ee)&&ee>0&&(I.takeawayToken=ee);const _e=H?`${U}/api/orders/${H}/kot`:`${U}/api/orders`,re=await Ke(_e,I,{headers:{"Content-Type":"application/json"}},{maxRetries:2,timeout:3e4});let T;try{const P=await re.text();T=P?JSON.parse(P):{}}catch{T={}}if(!re.ok){const P=T.message||T.error||r("failedCreateOrder");throw new Error(P)}x(2,"done"),x(3,"active"),await K($.kitchen),x(3,"done"),T._id&&(C?(localStorage.setItem("terra_orderId_TAKEAWAY",T._id),localStorage.removeItem(de),localStorage.setItem("terra_orderStatus_TAKEAWAY",T.status||"Confirmed"),localStorage.setItem("terra_orderStatusUpdatedAt_TAKEAWAY",new Date().toISOString())):(localStorage.setItem("terra_orderId",T._id),localStorage.setItem("terra_orderId_DINE_IN",T._id),localStorage.setItem("terra_orderStatus",T.status||"Confirmed"),localStorage.setItem("terra_orderStatus_DINE_IN",T.status||"Confirmed"),localStorage.setItem("terra_orderStatusUpdatedAt",new Date().toISOString()),localStorage.setItem("terra_orderStatusUpdatedAt_DINE_IN",new Date().toISOString())),localStorage.removeItem("terra_cart"),g({})),i("/menu")}catch(e){console.error("Order processing failed:",e),x(2,"error"),await K($.error),alert(`${r("errorPrefix")} ${e.message}`),L(!1)}},fe=e=>v.filter(a=>a===e).length,ye=e=>{const a=[...v,e];R(a),Z(a)},Ie=e=>{const a=v.indexOf(e);if(a===-1)return;const c=v.filter((o,S)=>S!==a);R(c),Z(c)},G=Object.entries(y).map(([e,a])=>{const c=b.find(o=>o.name.toLowerCase()===e.toLowerCase());return{name:e,qty:a,price:c?c.price:0,image:c?c.image||c.imageUrl:null}}).filter(e=>e.qty>0),be=G.reduce((e,a)=>e+a.price*a.qty,0),ve=v.reduce((e,a)=>{const c=Y.find(o=>o.id===a);return e+(c?c.price:0)},0),Se=be+ve;return t.jsxs("div",{className:`cart-page ${u?"accessibility-mode":""}`,children:[t.jsx(qe,{accessibilityMode:u,onClickCart:()=>{},cartCount:Object.values(y).reduce((e,a)=>e+a,0)}),t.jsxs("div",{className:"cart-content",children:[t.jsxs("div",{className:"cart-header-row",children:[t.jsx("button",{onClick:()=>i("/menu"),className:"back-btn",children:t.jsx(Oe,{size:24})}),t.jsx("h2",{children:r("yourCart")})]}),t.jsx("div",{className:"cart-list",children:G.length===0?t.jsxs("div",{className:"empty-msg",children:[r("cartEmptyMessage")," ",t.jsx("br",{}),t.jsx("span",{onClick:()=>i("/menu"),style:{color:"#fc8019",cursor:"pointer"},children:r("goToMenu")}),v.length>0&&t.jsx("div",{style:{marginTop:"10px",color:"#888",fontSize:12},children:r("addonsRequireMenuItem")})]}):G.map(e=>t.jsxs("div",{className:"cart-item-card",children:[e.image&&t.jsx("div",{className:"cart-item-image-wrap",children:t.jsx("img",{src:Je(e.image),alt:e.name,className:"cart-item-image"})}),t.jsxs("div",{className:"item-details",children:[t.jsx("h3",{children:e.name}),t.jsxs("div",{className:"item-price",children:["₹",e.price]})]}),t.jsxs("div",{className:"qty-controls",children:[t.jsx("button",{onClick:()=>te(e.name,-1),className:"ctrl-btn",children:e.qty===1?t.jsx(se,{size:16}):t.jsx(oe,{size:18})}),t.jsx("span",{className:"qty-val",children:e.qty}),t.jsx("button",{onClick:()=>te(e.name,1),className:"ctrl-btn",children:t.jsx(ie,{size:18})})]})]},e.name))}),G.length>0&&t.jsx("div",{className:"cart-footer",children:t.jsxs("div",{className:"cart-footer-content",children:[t.jsxs("div",{className:"total-row final-total-row",children:[t.jsx("span",{children:r("total")}),t.jsxs("span",{children:["₹",Se.toFixed(2)]})]}),t.jsxs("div",{className:"action-buttons",children:[t.jsx("button",{onClick:he,className:"reset-btn",children:r("reset")}),t.jsx("button",{onClick:ge,className:"confirm-btn",children:r("confirmOrder")})]})]})}),t.jsxs("div",{className:"addons-section",children:[t.jsx("h3",{children:r("customizationsExtras")}),B?t.jsx("div",{style:{padding:"20px",textAlign:"center",color:"#666"},children:r("loadingAddons")}):Y.length===0?t.jsx("div",{style:{padding:"20px",textAlign:"center",color:"#999",fontSize:"14px"},children:r("noAddonsAvailable")}):t.jsx("div",{className:"addons-grid",children:Y.map(e=>{const a=fe(e.id);return t.jsxs("div",{className:`addon-card ${a>0?"active":""}`,children:[t.jsx("div",{className:"addon-info",children:t.jsxs("div",{className:"addon-text",children:[t.jsx("span",{className:"addon-name",children:J(e.name)}),e.price>0&&t.jsxs("span",{className:"addon-price",children:["₹",e.price]})]})}),t.jsxs("div",{className:"addon-qty-controls",children:[t.jsx("button",{type:"button",className:"addon-ctrl-btn",onClick:()=>Ie(e.id),disabled:a===0,"aria-label":p("removeAddonAria",{name:J(e.name)}),children:a===1?t.jsx(se,{size:16}):t.jsx(oe,{size:18})}),t.jsx("span",{className:"addon-qty-val",children:a}),t.jsx("button",{type:"button",className:"addon-ctrl-btn",onClick:()=>ye(e.id),"aria-label":p("addAddonAria",{name:J(e.name)}),children:t.jsx(ie,{size:18})})]})]},e.id)})})]}),t.jsxs("div",{className:"instructions-section",style:{marginTop:"20px",padding:"0 16px 20px"},children:[t.jsx("h3",{style:{fontSize:"18px",marginBottom:"10px",color:"#333"},children:r("specialInstructionsTitle")}),t.jsx("textarea",{placeholder:r("specialInstructionsPlaceholder"),value:V,onChange:e=>{Q(e.target.value)},style:{width:"100%",minHeight:"80px",padding:"12px",borderRadius:"12px",border:"1px solid #ddd",fontSize:"14px",resize:"vertical",fontFamily:"inherit"}})]})]}),t.jsx(Ue,{open:_,steps:M,title:r("processOrderTitle")})]})}const tt=Object.freeze(Object.defineProperty({__proto__:null,default:Be},Symbol.toStringTag,{value:"Module"}));export{tt as C,Ue as P,ze as b,et as g,ce as m,Ke as p};
