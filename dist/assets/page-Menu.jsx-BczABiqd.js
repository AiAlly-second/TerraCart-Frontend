import{r as l,j as t,u as Mr,c as Rr,f as Wr,a as Kr,b as Yr}from"./vendor-react-ObuVvEbY.js";import{r as $r,H as Ur}from"./page-Billing.jsx-e1iYcKyK.js";import{a as Lr}from"./vendor-BzqibXkm.js";import{P as Fr,b as qr,p as Vt,m as zr}from"./page-CartPage.jsx-B-bsBLoz.js";/* empty css                          */import{l as Br}from"./vendor-socket-B6ltA_3q.js";import{h as Vr,E as Jr}from"./vendor-pdf-fbgw14A-.js";import{m as Hr}from"./vendor-motion-PmperX3c.js";const Qr="http://localhost:5050".replace(/\/$/,""),ft="translation_service_unavailable",It="translation_service_check_timestamp",Gr=6e4,Xr=()=>{try{const o=sessionStorage.getItem(ft),m=sessionStorage.getItem(It);if(o==="true"&&m){const _=Date.now(),j=parseInt(m,10);if(_-j<Gr)return!0}}catch{}return!1},Jt=()=>{try{sessionStorage.setItem(ft,"true"),sessionStorage.setItem(It,Date.now().toString())}catch{}},Zr=()=>{try{sessionStorage.removeItem(ft),sessionStorage.removeItem(It)}catch{}},ea=async(o,m)=>{if(Xr())return o;try{const _=await Lr.post(`${Qr}/api/translate`,{text:o,targetLang:m},{validateStatus:()=>!0,timeout:1500,transformRequest:[j=>j],transformResponse:[j=>j]});if(_.status===200&&_.data?.translatedText){Zr();const j=_.data.translatedText;return j.match(/as\s+"(.*?)"/)?.[1]||j||o}else return Jt(),o}catch(_){return(_.code==="ECONNREFUSED"||_.code==="ERR_NETWORK"||_.code==="ECONNABORTED"||_.message==="Network Error"||_.message?.includes("ERR_CONNECTION_REFUSED")||_.message?.includes("timeout"))&&Jt(),o}},rr=o=>{const[m,_]=l.useState(o),[j,R]=l.useState(!1);return l.useEffect(()=>{const W=localStorage.getItem("language")||"en";W==="en"?(_(o),R(!1)):(R(!0),ea(o,W).then(h=>{_(h),R(!1)}).catch(h=>{_(o),R(!1)}))},[o]),[m,j]},ta={manualEntry:"Menu",smartServe:"Smart Serve",aiOrdered:"AI Ordered:",orderSummary:"Order Summary:",confirm:"Confirm",speakOrder:"Speak Order",processingVoice:"Processing your voice...",cartEmpty:"Cart is empty",resetOrder:"Reset Order",tapToStop:"Tap to Stop",tapToOrder:"Tap to Order",searchPlaceholder:"Search item...",resetOrderBtn:"Reset Order",recordVoiceAria:"Record voice order",processSteps:{checkingOrder:"Checking your order",confirmingItems:"Confirming items & price",placingOrder:"Placing your order",sendingToKitchen:"Sending to kitchen",preparingDetails:"Preparing order details"},dineIn:"Dine-In",table:"Table",takeaway:"Takeaway",callWaiter:"Call Waiter",requestWater:"Request Water",vegOnly:"Veg Only",popular:"Popular",spicy:"Spicy",token:"Token"},ra={manualEntry:"मेनू",smartServe:"स्मार्ट सर्व",aiOrdered:"एआई द्वारा ऑर्डर:",orderSummary:"ऑर्डर सारांश:",confirm:"पुष्टि करें",speakOrder:"ऑर्डर सुनाएं",processingVoice:"आपकी आवाज़ प्रोसेस हो रही है...",cartEmpty:"कार्ट खाली है",resetOrder:"ऑर्डर रीसेट करें",tapToStop:"रोकने के लिए टैप करें",tapToOrder:"ऑर्डर करने के लिए टैप करें",searchPlaceholder:"आइटम खोजें...",resetOrderBtn:"ऑर्डर रीसेट करें",recordVoiceAria:"आवाज़ से ऑर्डर रिकॉर्ड करें",processSteps:{checkingOrder:"आपका ऑर्डर चेक कर रहे हैं",confirmingItems:"आइटम और कीमत की पुष्टि",placingOrder:"ऑर्डर प्लेस कर रहे हैं",sendingToKitchen:"किचन को भेज रहे हैं",preparingDetails:"ऑर्डर विवरण तैयार"},dineIn:"डाइन-इन",table:"टेबल",takeaway:"टेकअवे",callWaiter:"वेटर को बुलाएं",requestWater:"पानी मांगें",vegOnly:"केवल शाकाहारी",popular:"लोकप्रिय",spicy:"मसालेदार",token:"टोकन"},aa={manualEntry:"मेनू",smartServe:"स्मार्ट सर्व",aiOrdered:"एआय ने ऑर्डर केले:",orderSummary:"ऑर्डर सारांश:",confirm:"निश्चित करा",speakOrder:"ऑर्डर बोला",processingVoice:"तुमचा आवाज प्रोसेस होत आहे...",cartEmpty:"कार्ट रिकामे आहे",resetOrder:"ऑर्डर रीसेट करा",tapToStop:"थांबवण्यासाठी टॅप करा",tapToOrder:"ऑर्डर करण्यासाठी टॅप करा",searchPlaceholder:"वस्तू शोधा...",resetOrderBtn:"ऑर्डर रीसेट करा",recordVoiceAria:"आवाज रेकॉर्ड करा",processSteps:{checkingOrder:"तुमची ऑर्डर तपासत आहे",confirmingItems:"वस्तू आणि किंमत निश्चित करत आहे",placingOrder:"ऑर्डर देत आहे",sendingToKitchen:"किचनला पाठवत आहे",preparingDetails:"ऑर्डर तपशील तयार"},dineIn:"डाइन-इन",table:"टेबल",takeaway:"टेकअवे",callWaiter:"वेटरला बोलवा",requestWater:"पाणी मागवा",vegOnly:"फक्त शाकाहारी",popular:"लोकप्रिय",spicy:"तिखट",token:"टोकन"},oa={manualEntry:"મેનુ",smartServe:"સ્માર્ટ સર્વ",aiOrdered:"એઆઈ દ્વારા ઓર્ડર:",orderSummary:"ઓર્ડર સારાંશ:",confirm:"પુષ્ટિ કરો",speakOrder:"ઓર્ડર બોલો",processingVoice:"તમારો અવાજ પ્રોસેસ થઈ રહ્યો છે...",cartEmpty:"કાર્ટ ખાલી છે",resetOrder:"ઓર્ડર રીસેટ કરો",tapToStop:"રોકવા માટે ટૅપ કરો",tapToOrder:"ઓર્ડર કરવા માટે ટૅપ કરો",searchPlaceholder:"વસ્તુ શોધો...",resetOrderBtn:"ઓર્ડર રીસેટ કરો",recordVoiceAria:"અવાજ રેકોર્ડ કરો",processSteps:{checkingOrder:"તમારો ઓર્ડર તપાસી રહ્યા છીએ",confirmingItems:"વસ્તુઓ અને કિંમતની પુષ્ટિ",placingOrder:"ઓર્ડર આપી રહ્યા છીએ",sendingToKitchen:"કિચનમાં મોકલી રહ્યા છીએ",preparingDetails:"ઓર્ડર વિગતો તૈયાર"},dineIn:"ડાઇન-ઇન",table:"ટેબલ",takeaway:"ટેકઅવે",callWaiter:"વેટરને બોલાવો",requestWater:"પાણી મંગાવો",vegOnly:"માત્ર શાકાहारी",popular:"લોકપ્રિય",spicy:"મસાલેદાર",token:"ટોકન"},sa={en:ta,hi:ra,mr:aa,gu:oa},na={categories:{all_time_hit:"All Time Hit",mini_thali:"Mini Thali",fries:"Fries",starters:"Starters",veg_starters:"Veg Starters",tandoor_specials:"Tandoor Specials",maharashtrian:"Maharashtrian",punjabi:"Punjabi",paneer_specials:"Paneer Specials",rice:"Rice",roti:"Roti",dal:"Dal",chinese:"Chinese",thali:"Thali",desserts:"Desserts",beverages:"Beverages",street_snacks:"Street Snacks",north_indian_curries:"North Indian Curries",breads_rice:"Breads & Rice",regional_specials:"Regional Specials",desserts_beverages:"Desserts & Beverages",main_course:"Main Course"},items:{veg_sandwich:"Veg Sandwich",dosa:"Dosa",peanut_curry:"Peanut Curry",misal:"Misal",paneer_junglee_sandwich:"Paneer Junglee Sandwich",mumbai_sandwich:"Mumbai Sandwich",terra_wada_pav:"Terra Wada Pav",gluten_free_dosai:"Gluten Free Dosai",kothimbir_wadi:"Kothimbir Wadi",bombay_pav_bhaji:"Bombay Pav Bhaji",pizza_bomb:"Pizza Bomb",mini_batata_wada:"Mini Batata Wada",appe_chutney:"Appe & Chutney",namaste_misal_pav_dahi:"Namaste Misal Pav & Dahi",chola_kulcha:"Chola Kulcha",rajma_chawal:"Rajma Chawal",dal_makhni_jeera_rice:"Dal Makhni Jeera Rice",veg_korma_paratha:"Veg Korma & Malbori Paratha",dal_khichadi_dahi:"Dal Fry Rice / Dal Khichadi Dahi",schezwan_rice_manchurian:"Schezwan Rice & Manchurian",mumbai_vada_pav:"Mumbai Vada Pav",punjabi_samosa_chaat:"Punjabi Samosa Chaat",paneer_kathi_roll:"Paneer Kathi Roll",paneer_butter_masala:"Paneer Butter Masala",amritsari_chole:"Amritsari Chole",dal_tadka:"Dal Tadka",garlic_butter_naan:"Garlic Butter Naan",tandoori_roti:"Tandoori Roti",veg_dum_biryani:"Veg Dum Biryani",hyderabadi_chicken_65:"Hyderabadi Chicken 65",goan_fish_curry:"Goan Fish Curry",kerala_parotta_combo:"Kerala Parotta Combo",classic_gulab_jamun:"Classic Gulab Jamun",kulfi_falooda:"Kulfi Falooda",masala_chaas:"Masala Chaas"}},la={categories:{all_time_hit:"हमेशा पसंदीदा",mini_thali:"मिनी थाली",fries:"फ्राइज़",starters:"स्टार्टर्स",veg_starters:"शाकाहारी स्टार्टर",tandoor_specials:"तंदूरी स्पेशल",maharashtrian:"महाराष्ट्रीयन",punjabi:"पंजाबी",paneer_specials:"पनीर स्पेशल",rice:"चावल",roti:"रोटी",dal:"दाल",chinese:"चाइनीज़",thali:"थाली",desserts:"मिठाई",beverages:"पेय",street_snacks:"स्ट्रीट स्नैक्स",north_indian_curries:"उत्तर भारतीय करी",breads_rice:"रोटियाँ और चावल",regional_specials:"क्षेत्रीय विशेष",desserts_beverages:"डेसर्ट और पेय",main_course:"मुख्य भोजन"},items:{veg_sandwich:"वेज सैंडविच",dosa:"डोसा",peanut_curry:"पीनट करी",misal:"मिसल",paneer_junglee_sandwich:"पनीर जंगली सैंडविच",mumbai_sandwich:"मुंबई सैंडविच",terra_wada_pav:"टेरा वडा पाव",gluten_free_dosai:"ग्लूटेन फ्री डोसा",kothimbir_wadi:"कोथिंबीर वड़ी",bombay_pav_bhaji:"बॉम्बे पाव भाजी",pizza_bomb:"पिज़्ज़ा बॉम्ब",mini_batata_wada:"मिनी बटाटा वडा",appe_chutney:"अप्पे और चटनी",namaste_misal_pav_dahi:"नमस्ते मिसल पाव और दही",chola_kulcha:"छोला कुलचा",rajma_chawal:"राजमा चावल",dal_makhni_jeera_rice:"दाल मखनी जीरा चावल",veg_korma_paratha:"वेज कोरमा और पराठा",dal_khichadi_dahi:"दाल खिचड़ी दही",schezwan_rice_manchurian:"सिचुआन चावल और मंचूरियन",mumbai_vada_pav:"मुंबई वडा पाव",punjabi_samosa_chaat:"पंजाबी समोसा चाट",paneer_kathi_roll:"पनीर काठी रोल",paneer_butter_masala:"पनीर बटर मसाला",amritsari_chole:"अमृतसरी छोले",dal_tadka:"दाल तड़का",garlic_butter_naan:"गार्लिक बटर नान",tandoori_roti:"तंदूरी रोटी",veg_dum_biryani:"वेज दम बिरयानी",hyderabadi_chicken_65:"हैद्राबादी चिकन 65",goan_fish_curry:"गोअन फिश करी",kerala_parotta_combo:"केरल परोटा कॉम्बो",classic_gulab_jamun:"क्लासिक गुलाब जामुन",kulfi_falooda:"कुल्फी फालूदा",masala_chaas:"मसाला छाछ"}},ia={categories:{all_time_hit:"सर्वकालीन हिट",mini_thali:"मिनी थाळी",fries:"फ्राईज",starters:"स्टार्टर्स",veg_starters:"व्हेज स्टार्टर",tandoor_specials:"तंदूर स्पेशल",maharashtrian:"महाराष्ट्रीयन",punjabi:"पंजाबी",paneer_specials:"पनीर स्पेशल",rice:"भात",roti:"पोळी",dal:"डाळ",chinese:"चायनीज",thali:"थाळी",desserts:"गोड पदार्थ",beverages:"पेय",street_snacks:"स्ट्रीट स्नॅक्स",north_indian_curries:"उत्तर भारतीय करी",breads_rice:"पोळी आणि भात",regional_specials:"प्रादेशिक स्पेशल",desserts_beverages:"डेझर्ट आणि पेय",main_course:"मुख्य जेवण"},items:{veg_sandwich:"व्हेज सँडविच",dosa:"डोसा",peanut_curry:"शेंगदाणा आमटी",misal:"मिसळ",paneer_junglee_sandwich:"पनीर जंगलि सँडविच",mumbai_sandwich:"मुंबई सँडविच",terra_wada_pav:"टेरा वडा पाव",gluten_free_dosai:"ग्लूटेन फ्री डोसा",kothimbir_wadi:"कोथिंबीर वडी",bombay_pav_bhaji:"बॉम्बे पाव भाजी",pizza_bomb:"पिझ्झा बॉम्ब",mini_batata_wada:"मिनी बटाटा वडा",appe_chutney:"अप्पे आणि चटणी",namaste_misal_pav_dahi:"नमस्ते मिसळ पाव आणि दही",chola_kulcha:"छोला कुलचा",rajma_chawal:"राजमा भात",dal_makhni_jeera_rice:"डाळ मखनी जिरा भात",veg_korma_paratha:"व्हेज कोरमा आणि पराठा",dal_khichadi_dahi:"डाळ खिचडी दही",schezwan_rice_manchurian:"सिचुआन भात आणि मंचुरियन",mumbai_vada_pav:"मुंबई वडा पाव",punjabi_samosa_chaat:"पंजाबी समोसा चाट",paneer_kathi_roll:"पनीर काठी रोल",paneer_butter_masala:"पनीर बटर मसाला",amritsari_chole:"अमृतसरी छोले",dal_tadka:"दाल तडका",garlic_butter_naan:"गार्लिक बटर नान",tandoori_roti:"तंदूरी रोटी",veg_dum_biryani:"व्हेज दम बिर्याणी",hyderabadi_chicken_65:"हैद्राबादी चिकन 65",goan_fish_curry:"गोअन फिश करी",kerala_parotta_combo:"केरळ परोटा कॉम्बो",classic_gulab_jamun:"क्लासिक गुलाब जामुन",kulfi_falooda:"कुल्फी फालूदा",masala_chaas:"मसाला ताक"}},ca={categories:{all_time_hit:"Succès intemporel",mini_thali:"Mini Thali",fries:"Frites",starters:"Entrées",veg_starters:"Entrées végétariennes",tandoor_specials:"Spécialités Tandoor",maharashtrian:"Maharashtrien",punjabi:"Punjabi",paneer_specials:"Spécial Paneer",rice:"Riz",roti:"Pain",dal:"Lentilles",chinese:"Chinois",thali:"Thali",desserts:"Desserts",beverages:"Boissons"},items:{veg_sandwich:"Sandwich Végétarien",paneer_junglee_sandwich:"Sandwich Paneer Junglee",mumbai_sandwich:"Sandwich Mumbai",terra_wada_pav:"Terra Wada Pav",gluten_free_dosai:"Dosai sans gluten",kothimbir_wadi:"Kothimbir Wadi",bombay_pav_bhaji:"Pav Bhaji de Bombay",pizza_bomb:"Pizza Bomb",mini_batata_wada:"Mini Batata Wada",appe_chutney:"Appe & Chutney",namaste_misal_pav_dahi:"Namaste Misal Pav & Yaourt",chola_kulcha:"Chola Kulcha",rajma_chawal:"Rajma Chawal",dal_makhni_jeera_rice:"Dal Makhni Riz au Cumin",veg_korma_paratha:"Korma Végétarien & Paratha",dal_khichadi_dahi:"Dal Khichadi & Yaourt",schezwan_rice_manchurian:"Riz Schezwan & Manchurian"}},da={categories:{all_time_hit:"ઓલ ટાઇમ હિટ",mini_thali:"મિની થાળી",fries:"ફ્રાઈસ",starters:"સ્ટાર્ટર્સ",veg_starters:"વેજ સ્ટાર્ટર્સ",tandoor_specials:"તંદૂર સ્પેશિયલ",maharashtrian:"મહારાષ્ટ્રીયન",punjabi:"પંજાબી",paneer_specials:"પનીર સ્પેશિયલ",rice:"ભાત",roti:"રોટલી",dal:"દાળ",chinese:"ચાઈનીઝ",thali:"થાળી",desserts:"મીઠાઈ",beverages:"પીણાં",street_snacks:"સ્ટ્રીટ સ્નેક્સ",north_indian_curries:"ઉત્તર ભારતીય કરી",breads_rice:"રોટલી અને ભાત",regional_specials:"પ્રાદેશિક સ્પેશિયલ",desserts_beverages:"ડેઝર્ટ અને પીણાં",main_course:"મુખ્ય ભોજન"},items:{veg_sandwich:"વેજ સેન્ડવીચ",dosa:"ઢોસા",peanut_curry:"સીંગની કઢી",misal:"મિસળ",paneer_junglee_sandwich:"પનીર જંગલી સેન્ડવીચ",mumbai_sandwich:"મુંબઈ સેન્ડવીચ",terra_wada_pav:"ટેરા વડા પાવ",gluten_free_dosai:"ગ્લુટેન ફ્રી ઢોસા",kothimbir_wadi:"કોથમીર વડી",bombay_pav_bhaji:"બોમ્બે પાવ ભાજી",pizza_bomb:"પીઝા બોમ્બ",mini_batata_wada:"મિની બટાટા વડા",appe_chutney:"અપ્પે અને ચટણી",namaste_misal_pav_dahi:"નમસ્તે મિસળ પાવ અને દહીં",chola_kulcha:"છોલે કુલચા",rajma_chawal:"રાજમા ચાવલ",dal_makhni_jeera_rice:"દાલ મખની જીરા રાઇસ",veg_korma_paratha:"વેજ કોરમા અને પરાઠા",dal_khichadi_dahi:"દાલ ખીચડી દહીં",schezwan_rice_manchurian:"શેઝવાન રાઇસ અને મંચુરિયન",mumbai_vada_pav:"મુંબઈ વડા પાવ",punjabi_samosa_chaat:"પંજાબી સમોસા ચાટ",paneer_kathi_roll:"પનીર કાઠી રોલ",paneer_butter_masala:"પનીર બટર મસાલા",amritsari_chole:"અમૃતસરી છોલે",dal_tadka:"દાલ તડકા",garlic_butter_naan:"ગાર્લિક બટર નાન",tandoori_roti:"તંદૂરી રોટી",veg_dum_biryani:"વેજ દમ બિરયાની",hyderabadi_chicken_65:"હૈદરાબાદી ચિકન 65",goan_fish_curry:"ગોલ્ડન ફિશ કરી",kerala_parotta_combo:"કેરળ પરોટા કોમ્બો",classic_gulab_jamun:"ક્લાસિક ગુલાબ જાંબુ",kulfi_falooda:"કુલ્ફી ફાલુદા",masala_chaas:"મસાલા છાશ"}},He={en:na,hi:la,mr:ia,fr:ca,gu:da},ua={DINE_IN:[{key:"placed",label:"Order Placed"},{key:"preparing",label:"Preparing"},{key:"done",label:"Done"}],TAKEAWAY:[{key:"placed",label:"Order Placed"},{key:"preparing",label:"Preparing"},{key:"done",label:"Done"}]},ma={Pending:0,Confirmed:0,Preparing:1,Ready:1,Served:1,Finalized:1,Paid:2,Cancelled:-1,Returned:-1},ga={Pending:0,Confirmed:0,Accept:1,Accepted:1,"Being Prepared":1,BeingPrepared:1,Completed:1,Paid:2,Exit:2,Cancelled:-1,Returned:-1};function pa(o){return ua[o==="TAKEAWAY"?"TAKEAWAY":"DINE_IN"]}function fa(o){if(o==null||o==="")return"Pending";const m=String(o).trim();return m==="Accept"?"Accepted":m==="BeingPrepared"?"Being Prepared":m}function Ia(o,m){const _=(o??"").toString().trim();if(m==="TAKEAWAY"){const R=fa(_),W=ga[R];return W!==void 0&&W>=0?W:0}const j=ma[_];return j!==void 0&&j>=0?j:0}function Sa({status:o="Pending",className:m="",updatedAt:_,serviceType:j="DINE_IN",tableLabel:R,reason:W}){const h=pa(j),U=o??"Pending",q=Ia(U,j),M=_?new Date(_).toLocaleTimeString():null,Q=["Cancelled","Returned"].includes(U),ae=typeof W=="string"?W.trim():"";return Q?t.jsx("div",{className:`order-status-timeline ${m}`,children:t.jsxs("div",{className:"order-status-timeline-step order-status-step-completed",children:[t.jsx("div",{className:"order-status-dot order-status-dot-completed"}),t.jsxs("div",{className:"order-status-step-content",children:[t.jsx("span",{className:"order-status-step-label",children:U}),M&&t.jsxs("span",{className:"order-status-step-meta",children:["Updated ",M]}),ae&&t.jsxs("span",{className:"order-status-step-meta",children:["Reason: ",ae]})]})]})}):t.jsxs("div",{className:`order-status-timeline ${m}`,children:[M&&t.jsxs("div",{className:"order-status-updated-meta",children:["Updated ",M]}),h.map((L,le)=>{const ce=le<q,G=le===q,de=le>q,fe=le===h.length-1,_e=le===0&&R?R:L.label;return t.jsx("div",{className:"order-status-timeline-step-wrapper",children:t.jsxs("div",{className:"order-status-timeline-step",children:[t.jsxs("div",{className:"order-status-step-left",children:[t.jsx("div",{className:`order-status-dot ${ce?"order-status-dot-completed":""} ${G?"order-status-dot-active":""} ${de?"order-status-dot-pending":""}`,children:ce&&t.jsx("svg",{className:"order-status-check",viewBox:"0 0 12 12",fill:"none",stroke:"white",strokeWidth:"2.5",strokeLinecap:"round",children:t.jsx("path",{d:"M2 6l3 3 5-6"})})}),!fe&&t.jsx("div",{className:"order-status-line"})]}),t.jsxs("div",{className:"order-status-step-content",children:[t.jsx("span",{className:`order-status-step-label ${G?"order-status-step-label-active":""} ${de?"order-status-step-label-pending":""}`,children:_e}),G&&M&&t.jsxs("span",{className:"order-status-step-meta",children:["Updated ",M]})]})]})},L.key)})]})}const K="https://api.terracart.in".replace(/\/$/,""),_a=o=>o?o.startsWith("http://")||o.startsWith("https://")?o:o.startsWith("/")?`${K}${o}`:`${K}/uploads/${o}`:"/defaultImg.jpg",z="terra_serviceType",Se="terra_selectedTable",ha="terra_feedbackSubmittedOrders",Re="terra_takeaway_token_preview",ba=["Pending","Confirmed","Preparing","Ready","Served","Completed","Paid","Returned","Cancelled"],ya=["Pending","Confirmed","Preparing","Ready","Served","Finalized","Completed"],va=["Paid"],Ht=["Paid","Cancelled","Returned"],Ta=o=>{if(o==null)return 0;const m=Number(o);return Number.isNaN(m)?0:m/100},We=o=>{const m=Number(o);return Number.isNaN(m)?"0.00":m.toFixed(2)},Qt=760,Aa=()=>{if(typeof window>"u")return 2;const o=Number(window.devicePixelRatio)||1;return Math.min(Math.max(o,1.5),2)},ka=()=>{if(typeof navigator>"u")return!1;const o=navigator.userAgent||"",m=/iPad|iPhone|iPod/i.test(o),_=navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1;return m||_},wa=(o,m)=>{if(!ka()){o.save(m);return}const _=o.output("blob"),j=URL.createObjectURL(_);if(!window.open(j,"_blank","noopener,noreferrer")){const W=document.createElement("a");W.href=j,W.download=m,W.rel="noopener",document.body.appendChild(W),W.click(),document.body.removeChild(W)}window.setTimeout(()=>URL.revokeObjectURL(j),6e4)},ar=o=>String(o||"").replace(/^\(\s*\+\s*\)\s*/u,"").trim()||"Add-on",Gt=o=>{if(!o)return null;const m=o.acceptedBy||null,_=o.assignedStaff||null,j=m?.employeeName||_?.name||null;return j?{name:j,role:_?.role||m?.employeeRole||null,disability:m?.disability?.type||_?.disability||null}:null},Xt=o=>{if(!o)return"INV-NA";const m=new Date(o.createdAt||Date.now()).toISOString().slice(0,10).replace(/-/g,""),_=(o.cartId||o._id||"").toString().slice(-6).toUpperCase();return`INV-${m}-${_}`},pt=o=>{if(!o)return[];const m=new Map;return(Array.isArray(o.kotLines)?o.kotLines:[]).forEach(R=>{(R?.items||[]).forEach(W=>{if(!W)return;const h=W.name||"Item",U=Number(W.quantity)||0,q=Ta(W.price||0),M=!!W.returned;m.has(h)||m.set(h,{name:h,unitPrice:q,activeQuantity:0,returnedQuantity:0,totalQuantity:0,amount:0,returned:!1});const Q=m.get(h);Q.totalQuantity+=U,M?(Q.returnedQuantity+=U,Q.returned=!0):(Q.activeQuantity+=U,Q.amount+=q*U),Q.unitPrice||(Q.unitPrice=q)})}),(o.selectedAddons||[]).forEach(R=>{const W=ar(R.name),h=`addon:${R.addonId||R._id||R.id||`${W}-${R.price||0}`}`,U=1,q=Number(R.price)||0;m.has(h)||m.set(h,{name:W,unitPrice:q,activeQuantity:0,returnedQuantity:0,totalQuantity:0,amount:0,returned:!1});const M=m.get(h);M.totalQuantity+=U,M.activeQuantity+=U,M.amount+=q*U}),Array.from(m.values()).map(R=>({...R,quantity:R.activeQuantity}))},Zt=(o,m)=>{if(!o)return{subtotal:0,gst:0,totalAmount:0,totalItems:0};const _=Array.isArray(m)?m:pt(o)||[],j=_.reduce((U,q)=>{if(!q)return U;const M=Number(q.amount)||0;return U+M},0),R=Number(j.toFixed(2));return{subtotal:R,gst:0,totalAmount:R,totalItems:_.reduce((U,q)=>q?U+(Number(q.quantity)||0):U,0)}},er=o=>{if(!o)return null;const m=o.paidAt||o.updatedAt||o.createdAt;if(!m)return null;const _=new Date(m);return Number.isNaN(_.getTime())?null:_},Na=()=>{try{const o=localStorage.getItem(ha);if(!o)return[];const m=JSON.parse(o);return Array.isArray(m)?m.map(_=>_==null?"":String(_).trim()).filter(Boolean):[]}catch{return[]}},tr=o=>{if(!o)return!1;const m=String(o).trim();return m?Na().includes(m):!1},Ea=o=>{const m={};return o.forEach(_=>{(_.items||[]).forEach(j=>{m[j.name]=j})}),m},or={MILD:"Mild",MEDIUM:"Medium",HOT:"Hot",EXTREME:"Extreme"},xa=o=>{const m=String(o?.spiceLevel||"").trim().toUpperCase();return or[m]?m:""},sr=({item:o,onAdd:m,onRemove:_,count:j,lang:R})=>{if(!o)return null;const W=R||localStorage.getItem("language")||"en";let h=null;if(He[W]?.items){const le=o.name?.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"");h=He[W].items[le]}const[U]=rr(o.name||""),q=h||U,M=o.isAvailable!==!1,Q=o?.isFeatured===!0,ae=xa(o),L=ae?or[ae]:"";return t.jsxs(Hr.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.5},className:`item-card group ${M?"":"unavailable"}`,children:[t.jsxs("div",{className:"item-image-container",children:[t.jsx("img",{src:_a(o?.image),alt:o?.name||"Menu item",className:"item-image"}),Q&&t.jsx("span",{className:"special-corner-badge","aria-label":"Special item",children:"Special"})]}),t.jsxs("div",{className:"item-info-section",children:[t.jsx("h4",{className:"item-name",children:q||o?.name||"Unnamed Item"}),t.jsxs("div",{className:"item-price-row",children:[t.jsxs("p",{className:"item-price",children:["₹",o?.price||0]}),ae&&t.jsxs("span",{className:`item-spice-badge spice-${ae.toLowerCase()}`,title:`Spice level: ${L} Spicy`,children:[t.jsx("span",{className:"item-spice-primary",children:L}),t.jsx("span",{className:"item-spice-secondary",children:"Spicy"})]})]}),!M&&t.jsx("div",{className:"item-meta-row",children:t.jsx("span",{className:"item-status-badge unavailable",children:"Not available"})})]}),t.jsx("div",{className:"item-footer",children:t.jsxs("div",{className:"item-controls",children:[t.jsx("button",{"aria-label":`Remove one ${o?.name||"item"}`,className:"quantity-button",onClick:()=>o?.name&&_(o.name),disabled:!j,children:"-"}),t.jsx("span",{className:"item-count",children:j||0}),t.jsx("button",{"aria-label":`Add one ${o?.name||"item"}`,className:`quantity-button ${M?"":"disabled"}`,onClick:()=>o&&m(o),disabled:!M,title:M?void 0:"Currently unavailable",children:"+"})]})})]})},ja=({category:o,items:m,cart:_,onAdd:j,onRemove:R,lang:W,defaultOpen:h=!1})=>{if(!o)return null;const U=W||localStorage.getItem("language")||"en";let q=null;if(He[U]?.categories){const ce=o?.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"");q=He[U].categories[ce]}const[M]=rr(o||""),Q=q||M,[ae,L]=l.useState(h),le=Array.isArray(m)?m:[];return t.jsxs("div",{className:"category-wrapper",children:[t.jsxs("button",{onClick:()=>L(ce=>!ce),className:"category-button",children:[Q||o," ",t.jsx("span",{children:ae?"▲":"▼"})]}),ae&&t.jsx("div",{className:"category-items",children:le.map((ce,G)=>t.jsx(sr,{item:ce,onAdd:j,onRemove:R,count:_[ce?.name]||0,lang:U},ce?._id||`${o}-${G}`))})]})};function Oa(){const o=Mr(),m=Rr(),[_,j]=Wr(),[R,W]=l.useState(localStorage.getItem("language")||"en");l.useEffect(()=>{const e=()=>{W(localStorage.getItem("language")||"en")};return window.addEventListener("storage",e),window.addEventListener("language-change",e),()=>{window.removeEventListener("storage",e),window.removeEventListener("language-change",e)}},[]);const h=(e,r)=>{if(!e)return r;const n=e.split(".");let s=sa[R];for(const d of n)s=s?.[d];return s||r},U=[{label:h("processSteps.checkingOrder","Checking your order"),state:"pending"},{label:h("processSteps.confirmingItems","Confirming items & price"),state:"pending"},{label:h("processSteps.placingOrder","Placing your order"),state:"pending"},{label:h("processSteps.sendingToKitchen","Sending to kitchen"),state:"pending"},{label:h("processSteps.preparingDetails","Preparing order details"),state:"pending"}],[q,M]=l.useState(!1),[Q,ae]=l.useState(U),L=(e,r)=>ae(n=>n.map((s,d)=>d===e?{...s,state:r}:s)),[le,ce]=l.useState(localStorage.getItem("accessibilityMode")==="true"),[G,de]=l.useState(()=>{const e=localStorage.getItem("terra_cart");return e?JSON.parse(e):{}}),fe=l.useRef(G);l.useEffect(()=>{localStorage.setItem("terra_cart",JSON.stringify(G)),fe.current=G},[G]);const[_e,he]=l.useState(!1),[Ca,Da]=l.useState(!1),[St,Ke]=l.useState(""),[nr,Qe]=l.useState(!1),[Ge,_t]=l.useState(!1),[ht,Xe]=l.useState(!1),[bt,Ze]=l.useState(!1),[yt,vt]=l.useState(!1),[Tt,be]=l.useState(!1),[Pa,At]=l.useState(null),[lr,Ma]=l.useState(!1),[Ye,ir]=l.useState(""),[ye,kt]=l.useState([]),[ve,wt]=l.useState({}),[Ae,et]=l.useState(!0),[Te,Nt]=l.useState(null),me=l.useMemo(()=>!Array.isArray(ye)||ye.length===0?[]:ye.flatMap(e=>e?(Array.isArray(e.items)?e.items:[]).map(r=>({...r,categoryName:e?.name||"Menu"})):[]),[ye]),{cartTotal:cr,cartItemCount:Et}=l.useMemo(()=>{let e=0,r=0;return Object.entries(G).forEach(([n,s])=>{r+=s;const d=me.find(u=>u.name===n);d&&(e+=(d.price||0)*s)}),{cartTotal:e,cartItemCount:r}},[G,me]),xt=l.useMemo(()=>{const e=Ye.trim().toLowerCase();return e?!Array.isArray(me)||me.length===0?[]:me.filter(r=>r?.name?r.name.toLowerCase().includes(e)||(r.description||"").toLowerCase().includes(e)||(r.tags||[]).some(n=>n&&n.toLowerCase().includes(e)):!1):[]},[me,Ye]),ge=l.useRef(null),tt=l.useRef(null),Oe=l.useRef(null),[T,V]=l.useState(()=>{const e=localStorage.getItem(z)||"DINE_IN";let r=null;return e==="TAKEAWAY"?r=localStorage.getItem("terra_orderId_TAKEAWAY"):r=localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),r||null}),[O,B]=l.useState(()=>((localStorage.getItem(z)||"DINE_IN")==="TAKEAWAY"?localStorage.getItem("terra_orderStatus_TAKEAWAY")||localStorage.getItem("terra_orderStatus"):localStorage.getItem("terra_orderStatus_DINE_IN")||localStorage.getItem("terra_orderStatus"))||null),[pe,J]=l.useState(()=>((localStorage.getItem(z)||"DINE_IN")==="TAKEAWAY"?localStorage.getItem("terra_orderStatusUpdatedAt_TAKEAWAY")||localStorage.getItem("terra_orderStatusUpdatedAt"):localStorage.getItem("terra_orderStatusUpdatedAt_DINE_IN")||localStorage.getItem("terra_orderStatusUpdatedAt"))||null),[x,Ce]=l.useState(()=>localStorage.getItem("terra_takeaway_only")==="true"?"TAKEAWAY":localStorage.getItem(z)||"DINE_IN"),[F,rt]=l.useState(()=>{try{const e=localStorage.getItem(Se);return e?JSON.parse(e):null}catch(e){return console.warn("Invalid table selection cache",e),null}}),[$e,ee]=l.useState(()=>localStorage.getItem("terra_sessionToken"));l.useEffect(()=>{(async()=>{if((localStorage.getItem(z)||"DINE_IN")==="TAKEAWAY")return;const n=localStorage.getItem("terra_orderId"),s=localStorage.getItem("terra_sessionToken");if(!(!n||!s))try{const d=await fetch(`${K}/api/orders/${n}`);if(!d.ok){d.status===404?(console.log("[Menu] Active order not found (404), clearing order data"),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"),V(null),B(null),J(null)):console.warn("[Menu] Error verifying order (non-404), keeping existing status:",d.status);return}let u;try{u=await d.json()}catch(c){console.error("[Menu] Failed to parse order response as JSON:",c);return}if(!u)return;u.sessionToken&&u.sessionToken!==s&&(console.log("[Menu] Clearing stale dine-in order data for old session"),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_previousOrder"),localStorage.removeItem("terra_previousOrderDetail"),V(null),B(null),J(null))}catch(d){console.warn("[Menu] Error verifying active order session (network error), keeping existing status:",d)}})()},[]),l.useEffect(()=>{const e=localStorage.getItem("terra_sessionToken"),r=$e,n=localStorage.getItem(z)||"DINE_IN";e&&r&&e!==r&&(n!=="TAKEAWAY"&&(console.log("[Menu] SessionToken changed - clearing old dine-in order data"),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_previousOrder"),localStorage.removeItem("terra_previousOrderDetail"),localStorage.removeItem("terra_lastPaidOrderId"),localStorage.removeItem("terra_cart_DINE_IN"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN"),V(null),B(null),J(null)),ee(e))},[$e]),l.useEffect(()=>{const e=localStorage.getItem(z)||"DINE_IN";let r=null;e==="TAKEAWAY"?r=localStorage.getItem("terra_orderId_TAKEAWAY"):r=localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),r&&r!==T?V(r):!r&&T&&V(null)},[x,T]),l.useEffect(()=>{if(x!=="TAKEAWAY"){Ue(null);return}if(T){Ue(null),localStorage.removeItem(Re);return}const r=(()=>{const u=localStorage.getItem("terra_selectedCartId");if(u)return u;const c=localStorage.getItem("terra_takeaway_cartId");if(c)return c;try{const k=JSON.parse(localStorage.getItem(Se)||"{}"),S=k.cartId||k.cafeId||null;if(!S)return null;if(typeof S=="string")return S;if(typeof S=="object"){const w=S._id||S.id;return w?String(w):null}return String(S)}catch{return null}})();if(!r)return;let n=localStorage.getItem("terra_takeaway_sessionToken");n||(n=`TAKEAWAY-${Date.now()}-${Math.random().toString(36).slice(2,11)}`,localStorage.setItem("terra_takeaway_sessionToken",n));let s=!1;return(async()=>{try{const u=new URLSearchParams({cartId:r});n&&u.set("sessionToken",n);const c=await fetch(`${K}/api/orders/takeaway-token/next?${u.toString()}`);if(!c.ok)return;const k=await c.json(),S=Number(k?.token);!s&&Number.isInteger(S)&&S>0&&(Ue(S),localStorage.setItem(Re,String(S)))}catch(u){console.warn("[Menu] Failed to fetch takeaway token preview:",u)}})(),()=>{s=!0}},[x,T]),l.useEffect(()=>{},[x,o]);const[Ra]=l.useState(()=>localStorage.getItem("terra_takeaway_customerName")||""),[Wa]=l.useState(()=>localStorage.getItem("terra_takeaway_customerMobile")||""),[Ka]=l.useState(()=>localStorage.getItem("terra_takeaway_customerEmail")||""),[De,jt]=l.useState(()=>{try{const e=localStorage.getItem("terra_previousOrder");return e?JSON.parse(e):null}catch(e){return console.warn("Invalid previous order cache",e),localStorage.removeItem("terra_previousOrder"),null}}),[Y,Ot]=l.useState(()=>{try{const e=localStorage.getItem("terra_previousOrderDetail");return e?JSON.parse(e):null}catch(e){return console.warn("Invalid previous order detail cache",e),localStorage.removeItem("terra_previousOrderDetail"),null}}),[ke,X]=l.useState(null),[Ct,Ue]=l.useState(()=>{const e=Number(localStorage.getItem(Re));return Number.isInteger(e)&&e>0?e:null}),[dr,at]=l.useState(!1),[y,ot]=l.useState(null),[Dt,Le]=l.useState(!1),[st,we]=l.useState(!1),[Fe,nt]=l.useState(!1),[ur,Ne]=l.useState(!1),[Ee,Pt]=l.useState(null),[xe,lt]=l.useState(""),[it,Mt]=l.useState(!1),ue=l.useCallback(e=>{e?(jt(e),localStorage.setItem("terra_previousOrder",JSON.stringify(e))):(jt(null),localStorage.removeItem("terra_previousOrder"))},[]),oe=l.useCallback(e=>{e?(Ot(e),localStorage.setItem("terra_previousOrderDetail",JSON.stringify(e))):(Ot(null),localStorage.removeItem("terra_previousOrderDetail"))},[]),qe=l.useCallback((e={})=>{const r=e.orderId||T;if(!r)return;const n=e.status||O||"Confirmed",s=e.updatedAt||pe||new Date().toISOString(),d=e.tableInfo||F||(()=>{try{const k=localStorage.getItem(Se);return k?JSON.parse(k):null}catch{return null}})(),u=e.tableNumber??d?.number??d?.tableNumber??null,c=e.tableSlug??d?.qrSlug??localStorage.getItem("terra_scanToken")??null;ue({orderId:r,status:n,updatedAt:s,tableNumber:u,tableSlug:c})},[T,O,pe,F,ue]),Pe=l.useMemo(()=>y?Xt(y):null,[y]),ze=l.useMemo(()=>pt(y),[y]),ct=l.useMemo(()=>y?Zt(y,ze):{subtotal:0,gst:0,totalAmount:0,totalItems:0},[y,ze]),mr=l.useMemo(()=>y?y.serviceType==="TAKEAWAY"?"Takeaway":"Dine-In":"",[y]),gr=y?.table?.number??y?.tableNumber??null,Rt=y?.table?.name??null,Me=l.useMemo(()=>er(y),[y]),Wt=l.useMemo(()=>pt(Y),[Y]),Kt=l.useMemo(()=>Y?Zt(Y,Wt):{subtotal:0,gst:0,totalAmount:0,totalItems:0},[Y,Wt]),dt=l.useMemo(()=>er(Y),[Y]),Yt=l.useMemo(()=>Y?Xt(Y):null,[Y]),je=l.useMemo(()=>Gt(ke),[ke]),Be=l.useMemo(()=>Gt(Y),[Y]),Ve=l.useMemo(()=>{const e=ke?.takeawayToken??Y?.takeawayToken??Ct;return e!=null&&e!==""?e:null},[ke,Y,Ct]),pr=h("manualEntry","Menu");h("smartServe","Smart Serve");const fr=h("aiOrdered","AI Ordered:");h("orderSummary","Order Summary:"),h("confirm","Confirm"),h("speakOrder","Speak Order");const Ir=h("processingVoice","Processing your voice..."),ut=h("cartEmpty","Cart is empty");h("resetOrderBtn","Reset Order");const Sr=h("tapToOrder","Tap to Order"),_r=h("tapToStop","Tap to Stop"),hr=h("searchPlaceholder","Search item..."),br=h("recordVoiceAria","Record voice order");l.useEffect(()=>{O?localStorage.setItem("terra_orderStatus",O):localStorage.removeItem("terra_orderStatus"),pe?localStorage.setItem("terra_orderStatusUpdatedAt",pe):localStorage.removeItem("terra_orderStatusUpdatedAt")},[O,pe]),l.useEffect(()=>{O&&T&&De&&ue(null),O&&T&&Y&&oe(null)},[O,T,De,Y,ue,oe]),l.useEffect(()=>{if(!De&&!Y)return;const e=localStorage.getItem("terra_scanToken"),r=De?.tableSlug;if(r&&e&&r!==e){ue(null),oe(null);return}!r&&Y?.table?.qrSlug&&e&&Y.table.qrSlug!==e&&(ue(null),oe(null))},[De,Y,ue,oe]),l.useEffect(()=>{const e=localStorage.getItem(z),r=localStorage.getItem("terra_takeaway_only")==="true";if((localStorage.getItem("terra_orderId_TAKEAWAY")||r)&&e!=="TAKEAWAY"){console.log("[Menu] Detected takeaway order or takeaway-only mode on refresh, setting serviceType to TAKEAWAY"),Ce("TAKEAWAY"),localStorage.setItem(z,"TAKEAWAY");return}m.state?.serviceType?(Ce(m.state.serviceType),localStorage.setItem(z,m.state.serviceType)):e?Ce(e):r&&(console.log("[Menu] Detected takeaway-only QR flow, setting serviceType to TAKEAWAY"),Ce("TAKEAWAY"),localStorage.setItem(z,"TAKEAWAY")),m.state?.table&&(rt(m.state.table),localStorage.setItem(Se,JSON.stringify(m.state.table)))},[m.state,Ce]),l.useEffect(()=>{let e=!1;const r=async()=>{if((localStorage.getItem(z)||m.state?.serviceType||"DINE_IN")!=="DINE_IN")return!0;const u=localStorage.getItem("terra_orderId")||localStorage.getItem("terra_orderId_DINE_IN"),c=localStorage.getItem("terra_orderStatus")||localStorage.getItem("terra_orderStatus_DINE_IN"),k=u&&(!c||!["Paid","Cancelled","Returned","Completed"].includes(c));if(u)try{const N=await fetch(`${K}/api/orders/${u}`);if(N.ok){const b=await N.json();if(b.status&&!["Paid","Cancelled","Returned","Completed"].includes(b.status))return console.log("[Menu] User has verified active order - allowing access, skipping waitlist check"),!0}}catch(N){if(console.warn("[Menu] Failed to verify order on backend:",N),k)return console.log("[Menu] Order verification failed but order exists in storage - allowing access"),!0}const S=localStorage.getItem("terra_sessionToken"),w=localStorage.getItem("terra_selectedTable");if(S&&w)try{const N=JSON.parse(w);if(N.sessionToken===S)return console.log("[Menu] User has matching sessionToken - allowing access, skipping waitlist check"),!0;const b=N.qrSlug||localStorage.getItem("terra_scanToken");if(b)try{const a=await fetch(`${K}/api/tables/lookup/${b}?sessionToken=${S}`);if(a.ok){const i=await a.json();if(i?.table?.sessionToken===S||i?.table?.activeOrder)return console.log("[Menu] Backend confirms user owns table session - allowing access"),!0}}catch(a){if(console.warn("[Menu] Failed to verify table session on backend:",a),N.sessionToken===S)return!0}}catch(N){console.warn("[Menu] Failed to check sessionToken:",N)}const g=localStorage.getItem("terra_waitToken");if(k&&g)return console.log("[Menu] User has active order but also has waitlist token - clearing waitlist token"),localStorage.removeItem("terra_waitToken"),!0;if(!g)return!0;try{const N=await fetch(`${K}/api/waitlist/status?token=${g}`);if(N.ok){const b=await N.json();if(b.status==="WAITING")return console.log("[Menu] User is in WAITING status - blocking menu access"),alert("You are currently in the waitlist. Please wait for your turn. You will be notified when the table is ready."),o("/secondpage"),!1;if(b.status==="NOTIFIED"||b.status==="SEATED")return!0}}catch(N){console.error("[Menu] Failed to check waitlist status:",N)}return!0},n=async()=>{try{if((localStorage.getItem(z)||m.state?.serviceType||"DINE_IN")==="TAKEAWAY")return;const u=localStorage.getItem("terra_selectedTable");let c=localStorage.getItem("terra_sessionToken");const k=localStorage.getItem("terra_scanToken");if(!u||!k)return;const S=JSON.parse(u),w=S.id||S._id;if(!w)return;let g=!0;try{const p=S.qrSlug||k;if(p){const I=await fetch(`${K}/api/tables/lookup/${p}${c?`?sessionToken=${c}`:""}`).catch(f=>{throw console.warn("[Menu] Network error during table lookup:",f),f});if(I.status===423){let f={};try{f=await I.json()}catch(E){console.warn("[Menu] Failed to parse 423 response (expected for occupied tables):",E)}console.log("[Menu] Table lookup returned 423 (Locked - expected for occupied tables) - handling gracefully");const C=localStorage.getItem("terra_orderId")||localStorage.getItem("terra_orderId_DINE_IN");if(C)try{const E=await fetch(`${K}/api/orders/${C}`);if(E.ok){const $=await E.json();if(($.table?.toString()||$.tableId?.toString())===w?.toString()){$.sessionToken&&(c=$.sessionToken,localStorage.setItem("terra_sessionToken",c),ee(c),console.log("[Menu] Table is locked but user has active order - using order's sessionToken:",c)),console.log("[Menu] Table is already occupied by user's active order - skipping markTableOccupied"),g=!1;return}}}catch(E){console.warn("[Menu] Failed to verify order when table is locked:",E)}if(f?.table){const E={...S,...f.table,qrSlug:S.qrSlug||f.table.qrSlug};if(localStorage.setItem("terra_selectedTable",JSON.stringify(E)),f.table.sessionToken){const $=f.table.sessionToken;if($===c)console.log("[Menu] Table is locked but sessionToken matches - we own this table"),localStorage.setItem("terra_sessionToken",c),ee(c),g=!0;else{const H=localStorage.getItem("terra_sessionToken");if(H&&H===$)console.log("[Menu] Table is locked but stored sessionToken matches table's token - we own this table"),c=H,localStorage.setItem("terra_sessionToken",c),ee(c),g=!0;else{console.warn("[Menu] Table is locked and sessionToken doesn't match - table belongs to another user"),g=!1;return}}}else if(c)console.log("[Menu] Table is locked and no sessionToken in response, but we have one - proceeding (backend will validate)"),g=!0;else{console.warn("[Menu] Table is locked and no sessionToken available - table belongs to another user"),g=!1;return}}else if(c)console.log("[Menu] Table is locked and no table data in response, but we have sessionToken - proceeding (backend will validate)"),g=!0;else{console.warn("[Menu] Table is locked and user has no active order for this table - skipping markTableOccupied"),g=!1;return}}if(I.ok){const f=await I.json();if(f?.table){const C=f.table,E=C.sessionToken,$={...S,...C,qrSlug:S.qrSlug||C.qrSlug};if(localStorage.setItem("terra_selectedTable",JSON.stringify($)),E&&E!==c){const H=localStorage.getItem("terra_orderId")||localStorage.getItem("terra_orderId_DINE_IN");if(H)try{const te=await fetch(`${K}/api/orders/${H}`);if(te.ok){const A=await te.json();(A.table?.toString()||A.tableId?.toString())===w?.toString()?A.sessionToken?(c=A.sessionToken,localStorage.setItem("terra_sessionToken",c),ee(c),console.log("[Menu] Using order's sessionToken:",c)):(c=E,localStorage.setItem("terra_sessionToken",c),ee(c),console.log("[Menu] Using backend table's sessionToken:",c)):(console.warn("[Menu] User has order but not for this table - skipping markTableOccupied"),g=!1)}}catch(te){console.warn("[Menu] Failed to verify order:",te),c=E,localStorage.setItem("terra_sessionToken",c),ee(c)}else console.warn("[Menu] Table has different sessionToken and user has no active order - skipping markTableOccupied"),g=!1}else E&&E===c?console.log("[Menu] SessionToken matches - proceeding with markTableOccupied"):E||console.log("[Menu] Table has no sessionToken - proceeding with markTableOccupied")}}}}catch(p){p?.status!==423&&console.warn("[Menu] Failed to refresh table status before markTableOccupied:",p)}if(!g)return;const N=localStorage.getItem("terra_orderId")||localStorage.getItem("terra_orderId_DINE_IN"),b=localStorage.getItem("terra_orderStatus")||localStorage.getItem("terra_orderStatus_DINE_IN");if(N&&b&&!["Paid","Cancelled","Returned","Completed"].includes(b)&&N)try{const p=await fetch(`${K}/api/orders/${N}`);if(p.ok){const I=await p.json();if(I.status&&!["Paid","Cancelled","Returned","Completed"].includes(I.status)&&(I.table?.toString()===w?.toString()||I.tableId?.toString()===w?.toString())){console.log("[Menu] User has active order for this table - skipping markTableOccupied"),I.sessionToken&&(localStorage.setItem("terra_sessionToken",I.sessionToken),ee(I.sessionToken));return}}}catch(p){console.warn("[Menu] Failed to verify order before markTableOccupied:",p)}let i;try{i=await Vt(`${K}/api/tables/${w}/occupy`,{sessionToken:c||void 0},{headers:{"Content-Type":"application/json"}},{maxRetries:2,retryDelay:1e3,timeout:15e3,shouldRetry:(p,I)=>p.message?.includes("timeout")||p.message?.includes("Network error")||p.message?.includes("Failed to fetch")||p.message?.includes("CORS")?!0:p.status>=400&&p.status<500?!1:p.status>=500?!0:I<1})}catch(p){console.warn("[Menu] Failed to mark table as occupied after retries:",p),i={ok:!1,status:0,json:async()=>({}),text:async()=>p.message||"Network error"}}if(i.ok){const p=await i.json().catch(()=>null);if(p?.table){const I=p.table.sessionToken||c,f={...S,status:p.table.status||"OCCUPIED",sessionToken:I};localStorage.setItem("terra_selectedTable",JSON.stringify(f)),I&&I!==c&&(localStorage.setItem("terra_sessionToken",I),ee(I),console.log("[Menu] Updated sessionToken after marking table occupied:",I))}else S.status="OCCUPIED",localStorage.setItem("terra_selectedTable",JSON.stringify(S))}else{const p=await i.text().catch(()=>"Unknown error");if(console.warn("Failed to mark table as occupied:",p),i.status===423)try{const I=S.qrSlug||localStorage.getItem("terra_scanToken");if(I){const f=await fetch(`${K}/api/tables/lookup/${I}?sessionToken=${c||""}`);if(f.ok){const C=await f.json().catch(()=>({}));if(C?.table?.sessionToken){const E=C.table.sessionToken;localStorage.setItem("terra_sessionToken",E),ee(E),console.log("[Menu] Table already occupied by us, updated sessionToken:",E)}}}}catch(I){console.warn("Failed to refresh table status:",I)}}}catch(d){console.warn("Error marking table as occupied:",d)}};return(async()=>{try{if(et(!0),Nt(null),!await r()){et(!1);return}await n();let u="";const c=localStorage.getItem("terra_selectedCartId");if(c)u=c,console.log("[Menu] Using selected cart ID for menu:",u);else{const b=localStorage.getItem("terra_takeaway_cartId");if(b)u=b,console.log("[Menu] Using takeaway QR cart ID for menu:",u);else try{let a=localStorage.getItem("terra_selectedTable");a||(a=localStorage.getItem(Se)||"{}");const i=JSON.parse(a);u=i.cartId||i.cafeId||"",console.log("[Menu] Table data for cartId lookup:",{hasTableData:!!a,tableDataKeys:i?Object.keys(i):[],cartId:i.cartId,cafeId:i.cafeId,foundCartId:u}),u?console.log("[Menu] Using table cart ID for menu:",u):console.warn("[Menu] No cartId or cafeId found in table data:",i)}catch(a){console.error("[Menu] Error parsing table data:",a),console.log("[Menu] No cart ID found, loading default menu")}}const k=u?`${K}/api/menu/public?cartId=${u}`:`${K}/api/menu/public`;console.log("[Menu] Loading menu from:",k,{hasCartId:!!u,cartId:u,serviceType:x});const S=await fetch(k);if(!S.ok)throw new Error(`Menu fetch failed with status ${S.status}`);let w;try{w=await S.json()}catch(b){console.error("[Menu] Failed to parse menu response as JSON:",b);const a=await S.text().catch(()=>"Unknown error");throw new Error(`Invalid menu response format: ${a.substring(0,100)}`)}if(e)return;const g=(Array.isArray(w)?w:[]).map(b=>b?{...b,name:b.name||"Menu",items:(Array.isArray(b.items)?b.items:[]).map(a=>a?{...a,isAvailable:a.isAvailable!==!1,categoryName:b.name||"Menu"}:null).filter(Boolean)}:null).filter(Boolean),N=Ea(g);kt(g),wt(N),At(b=>b||Array.isArray(g)&&g.length>0&&g[0]?.name||null)}catch(d){if(console.error("Menu fetch error",d),e)return;kt([]),wt({}),At(null),Nt("Trying to connect to live menu... please check your network or ask staff.")}finally{e||et(!1)}})(),()=>{e=!0}},[]);const $t=e=>{const r=typeof e=="string"?e:e?.name;if(!r)return;const n=ve[r]||e;if(n&&n.isAvailable===!1){alert(`${n.name} is currently unavailable.`);return}de(s=>({...s,[r]:(s[r]||0)+1}))},Ut=e=>{de(r=>{const n=(r[e]||0)-1;if(n<=0){const{[e]:s,...d}=r;return d}return{...r,[e]:n}})},se=e=>new Promise(r=>setTimeout(r,e)),ne={validate:1e3,order:1e3,beforeSend:1e3,kitchen:1e3,summary:1e3,error:1e3},Lt=async()=>{if(Object.keys(fe.current||{}).length===0)return M(!1),alert(ut);if(x==="DINE_IN"&&!T&&!F){M(!1),alert("We couldn't detect your table. Please scan the table QR again or contact staff before placing an order.");return}await yr()},yr=async()=>{let e=T;if(e)try{const r=await fetch(`${K}/api/orders/${e}`);if(r.ok){const n=await r.json();["Paid","Cancelled","Returned"].includes(n.status)&&(console.log("[Menu] Existing order is in blocked status, creating new order instead:",n.status),e=null,V(null),x==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.removeItem("terra_orderStatus_TAKEAWAY"),localStorage.removeItem("terra_orderStatusUpdatedAt_TAKEAWAY")):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN")))}else console.log("[Menu] Could not fetch existing order, creating new order"),e=null,V(null),x==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.removeItem("terra_orderStatus_TAKEAWAY"),localStorage.removeItem("terra_orderStatusUpdatedAt_TAKEAWAY")):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN"))}catch(r){console.warn("[Menu] Error checking existing order, creating new order:",r),e=null,V(null),x==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.removeItem("terra_orderStatus_TAKEAWAY"),localStorage.removeItem("terra_orderStatusUpdatedAt_TAKEAWAY")):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN"))}ae(U.map((r,n)=>{let s=r.label;switch(n){case 0:s=h("processSteps.checkingOrder","Checking your order");break;case 1:s=h("processSteps.confirmingItems","Confirming items & price");break;case 2:s=h("processSteps.placingOrder","Placing your order");break;case 3:s=h("processSteps.sendingToKitchen","Sending to kitchen");break;case 4:s=h("processSteps.preparingDetails","Preparing order details");break}return{...r,label:s,state:"pending"}})),M(!0);try{L(0,"active"),await se(ne.validate),L(0,"done"),L(1,"active"),await se(ne.order),L(1,"done"),L(2,"active"),await se(ne.beforeSend);let r=F;const n=x!=="DINE_IN"&&localStorage.getItem("terra_orderType")||null,s=x==="PICKUP"||x==="DELIVERY",d=n==="PICKUP"||n==="DELIVERY"?n:s?x:null,u=x==="TAKEAWAY"||s,c=x!=="DINE_IN"?localStorage.getItem("terra_customerLocation"):null;let k=null;if(c)try{k=JSON.parse(c)}catch(v){console.warn("[Menu] Failed to parse customerLocation from localStorage:",v),k=null}const S=u||d==="PICKUP"||d==="DELIVERY",w=d==="PICKUP"||d==="DELIVERY",g=S&&localStorage.getItem("terra_takeaway_customerName")||"",N=S&&localStorage.getItem("terra_takeaway_customerMobile")||"",b=S&&localStorage.getItem("terra_takeaway_customerEmail")||"";let a=null;if(u){const v=localStorage.getItem("terra_takeaway_cartId");if(v)a=v;else try{const P=JSON.parse(localStorage.getItem(Se)||"{}");let re=P.cartId||P.cafeId||null;re&&(typeof re=="object"&&re._id?a=re._id:typeof re=="string"?a=re:a=String(re)),console.log("[Menu] Using cartId from table data for takeaway:",a)}catch(P){console.warn("[Menu] Could not get cartId from table data for takeaway order:",P)}}let i=null;u?(i=localStorage.getItem("terra_takeaway_sessionToken"),i?console.log("[Menu] Using existing takeaway sessionToken (unified for both flows):",i):(i=`TAKEAWAY-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("terra_takeaway_sessionToken",i),console.log("[Menu] Generated new takeaway sessionToken (unified for both flows):",i))):(i=localStorage.getItem("terra_sessionToken"),i||(i=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("terra_sessionToken",i),ee(i),console.log("[Menu] Generated new DINE_IN sessionToken:",i)));const p=localStorage.getItem("terra_specialInstructions")||null,I=localStorage.getItem("terra_selectedCartId")||a,f=I||(()=>{try{const v=JSON.parse(localStorage.getItem(Se)||"{}"),P=v.cartId||v.cafeId;if(typeof P=="string")return P;if(P&&typeof P=="object"&&P._id)return P._id;if(P!=null)return String(P)}catch{}return""})(),C=localStorage.getItem("terra_cart_addons")||"{}";let E=[];try{const v=JSON.parse(C);Array.isArray(v)?E=v:f&&Array.isArray(v[f])&&(E=v[f])}catch{E=[]}const $=JSON.parse(localStorage.getItem("terra_global_addons")||"[]"),H=Array.isArray($)?$:[],te=E.map(v=>{const P=H.find(re=>re.id===v);return P?{addonId:v,name:ar(P.name),price:P.price}:null}).filter(Boolean),A=qr(fe.current,{serviceType:d?d==="PICKUP"?"PICKUP":"DELIVERY":x,orderType:d==="PICKUP"||d==="DELIVERY"?d:void 0,tableId:r?.id||r?._id||F?.id||F?._id,tableNumber:r?.number??r?.tableNumber??F?.number??F?.tableNumber,menuCatalog:ve,sessionToken:i,customerName:w&&g?.trim()?g.trim():void 0,customerMobile:w&&N?.trim()?N.trim():void 0,customerEmail:w&&b?.trim()?b.trim():void 0,cartId:S||d?I||a:void 0,customerLocation:k,specialInstructions:p,selectedAddons:te}),ie=Number(localStorage.getItem(Re));if(u&&d!=="DELIVERY"&&!e&&Number.isInteger(ie)&&ie>0&&(A.takeawayToken=ie),!A.items||!Array.isArray(A.items)||A.items.length===0){console.error("[Menu] Invalid order payload - no items:",A),alert("❌ Your cart is empty. Please add items before placing an order."),L(2,"error"),await se(ne.error),M(!1);return}const zt=A.items.filter(v=>!v.name||typeof v.quantity!="number"||v.quantity<=0||typeof v.price!="number"||v.price<0);if(zt.length>0){console.error("[Menu] Invalid order payload - invalid items:",zt),alert("❌ Some items in your cart are invalid. Please refresh the page and try again."),L(2,"error"),await se(ne.error),M(!1);return}if(A.serviceType==="DINE_IN"&&!A.sessionToken&&(i?A.sessionToken=i:(A.sessionToken=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("terra_sessionToken",A.sessionToken),ee(A.sessionToken))),A.serviceType==="PICKUP"||A.serviceType==="DELIVERY"||A.orderType==="PICKUP"||A.orderType==="DELIVERY"){if(!A.customerName||!A.customerName.trim()){alert("❌ Customer name is required for "+(A.orderType||A.serviceType)+" orders. Please provide your name."),L(2,"error"),await se(ne.error),M(!1);return}if(!A.customerMobile||!A.customerMobile.trim()){alert("❌ Customer mobile number is required for "+(A.orderType||A.serviceType)+" orders. Please provide your mobile number."),L(2,"error"),await se(ne.error),M(!1);return}}if(A.serviceType==="DELIVERY"||A.orderType==="DELIVERY"){if(!A.customerLocation||!A.customerLocation.latitude||!A.customerLocation.longitude){alert("❌ Delivery location is required. Please go back and provide your delivery address."),L(2,"error"),await se(ne.error),M(!1);return}if(!A.cartId){alert("❌ Store selection is required for delivery. Please go back and select a store."),L(2,"error"),await se(ne.error),M(!1);return}try{const v=await fetch(`${K}/api/carts/${A.cartId}?latitude=${A.customerLocation.latitude}&longitude=${A.customerLocation.longitude}&orderType=DELIVERY`);if(v.ok){const P=await v.json();if(P.success&&P.data){const re=P.data;if(!re.canDeliver){let Je=`❌ Delivery not available!

`;re.distance!==null?Je+=`You are ${re.distance.toFixed(2)} km away, but maximum delivery radius is ${re.deliveryRadius||5} km.

`:Je+=`Delivery is not enabled for this store or the store location is not configured.

`,Je+="Please select a different store or choose Pickup instead.",alert(Je),L(2,"error"),await se(ne.error),M(!1);return}}}}catch(v){console.error("[Menu] Error checking delivery availability:",v)}}const Pr=e?`${K}/api/orders/${e}/kot`:`${K}/api/orders`;let Z;try{Z=await Vt(Pr,A,{headers:{"Content-Type":"application/json"}},{maxRetries:2,retryDelay:1500,timeout:3e4,shouldRetry:(v,P)=>v.message?.includes("timeout")||v.message?.includes("Network error")||v.message?.includes("Failed to fetch")||v.message?.includes("CORS")?(console.log(`[Menu] Retrying order creation (attempt ${P+1}/2)...`),!0):v.status>=400&&v.status<500?!1:v.status>=500?!0:P<1})}catch(v){console.error("[Menu] Order creation failed after retries:",v);const P=v.message||"Failed to create order. Please check your connection and try again.";Z={ok:!1,status:0,statusText:"Network Error",json:async()=>({message:P}),text:async()=>P,headers:new Headers}}let D;try{if((Z.headers?.get?.("content-type")||"").includes("application/json"))D=await Z.json();else{const P=await Z.text().catch(()=>"");if(P)try{D=JSON.parse(P)}catch{D={message:P||"Unknown error"}}else D={message:"No response from server"}}}catch(v){console.error("[Menu] Failed to parse response:",v);try{D={message:await Z.text().catch(()=>"Unknown error")||"Failed to parse server response"}}catch{D={message:"Failed to parse server response"}}}const Bt=Z.ok&&D?._id;if(console.log("[Menu] Order creation response:",{ok:Z.ok,status:Z.status,hasOrderId:!!D?._id,orderId:D?._id,orderCreated:Bt}),Bt)console.log("[Menu] Order created successfully:",D._id);else{if(L(2,"error"),Z.status===403){const v=D?.message||"Access denied. Please try refreshing the page.";v.includes("assigned to another guest")||v.includes("table")?alert(`⚠️ ${v}

Please scan the table QR code again or contact staff for assistance.`):alert(`❌ ${v}`)}else if(Z.status===400){const v=D?.message||D?.error||"Invalid request. Please check your order and try again.";console.error("[Menu] Order save failed (400 Bad Request):",{status:Z.status,statusText:Z.statusText,error:D,payload:A,itemsCount:A.items?.length,serviceType:A.serviceType,hasSessionToken:!!A.sessionToken,hasTableId:!!A.tableId,hasTableNumber:!!A.tableNumber});let P=v;D?.message?.includes("No items supplied")?P="Your cart is empty. Please add items before placing an order.":D?.message?.includes("Session token is required")?P="Session token is missing. Please scan the table QR code again.":D?.message?.includes("Table selection is required")?P="Table information is missing. Please scan the table QR code again.":D?.message?.includes("Invalid order items")&&(P="Some items in your cart are invalid. Please refresh the page and try again."),alert(`❌ ${P}`)}else{const v=D?.message||D?.error||"Failed to save order.";console.error("[Menu] Order save failed:",{status:Z.status,statusText:Z.statusText,error:D,payload:A}),alert(`❌ ${v}`)}await se(ne.error),M(!1),be(!1);return}console.log("[Menu] Proceeding with order success flow for order:",D._id),L(2,"done"),L(3,"active"),await se(ne.kitchen),L(3,"done"),u?(localStorage.setItem("terra_orderId_TAKEAWAY",D._id),localStorage.removeItem(Re),Ue(null),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),D.sessionToken?(localStorage.setItem("terra_takeaway_sessionToken",D.sessionToken),console.log("[Menu] Stored takeaway sessionToken from order response:",D.sessionToken)):i&&(localStorage.setItem("terra_takeaway_sessionToken",i),console.log("[Menu] Stored generated takeaway sessionToken:",i))):(localStorage.setItem("terra_orderId",D._id),localStorage.setItem("terra_orderId_DINE_IN",D._id),localStorage.removeItem("terra_orderId_TAKEAWAY")),V(D._id),B(D.status||"Confirmed"),J(new Date().toISOString()),X(D),u?(localStorage.setItem("terra_orderStatus_TAKEAWAY",D.status||"Confirmed"),localStorage.setItem("terra_orderStatusUpdatedAt_TAKEAWAY",new Date().toISOString())):(localStorage.setItem("terra_orderStatus_DINE_IN",D.status||"Confirmed"),localStorage.setItem("terra_orderStatusUpdatedAt_DINE_IN",new Date().toISOString())),D&&(D.takeawayToken||D.serviceType==="TAKEAWAY")&&oe(D),de({}),localStorage.removeItem("terra_cart"),localStorage.removeItem("terra_cart_DINE_IN"),localStorage.removeItem("terra_cart_TAKEAWAY"),be(!1),console.log("[Menu] Order created and stored:",{orderId:D._id,serviceType:x,storedInLocalStorage:{generic:x==="DINE_IN"?localStorage.getItem("terra_orderId"):null,dineIn:x==="DINE_IN"?localStorage.getItem("terra_orderId_DINE_IN"):null,takeaway:u?localStorage.getItem("terra_orderId_TAKEAWAY"):null}}),L(4,"active"),L(4,"done"),M(!1)}catch(r){L(2,"error"),alert("❌ Server Error"),console.error(r),await se(ne.error),M(!1),be(!1)}},vr=async()=>{if(_e){try{ge.current&&(ge.current.stop(),ge.current=null)}catch(e){console.warn("Error stopping recognition:",e)}he(!1);return}if(!("webkitSpeechRecognition"in window)&&!("SpeechRecognition"in window)){alert("Your browser doesn't support voice input. Please use the menu buttons to order.");return}try{const e=window.SpeechRecognition||window.webkitSpeechRecognition,r=new e;ge.current=r,r.continuous=!1,r.interimResults=!1,r.maxAlternatives=3,r.lang=qt(),r.onstart=()=>{he(!0),Ke(""),console.log("🎤 Voice recognition started")},r.onresult=async n=>{const s=n.results[0][0].transcript;console.log("📝 Transcribed:",s),Ke(s),he(!1),Qe(!0);try{await Dr(s,{speakFeedback:!1})}catch{}finally{Qe(!1)}},r.onerror=n=>{console.error("Voice recognition error:",n.error),he(!1),Qe(!1),ge.current=null,n.error==="no-speech"?alert("No speech detected. Please try again."):n.error==="not-allowed"?alert("Microphone permission denied. Please allow microphone access."):alert("Voice recognition error. Please try again or use menu buttons.")},r.onend=()=>{he(!1),ge.current=null},he(!0),r.start()}catch(e){console.error("Error starting voice recognition:",e),alert("Failed to start voice input. Please try again or use menu buttons."),he(!1)}};l.useEffect(()=>()=>{if(ge.current){try{ge.current.stop()}catch{}ge.current=null}if(tt.current){try{tt.current.stop()}catch{}tt.current=null}typeof window<"u"&&"speechSynthesis"in window&&window.speechSynthesis.cancel()},[]);const Tr=()=>{de({}),localStorage.removeItem("terra_cart")},Ar=async()=>{if(!(!O||Ge)){be(!0),_t(!0);try{if((localStorage.getItem(z)||"DINE_IN")==="TAKEAWAY"){const a=T||localStorage.getItem("terra_orderId_TAKEAWAY")||localStorage.getItem("terra_orderId"),i=localStorage.getItem("terra_takeaway_sessionToken")||localStorage.getItem("terra_sessionToken");if(!a){alert("No active order found. Please create a new order.");return}try{const p=await fetch(`${K}/api/orders/${a}`);if(p.ok){const I=await p.json();if(I.status&&["Paid","Cancelled","Returned","Completed"].includes(I.status)){alert("This order has been completed. Please create a new order.");return}V(a),localStorage.setItem("terra_orderId_TAKEAWAY",a),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),B(I.status||O||"Confirmed"),localStorage.setItem("terra_orderStatus_TAKEAWAY",I.status||O||"Confirmed"),I.updatedAt&&(J(I.updatedAt),localStorage.setItem("terra_orderStatusUpdatedAt_TAKEAWAY",I.updatedAt)),de({}),localStorage.removeItem("terra_cart"),localStorage.removeItem("terra_cart_TAKEAWAY"),alert("You can continue adding items to your takeaway order.");return}else{alert("Order not found. Please create a new order.");return}}catch{alert("Unable to verify order. Please try again or contact staff.");return}}const r=localStorage.getItem("terra_selectedTable"),n=$e||localStorage.getItem("terra_sessionToken");if(!r||!n){alert("We couldn't detect your table. Please scan the table QR again or contact staff.");return}let s=null;if(T)try{const a=await fetch(`${K}/api/orders/${T}`);a.ok&&(s=await a.json())}catch{}const d=JSON.parse(r),u=d.qrSlug||localStorage.getItem("terra_scanToken"),c=localStorage.getItem("terra_sessionToken")||n,k=new URLSearchParams;c&&k.set("sessionToken",c);const S=`${K}/api/tables/lookup/${u}${k.toString()?`?${k.toString()}`:""}`;let w=await fetch(S),g=await w.json().catch(()=>({}));if(w.status===423){const a=g?.table?.sessionToken;if(a&&a===c)console.log("[Menu] Table is occupied by current session, proceeding");else{const i=g?.message||"Table is currently assigned to another guest.";if(c){console.warn("Stale session detected, retrying table lookup without session token."),localStorage.removeItem("terra_sessionToken"),ee(null);const I=new URLSearchParams().toString(),f=`${K}/api/tables/lookup/${u}${I?`?${I}`:""}`,C=await fetch(f),E=await C.json().catch(()=>({}));if(!C.ok)throw new Error(E?.message||i||"Unable to refresh table session. Please ask staff for help.");w=C,g=E}else throw new Error(i)}}else if(!w.ok)throw new Error(g?.message||"Failed to refresh table session. Please ask staff for help.");if(g.sessionToken){const a=$e||localStorage.getItem("terra_sessionToken"),i=g.sessionToken;i!==a&&(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_previousOrder"),localStorage.removeItem("terra_previousOrderDetail"),localStorage.removeItem("terra_lastPaidOrderId"),V(null),B(null),J(null),ue(null),oe(null),["DINE_IN","TAKEAWAY"].forEach(p=>{localStorage.removeItem(`terra_cart_${p}`),localStorage.removeItem(`terra_orderId_${p}`),localStorage.removeItem(`terra_orderStatus_${p}`),localStorage.removeItem(`terra_orderStatusUpdatedAt_${p}`)})),localStorage.setItem("terra_sessionToken",i),ee(i)}g.table&&(localStorage.setItem("terra_selectedTable",JSON.stringify(g.table)),rt(g.table)),(g.table?.status||"AVAILABLE")==="AVAILABLE"?localStorage.removeItem("terra_waitToken"):g.waitlist?.token?localStorage.setItem("terra_waitToken",g.waitlist.token):localStorage.removeItem("terra_waitToken");const b=g.table||d;if(g.order){const a=localStorage.getItem(z)||"DINE_IN";if(g.order.serviceType&&g.order.serviceType!==a){console.log(`[Menu] Ignoring order from table lookup - serviceType mismatch: order is ${g.order.serviceType}, current is ${a}`);return}V(g.order._id),a==="TAKEAWAY"?(localStorage.setItem("terra_orderId_TAKEAWAY",g.order._id),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN")):(localStorage.setItem("terra_orderId",g.order._id),localStorage.setItem("terra_orderId_DINE_IN",g.order._id),localStorage.removeItem("terra_orderId_TAKEAWAY")),B(g.order.status||O||"Confirmed"),g.order.updatedAt&&(J(g.order.updatedAt),localStorage.setItem("terra_orderStatusUpdatedAt",g.order.updatedAt)),ue(null)}else T?console.log("No order returned from table lookup, keeping existing order status"):(qe({status:O||"Completed",updatedAt:pe||new Date().toISOString(),tableNumber:b?.number??b?.tableNumber??null,tableSlug:b?.qrSlug??u??null,tableInfo:b}),B(null),J(null),V(null),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"));s&&oe(s),alert("You can continue adding items to your order.")}catch(e){console.error("handleOrderAgain error",e),alert(e.message||"Unable to resume ordering. Please contact staff.")}finally{_t(!1),be(!1)}}},kr=()=>{if(!(x==="TAKEAWAY"?T||localStorage.getItem("terra_orderId_TAKEAWAY")||localStorage.getItem("terra_orderId"):T||localStorage.getItem("terra_orderId"))){alert("No active order found.");return}Pt("Cancel"),lt(""),Ne(!0)},wr=()=>{if(!T){alert("No active order found.");return}Pt("Return"),lt(""),Ne(!0)},Nr=async()=>{if(!xe.trim()){alert("Please enter a reason.");return}Mt(!0);try{if(Ee==="Cancel"){Xe(!0);const e=x==="TAKEAWAY"?T||localStorage.getItem("terra_orderId_TAKEAWAY")||localStorage.getItem("terra_orderId"):T||localStorage.getItem("terra_orderId");let r=null;if(x==="TAKEAWAY"){if(r=localStorage.getItem("terra_takeaway_sessionToken")||localStorage.getItem("terra_sessionToken"),!r)try{const c=await fetch(`${K}/api/orders/${e}`);if(c.ok){const k=await c.json();k?.sessionToken&&(r=k.sessionToken,localStorage.setItem("terra_takeaway_sessionToken",r))}}catch(c){console.warn("[Menu] Failed to fetch order to get sessionToken:",c)}}else r=localStorage.getItem("terra_sessionToken");const n=await fetch(`${K}/api/orders/${e}/customer-status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"Cancelled",sessionToken:r||void 0,reason:xe})}),s=await n.json().catch(()=>({}));if(!n.ok)throw new Error(s?.message||"Failed to cancel order");const d=s?._id?s:null,u=d?.updatedAt||new Date().toISOString();qe({orderId:d?._id,status:"Cancelled",updatedAt:u,tableNumber:d?.tableNumber??F?.number??F?.tableNumber??null,tableSlug:d?.table?.qrSlug??F?.qrSlug??localStorage.getItem("terra_scanToken")??null,tableInfo:d?.table||F}),d&&oe(d),B("Cancelled"),J(u),X(d||{status:"Cancelled",cancellationReason:xe,updatedAt:u,serviceType:x}),V(null),x==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.setItem("terra_orderStatus_TAKEAWAY","Cancelled"),localStorage.setItem("terra_orderStatusUpdatedAt_TAKEAWAY",u),localStorage.removeItem("terra_cart_TAKEAWAY"),localStorage.setItem("terra_orderStatus","Cancelled"),localStorage.setItem("terra_orderStatusUpdatedAt",u),localStorage.removeItem("terra_takeaway_customerName"),localStorage.removeItem("terra_takeaway_customerMobile"),localStorage.removeItem("terra_takeaway_customerEmail"),console.log("[Menu] Cleared takeaway customer data after order cancellation")):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.setItem("terra_orderStatus","Cancelled"),localStorage.setItem("terra_orderStatusUpdatedAt",u),localStorage.setItem("terra_orderStatus_DINE_IN","Cancelled"),localStorage.setItem("terra_orderStatusUpdatedAt_DINE_IN",u),localStorage.removeItem("terra_cart")),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_cart"),x==="TAKEAWAY"&&(localStorage.removeItem("terra_waitToken"),console.log("[Menu] Cleared waitlist state for cancelled takeaway order")),de({}),be(!1),alert("Your order has been cancelled."),Xe(!1)}else if(Ee==="Return"){Ze(!0);const e=x==="TAKEAWAY"?T||localStorage.getItem("terra_orderId_TAKEAWAY")||localStorage.getItem("terra_orderId"):T||localStorage.getItem("terra_orderId");let r=null;if(x==="TAKEAWAY"){if(r=localStorage.getItem("terra_takeaway_sessionToken")||localStorage.getItem("terra_sessionToken"),!r&&e)try{const c=await fetch(`${K}/api/orders/${e}`);if(c.ok){const k=await c.json();k?.sessionToken&&(r=k.sessionToken,localStorage.setItem("terra_takeaway_sessionToken",r))}}catch(c){console.warn("[Menu] Failed to fetch order to get sessionToken for return:",c)}}else r=localStorage.getItem("terra_sessionToken");const n=await fetch(`${K}/api/orders/${e}/customer-status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"Returned",sessionToken:r||void 0,reason:xe})}),s=await n.json().catch(()=>({}));if(!n.ok)throw new Error(s?.message||"Failed to return order");const d=s?._id?s:null,u=d?.updatedAt||new Date().toISOString();qe({orderId:d?._id,status:"Returned",updatedAt:u,tableNumber:d?.tableNumber??F?.number??F?.tableNumber??null,tableSlug:d?.table?.qrSlug??F?.qrSlug??localStorage.getItem("terra_scanToken")??null,tableInfo:d?.table||F}),d&&oe(d),B("Returned"),J(u),X(d||{status:"Returned",cancellationReason:xe,updatedAt:u,serviceType:x}),V(null),x==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.setItem("terra_orderStatus_TAKEAWAY","Returned"),localStorage.setItem("terra_orderStatusUpdatedAt_TAKEAWAY",u),localStorage.setItem("terra_orderStatus","Returned"),localStorage.setItem("terra_orderStatusUpdatedAt",u)):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.setItem("terra_orderStatus","Returned"),localStorage.setItem("terra_orderStatusUpdatedAt",u),localStorage.setItem("terra_orderStatus_DINE_IN","Returned"),localStorage.setItem("terra_orderStatusUpdatedAt_DINE_IN",u)),localStorage.removeItem("terra_cart"),de({}),be(!1),x==="TAKEAWAY"&&(localStorage.removeItem("terra_waitToken"),localStorage.removeItem("terra_takeaway_customerName"),localStorage.removeItem("terra_takeaway_customerMobile"),localStorage.removeItem("terra_takeaway_customerEmail")),alert("Your order has been marked as returned."),Ze(!1)}Ne(!1)}catch(e){alert(e.message||`Unable to ${Ee.toLowerCase()} order.`),Ee==="Cancel"&&Xe(!1),Ee==="Return"&&Ze(!1)}finally{Mt(!1)}},Er=async()=>{if(!T){alert("No active order found.");return}if(await window.confirm("Confirm that payment has been completed for this order?")){vt(!0);try{const e=localStorage.getItem("terra_sessionToken"),r=await fetch(`${K}/api/orders/${T}/confirm-payment`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentMethod:"CASH",sessionToken:x==="DINE_IN"&&e||void 0})}),n=await r.json().catch(()=>({}));if(!r.ok)throw new Error(n?.message||"Failed to confirm payment");const s=n?._id?n:null,d=s?.updatedAt||new Date().toISOString();qe({orderId:s?._id,status:"Paid",updatedAt:d,tableNumber:s?.tableNumber??F?.number??F?.tableNumber??null,tableSlug:s?.table?.qrSlug??F?.qrSlug??localStorage.getItem("terra_scanToken")??null,tableInfo:s?.table||F}),s&&oe(s),B("Paid"),J(d),localStorage.setItem("terra_orderStatus","Paid"),localStorage.setItem("terra_orderStatusUpdatedAt",d),localStorage.setItem("terra_lastPaidOrderId",T),alert("Payment confirmed successfully!")}catch(e){console.error("handleConfirmPayment error",e),alert(e.message||"Unable to confirm payment. Please contact staff.")}finally{vt(!1)}}},mt=l.useCallback(async()=>{if(!T){alert("We couldn't locate your order. Please contact staff.");return}try{Le(!0);const e=await fetch(`${K}/api/orders/${T}`),r=await e.json().catch(()=>({}));if(!e.ok)throw new Error(r?.message||"Failed to load invoice details.");console.log("📄 Invoice order data:",{orderId:r._id,franchiseId:r.franchiseId,cafeId:r.cafeId,franchise:r.franchise,cafe:r.cafe}),ot(r),at(!0)}catch(e){console.error("Invoice fetch failed",e),alert(e.message||"Unable to load invoice. Please contact staff.")}finally{Le(!1)}},[T]),Ft=l.useCallback(()=>{at(!1),ot(null),we(!1),nt(!1),Le(!1)},[]);l.useCallback(()=>{if(!(!Oe.current||!y||st)){we(!0);try{const e=document.createElement("iframe");e.style.position="fixed",e.style.right="0",e.style.bottom="0",e.style.width="0",e.style.height="0",e.style.border="0",e.style.visibility="hidden",e.setAttribute("sandbox","allow-same-origin allow-scripts allow-modals"),document.body.appendChild(e);const r=e.contentWindow?.document;if(!r){we(!1),document.body.removeChild(e),alert("Print preview failed to open. Please check your browser settings.");return}r.open(),r.write(`
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>${Pe||"Invoice"}</title>
          <style>
            * { box-sizing: border-box; }
            body {
              font-family: 'Segoe UI', Arial, sans-serif;
              margin: 0;
              padding: 32px;
              background: #ffffff;
              color: #1f2933;
            }
            h1, h2, h3, h4 { margin: 0; }
            table { border-collapse: collapse; width: 100%; }
            th, td { padding: 8px; border-bottom: 1px solid #e5e7eb; }
            th { text-align: left; color: #475569; font-weight: 600; }
            .invoice-shell {
              max-width: 720px;
              margin: 0 auto;
              padding: 24px;
              border: 1px solid #d2d6dc;
              border-radius: 12px;
            }
            @media print {
              body { padding: 0; }
              .invoice-shell { border: none; }
            }
          </style>
        </head>
        <body>
          <div class="invoice-shell">
            ${Oe.current.innerHTML}
          </div>
        </body>
      </html>
    `),r.close(),e.onload=function(){setTimeout(()=>{try{e.contentWindow?.focus(),e.contentWindow?.print()}catch(n){console.error("Print failed:",n),alert("Print failed. Please try using your browser's print function (Ctrl+P).")}finally{setTimeout(()=>{document.body.contains(e)&&document.body.removeChild(e),we(!1)},500)}},250)},setTimeout(()=>{st&&document.body.contains(e)&&(document.body.removeChild(e),we(!1),console.warn("Print timeout - iframe failed to load"))},5e3)}catch(e){console.error("Print setup failed:",e),we(!1),alert("Failed to initialize print. Please try again or use Ctrl+P.")}}},[Pe,y,st]);const xr=l.useCallback(async()=>{if(!Oe.current||!y||Fe)return;nt(!0);let e=null;try{e=document.createElement("div"),e.style.position="fixed",e.style.left="-10000px",e.style.top="0",e.style.width=`${Qt}px`,e.style.background="#ffffff",e.style.padding="0",e.style.margin="0",e.style.pointerEvents="none",e.style.opacity="0",e.style.zIndex="-1";const r=Oe.current.cloneNode(!0);r.style.width="100%",r.style.maxWidth="100%",r.style.margin="0",r.style.borderRadius="0",r.style.boxShadow="none",e.appendChild(r),document.body.appendChild(e),await new Promise(I=>{window.requestAnimationFrame(()=>I())});const n=r.scrollWidth||e.scrollWidth||Qt,s=Math.max(r.scrollHeight||e.scrollHeight||1,1),u=(await Vr(r,{scale:Aa(),useCORS:!0,logging:!1,backgroundColor:"#ffffff",scrollX:0,scrollY:0,windowWidth:n,windowHeight:s,width:n,height:s,onclone:I=>{I.querySelectorAll(".invoice-preview, .invoice-preview *").forEach(C=>{const E=window.getComputedStyle(C);["color","backgroundColor","borderColor"].forEach($=>{const H=E[$];H&&H.includes("oklch")&&(C.style[$]="#000000",$==="backgroundColor"&&(C.style[$]="transparent"))})})}})).toDataURL("image/png"),c=new Jr("p","mm","a4"),k=c.internal.pageSize.getWidth(),S=c.internal.pageSize.getHeight(),w=10,g=k-w*2,N=c.getImageProperties(u),b=N.height/N.width,a=g*b;let i=a,p=w;for(c.addImage(u,"PNG",w,p,g,a),i-=S-w*2;i>0;)c.addPage(),p=w-(a-i),c.addImage(u,"PNG",w,p,g,a),i-=S-w*2;wa(c,`${Pe||"invoice"}.pdf`)}catch(r){console.error("Invoice download failed",r),alert("Failed to generate invoice PDF. Please try again.")}finally{e&&document.body.contains(e)&&document.body.removeChild(e),nt(!1)}},[Pe,y,Fe]);l.useCallback(async()=>{if(["Preparing","Ready","Served","Finalized","Paid"].includes(O)){await mt();return}if(O==="Returned"||O==="Cancelled"){alert(O==="Returned"?"This order has already been returned.":"This order has been cancelled.");return}o("/billing")},[O,mt,o]);const jr=l.useCallback(()=>{Y&&(Le(!1),ot(Y),at(!0))},[Y]),qt=()=>{const e=localStorage.getItem("language")||"en";return e==="hi"?"hi-IN":e==="mr"?"mr-IN":e==="gu"?"gu-IN":"en-IN"},Ie=(e,r)=>{if(!(!e||typeof window>"u"||!("speechSynthesis"in window)))try{const n=new SpeechSynthesisUtterance(e);n.lang=qt(),n.rate=.95,n.pitch=1,n.onend=()=>{},window.speechSynthesis.cancel(),window.speechSynthesis.speak(n)}catch{}},gt=e=>(e||"").toLowerCase().replace(/[.,!?]/g," ").replace(/\s+/g," ").trim(),Or=e=>{const r={one:1,two:2,three:3,four:4,five:5,six:6,seven:7,eight:8,nine:9,ten:10,ek:1,do:2,teen:3,char:4,paanch:5,che:6,saat:7,aath:8,nau:9,das:10},n=gt(e);if(r[n]!==void 0)return r[n];const s=parseInt(n,10);return Number.isNaN(s)?0:s},Cr=e=>{const r={addedItems:[],notFound:[]};if(!e)return r;const n={...fe.current||{}},s=Array.isArray(me)&&me.length>0?me:Object.values(ve).length>0?Object.values(ve):zr.map(c=>({...c,isAvailable:!0})),d=e.replace(/\b(and|aur|plus|with)\b/gi,",").replace(/[;|]/g,",").split(",").map(c=>c.trim()).filter(Boolean),u=c=>gt(c).replace(/[^a-z0-9\s]/g,"");return d.forEach(c=>{let k=1,S=c.replace(/^(add|order|please add|please|i want|give me|mujhe|mala|mane)\s+/i,"").trim();const w=S.match(/^(\d+)\s*(x|times)?\s+(.+)$/i);if(w)k=parseInt(w[1],10)||1,S=w[3].trim();else{const b=S.match(/^(one|two|three|four|five|six|seven|eight|nine|ten|ek|do|teen|char|paanch|che|saat|aath|nau|das)\s+(.+)$/i);b&&(k=Or(b[1])||1,S=b[2].trim())}if(!S)return;const g=u(S),N=s.find(b=>b?.name&&u(b.name)===g)||s.find(b=>{if(!b?.name)return!1;const a=u(b.name);return a.includes(g)||g.includes(a)});N&&N.isAvailable!==!1?(n[N.name]=(n[N.name]||0)+k,r.addedItems.push({name:N.name,qty:k})):r.notFound.push(S)}),fe.current=n,de(n),r},Dr=async(e,{speakFeedback:r=!1,allowStop:n=!1}={})=>{const s=gt(e);if(!s)return r&&Ie("I could not hear you clearly. Please try again."),{type:"empty"};const d=a=>a.some(i=>s.includes(i)),u=["stop","assistant stop","close assistant","stop listening"],c=["confirm order","place order","order now","checkout","submit order","confirm my order","ऑर्डर कन्फर्म","ऑर्डर करो","ऑर्डर प्लेस","ऑર્ડર कન્ફર્મ","ઓર્ડર મૂકો"],k=["open cart","show cart","go to cart","cart kholo","कार्ट","કાર્ટ"],S=["clear cart","empty cart","reset cart","remove all","cart clear","कार्ट खाली","કાર્ટ ખાલી"];if(n&&d(u))return r&&Ie("Blind assistant stopped."),{type:"stop"};if(d(S))return Tr(),Ke(""),r?Ie("Cart has been cleared."):alert("Cart cleared."),{type:"clear"};if(d(k))return r&&Ie("Opening cart."),o("/cart"),{type:"cart"};if(d(c))return Object.keys(fe.current||{}).length===0?(r?Ie(ut||"Your cart is empty."):alert(ut),{type:"place-empty"}):(r&&Ie("Placing your order now."),await Lt(),{type:"place"});const{addedItems:w,notFound:g}=Cr(e),N=w.length,b=w.map(({name:a,qty:i})=>`${i}x ${a}`).join(", ");if(b&&Ke(b),N>0)r?Ie(`Added ${N} item${N>1?"s":""} to your cart.`):g.length>0&&alert(`✅ Added ${N} item(s) to cart.
⚠️ Not found in menu: ${g.join(", ")}`);else if(g.length>0){const a=`Could not find in menu: ${g.join(", ")}. Try saying item names as shown in the menu.`;r?Ie(a):alert(a)}return{type:"items",addedItems:w,notFound:g}};return l.useEffect(()=>{const r=(localStorage.getItem(z)||"DINE_IN")==="TAKEAWAY";let n=null;if(r?n=T||localStorage.getItem("terra_orderId_TAKEAWAY"):n=T||localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),!n){const a=r?localStorage.getItem("terra_orderStatus_TAKEAWAY")||localStorage.getItem("terra_orderStatus"):localStorage.getItem("terra_orderStatus_DINE_IN")||localStorage.getItem("terra_orderStatus"),i=r?localStorage.getItem("terra_orderStatusUpdatedAt_TAKEAWAY")||localStorage.getItem("terra_orderStatusUpdatedAt"):localStorage.getItem("terra_orderStatusUpdatedAt_DINE_IN")||localStorage.getItem("terra_orderStatusUpdatedAt");Ht.includes(a||"")?(B(a),J(i||null)):(B(null),J(null)),X(null);return}if(Tt)return;let s,d,u=!1,c=null;const k=a=>{if(!s||!a)return;const i=String(a);c!==i&&(s.emit("join:cart",i),c=i)},S=async()=>{try{const a=localStorage.getItem(z)||"DINE_IN";let i=null;if(a==="TAKEAWAY"?i=T||localStorage.getItem("terra_orderId_TAKEAWAY"):i=T||localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),!i){X(null);return}const p=localStorage.getItem("terra_sessionToken");let I;try{I=await fetch(`${K}/api/orders/${i}`,{signal:AbortSignal.timeout(5e3)})}catch{u||(console.warn("[Menu] Backend server appears to be offline. Will retry automatically."),u=!0);return}if(u&&(u=!1),!I.ok){I.status===404&&(console.warn("Order not found (404), clearing order data"),a==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.removeItem("terra_orderStatus_TAKEAWAY"),localStorage.removeItem("terra_orderStatusUpdatedAt_TAKEAWAY")):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN")),V(null),B(null),J(null),X(null));return}let f;try{f=await I.json()}catch(H){console.error("[Menu] Failed to parse order status response as JSON:",H);return}if(!f)return;const C=localStorage.getItem("terra_serviceType")||"DINE_IN",E=C==="TAKEAWAY";if(f.serviceType&&f.serviceType!==C){console.log(`[Menu] Ignoring order update - serviceType mismatch: order is ${f.serviceType}, current is ${C}`);return}const $=E&&localStorage.getItem("terra_takeaway_sessionToken")||p;if(E){if($&&f.sessionToken&&f.sessionToken!==$)return}else if($&&f.sessionToken&&f.sessionToken!==$){localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN"),localStorage.removeItem("terra_cart_DINE_IN"),localStorage.removeItem("terra_previousOrder"),localStorage.removeItem("terra_previousOrderDetail"),V(null),B(null),J(null),X(null),ue(null),oe(null);return}if(X(f),f.cartId&&k(f.cartId),E&&oe(f),f?.status){if((E?localStorage.getItem("terra_orderStatus_TAKEAWAY")||localStorage.getItem("terra_orderStatus"):localStorage.getItem("terra_orderStatus_DINE_IN")||localStorage.getItem("terra_orderStatus"))===f.status&&O===f.status)return;const te=new Date().toISOString();B(f.status),J(te),E?(localStorage.setItem("terra_orderStatus_TAKEAWAY",f.status),localStorage.setItem("terra_orderStatusUpdatedAt_TAKEAWAY",te),localStorage.setItem("terra_orderStatus",f.status),localStorage.setItem("terra_orderStatusUpdatedAt",te)):(localStorage.setItem("terra_orderStatus_DINE_IN",f.status),localStorage.setItem("terra_orderStatusUpdatedAt_DINE_IN",te),localStorage.setItem("terra_orderStatus",f.status),localStorage.setItem("terra_orderStatusUpdatedAt",te))}}catch{}};S(),d=setInterval(S,2e4);try{s=Br(K,{transports:["websocket","polling"],reconnection:!0,reconnectionDelay:1e3,reconnectionDelayMax:5e3,reconnectionAttempts:5,timeout:6e4,connectTimeout:6e4,autoConnect:!0,forceNew:!1});let a=!1;s.on("connect",()=>{a=!1,u=!1;const i=ke?.cartId,p=localStorage.getItem("terra_takeaway_cartId");let I=null;try{const f=JSON.parse(localStorage.getItem(Se)||"{}"),C=f.cartId||f.cafeId;I=typeof C=="object"&&C?._id?C._id:C}catch{I=null}k(i||p||I)}),s.on("connect_error",i=>{a||(console.warn("[Menu] Socket connection error - backend may be offline. Will retry automatically."),a=!0)}),s.on("disconnect",i=>{})}catch(a){console.warn("[Menu] Failed to create socket connection:",a),s=null}const w=a=>{const i=localStorage.getItem(z)||"DINE_IN";let p=null;if(i==="TAKEAWAY"?p=T||localStorage.getItem("terra_orderId_TAKEAWAY"):p=T||localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),String(a?._id||"")===String(p||"")&&a?.status&&a?.serviceType===i){if(localStorage.getItem("terra_orderStatus")===a.status&&O===a.status)return;if(i==="TAKEAWAY"&&a.sessionToken){const C=localStorage.getItem("terra_takeaway_sessionToken")||localStorage.getItem("terra_sessionToken");if(C&&a.sessionToken!==C)return}const f=new Date().toISOString();B(a.status),J(f),X(a),a.cartId&&k(a.cartId),localStorage.setItem("terra_orderStatus",a.status),localStorage.setItem("terra_orderStatusUpdatedAt",f),i==="TAKEAWAY"?(localStorage.setItem("terra_orderStatus_TAKEAWAY",a.status),localStorage.setItem("terra_orderStatusUpdatedAt_TAKEAWAY",f)):(localStorage.setItem("terra_orderStatus_DINE_IN",a.status),localStorage.setItem("terra_orderStatusUpdatedAt_DINE_IN",f))}},g=a=>{if(!a)return;const i=localStorage.getItem(z)||"DINE_IN";let p=null;i==="TAKEAWAY"?p=T||localStorage.getItem("terra_orderId_TAKEAWAY"):p=T||localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId");const I=a.orderId||a.order?._id;if(!I||String(I)!==String(p||""))return;const f=a.status||a.order?.status||"Confirmed",C=new Date().toISOString();if(B(f),J(C),localStorage.setItem("terra_orderStatus",f),localStorage.setItem("terra_orderStatusUpdatedAt",C),i==="TAKEAWAY"?(localStorage.setItem("terra_orderStatus_TAKEAWAY",f),localStorage.setItem("terra_orderStatusUpdatedAt_TAKEAWAY",C)):(localStorage.setItem("terra_orderStatus_DINE_IN",f),localStorage.setItem("terra_orderStatusUpdatedAt_DINE_IN",C)),a.order&&typeof a.order=="object"){X(a.order),a.order.cartId&&k(a.order.cartId);return}a.assignedStaff&&X(E=>{const $=E?{...E}:{_id:I};return $.status=f,$.assignedStaff=a.assignedStaff,$.acceptedBy||($.acceptedBy={employeeId:a.assignedStaff.id||null,employeeName:a.assignedStaff.name||null,employeeRole:a.assignedStaff.role||null,disability:{hasDisability:!!a.assignedStaff.disability,type:a.assignedStaff.disability||null}}),$})},N=a=>{const i=localStorage.getItem(z)||"DINE_IN";let p=null;i==="TAKEAWAY"?p=T||localStorage.getItem("terra_orderId_TAKEAWAY"):p=T||localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),a?.id===p&&(B(null),V(null),X(null),i==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.removeItem("terra_orderStatus_TAKEAWAY"),localStorage.removeItem("terra_orderStatusUpdatedAt_TAKEAWAY")):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN")))},b=a=>{const i=F||(()=>{try{const ie=localStorage.getItem("terra_selectedTable");return ie?JSON.parse(ie):null}catch{return null}})();if(!i)return;const p=a.id||a._id,I=i.id||i._id,f=p&&I&&String(p)===String(I),C=a.number&&i.number&&String(a.number)===String(i.number);if(!f&&!C)return;console.log("[Menu] Table status updated via socket:",a.status,"Previous status:",i.status);const E={...i,status:a.status,currentOrder:a.currentOrder||null,sessionToken:a.sessionToken||i.sessionToken};rt(E),localStorage.setItem("terra_selectedTable",JSON.stringify(E));const $=localStorage.getItem("terra_orderId")||localStorage.getItem("terra_orderId_DINE_IN"),H=localStorage.getItem("terra_orderStatus")||localStorage.getItem("terra_orderStatus_DINE_IN"),te=$&&(!H||!["Paid","Cancelled","Returned","Completed"].includes(H)),A=Ht.includes(H||"");a.status==="AVAILABLE"&&(!te&&!A?(console.log("[Menu] Table became AVAILABLE via socket - clearing waitlist state and order data (user has no active order)"),localStorage.removeItem("terra_waitToken"),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_cart"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_previousOrder"),localStorage.removeItem("terra_previousOrderDetail"),["DINE_IN","TAKEAWAY"].forEach(ie=>{localStorage.removeItem(`terra_cart_${ie}`),localStorage.removeItem(`terra_orderId_${ie}`),localStorage.removeItem(`terra_orderStatus_${ie}`),localStorage.removeItem(`terra_orderStatusUpdatedAt_${ie}`)}),V(null),B(null),X(null),console.log("[Menu] Cleared all order data for new customer")):console.log(A?"[Menu] Table became AVAILABLE but preserving final customer order status":"[Menu] Table became AVAILABLE but user has active order - preserving order data"))};return s&&(s.on("orderUpdated",w),s.on("ORDER_ACCEPTED",g),s.on("orderDeleted",N),s.on("table:status:updated",b)),()=>{d&&clearInterval(d),s&&(s.off("orderUpdated",w),s.off("ORDER_ACCEPTED",g),s.off("orderDeleted",N),s.off("table:status:updated",b),s.disconnect())}},[T,Tt,x]),l.useEffect(()=>{const e=localStorage.getItem(z)||"DINE_IN";if(e==="TAKEAWAY"?T||localStorage.getItem("terra_orderId_TAKEAWAY")||localStorage.getItem("terra_orderId"):T||localStorage.getItem("terra_orderId")){const n=e==="TAKEAWAY"&&localStorage.getItem("terra_orderStatus_TAKEAWAY")||localStorage.getItem("terra_orderStatus"),s=e==="TAKEAWAY"&&localStorage.getItem("terra_orderStatusUpdatedAt_TAKEAWAY")||localStorage.getItem("terra_orderStatusUpdatedAt");n&&(n!==O&&(console.log("[Menu] Syncing orderStatus from localStorage:",n),B(n)),s&&s!==pe&&J(s))}},[T,O,pe]),l.useEffect(()=>{const e=localStorage.getItem(z)||"DINE_IN";let r=null;if(e==="TAKEAWAY"?r=localStorage.getItem("terra_orderId_TAKEAWAY"):r=localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),r&&r!==T&&(console.log("[Menu] Restoring activeOrderId on mount:",r,"serviceType:",e),V(r)),r&&!O){const n=e==="TAKEAWAY"&&localStorage.getItem("terra_orderStatus_TAKEAWAY")||localStorage.getItem("terra_orderStatus"),s=e==="TAKEAWAY"&&localStorage.getItem("terra_orderStatusUpdatedAt_TAKEAWAY")||localStorage.getItem("terra_orderStatusUpdatedAt");n&&(B(n),s&&J(s))}},[]),l.useEffect(()=>{if(!T){X(null);return}let e=!1;return(async()=>{try{const n=await fetch(`${K}/api/orders/${T}`,{signal:AbortSignal.timeout(5e3)});if(!n.ok)return;const s=await n.json();if(e||!s)return;const d=localStorage.getItem(z)||"DINE_IN";if(s.serviceType&&s.serviceType!==d)return;X(s)}catch{}})(),()=>{e=!0}},[T,x]),l.useEffect(()=>{if(_.get("action")==="confirm"&&!Ae){if(Te||Object.keys(ve).length===0){console.error("[Menu] Auto-confirm aborted: Menu data missing or error",{menuCatalogSize:Object.keys(ve).length,menuError:Te});const r=new URLSearchParams(_);r.delete("action"),j(r),alert(Te?"Cannot place order automatically: "+Te:"Cannot place order automatically: Menu prices not loaded. Please try again manually.");return}const e=new URLSearchParams(_);e.delete("action"),j(e),M(!0),Lt()}},[_,Ae,ve,Te]),t.jsxs("div",{className:`menu-root ${le?"accessibility-mode":""}`,children:[t.jsx("div",{className:"background-image",style:{backgroundImage:`url(${$r})`}}),t.jsx("div",{className:"overlay"}),t.jsx(Ur,{accessibilityMode:le,onClickCart:()=>o("/cart"),cartCount:Et}),t.jsx("div",{className:"content-wrapper",children:t.jsx("div",{className:"main-container",children:t.jsxs("div",{className:"panels-container",children:[t.jsxs("div",{className:"left-panel",children:[t.jsxs("div",{className:"order-header-section",children:[t.jsxs("div",{className:"order-header-info",children:[t.jsx("div",{className:"order-header-badge",children:x==="DINE_IN"?t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"order-header-icon",children:"📍"}),t.jsx("span",{children:F?.number?`${h("dineIn","Dine-In")} - ${h("table","Table")} ${F.number}`:h("dineIn","Dine-In")})]}):t.jsx("span",{children:h("takeaway","Takeaway")})}),x==="DINE_IN"&&t.jsxs("div",{className:"guest-count-badge",children:[t.jsx("span",{className:"guest-icon",children:"👥"}),t.jsx("span",{children:F?.seats||F?.capacity||2})]})]}),x==="TAKEAWAY"&&Ve&&t.jsxs("span",{className:"token-badge",children:[h("token","Token"),":"," ",t.jsx("strong",{children:Ve})]})]}),t.jsx("button",{type:"button",onClick:vr,className:`voice-button ${_e?"recording":""}`,"aria-pressed":_e,"aria-label":br,disabled:Ae,children:_e?t.jsx(Kr,{}):t.jsx(Yr,{})}),t.jsx("p",{className:"instruction-text",children:Ae?h("loadingMenu","Loading menu...")||"Loading menu...":nr?Ir:_e?_r:Sr}),x==="DINE_IN"&&t.jsxs("div",{className:"action-buttons-row",children:[t.jsx("button",{onClick:async()=>{try{const e=localStorage.getItem("terra_selectedTable");if(!e){alert("Please select a table first");return}const r=JSON.parse(e),n=r.id||r._id,s=localStorage.getItem("terra_orderId")||null,d="https://api.terracart.in".replace(/\/$/,"");if((await fetch(`${d}/api/customer-requests`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tableId:n,requestType:"assistance",customerNotes:"Call Waiter",...s&&{orderId:s}})})).ok)alert("✅ Waiter called! Someone will be with you shortly.");else throw new Error("Failed to send request")}catch(e){console.error("Error calling waiter:",e),alert("❌ Failed to call waiter. Please try again.")}},className:"action-button call-waiter-button",children:h("callWaiter","Call Waiter")}),T?t.jsxs("button",{onClick:async()=>{try{const e=localStorage.getItem("terra_selectedTable");if(!e){alert("Please select a table first");return}const r=JSON.parse(e),n=r.id||r._id,s=localStorage.getItem("terra_orderId")||null,d="https://api.terracart.in".replace(/\/$/,"");if((await fetch(`${d}/api/customer-requests`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tableId:n,requestType:"bill",customerNotes:"Request Bill",...s&&{orderId:s}})})).ok)alert("✅ Bill requested! Someone will bring it shortly.");else throw new Error("Failed to send request")}catch(e){console.error("Error requesting bill:",e),alert("❌ Failed to request bill. Please try again.")}},className:"action-button request-bill-button",children:["🧾 ",h("requestBill","Request Bill")]}):t.jsxs("button",{onClick:async()=>{try{const e=localStorage.getItem("terra_selectedTable");if(!e){alert("Please select a table first");return}const r=JSON.parse(e),n=r.id||r._id,s=localStorage.getItem("terra_orderId")||null,d="https://api.terracart.in".replace(/\/$/,"");if((await fetch(`${d}/api/customer-requests`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tableId:n,requestType:"water",customerNotes:"Request Water",...s&&{orderId:s}})})).ok)alert("✅ Water requested! Someone will bring it shortly.");else throw new Error("Failed to send request")}catch(e){console.error("Error requesting water:",e),alert("❌ Failed to request water. Please try again.")}},className:"action-button request-water-button",children:["💧 ",h("requestWater","Request Water")]})]}),St&&t.jsxs("p",{className:"ai-ordered-text",children:[fr," ",t.jsx("span",{className:"order-text-italic",children:St})]}),O&&t.jsxs("div",{className:"order-status-card",children:[t.jsx("h4",{className:"order-summary-title",children:"Order Status"}),x==="TAKEAWAY"&&Ve&&t.jsxs("div",{className:"mb-3 p-2 bg-blue-50 border border-blue-200 rounded-lg",children:[t.jsxs("div",{className:"text-sm font-semibold text-blue-700",children:["Your Token:"," ",t.jsx("span",{className:"text-lg font-bold",children:Ve})]}),t.jsx("div",{className:"text-xs text-blue-600 mt-1",children:"Please keep this token for reference"})]}),t.jsx("div",{className:"order-status-section",children:t.jsx(Sa,{status:O,updatedAt:pe,reason:ke?.cancellationReason||Y?.cancellationReason,serviceType:x,tableLabel:x==="DINE_IN"&&F?.number?`Dine-In | Table ${F.number}`:null})}),je?.name&&t.jsxs("div",{className:"mt-3 p-3 bg-green-50 border border-green-200 rounded-lg text-center",children:[t.jsxs("p",{className:"text-green-800 font-medium",children:["Your order is being handled by ",je.name]}),je.role&&t.jsxs("p",{className:"text-sm text-gray-700 mt-1",children:["Role: ",je.role]}),je.disability&&t.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:["Disability Support: ",je.disability]})]}),t.jsxs("div",{className:"button-group status-actions",children:[(()=>{const e=(O||"").toLowerCase();return["paid","completed"].includes(e)&&va.includes(O)?t.jsx("button",{className:"reset-button return-button",onClick:wr,disabled:bt,children:bt?"Processing...":"Return Order"}):ya.includes(O)?t.jsx("button",{className:"reset-button cancel-button",onClick:kr,disabled:ht,children:ht?"Cancelling...":"Cancel Order"}):O==="Returned"||O==="Cancelled"?t.jsx("button",{className:"billing-button billing-button-disabled",disabled:!0,children:O==="Returned"?"Order Returned":"Order Cancelled"}):null})(),["Pending","Placed","Confirmed","Preparing","Ready","Served","Finalized","Completed","Paid"].includes(O)?t.jsx("button",{className:"billing-button",onClick:mt,disabled:Dt,children:Dt?"Opening...":"View Invoice"}):null,t.jsx("button",{className:"confirm-button",onClick:Ar,disabled:Ge||O&&!ba.includes(O),children:Ge?"Please wait...":"Order More"}),(()=>{const e=(O||"").toLowerCase();if(["Finalized","Completed"].includes(O))return t.jsx("button",{className:"billing-button",onClick:Er,disabled:yt,children:yt?"Confirming...":"Confirm Payment"});if(O!=="Returned"&&O!=="Cancelled"&&!["paid","completed"].includes(e))return t.jsx("button",{className:"complete-payment-button",onClick:()=>{o("/billing")},children:"Payment"});if(["paid","completed"].includes(e)){const r=T||localStorage.getItem("terra_orderId")||localStorage.getItem("terra_lastPaidOrderId");return tr(r)?null:t.jsx("button",{className:"feedback-button",onClick:()=>{o("/feedback",{state:{orderId:r}})},children:"Share Feedback"})}return null})()]})]}),Y&&t.jsxs("div",{className:"order-status-card previous-order-detail-card",style:{padding:"12px",fontSize:"0.9rem"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"8px"},children:[t.jsx("h4",{className:"order-summary-title",style:{margin:0,fontSize:"1rem"},children:"Last Order"}),Y.status&&t.jsx("span",{className:"meta-chip status-chip",style:{fontSize:"0.75rem",padding:"4px 8px"},children:Y.status})]}),t.jsxs("div",{style:{display:"flex",gap:"8px",marginBottom:"8px",flexWrap:"wrap",fontSize:"0.8rem"},children:[Yt&&t.jsx("span",{className:"meta-chip",style:{fontSize:"0.75rem",padding:"2px 6px"},children:Yt}),dt&&t.jsx("span",{className:"meta-chip",style:{fontSize:"0.75rem",padding:"2px 6px"},children:dt?dt.toLocaleDateString():"N/A"})]}),Be?.name&&t.jsxs("div",{style:{marginBottom:"8px",padding:"8px",borderRadius:"8px",background:"#ecfdf5",border:"1px solid #bbf7d0",fontSize:"0.8rem"},children:[t.jsx("strong",{children:"Handled by:"})," ",Be.name,Be.role&&t.jsxs("span",{children:[" (",Be.role,")"]})]}),t.jsx("div",{style:{marginBottom:"8px",fontSize:"0.85rem"},children:t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontWeight:"600"},children:[t.jsxs("span",{children:["Total: ₹",We(Kt?.totalAmount||0)]}),t.jsxs("span",{children:[Kt?.totalItems||0," items"]})]})}),t.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[t.jsx("button",{className:"invoice-action-btn download w-full sm:w-auto",onClick:jr,style:{padding:"6px 12px",fontSize:"0.85rem"},children:"View Invoice"}),Y._id&&!tr(Y._id)&&t.jsx("button",{className:"feedback-button w-full sm:w-auto",onClick:()=>{const e=Y._id;o("/feedback",{state:{orderId:e}})},style:{backgroundColor:"#10b981",color:"#ffffff",border:"1px solid #059669",fontWeight:"600",padding:"6px 12px",fontSize:"0.85rem"},children:"Feedback"})]})]})]}),t.jsxs("div",{className:"right-panel",children:[t.jsx("h3",{className:"manual-entry-title",children:pr}),t.jsx("input",{type:"text",placeholder:hr,value:Ye,onChange:e=>ir(e.target.value),className:"search-input"}),Te&&!Ae&&t.jsx("div",{className:"menu-warning",children:Te}),Ae?t.jsx("div",{className:"menu-loading-message",children:"Loading menu, please wait..."}):Ye.trim()?xt.length>0?t.jsx("div",{className:"search-results",children:xt.map(e=>t.jsx(sr,{item:e,onAdd:$t,onRemove:Ut,count:G[e.name]||0,lang:R},e._id||e.name))}):t.jsx("div",{className:"search-no-results",children:"No matching items found. Try another keyword."}):t.jsx("div",{className:"category-container",children:ye.length===0?t.jsx("div",{className:"search-no-results",children:"Menu is not configured yet. Please contact the administrator."}):t.jsx(t.Fragment,{children:(Array.isArray(ye)?ye:[]).map((e,r)=>t.jsx(ja,{defaultOpen:r===0,category:e?.name||"Unnamed Category",items:Array.isArray(e?.items)?e.items:[],cart:G,onAdd:$t,onRemove:Ut,lang:R},e?._id||e?.name||Math.random()))})})]})]})})}),dr&&t.jsx("div",{className:"invoice-modal-overlay",onClick:Ft,children:t.jsxs("div",{className:"invoice-modal",role:"dialog","aria-modal":"true",onClick:e=>e.stopPropagation(),children:[t.jsxs("div",{className:"invoice-modal-header",children:[t.jsxs("div",{children:[t.jsx("h3",{children:"Invoice"}),y&&t.jsxs("div",{className:"invoice-meta",children:[t.jsx("span",{children:`Order #${y._id||"—"}`}),Me&&t.jsx("span",{children:Me.toLocaleString()})]})]}),t.jsxs("div",{className:"invoice-modal-actions",children:[t.jsx("button",{onClick:xr,disabled:!y||Fe,className:"invoice-action-btn download",children:Fe?"Preparing…":"Download"}),t.jsx("button",{onClick:Ft,className:"invoice-close-btn","aria-label":"Close invoice modal",children:"✕"})]})]}),t.jsxs("div",{ref:Oe,className:"invoice-preview",children:[t.jsxs("div",{className:"invoice-top",children:[t.jsxs("div",{children:[t.jsx("div",{className:"brand-name",children:y?.cafe?.cafeName||y?.cafe?.name||"Terra Cart"}),t.jsx("div",{className:"brand-address",children:y?.cafe?.address||y?.franchise?.address||"123 Main Street, City"}),(y?.franchise?.fssaiNumber||y?.franchise?.fssai||y?.cafe?.fssaiNumber||y?.cafe?.fssai)&&t.jsxs("div",{className:"brand-address",children:["FSSAI No:"," ",y.franchise?.fssaiNumber||y.franchise?.fssai||y.cafe?.fssaiNumber||y.cafe?.fssai]}),(y?.franchise?.gstNumber||y?.cafe?.gstNumber)&&t.jsxs("div",{className:"brand-address",children:["FSSAI No:"," ",y.franchise?.gstNumber||y.cafe?.gstNumber]})]}),t.jsxs("div",{className:"invoice-meta-block",children:[t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Invoice No:"}),t.jsx("span",{children:Pe||"—"})]}),y?.serviceType==="TAKEAWAY"&&y?.takeawayToken&&t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Token:"}),t.jsx("span",{className:"font-bold text-blue-600",children:y.takeawayToken})]}),Me&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Date:"}),t.jsx("span",{children:Me.toLocaleDateString()})]}),t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Time:"}),t.jsx("span",{children:Me.toLocaleTimeString()})]})]})]})]}),t.jsxs("div",{className:"invoice-billed",children:[t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Service:"}),t.jsx("span",{children:mr})]}),t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Table:"}),t.jsxs("span",{children:[y?.serviceType==="TAKEAWAY"?"Takeaway Counter":gr||"—",Rt?` · ${Rt}`:""]})]}),y?.serviceType==="TAKEAWAY"&&(y.customerName||y.customerMobile)&&t.jsxs(t.Fragment,{children:[y.customerName&&t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Customer Name:"}),t.jsx("span",{children:y.customerName})]}),y.customerMobile&&t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Mobile Number:"}),t.jsx("span",{children:y.customerMobile})]})]}),y?.specialInstructions&&t.jsxs("div",{className:"meta-line",style:{marginTop:"8px",borderTop:"1px dashed #e5e7eb",paddingTop:"4px"},children:[t.jsx("span",{style:{color:"#d97706",fontWeight:"bold"},children:"Note:"}),t.jsx("span",{style:{fontStyle:"italic"},children:y.specialInstructions})]})]}),t.jsxs("table",{className:"invoice-table",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"Item"}),t.jsx("th",{children:"Qty"}),t.jsx("th",{children:"Price (₹)"}),t.jsx("th",{className:"align-right",children:"Amount (₹)"})]})}),t.jsx("tbody",{children:ze.length>0?ze.map(e=>t.jsxs("tr",{children:[t.jsx("td",{children:t.jsxs("div",{className:"flex flex-col gap-0.5",children:[t.jsx("span",{children:e.name}),e.returned&&t.jsxs("span",{className:"invoice-returned-note",children:["Returned ",e.returnedQuantity]})]})}),t.jsx("td",{children:e.quantity>0?e.quantity:"—"}),t.jsxs("td",{children:["₹",We(e.unitPrice)]}),t.jsx("td",{className:"align-right",children:e.quantity>0?`₹${We(e.amount)}`:"Returned"})]},e.name)):t.jsx("tr",{children:t.jsx("td",{colSpan:4,className:"empty-row",children:"No items found"})})})]}),t.jsxs("div",{className:"invoice-totals",children:[t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Total Items"}),t.jsx("span",{children:ct.totalItems})]}),t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Subtotal"}),t.jsxs("span",{children:["₹",We(ct.subtotal)]})]}),t.jsxs("div",{className:"meta-line total",children:[t.jsx("span",{children:"Total"}),t.jsxs("span",{children:["₹",We(ct.totalAmount)]})]})]}),t.jsx("div",{className:"invoice-footer",children:"Thank you for dining with Terra Cart. We hope to see you again!"})]})]})}),ur&&t.jsx("div",{className:"invoice-modal-overlay",onClick:()=>Ne(!1),children:t.jsxs("div",{className:"invoice-modal reason-modal",style:{maxWidth:"24rem",maxHeight:"auto",height:"auto"},onClick:e=>e.stopPropagation(),children:[t.jsxs("div",{className:"invoice-modal-header",children:[t.jsx("div",{children:t.jsx("h3",{children:Ee==="Cancel"?"Cancel Order":"Return Order"})}),t.jsx("button",{onClick:()=>Ne(!1),className:"invoice-close-btn",children:"✕"})]}),t.jsxs("div",{style:{paddingTop:"0.25rem"},children:[t.jsx("p",{style:{marginTop:0,marginBottom:"0.5rem",fontSize:"0.9rem",color:"#666"},children:"Please provide a reason:"}),t.jsx("textarea",{style:{width:"100%",padding:"0.75rem",border:"1px solid #ddd",borderRadius:"0.5rem",minHeight:"100px",fontSize:"0.9rem",marginBottom:"1rem",fontFamily:"inherit",resize:"vertical",boxSizing:"border-box"},placeholder:"e.g. Changed my mind, Taking too long...",value:xe,onChange:e=>lt(e.target.value)}),t.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:"0.5rem"},children:[t.jsx("button",{className:"reset-button",style:{width:"auto",flex:"1"},onClick:()=>Ne(!1),disabled:it,children:"Close"}),t.jsx("button",{className:"confirm-button",style:{width:"auto",flex:"1"},onClick:Nr,disabled:it,children:it?"Processing...":"Confirm"})]})]})]})}),Object.keys(G).length>0&&!lr&&t.jsx("div",{className:"menu-cart-footer",children:t.jsxs("div",{className:"menu-cart-footer-inner",children:[t.jsxs("div",{style:{display:"flex",flexDirection:"column"},children:[t.jsxs("span",{style:{fontWeight:"bold",fontSize:"1.1rem",color:"#333"},children:[Et," Items"]}),t.jsxs("span",{style:{color:"#666",fontSize:"0.9rem"},children:["Total: ₹",cr.toFixed(2)]})]}),t.jsx("button",{onClick:()=>o("/cart"),style:{backgroundColor:"#ff6b35",color:"white",padding:"12px 24px",borderRadius:"50px",fontWeight:"bold",fontSize:"1rem",border:"none",cursor:"pointer",boxShadow:"0 4px 6px rgba(255, 107, 53, 0.3)"},children:"View Cart →"})]})}),t.jsx(Fr,{open:q,steps:Q,title:"Processing your order"})]})}const Ja=Object.freeze(Object.defineProperty({__proto__:null,default:Oa},Symbol.toStringTag,{value:"Module"}));export{Ja as M,Sa as O};
