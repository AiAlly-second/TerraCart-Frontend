import{r as c,j as t,u as zr,c as Br,f as Vr,a as qr,b as Jr}from"./vendor-react-BMxAjtiD.js";import{r as Hr,H as Qr}from"./page-Billing.jsx-CXD1st4q.js";import{a as Gr}from"./vendor-CB8mghnX.js";import{P as Xr,b as Zr,p as Zt,m as ea}from"./page-CartPage.jsx-DM0lPMsA.js";/* empty css                          */import{l as ta}from"./vendor-socket-DJ_CsPWr.js";import{h as ra,E as aa}from"./vendor-pdf-KWoZMcRy.js";import{m as oa}from"./vendor-motion-iT52ZrD2.js";const sa="http://localhost:5050".replace(/\/$/,""),vt="translation_service_unavailable",At="translation_service_check_timestamp",na=6e4,la=()=>{try{const o=sessionStorage.getItem(vt),g=sessionStorage.getItem(At);if(o==="true"&&g){const _=Date.now(),C=parseInt(g,10);if(_-C<na)return!0}}catch{}return!1},er=()=>{try{sessionStorage.setItem(vt,"true"),sessionStorage.setItem(At,Date.now().toString())}catch{}},ia=()=>{try{sessionStorage.removeItem(vt),sessionStorage.removeItem(At)}catch{}},ca=async(o,g)=>{if(la())return o;try{const _=await Gr.post(`${sa}/api/translate`,{text:o,targetLang:g},{validateStatus:()=>!0,timeout:1500,transformRequest:[C=>C],transformResponse:[C=>C]});if(_.status===200&&_.data?.translatedText){ia();const C=_.data.translatedText;return C.match(/as\s+"(.*?)"/)?.[1]||C||o}else return er(),o}catch(_){return(_.code==="ECONNREFUSED"||_.code==="ERR_NETWORK"||_.code==="ECONNABORTED"||_.message==="Network Error"||_.message?.includes("ERR_CONNECTION_REFUSED")||_.message?.includes("timeout"))&&er(),o}},cr=o=>{const[g,_]=c.useState(o),[C,K]=c.useState(!1);return c.useEffect(()=>{const M=localStorage.getItem("language")||"en";M==="en"?(_(o),K(!1)):(K(!0),ca(o,M).then(V=>{_(V),K(!1)}).catch(V=>{_(o),K(!1)}))},[o]),[g,C]},da={manualEntry:"Menu",smartServe:"Smart Serve",aiOrdered:"AI Ordered:",orderSummary:"Order Summary:",confirm:"Confirm",speakOrder:"Speak Order",processingVoice:"Processing your voice...",cartEmpty:"Cart is empty",resetOrder:"Reset Order",tapToStop:"Tap to Stop",tapToOrder:"Tap to Order",searchPlaceholder:"Search item...",resetOrderBtn:"Reset Order",recordVoiceAria:"Record voice order",processSteps:{checkingOrder:"Checking your order",confirmingItems:"Confirming items & price",placingOrder:"Placing your order",sendingToKitchen:"Sending to kitchen",preparingDetails:"Preparing order details"},dineIn:"Dine-In",table:"Table",takeaway:"Takeaway",callWaiter:"Call Waiter",requestWater:"Request Water",vegOnly:"Veg Only",popular:"Popular",spicy:"Spicy",token:"Token"},ua={manualEntry:"मेनू",smartServe:"स्मार्ट सर्व",aiOrdered:"एआई द्वारा ऑर्डर:",orderSummary:"ऑर्डर सारांश:",confirm:"पुष्टि करें",speakOrder:"ऑर्डर सुनाएं",processingVoice:"आपकी आवाज़ प्रोसेस हो रही है...",cartEmpty:"कार्ट खाली है",resetOrder:"ऑर्डर रीसेट करें",tapToStop:"रोकने के लिए टैप करें",tapToOrder:"ऑर्डर करने के लिए टैप करें",searchPlaceholder:"आइटम खोजें...",resetOrderBtn:"ऑर्डर रीसेट करें",recordVoiceAria:"आवाज़ से ऑर्डर रिकॉर्ड करें",processSteps:{checkingOrder:"आपका ऑर्डर चेक कर रहे हैं",confirmingItems:"आइटम और कीमत की पुष्टि",placingOrder:"ऑर्डर प्लेस कर रहे हैं",sendingToKitchen:"किचन को भेज रहे हैं",preparingDetails:"ऑर्डर विवरण तैयार"},dineIn:"डाइन-इन",table:"टेबल",takeaway:"टेकअवे",callWaiter:"वेटर को बुलाएं",requestWater:"पानी मांगें",vegOnly:"केवल शाकाहारी",popular:"लोकप्रिय",spicy:"मसालेदार",token:"टोकन"},ma={manualEntry:"मेनू",smartServe:"स्मार्ट सर्व",aiOrdered:"एआय ने ऑर्डर केले:",orderSummary:"ऑर्डर सारांश:",confirm:"निश्चित करा",speakOrder:"ऑर्डर बोला",processingVoice:"तुमचा आवाज प्रोसेस होत आहे...",cartEmpty:"कार्ट रिकामे आहे",resetOrder:"ऑर्डर रीसेट करा",tapToStop:"थांबवण्यासाठी टॅप करा",tapToOrder:"ऑर्डर करण्यासाठी टॅप करा",searchPlaceholder:"वस्तू शोधा...",resetOrderBtn:"ऑर्डर रीसेट करा",recordVoiceAria:"आवाज रेकॉर्ड करा",processSteps:{checkingOrder:"तुमची ऑर्डर तपासत आहे",confirmingItems:"वस्तू आणि किंमत निश्चित करत आहे",placingOrder:"ऑर्डर देत आहे",sendingToKitchen:"किचनला पाठवत आहे",preparingDetails:"ऑर्डर तपशील तयार"},dineIn:"डाइन-इन",table:"टेबल",takeaway:"टेकअवे",callWaiter:"वेटरला बोलवा",requestWater:"पाणी मागवा",vegOnly:"फक्त शाकाहारी",popular:"लोकप्रिय",spicy:"तिखट",token:"टोकन"},ga={manualEntry:"મેનુ",smartServe:"સ્માર્ટ સર્વ",aiOrdered:"એઆઈ દ્વારા ઓર્ડર:",orderSummary:"ઓર્ડર સારાંશ:",confirm:"પુષ્ટિ કરો",speakOrder:"ઓર્ડર બોલો",processingVoice:"તમારો અવાજ પ્રોસેસ થઈ રહ્યો છે...",cartEmpty:"કાર્ટ ખાલી છે",resetOrder:"ઓર્ડર રીસેટ કરો",tapToStop:"રોકવા માટે ટૅપ કરો",tapToOrder:"ઓર્ડર કરવા માટે ટૅપ કરો",searchPlaceholder:"વસ્તુ શોધો...",resetOrderBtn:"ઓર્ડર રીસેટ કરો",recordVoiceAria:"અવાજ રેકોર્ડ કરો",processSteps:{checkingOrder:"તમારો ઓર્ડર તપાસી રહ્યા છીએ",confirmingItems:"વસ્તુઓ અને કિંમતની પુષ્ટિ",placingOrder:"ઓર્ડર આપી રહ્યા છીએ",sendingToKitchen:"કિચનમાં મોકલી રહ્યા છીએ",preparingDetails:"ઓર્ડર વિગતો તૈયાર"},dineIn:"ડાઇન-ઇન",table:"ટેબલ",takeaway:"ટેકઅવે",callWaiter:"વેટરને બોલાવો",requestWater:"પાણી મંગાવો",vegOnly:"માત્ર શાકાहारी",popular:"લોકપ્રિય",spicy:"મસાલેદાર",token:"ટોકન"},tr={en:da,hi:ua,mr:ma,gu:ga},fa={categories:{all_time_hit:"All Time Hit",mini_thali:"Mini Thali",fries:"Fries",starters:"Starters",veg_starters:"Veg Starters",tandoor_specials:"Tandoor Specials",maharashtrian:"Maharashtrian",punjabi:"Punjabi",paneer_specials:"Paneer Specials",rice:"Rice",roti:"Roti",dal:"Dal",chinese:"Chinese",thali:"Thali",desserts:"Desserts",beverages:"Beverages",street_snacks:"Street Snacks",north_indian_curries:"North Indian Curries",breads_rice:"Breads & Rice",regional_specials:"Regional Specials",desserts_beverages:"Desserts & Beverages",main_course:"Main Course"},items:{veg_sandwich:"Veg Sandwich",dosa:"Dosa",peanut_curry:"Peanut Curry",misal:"Misal",paneer_junglee_sandwich:"Paneer Junglee Sandwich",mumbai_sandwich:"Mumbai Sandwich",terra_wada_pav:"Terra Wada Pav",gluten_free_dosai:"Gluten Free Dosai",kothimbir_wadi:"Kothimbir Wadi",bombay_pav_bhaji:"Bombay Pav Bhaji",pizza_bomb:"Pizza Bomb",mini_batata_wada:"Mini Batata Wada",appe_chutney:"Appe & Chutney",namaste_misal_pav_dahi:"Namaste Misal Pav & Dahi",chola_kulcha:"Chola Kulcha",rajma_chawal:"Rajma Chawal",dal_makhni_jeera_rice:"Dal Makhni Jeera Rice",veg_korma_paratha:"Veg Korma & Malbori Paratha",dal_khichadi_dahi:"Dal Fry Rice / Dal Khichadi Dahi",schezwan_rice_manchurian:"Schezwan Rice & Manchurian",mumbai_vada_pav:"Mumbai Vada Pav",punjabi_samosa_chaat:"Punjabi Samosa Chaat",paneer_kathi_roll:"Paneer Kathi Roll",paneer_butter_masala:"Paneer Butter Masala",amritsari_chole:"Amritsari Chole",dal_tadka:"Dal Tadka",garlic_butter_naan:"Garlic Butter Naan",tandoori_roti:"Tandoori Roti",veg_dum_biryani:"Veg Dum Biryani",hyderabadi_chicken_65:"Hyderabadi Chicken 65",goan_fish_curry:"Goan Fish Curry",kerala_parotta_combo:"Kerala Parotta Combo",classic_gulab_jamun:"Classic Gulab Jamun",kulfi_falooda:"Kulfi Falooda",masala_chaas:"Masala Chaas"}},pa={categories:{all_time_hit:"हमेशा पसंदीदा",mini_thali:"मिनी थाली",fries:"फ्राइज़",starters:"स्टार्टर्स",veg_starters:"शाकाहारी स्टार्टर",tandoor_specials:"तंदूरी स्पेशल",maharashtrian:"महाराष्ट्रीयन",punjabi:"पंजाबी",paneer_specials:"पनीर स्पेशल",rice:"चावल",roti:"रोटी",dal:"दाल",chinese:"चाइनीज़",thali:"थाली",desserts:"मिठाई",beverages:"पेय",street_snacks:"स्ट्रीट स्नैक्स",north_indian_curries:"उत्तर भारतीय करी",breads_rice:"रोटियाँ और चावल",regional_specials:"क्षेत्रीय विशेष",desserts_beverages:"डेसर्ट और पेय",main_course:"मुख्य भोजन"},items:{veg_sandwich:"वेज सैंडविच",dosa:"डोसा",peanut_curry:"पीनट करी",misal:"मिसल",paneer_junglee_sandwich:"पनीर जंगली सैंडविच",mumbai_sandwich:"मुंबई सैंडविच",terra_wada_pav:"टेरा वडा पाव",gluten_free_dosai:"ग्लूटेन फ्री डोसा",kothimbir_wadi:"कोथिंबीर वड़ी",bombay_pav_bhaji:"बॉम्बे पाव भाजी",pizza_bomb:"पिज़्ज़ा बॉम्ब",mini_batata_wada:"मिनी बटाटा वडा",appe_chutney:"अप्पे और चटनी",namaste_misal_pav_dahi:"नमस्ते मिसल पाव और दही",chola_kulcha:"छोला कुलचा",rajma_chawal:"राजमा चावल",dal_makhni_jeera_rice:"दाल मखनी जीरा चावल",veg_korma_paratha:"वेज कोरमा और पराठा",dal_khichadi_dahi:"दाल खिचड़ी दही",schezwan_rice_manchurian:"सिचुआन चावल और मंचूरियन",mumbai_vada_pav:"मुंबई वडा पाव",punjabi_samosa_chaat:"पंजाबी समोसा चाट",paneer_kathi_roll:"पनीर काठी रोल",paneer_butter_masala:"पनीर बटर मसाला",amritsari_chole:"अमृतसरी छोले",dal_tadka:"दाल तड़का",garlic_butter_naan:"गार्लिक बटर नान",tandoori_roti:"तंदूरी रोटी",veg_dum_biryani:"वेज दम बिरयानी",hyderabadi_chicken_65:"हैद्राबादी चिकन 65",goan_fish_curry:"गोअन फिश करी",kerala_parotta_combo:"केरल परोटा कॉम्बो",classic_gulab_jamun:"क्लासिक गुलाब जामुन",kulfi_falooda:"कुल्फी फालूदा",masala_chaas:"मसाला छाछ"}},Ia={categories:{all_time_hit:"सर्वकालीन हिट",mini_thali:"मिनी थाळी",fries:"फ्राईज",starters:"स्टार्टर्स",veg_starters:"व्हेज स्टार्टर",tandoor_specials:"तंदूर स्पेशल",maharashtrian:"महाराष्ट्रीयन",punjabi:"पंजाबी",paneer_specials:"पनीर स्पेशल",rice:"भात",roti:"पोळी",dal:"डाळ",chinese:"चायनीज",thali:"थाळी",desserts:"गोड पदार्थ",beverages:"पेय",street_snacks:"स्ट्रीट स्नॅक्स",north_indian_curries:"उत्तर भारतीय करी",breads_rice:"पोळी आणि भात",regional_specials:"प्रादेशिक स्पेशल",desserts_beverages:"डेझर्ट आणि पेय",main_course:"मुख्य जेवण"},items:{veg_sandwich:"व्हेज सँडविच",dosa:"डोसा",peanut_curry:"शेंगदाणा आमटी",misal:"मिसळ",paneer_junglee_sandwich:"पनीर जंगलि सँडविच",mumbai_sandwich:"मुंबई सँडविच",terra_wada_pav:"टेरा वडा पाव",gluten_free_dosai:"ग्लूटेन फ्री डोसा",kothimbir_wadi:"कोथिंबीर वडी",bombay_pav_bhaji:"बॉम्बे पाव भाजी",pizza_bomb:"पिझ्झा बॉम्ब",mini_batata_wada:"मिनी बटाटा वडा",appe_chutney:"अप्पे आणि चटणी",namaste_misal_pav_dahi:"नमस्ते मिसळ पाव आणि दही",chola_kulcha:"छोला कुलचा",rajma_chawal:"राजमा भात",dal_makhni_jeera_rice:"डाळ मखनी जिरा भात",veg_korma_paratha:"व्हेज कोरमा आणि पराठा",dal_khichadi_dahi:"डाळ खिचडी दही",schezwan_rice_manchurian:"सिचुआन भात आणि मंचुरियन",mumbai_vada_pav:"मुंबई वडा पाव",punjabi_samosa_chaat:"पंजाबी समोसा चाट",paneer_kathi_roll:"पनीर काठी रोल",paneer_butter_masala:"पनीर बटर मसाला",amritsari_chole:"अमृतसरी छोले",dal_tadka:"दाल तडका",garlic_butter_naan:"गार्लिक बटर नान",tandoori_roti:"तंदूरी रोटी",veg_dum_biryani:"व्हेज दम बिर्याणी",hyderabadi_chicken_65:"हैद्राबादी चिकन 65",goan_fish_curry:"गोअन फिश करी",kerala_parotta_combo:"केरळ परोटा कॉम्बो",classic_gulab_jamun:"क्लासिक गुलाब जामुन",kulfi_falooda:"कुल्फी फालूदा",masala_chaas:"मसाला ताक"}},_a={categories:{all_time_hit:"Succès intemporel",mini_thali:"Mini Thali",fries:"Frites",starters:"Entrées",veg_starters:"Entrées végétariennes",tandoor_specials:"Spécialités Tandoor",maharashtrian:"Maharashtrien",punjabi:"Punjabi",paneer_specials:"Spécial Paneer",rice:"Riz",roti:"Pain",dal:"Lentilles",chinese:"Chinois",thali:"Thali",desserts:"Desserts",beverages:"Boissons"},items:{veg_sandwich:"Sandwich Végétarien",paneer_junglee_sandwich:"Sandwich Paneer Junglee",mumbai_sandwich:"Sandwich Mumbai",terra_wada_pav:"Terra Wada Pav",gluten_free_dosai:"Dosai sans gluten",kothimbir_wadi:"Kothimbir Wadi",bombay_pav_bhaji:"Pav Bhaji de Bombay",pizza_bomb:"Pizza Bomb",mini_batata_wada:"Mini Batata Wada",appe_chutney:"Appe & Chutney",namaste_misal_pav_dahi:"Namaste Misal Pav & Yaourt",chola_kulcha:"Chola Kulcha",rajma_chawal:"Rajma Chawal",dal_makhni_jeera_rice:"Dal Makhni Riz au Cumin",veg_korma_paratha:"Korma Végétarien & Paratha",dal_khichadi_dahi:"Dal Khichadi & Yaourt",schezwan_rice_manchurian:"Riz Schezwan & Manchurian"}},Sa={categories:{all_time_hit:"ઓલ ટાઇમ હિટ",mini_thali:"મિની થાળી",fries:"ફ્રાઈસ",starters:"સ્ટાર્ટર્સ",veg_starters:"વેજ સ્ટાર્ટર્સ",tandoor_specials:"તંદૂર સ્પેશિયલ",maharashtrian:"મહારાષ્ટ્રીયન",punjabi:"પંજાબી",paneer_specials:"પનીર સ્પેશિયલ",rice:"ભાત",roti:"રોટલી",dal:"દાળ",chinese:"ચાઈનીઝ",thali:"થાળી",desserts:"મીઠાઈ",beverages:"પીણાં",street_snacks:"સ્ટ્રીટ સ્નેક્સ",north_indian_curries:"ઉત્તર ભારતીય કરી",breads_rice:"રોટલી અને ભાત",regional_specials:"પ્રાદેશિક સ્પેશિયલ",desserts_beverages:"ડેઝર્ટ અને પીણાં",main_course:"મુખ્ય ભોજન"},items:{veg_sandwich:"વેજ સેન્ડવીચ",dosa:"ઢોસા",peanut_curry:"સીંગની કઢી",misal:"મિસળ",paneer_junglee_sandwich:"પનીર જંગલી સેન્ડવીચ",mumbai_sandwich:"મુંબઈ સેન્ડવીચ",terra_wada_pav:"ટેરા વડા પાવ",gluten_free_dosai:"ગ્લુટેન ફ્રી ઢોસા",kothimbir_wadi:"કોથમીર વડી",bombay_pav_bhaji:"બોમ્બે પાવ ભાજી",pizza_bomb:"પીઝા બોમ્બ",mini_batata_wada:"મિની બટાટા વડા",appe_chutney:"અપ્પે અને ચટણી",namaste_misal_pav_dahi:"નમસ્તે મિસળ પાવ અને દહીં",chola_kulcha:"છોલે કુલચા",rajma_chawal:"રાજમા ચાવલ",dal_makhni_jeera_rice:"દાલ મખની જીરા રાઇસ",veg_korma_paratha:"વેજ કોરમા અને પરાઠા",dal_khichadi_dahi:"દાલ ખીચડી દહીં",schezwan_rice_manchurian:"શેઝવાન રાઇસ અને મંચુરિયન",mumbai_vada_pav:"મુંબઈ વડા પાવ",punjabi_samosa_chaat:"પંજાબી સમોસા ચાટ",paneer_kathi_roll:"પનીર કાઠી રોલ",paneer_butter_masala:"પનીર બટર મસાલા",amritsari_chole:"અમૃતસરી છોલે",dal_tadka:"દાલ તડકા",garlic_butter_naan:"ગાર્લિક બટર નાન",tandoori_roti:"તંદૂરી રોટી",veg_dum_biryani:"વેજ દમ બિરયાની",hyderabadi_chicken_65:"હૈદરાબાદી ચિકન 65",goan_fish_curry:"ગોલ્ડન ફિશ કરી",kerala_parotta_combo:"કેરળ પરોટા કોમ્બો",classic_gulab_jamun:"ક્લાસિક ગુલાબ જાંબુ",kulfi_falooda:"કુલ્ફી ફાલુદા",masala_chaas:"મસાલા છાશ"}},Xe={en:fa,hi:pa,mr:Ia,fr:_a,gu:Sa},ha={DINE_IN:[{key:"placed",label:"Order Placed"},{key:"preparing",label:"Preparing"},{key:"done",label:"Done"}],TAKEAWAY:[{key:"placed",label:"Order Placed"},{key:"preparing",label:"Preparing"},{key:"done",label:"Done"}]},ba={Pending:0,Confirmed:0,Preparing:1,Ready:1,Served:1,Finalized:1,Paid:2,Cancelled:-1,Returned:-1},ya={Pending:0,Confirmed:0,Accept:1,Accepted:1,"Being Prepared":1,BeingPrepared:1,Completed:1,Paid:2,Exit:2,Cancelled:-1,Returned:-1};function va(o){return ha[o==="TAKEAWAY"?"TAKEAWAY":"DINE_IN"]}function Aa(o){if(o==null||o==="")return"Pending";const g=String(o).trim();return g==="Accept"?"Accepted":g==="BeingPrepared"?"Being Prepared":g}function Ta(o,g){const _=(o??"").toString().trim();if(g==="TAKEAWAY"){const K=Aa(_),M=ya[K];return M!==void 0&&M>=0?M:0}const C=ba[_];return C!==void 0&&C>=0?C:0}function ka({status:o="Pending",className:g="",updatedAt:_,serviceType:C="DINE_IN",tableLabel:K,reason:M}){const V=va(C),L=o??"Pending",b=Ta(L,C),z=_?new Date(_).toLocaleTimeString():null,G=["Cancelled","Returned"].includes(L),F=typeof M=="string"?M.trim():"";return G?t.jsx("div",{className:`order-status-timeline ${g}`,children:t.jsxs("div",{className:"order-status-timeline-step order-status-step-completed",children:[t.jsx("div",{className:"order-status-dot order-status-dot-completed"}),t.jsxs("div",{className:"order-status-step-content",children:[t.jsx("span",{className:"order-status-step-label",children:L}),z&&t.jsxs("span",{className:"order-status-step-meta",children:["Updated ",z]}),F&&t.jsxs("span",{className:"order-status-step-meta",children:["Reason: ",F]})]})]})}):t.jsxs("div",{className:`order-status-timeline ${g}`,children:[z&&t.jsxs("div",{className:"order-status-updated-meta",children:["Updated ",z]}),V.map((ue,ne)=>{const Y=ne<b,pe=ne===b,Ze=ne>b,le=ne===V.length-1,ie=ne===0&&K?K:ue.label;return t.jsx("div",{className:"order-status-timeline-step-wrapper",children:t.jsxs("div",{className:"order-status-timeline-step",children:[t.jsxs("div",{className:"order-status-step-left",children:[t.jsx("div",{className:`order-status-dot ${Y?"order-status-dot-completed":""} ${pe?"order-status-dot-active":""} ${Ze?"order-status-dot-pending":""}`,children:Y&&t.jsx("svg",{className:"order-status-check",viewBox:"0 0 12 12",fill:"none",stroke:"white",strokeWidth:"2.5",strokeLinecap:"round",children:t.jsx("path",{d:"M2 6l3 3 5-6"})})}),!le&&t.jsx("div",{className:"order-status-line"})]}),t.jsxs("div",{className:"order-status-step-content",children:[t.jsx("span",{className:`order-status-step-label ${pe?"order-status-step-label-active":""} ${Ze?"order-status-step-label-pending":""}`,children:ie}),pe&&z&&t.jsxs("span",{className:"order-status-step-meta",children:["Updated ",z]})]})]})},ue.key)})]})}const R="https://api.terracart.in".replace(/\/$/,""),wa=o=>o?o.startsWith("http://")||o.startsWith("https://")?o:o.startsWith("/")?`${R}${o}`:`${R}/uploads/${o}`:"/defaultImg.jpg",q="terra_serviceType",_e="terra_selectedTable",Na="terra_feedbackSubmittedOrders",Ye="terra_takeaway_token_preview",Ea=["Pending","Confirmed","Preparing","Ready","Served","Completed","Paid","Returned","Cancelled"],xa=["Pending","Confirmed","Preparing","Ready","Served","Finalized","Completed"],ja=["Paid"],rr=["Paid","Cancelled","Returned"],Ca=o=>{if(o==null)return 0;const g=Number(o);return Number.isNaN(g)?0:g/100},$e=o=>{const g=Number(o);return Number.isNaN(g)?"0.00":g.toFixed(2)},ar=760,Oa=()=>{if(typeof window>"u")return 2;const o=Number(window.devicePixelRatio)||1;return Math.min(Math.max(o,1.5),2)},Da=()=>{if(typeof navigator>"u")return!1;const o=navigator.userAgent||"",g=/iPad|iPhone|iPod/i.test(o),_=navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1;return g||_},Pa=(o,g)=>{if(!Da()){o.save(g);return}const _=o.output("blob"),C=URL.createObjectURL(_);if(!window.open(C,"_blank","noopener,noreferrer")){const M=document.createElement("a");M.href=C,M.download=g,M.rel="noopener",document.body.appendChild(M),M.click(),document.body.removeChild(M)}window.setTimeout(()=>URL.revokeObjectURL(C),6e4)},dr=o=>String(o||"").replace(/^\(\s*\+\s*\)\s*/u,"").trim()||"Add-on",or=o=>{if(!o)return null;const g=o.acceptedBy||null,_=o.assignedStaff||null,C=g?.employeeName||_?.name||null;return C?{name:C,role:_?.role||g?.employeeRole||null,disability:g?.disability?.type||_?.disability||null}:null},sr=o=>{if(!o)return"INV-NA";const g=new Date(o.createdAt||Date.now()).toISOString().slice(0,10).replace(/-/g,""),_=(o.cartId||o._id||"").toString().slice(-6).toUpperCase();return`INV-${g}-${_}`},yt=o=>{if(!o)return[];const g=new Map;return(Array.isArray(o.kotLines)?o.kotLines:[]).forEach(K=>{(K?.items||[]).forEach(M=>{if(!M)return;const V=M.name||"Item",L=Number(M.quantity)||0,b=Ca(M.price||0),z=!!M.returned;g.has(V)||g.set(V,{name:V,unitPrice:b,activeQuantity:0,returnedQuantity:0,totalQuantity:0,amount:0,returned:!1});const G=g.get(V);G.totalQuantity+=L,z?(G.returnedQuantity+=L,G.returned=!0):(G.activeQuantity+=L,G.amount+=b*L),G.unitPrice||(G.unitPrice=b)})}),(o.selectedAddons||[]).forEach(K=>{const M=dr(K.name),V=`addon:${K.addonId||K._id||K.id||`${M}-${K.price||0}`}`,L=1,b=Number(K.price)||0;g.has(V)||g.set(V,{name:M,unitPrice:b,activeQuantity:0,returnedQuantity:0,totalQuantity:0,amount:0,returned:!1});const z=g.get(V);z.totalQuantity+=L,z.activeQuantity+=L,z.amount+=b*L}),Array.from(g.values()).map(K=>({...K,quantity:K.activeQuantity}))},nr=(o,g)=>{if(!o)return{subtotal:0,gst:0,totalAmount:0,totalItems:0};const _=Array.isArray(g)?g:yt(o)||[],C=_.reduce((L,b)=>{if(!b)return L;const z=Number(b.amount)||0;return L+z},0),K=Number(C.toFixed(2));return{subtotal:K,gst:0,totalAmount:K,totalItems:_.reduce((L,b)=>b?L+(Number(b.quantity)||0):L,0)}},lr=o=>{if(!o)return null;const g=o.paidAt||o.updatedAt||o.createdAt;if(!g)return null;const _=new Date(g);return Number.isNaN(_.getTime())?null:_},Ma=()=>{try{const o=localStorage.getItem(Na);if(!o)return[];const g=JSON.parse(o);return Array.isArray(g)?g.map(_=>_==null?"":String(_).trim()).filter(Boolean):[]}catch{return[]}},ir=o=>{if(!o)return!1;const g=String(o).trim();return g?Ma().includes(g):!1},Ra=o=>{const g={};return o.forEach(_=>{(_.items||[]).forEach(C=>{g[C.name]=C})}),g},ur={MILD:"Mild",MEDIUM:"Medium",HOT:"Hot",EXTREME:"Extreme"},Wa=o=>{const g=String(o?.spiceLevel||"").trim().toUpperCase();return ur[g]?g:""},mr=({item:o,onAdd:g,onRemove:_,count:C,lang:K})=>{if(!o)return null;const M=K||localStorage.getItem("language")||"en";let V=null;if(Xe[M]?.items){const ne=o.name?.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"");V=Xe[M].items[ne]}const[L]=cr(o.name||""),b=V||L,z=o.isAvailable!==!1,G=o?.isFeatured===!0,F=Wa(o),ue=F?ur[F]:"";return t.jsxs(oa.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.5},className:`item-card group ${z?"":"unavailable"}`,children:[t.jsxs("div",{className:"item-image-container",children:[t.jsx("img",{src:wa(o?.image),alt:o?.name||"Menu item",className:"item-image"}),G&&t.jsx("span",{className:"special-corner-badge","aria-label":"Special item",children:"Special"})]}),t.jsxs("div",{className:"item-info-section",children:[t.jsx("h4",{className:"item-name",children:b||o?.name||"Unnamed Item"}),t.jsxs("div",{className:"item-price-row",children:[t.jsxs("p",{className:"item-price",children:["₹",o?.price||0]}),F&&t.jsxs("span",{className:`item-spice-badge spice-${F.toLowerCase()}`,title:`Spice level: ${ue} Spicy`,children:[t.jsx("span",{className:"item-spice-primary",children:ue}),t.jsx("span",{className:"item-spice-secondary",children:"Spicy"})]})]}),!z&&t.jsx("div",{className:"item-meta-row",children:t.jsx("span",{className:"item-status-badge unavailable",children:"Not available"})})]}),t.jsx("div",{className:"item-footer",children:t.jsxs("div",{className:"item-controls",children:[t.jsx("button",{"aria-label":`Remove one ${o?.name||"item"}`,className:"quantity-button",onClick:()=>o?.name&&_(o.name),disabled:!C,children:"-"}),t.jsx("span",{className:"item-count",children:C||0}),t.jsx("button",{"aria-label":`Add one ${o?.name||"item"}`,className:`quantity-button ${z?"":"disabled"}`,onClick:()=>o&&g(o),disabled:!z,title:z?void 0:"Currently unavailable",children:"+"})]})})]})},Ka=({category:o,items:g,cart:_,onAdd:C,onRemove:K,lang:M,defaultOpen:V=!1})=>{if(!o)return null;const L=M||localStorage.getItem("language")||"en";let b=null;if(Xe[L]?.categories){const Y=o?.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"");b=Xe[L].categories[Y]}const[z]=cr(o||""),G=b||z,[F,ue]=c.useState(V),ne=Array.isArray(g)?g:[];return t.jsxs("div",{className:"category-wrapper",children:[t.jsxs("button",{onClick:()=>ue(Y=>!Y),className:"category-button",children:[G||o," ",t.jsx("span",{children:F?"▲":"▼"})]}),F&&t.jsx("div",{className:"category-items",children:ne.map((Y,pe)=>t.jsx(mr,{item:Y,onAdd:C,onRemove:K,count:_[Y?.name]||0,lang:L},Y?._id||`${o}-${pe}`))})]})};function Ya(){const o=zr(),g=Br(),[_,C]=Vr(),K=["en","hi","mr","gu"],M=e=>K.includes(e)?e:"en",[V,L]=c.useState(()=>M(localStorage.getItem("language")||"en"));c.useEffect(()=>{const e=()=>{L(M(localStorage.getItem("language")||"en"))};return window.addEventListener("storage",e),window.addEventListener("language-change",e),()=>{window.removeEventListener("storage",e),window.removeEventListener("language-change",e)}},[]);const b=(e,r)=>{if(!e)return r;const i=e.split(".");let u=tr[V]??tr.en??{};for(const s of i)u=u?.[s];return u??r},z=[{label:b("processSteps.checkingOrder","Checking your order"),state:"pending"},{label:b("processSteps.confirmingItems","Confirming items & price"),state:"pending"},{label:b("processSteps.placingOrder","Placing your order"),state:"pending"},{label:b("processSteps.sendingToKitchen","Sending to kitchen"),state:"pending"},{label:b("processSteps.preparingDetails","Preparing order details"),state:"pending"}],[G,F]=c.useState(!1),[ue,ne]=c.useState(z),Y=(e,r)=>ne(i=>i.map((n,u)=>u===e?{...n,state:r}:n)),[pe,Ze]=c.useState(localStorage.getItem("accessibilityMode")==="true"),[le,ie]=c.useState(()=>{const e=localStorage.getItem("terra_cart");return e?JSON.parse(e):{}}),ke=c.useRef(le);c.useEffect(()=>{localStorage.setItem("terra_cart",JSON.stringify(le)),ke.current=le},[le]);const[Oe,Se]=c.useState(!1),[$a,Ua]=c.useState(!1),[Tt,Ue]=c.useState(""),[gr,et]=c.useState(!1),[tt,kt]=c.useState(!1),[wt,rt]=c.useState(!1),[Nt,at]=c.useState(!1),[Et,xt]=c.useState(!1),[jt,he]=c.useState(!1),[La,Ct]=c.useState(null),[fr,Fa]=c.useState(!1),[Le,pr]=c.useState(""),[be,Ot]=c.useState([]),[ye,Dt]=c.useState({}),[ve,ot]=c.useState(!0),[Ae,Pt]=c.useState(null),[Ir,De]=c.useState(null),[_r,st]=c.useState(!1),[nt,lt]=c.useState(""),me=c.useMemo(()=>!Array.isArray(be)||be.length===0?[]:be.flatMap(e=>e?(Array.isArray(e.items)?e.items:[]).map(r=>({...r,categoryName:e?.name||"Menu"})):[]),[be]),{cartTotal:Sr,cartItemCount:Mt}=c.useMemo(()=>{let e=0,r=0;return Object.entries(le).forEach(([i,n])=>{r+=n;const u=me.find(s=>s.name===i);u&&(e+=(u.price||0)*n)}),{cartTotal:e,cartItemCount:r}},[le,me]),Rt=c.useMemo(()=>{const e=Le.trim().toLowerCase();return e?!Array.isArray(me)||me.length===0?[]:me.filter(r=>r?.name?r.name.toLowerCase().includes(e)||(r.description||"").toLowerCase().includes(e)||(r.tags||[]).some(i=>i&&i.toLowerCase().includes(e)):!1):[]},[me,Le]),ge=c.useRef(null),it=c.useRef(null),Pe=c.useRef(null),[k,H]=c.useState(()=>{const e=localStorage.getItem(q)||"DINE_IN";let r=null;return e==="TAKEAWAY"?r=localStorage.getItem("terra_orderId_TAKEAWAY"):r=localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),r||null}),[O,J]=c.useState(()=>((localStorage.getItem(q)||"DINE_IN")==="TAKEAWAY"?localStorage.getItem("terra_orderStatus_TAKEAWAY")||localStorage.getItem("terra_orderStatus"):localStorage.getItem("terra_orderStatus_DINE_IN")||localStorage.getItem("terra_orderStatus"))||null),[fe,Q]=c.useState(()=>((localStorage.getItem(q)||"DINE_IN")==="TAKEAWAY"?localStorage.getItem("terra_orderStatusUpdatedAt_TAKEAWAY")||localStorage.getItem("terra_orderStatusUpdatedAt"):localStorage.getItem("terra_orderStatusUpdatedAt_DINE_IN")||localStorage.getItem("terra_orderStatusUpdatedAt"))||null),[x,Me]=c.useState(()=>localStorage.getItem("terra_takeaway_only")==="true"?"TAKEAWAY":localStorage.getItem(q)||"DINE_IN"),[U,ct]=c.useState(()=>{try{const e=localStorage.getItem(_e);return e?JSON.parse(e):null}catch(e){return console.warn("Invalid table selection cache",e),null}}),[Fe,ee]=c.useState(()=>localStorage.getItem("terra_sessionToken"));c.useEffect(()=>{(async()=>{if((localStorage.getItem(q)||"DINE_IN")==="TAKEAWAY")return;const i=localStorage.getItem("terra_orderId"),n=localStorage.getItem("terra_sessionToken");if(!(!i||!n))try{const u=await fetch(`${R}/api/orders/${i}`);if(!u.ok){u.status===404?(console.log("[Menu] Active order not found (404), clearing order data"),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"),H(null),J(null),Q(null)):console.warn("[Menu] Error verifying order (non-404), keeping existing status:",u.status);return}let s;try{s=await u.json()}catch(d){console.error("[Menu] Failed to parse order response as JSON:",d);return}if(!s)return;s.sessionToken&&s.sessionToken!==n&&(console.log("[Menu] Clearing stale dine-in order data for old session"),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_previousOrder"),localStorage.removeItem("terra_previousOrderDetail"),H(null),J(null),Q(null))}catch(u){console.warn("[Menu] Error verifying active order session (network error), keeping existing status:",u)}})()},[]),c.useEffect(()=>{const e=localStorage.getItem("terra_sessionToken"),r=Fe,i=localStorage.getItem(q)||"DINE_IN";e&&r&&e!==r&&(i!=="TAKEAWAY"&&(console.log("[Menu] SessionToken changed - clearing old dine-in order data"),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_previousOrder"),localStorage.removeItem("terra_previousOrderDetail"),localStorage.removeItem("terra_lastPaidOrderId"),localStorage.removeItem("terra_cart_DINE_IN"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN"),H(null),J(null),Q(null)),ee(e))},[Fe]),c.useEffect(()=>{const e=localStorage.getItem(q)||"DINE_IN";let r=null;e==="TAKEAWAY"?r=localStorage.getItem("terra_orderId_TAKEAWAY"):r=localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),r&&r!==k?H(r):!r&&k&&H(null)},[x,k]),c.useEffect(()=>{if(x!=="TAKEAWAY"){ze(null);return}if(k){ze(null),localStorage.removeItem(Ye);return}const r=(()=>{const s=localStorage.getItem("terra_selectedCartId");if(s)return s;const d=localStorage.getItem("terra_takeaway_cartId");if(d)return d;try{const E=JSON.parse(localStorage.getItem(_e)||"{}"),I=E.cartId||E.cafeId||null;if(!I)return null;if(typeof I=="string")return I;if(typeof I=="object"){const N=I._id||I.id;return N?String(N):null}return String(I)}catch{return null}})();if(!r)return;let i=localStorage.getItem("terra_takeaway_sessionToken");i||(i=`TAKEAWAY-${Date.now()}-${Math.random().toString(36).slice(2,11)}`,localStorage.setItem("terra_takeaway_sessionToken",i));let n=!1;return(async()=>{try{const s=new URLSearchParams({cartId:r});i&&s.set("sessionToken",i);const d=await fetch(`${R}/api/orders/takeaway-token/next?${s.toString()}`);if(!d.ok)return;const E=await d.json(),I=Number(E?.token);!n&&Number.isInteger(I)&&I>0&&(ze(I),localStorage.setItem(Ye,String(I)))}catch(s){console.warn("[Menu] Failed to fetch takeaway token preview:",s)}})(),()=>{n=!0}},[x,k]),c.useEffect(()=>{},[x,o]);const[za]=c.useState(()=>localStorage.getItem("terra_takeaway_customerName")||""),[Ba]=c.useState(()=>localStorage.getItem("terra_takeaway_customerMobile")||""),[Va]=c.useState(()=>localStorage.getItem("terra_takeaway_customerEmail")||""),[Re,Wt]=c.useState(()=>{try{const e=localStorage.getItem("terra_previousOrder");return e?JSON.parse(e):null}catch(e){return console.warn("Invalid previous order cache",e),localStorage.removeItem("terra_previousOrder"),null}}),[$,Kt]=c.useState(()=>{try{const e=localStorage.getItem("terra_previousOrderDetail");return e?JSON.parse(e):null}catch(e){return console.warn("Invalid previous order detail cache",e),localStorage.removeItem("terra_previousOrderDetail"),null}}),[we,X]=c.useState(null),[Yt,ze]=c.useState(()=>{const e=Number(localStorage.getItem(Ye));return Number.isInteger(e)&&e>0?e:null}),[hr,dt]=c.useState(!1),[y,ut]=c.useState(null),[$t,Be]=c.useState(!1),[mt,Ne]=c.useState(!1),[Ve,gt]=c.useState(!1),[br,Ee]=c.useState(!1),[xe,Ut]=c.useState(null),[je,ft]=c.useState(""),[pt,Lt]=c.useState(!1),ce=c.useCallback(e=>{e?(Wt(e),localStorage.setItem("terra_previousOrder",JSON.stringify(e))):(Wt(null),localStorage.removeItem("terra_previousOrder"))},[]),ae=c.useCallback(e=>{e?(Kt(e),localStorage.setItem("terra_previousOrderDetail",JSON.stringify(e))):(Kt(null),localStorage.removeItem("terra_previousOrderDetail"))},[]),qe=c.useCallback((e={})=>{const r=e.orderId||k;if(!r)return;const i=e.status||O||"Confirmed",n=e.updatedAt||fe||new Date().toISOString(),u=e.tableInfo||U||(()=>{try{const E=localStorage.getItem(_e);return E?JSON.parse(E):null}catch{return null}})(),s=e.tableNumber??u?.number??u?.tableNumber??null,d=e.tableSlug??u?.qrSlug??localStorage.getItem("terra_scanToken")??null;ce({orderId:r,status:i,updatedAt:n,tableNumber:s,tableSlug:d})},[k,O,fe,U,ce]),We=c.useMemo(()=>y?sr(y):null,[y]),Je=c.useMemo(()=>yt(y),[y]),It=c.useMemo(()=>y?nr(y,Je):{subtotal:0,gst:0,totalAmount:0,totalItems:0},[y,Je]),yr=c.useMemo(()=>y?y.serviceType==="TAKEAWAY"?"Takeaway":"Dine-In":"",[y]),vr=y?.table?.number??y?.tableNumber??null,Ft=y?.table?.name??null,Ke=c.useMemo(()=>lr(y),[y]),zt=c.useMemo(()=>yt($),[$]),Bt=c.useMemo(()=>$?nr($,zt):{subtotal:0,gst:0,totalAmount:0,totalItems:0},[$,zt]),_t=c.useMemo(()=>lr($),[$]),Vt=c.useMemo(()=>$?sr($):null,[$]),Ce=c.useMemo(()=>or(we),[we]),He=c.useMemo(()=>or($),[$]),Qe=c.useMemo(()=>{const e=we?.takeawayToken??$?.takeawayToken??Yt;return e!=null&&e!==""?e:null},[we,$,Yt]),Ar=b("manualEntry","Menu");b("smartServe","Smart Serve");const Tr=b("aiOrdered","AI Ordered:");b("orderSummary","Order Summary:"),b("confirm","Confirm"),b("speakOrder","Speak Order");const kr=b("processingVoice","Processing your voice..."),St=b("cartEmpty","Cart is empty");b("resetOrderBtn","Reset Order");const wr=b("tapToOrder","Tap to Order"),Nr=b("tapToStop","Tap to Stop"),Er=b("searchPlaceholder","Search item..."),xr=b("recordVoiceAria","Record voice order");c.useEffect(()=>{O?localStorage.setItem("terra_orderStatus",O):localStorage.removeItem("terra_orderStatus"),fe?localStorage.setItem("terra_orderStatusUpdatedAt",fe):localStorage.removeItem("terra_orderStatusUpdatedAt")},[O,fe]),c.useEffect(()=>{O&&k&&Re&&ce(null),O&&k&&$&&ae(null)},[O,k,Re,$,ce,ae]),c.useEffect(()=>{if(!Re&&!$)return;const e=localStorage.getItem("terra_scanToken"),r=Re?.tableSlug;if(r&&e&&r!==e){ce(null),ae(null);return}!r&&$?.table?.qrSlug&&e&&$.table.qrSlug!==e&&(ce(null),ae(null))},[Re,$,ce,ae]),c.useEffect(()=>{const e=localStorage.getItem(q),r=localStorage.getItem("terra_takeaway_only")==="true";if((localStorage.getItem("terra_orderId_TAKEAWAY")||r)&&e!=="TAKEAWAY"){console.log("[Menu] Detected takeaway order or takeaway-only mode on refresh, setting serviceType to TAKEAWAY"),Me("TAKEAWAY"),localStorage.setItem(q,"TAKEAWAY");return}g.state?.serviceType?(Me(g.state.serviceType),localStorage.setItem(q,g.state.serviceType)):e?Me(e):r&&(console.log("[Menu] Detected takeaway-only QR flow, setting serviceType to TAKEAWAY"),Me("TAKEAWAY"),localStorage.setItem(q,"TAKEAWAY")),g.state?.table&&(ct(g.state.table),localStorage.setItem(_e,JSON.stringify(g.state.table)))},[g.state,Me]),c.useEffect(()=>{let e=!1;const r=async()=>{if((localStorage.getItem(q)||g.state?.serviceType||"DINE_IN")!=="DINE_IN")return!0;const s=localStorage.getItem("terra_orderId")||localStorage.getItem("terra_orderId_DINE_IN"),d=localStorage.getItem("terra_orderStatus")||localStorage.getItem("terra_orderStatus_DINE_IN"),E=s&&(!d||!["Paid","Cancelled","Returned","Completed"].includes(d));if(s)try{const w=await fetch(`${R}/api/orders/${s}`);if(w.ok){const j=await w.json();if(j.status&&!["Paid","Cancelled","Returned","Completed"].includes(j.status))return console.log("[Menu] User has verified active order - allowing access, skipping waitlist check"),!0}}catch(w){if(console.warn("[Menu] Failed to verify order on backend:",w),E)return console.log("[Menu] Order verification failed but order exists in storage - allowing access"),!0}const I=localStorage.getItem("terra_sessionToken"),N=localStorage.getItem("terra_selectedTable");if(I&&N)try{const w=JSON.parse(N);if(w.sessionToken===I)return console.log("[Menu] User has matching sessionToken - allowing access, skipping waitlist check"),!0;const j=w.qrSlug||localStorage.getItem("terra_scanToken");if(j)try{const h=await fetch(`${R}/api/tables/lookup/${j}?sessionToken=${I}`);if(h.ok){const a=await h.json();if(a?.table?.sessionToken===I||a?.table?.activeOrder)return console.log("[Menu] Backend confirms user owns table session - allowing access"),!0}}catch(h){if(console.warn("[Menu] Failed to verify table session on backend:",h),w.sessionToken===I)return!0}}catch(w){console.warn("[Menu] Failed to check sessionToken:",w)}const f=localStorage.getItem("terra_waitToken");if(E&&f)return console.log("[Menu] User has active order but also has waitlist token - clearing waitlist token"),localStorage.removeItem("terra_waitToken"),!0;if(!f)return!0;try{const w=await fetch(`${R}/api/waitlist/status?token=${f}`);if(w.ok){const j=await w.json();if(j.status==="WAITING")return console.log("[Menu] User is in WAITING status - blocking menu access"),alert("You are currently in the waitlist. Please wait for your turn. You will be notified when the table is ready."),o("/secondpage"),!1;if(j.status==="NOTIFIED"||j.status==="SEATED")return!0}}catch(w){console.error("[Menu] Failed to check waitlist status:",w)}return!0},i=async()=>{try{if((localStorage.getItem(q)||g.state?.serviceType||"DINE_IN")==="TAKEAWAY")return;const s=localStorage.getItem("terra_selectedTable");let d=localStorage.getItem("terra_sessionToken");const E=localStorage.getItem("terra_scanToken");if(!s||!E)return;const I=JSON.parse(s),N=I.id||I._id;if(!N)return;let f=!0;try{const l=I.qrSlug||E;if(l){const m=await fetch(`${R}/api/tables/lookup/${l}${d?`?sessionToken=${d}`:""}`).catch(v=>{throw console.warn("[Menu] Network error during table lookup:",v),v});if(m.status===423){let v={};try{v=await m.json()}catch(A){console.warn("[Menu] Failed to parse 423 response (expected for occupied tables):",A)}console.log("[Menu] Table lookup returned 423 (Locked - expected for occupied tables) - handling gracefully");const p=localStorage.getItem("terra_orderId")||localStorage.getItem("terra_orderId_DINE_IN");if(p)try{const A=await fetch(`${R}/api/orders/${p}`);if(A.ok){const W=await A.json();if((W.table?.toString()||W.tableId?.toString())===N?.toString()){W.sessionToken&&(d=W.sessionToken,localStorage.setItem("terra_sessionToken",d),ee(d),console.log("[Menu] Table is locked but user has active order - using order's sessionToken:",d)),console.log("[Menu] Table is already occupied by user's active order - skipping markTableOccupied"),f=!1;return}}}catch(A){console.warn("[Menu] Failed to verify order when table is locked:",A)}if(v?.table){const A={...I,...v.table,qrSlug:I.qrSlug||v.table.qrSlug};if(localStorage.setItem("terra_selectedTable",JSON.stringify(A)),v.table.sessionToken){const W=v.table.sessionToken;if(W===d)console.log("[Menu] Table is locked but sessionToken matches - we own this table"),localStorage.setItem("terra_sessionToken",d),ee(d),f=!0;else{const B=localStorage.getItem("terra_sessionToken");if(B&&B===W)console.log("[Menu] Table is locked but stored sessionToken matches table's token - we own this table"),d=B,localStorage.setItem("terra_sessionToken",d),ee(d),f=!0;else{console.warn("[Menu] Table is locked and sessionToken doesn't match - table belongs to another user"),f=!1;return}}}else if(d)console.log("[Menu] Table is locked and no sessionToken in response, but we have one - proceeding (backend will validate)"),f=!0;else{console.warn("[Menu] Table is locked and no sessionToken available - table belongs to another user"),f=!1;return}}else if(d)console.log("[Menu] Table is locked and no table data in response, but we have sessionToken - proceeding (backend will validate)"),f=!0;else{console.warn("[Menu] Table is locked and user has no active order for this table - skipping markTableOccupied"),f=!1;return}}if(m.ok){const v=await m.json();if(v?.table){const p=v.table,A=p.sessionToken,W={...I,...p,qrSlug:I.qrSlug||p.qrSlug};if(localStorage.setItem("terra_selectedTable",JSON.stringify(W)),A&&A!==d){const B=localStorage.getItem("terra_orderId")||localStorage.getItem("terra_orderId_DINE_IN");if(B)try{const te=await fetch(`${R}/api/orders/${B}`);if(te.ok){const S=await te.json();(S.table?.toString()||S.tableId?.toString())===N?.toString()?S.sessionToken?(d=S.sessionToken,localStorage.setItem("terra_sessionToken",d),ee(d),console.log("[Menu] Using order's sessionToken:",d)):(d=A,localStorage.setItem("terra_sessionToken",d),ee(d),console.log("[Menu] Using backend table's sessionToken:",d)):(console.warn("[Menu] User has order but not for this table - skipping markTableOccupied"),f=!1)}}catch(te){console.warn("[Menu] Failed to verify order:",te),d=A,localStorage.setItem("terra_sessionToken",d),ee(d)}else console.warn("[Menu] Table has different sessionToken and user has no active order - skipping markTableOccupied"),f=!1}else A&&A===d?console.log("[Menu] SessionToken matches - proceeding with markTableOccupied"):A||console.log("[Menu] Table has no sessionToken - proceeding with markTableOccupied")}}}}catch(l){l?.status!==423&&console.warn("[Menu] Failed to refresh table status before markTableOccupied:",l)}if(!f)return;const w=localStorage.getItem("terra_orderId")||localStorage.getItem("terra_orderId_DINE_IN"),j=localStorage.getItem("terra_orderStatus")||localStorage.getItem("terra_orderStatus_DINE_IN");if(w&&j&&!["Paid","Cancelled","Returned","Completed"].includes(j)&&w)try{const l=await fetch(`${R}/api/orders/${w}`);if(l.ok){const m=await l.json();if(m.status&&!["Paid","Cancelled","Returned","Completed"].includes(m.status)&&(m.table?.toString()===N?.toString()||m.tableId?.toString()===N?.toString())){console.log("[Menu] User has active order for this table - skipping markTableOccupied"),m.sessionToken&&(localStorage.setItem("terra_sessionToken",m.sessionToken),ee(m.sessionToken));return}}}catch(l){console.warn("[Menu] Failed to verify order before markTableOccupied:",l)}let a;try{a=await Zt(`${R}/api/tables/${N}/occupy`,{sessionToken:d||void 0},{headers:{"Content-Type":"application/json"}},{maxRetries:2,retryDelay:1e3,timeout:15e3,shouldRetry:(l,m)=>l.message?.includes("timeout")||l.message?.includes("Network error")||l.message?.includes("Failed to fetch")||l.message?.includes("CORS")?!0:l.status>=400&&l.status<500?!1:l.status>=500?!0:m<1})}catch(l){console.warn("[Menu] Failed to mark table as occupied after retries:",l),a={ok:!1,status:0,json:async()=>({}),text:async()=>l.message||"Network error"}}if(a.ok){const l=await a.json().catch(()=>null);if(l?.table){const m=l.table.sessionToken||d,v={...I,status:l.table.status||"OCCUPIED",sessionToken:m};localStorage.setItem("terra_selectedTable",JSON.stringify(v)),m&&m!==d&&(localStorage.setItem("terra_sessionToken",m),ee(m),console.log("[Menu] Updated sessionToken after marking table occupied:",m))}else I.status="OCCUPIED",localStorage.setItem("terra_selectedTable",JSON.stringify(I))}else{const l=await a.text().catch(()=>"Unknown error");if(console.warn("Failed to mark table as occupied:",l),a.status===423)try{const m=I.qrSlug||localStorage.getItem("terra_scanToken");if(m){const v=await fetch(`${R}/api/tables/lookup/${m}?sessionToken=${d||""}`);if(v.ok){const p=await v.json().catch(()=>({}));if(p?.table?.sessionToken){const A=p.table.sessionToken;localStorage.setItem("terra_sessionToken",A),ee(A),console.log("[Menu] Table already occupied by us, updated sessionToken:",A)}}}}catch(m){console.warn("Failed to refresh table status:",m)}}}catch(u){console.warn("Error marking table as occupied:",u)}};return(async()=>{try{if(ot(!0),Pt(null),!await r()){ot(!1);return}await i();let s="";const d=localStorage.getItem("terra_selectedCartId");if(d)s=d,console.log("[Menu] Using selected cart ID for menu:",s);else{const a=localStorage.getItem("terra_takeaway_cartId");if(a)s=a,console.log("[Menu] Using takeaway QR cart ID for menu:",s);else try{let l=localStorage.getItem("terra_selectedTable");l||(l=localStorage.getItem(_e)||"{}");const m=JSON.parse(l),v=m.cartId||m.cafeId||"";if(typeof v=="string"?s=v:v&&typeof v=="object"&&(v._id||v.id)?s=String(v._id||v.id):s=v?String(v):"",!s&&(m.id||m._id))try{const p=m.id||m._id,A=await fetch(`${R}/api/tables/public-cart-id/${encodeURIComponent(p)}`);if(A.ok){const W=await A.json().catch(()=>({}));W?.success&&W?.cartId&&(s=String(W.cartId))}}catch(p){console.warn("[Menu] Failed to resolve cartId from table id:",p)}console.log("[Menu] Table data for cartId lookup:",{hasTableData:!!l,tableDataKeys:m?Object.keys(m):[],cartId:m.cartId,cafeId:m.cafeId,foundCartId:s}),s?console.log("[Menu] Using table cart ID for menu:",s):console.warn("[Menu] No cartId or cafeId found in table data:",m)}catch(l){console.error("[Menu] Error parsing table data:",l),console.log("[Menu] No cart ID found, loading default menu")}}const E=typeof s=="string"?s:s&&(s._id||s.id)?String(s._id||s.id):"",I=E?`${R}/api/menu/public?cartId=${E}`:`${R}/api/menu/public`;console.log("[Menu] Loading menu from:",I,{hasCartId:!!s,cartId:s,serviceType:x});const N=await fetch(I);if(!N.ok)throw new Error(`Menu fetch failed with status ${N.status}`);let f;try{f=await N.json()}catch(a){console.error("[Menu] Failed to parse menu response as JSON:",a);const l=await N.text().catch(()=>"Unknown error");throw new Error(`Invalid menu response format: ${l.substring(0,100)}`)}if(e)return;const w=(Array.isArray(f)?f:[]).map(a=>a?{...a,name:a.name||"Menu",items:(Array.isArray(a.items)?a.items:[]).map(l=>l?{...l,isAvailable:l.isAvailable!==!1,categoryName:a.name||"Menu"}:null).filter(Boolean)}:null).filter(Boolean),j=Ra(w);Ot(w),Dt(j),Ct(a=>a||Array.isArray(w)&&w.length>0&&w[0]?.name||null);const h=typeof s=="string"?s:s&&(s._id||s.id)?String(s._id||s.id):"";if(h&&!e){st(!0),lt(h);try{const l=await(await fetch(`${R}/api/carts/public-contact?cartId=${encodeURIComponent(h)}`)).json();l?.success&&l?.data?De(l.data):De(null)}catch{De(null)}}else st(!!E),lt(E||""),De(null)}catch(u){if(console.error("Menu fetch error",u),e)return;Ot([]),Dt({}),Ct(null),De(null),st(!1),lt(""),Pt("Trying to connect to live menu... please check your network or ask staff.")}finally{e||ot(!1)}})(),()=>{e=!0}},[]);const qt=e=>{const r=typeof e=="string"?e:e?.name;if(!r)return;const i=ye[r]||e;if(i&&i.isAvailable===!1){alert(`${i.name} is currently unavailable.`);return}ie(n=>({...n,[r]:(n[r]||0)+1}))},Jt=e=>{ie(r=>{const i=(r[e]||0)-1;if(i<=0){const{[e]:n,...u}=r;return u}return{...r,[e]:i}})},oe=e=>new Promise(r=>setTimeout(r,e)),se={validate:1e3,order:1e3,beforeSend:1e3,kitchen:1e3,summary:1e3,error:1e3},Ht=async()=>{if(Object.keys(ke.current||{}).length===0)return F(!1),alert(St);if(x==="DINE_IN"&&!k&&!U){F(!1),alert("We couldn't detect your table. Please scan the table QR again or contact staff before placing an order.");return}await jr()},jr=async()=>{let e=k;if(e)try{const r=await fetch(`${R}/api/orders/${e}`);if(r.ok){const i=await r.json();["Paid","Cancelled","Returned"].includes(i.status)&&(console.log("[Menu] Existing order is in blocked status, creating new order instead:",i.status),e=null,H(null),x==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.removeItem("terra_orderStatus_TAKEAWAY"),localStorage.removeItem("terra_orderStatusUpdatedAt_TAKEAWAY")):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN")))}else console.log("[Menu] Could not fetch existing order, creating new order"),e=null,H(null),x==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.removeItem("terra_orderStatus_TAKEAWAY"),localStorage.removeItem("terra_orderStatusUpdatedAt_TAKEAWAY")):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN"))}catch(r){console.warn("[Menu] Error checking existing order, creating new order:",r),e=null,H(null),x==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.removeItem("terra_orderStatus_TAKEAWAY"),localStorage.removeItem("terra_orderStatusUpdatedAt_TAKEAWAY")):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN"))}ne(z.map((r,i)=>{let n=r.label;switch(i){case 0:n=b("processSteps.checkingOrder","Checking your order");break;case 1:n=b("processSteps.confirmingItems","Confirming items & price");break;case 2:n=b("processSteps.placingOrder","Placing your order");break;case 3:n=b("processSteps.sendingToKitchen","Sending to kitchen");break;case 4:n=b("processSteps.preparingDetails","Preparing order details");break}return{...r,label:n,state:"pending"}})),F(!0);try{Y(0,"active"),await oe(se.validate),Y(0,"done"),Y(1,"active"),await oe(se.order),Y(1,"done"),Y(2,"active"),await oe(se.beforeSend);let r=U;const i=x!=="DINE_IN"&&localStorage.getItem("terra_orderType")||null,n=x==="PICKUP"||x==="DELIVERY",u=i==="PICKUP"||i==="DELIVERY"?i:n?x:null,s=x==="TAKEAWAY"||n,d=x!=="DINE_IN"?localStorage.getItem("terra_customerLocation"):null;let E=null;if(d)try{E=JSON.parse(d)}catch(T){console.warn("[Menu] Failed to parse customerLocation from localStorage:",T),E=null}const I=s||u==="PICKUP"||u==="DELIVERY",N=u==="PICKUP"||u==="DELIVERY",f=I&&localStorage.getItem("terra_takeaway_customerName")||"",w=I&&localStorage.getItem("terra_takeaway_customerMobile")||"",j=I&&localStorage.getItem("terra_takeaway_customerEmail")||"";let h=null;if(s){const T=localStorage.getItem("terra_takeaway_cartId");if(T)h=T;else try{const P=JSON.parse(localStorage.getItem(_e)||"{}");let re=P.cartId||P.cafeId||null;re&&(typeof re=="object"&&re._id?h=re._id:typeof re=="string"?h=re:h=String(re)),console.log("[Menu] Using cartId from table data for takeaway:",h)}catch(P){console.warn("[Menu] Could not get cartId from table data for takeaway order:",P)}}let a=null;s?(a=localStorage.getItem("terra_takeaway_sessionToken"),a?console.log("[Menu] Using existing takeaway sessionToken (unified for both flows):",a):(a=`TAKEAWAY-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("terra_takeaway_sessionToken",a),console.log("[Menu] Generated new takeaway sessionToken (unified for both flows):",a))):(a=localStorage.getItem("terra_sessionToken"),a||(a=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("terra_sessionToken",a),ee(a),console.log("[Menu] Generated new DINE_IN sessionToken:",a)));const l=localStorage.getItem("terra_specialInstructions")||null,m=localStorage.getItem("terra_selectedCartId")||h,v=m||(()=>{try{const T=JSON.parse(localStorage.getItem(_e)||"{}"),P=T.cartId||T.cafeId;if(typeof P=="string")return P;if(P&&typeof P=="object"&&P._id)return P._id;if(P!=null)return String(P)}catch{}return""})(),p=localStorage.getItem("terra_cart_addons")||"{}";let A=[];try{const T=JSON.parse(p);Array.isArray(T)?A=T:v&&Array.isArray(T[v])&&(A=T[v])}catch{A=[]}const W=JSON.parse(localStorage.getItem("terra_global_addons")||"[]"),B=Array.isArray(W)?W:[],te=A.map(T=>{const P=B.find(re=>re.id===T);return P?{addonId:T,name:dr(P.name),price:P.price}:null}).filter(Boolean),S=Zr(ke.current,{serviceType:u?u==="PICKUP"?"PICKUP":"DELIVERY":x,orderType:u==="PICKUP"||u==="DELIVERY"?u:void 0,tableId:r?.id||r?._id||U?.id||U?._id,tableNumber:r?.number??r?.tableNumber??U?.number??U?.tableNumber,menuCatalog:ye,sessionToken:a,customerName:N&&f?.trim()?f.trim():void 0,customerMobile:N&&w?.trim()?w.trim():void 0,customerEmail:N&&j?.trim()?j.trim():void 0,cartId:I||u?m||h:void 0,customerLocation:E,specialInstructions:l,selectedAddons:te}),Te=Number(localStorage.getItem(Ye));if(s&&u!=="DELIVERY"&&!e&&Number.isInteger(Te)&&Te>0&&(S.takeawayToken=Te),!S.items||!Array.isArray(S.items)||S.items.length===0){console.error("[Menu] Invalid order payload - no items:",S),alert("❌ Your cart is empty. Please add items before placing an order."),Y(2,"error"),await oe(se.error),F(!1);return}const de=S.items.filter(T=>!T.name||typeof T.quantity!="number"||T.quantity<=0||typeof T.price!="number"||T.price<0);if(de.length>0){console.error("[Menu] Invalid order payload - invalid items:",de),alert("❌ Some items in your cart are invalid. Please refresh the page and try again."),Y(2,"error"),await oe(se.error),F(!1);return}if(S.serviceType==="DINE_IN"&&!S.sessionToken&&(a?S.sessionToken=a:(S.sessionToken=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("terra_sessionToken",S.sessionToken),ee(S.sessionToken))),S.serviceType==="PICKUP"||S.serviceType==="DELIVERY"||S.orderType==="PICKUP"||S.orderType==="DELIVERY"){if(!S.customerName||!S.customerName.trim()){alert("❌ Customer name is required for "+(S.orderType||S.serviceType)+" orders. Please provide your name."),Y(2,"error"),await oe(se.error),F(!1);return}if(!S.customerMobile||!S.customerMobile.trim()){alert("❌ Customer mobile number is required for "+(S.orderType||S.serviceType)+" orders. Please provide your mobile number."),Y(2,"error"),await oe(se.error),F(!1);return}}if(S.serviceType==="DELIVERY"||S.orderType==="DELIVERY"){if(!S.customerLocation||!S.customerLocation.latitude||!S.customerLocation.longitude){alert("❌ Delivery location is required. Please go back and provide your delivery address."),Y(2,"error"),await oe(se.error),F(!1);return}if(!S.cartId){alert("❌ Store selection is required for delivery. Please go back and select a store."),Y(2,"error"),await oe(se.error),F(!1);return}try{const T=await fetch(`${R}/api/carts/${S.cartId}?latitude=${S.customerLocation.latitude}&longitude=${S.customerLocation.longitude}&orderType=DELIVERY`);if(T.ok){const P=await T.json();if(P.success&&P.data){const re=P.data;if(!re.canDeliver){let Ge=`❌ Delivery not available!

`;re.distance!==null?Ge+=`You are ${re.distance.toFixed(2)} km away, but maximum delivery radius is ${re.deliveryRadius||5} km.

`:Ge+=`Delivery is not enabled for this store or the store location is not configured.

`,Ge+="Please select a different store or choose Pickup instead.",alert(Ge),Y(2,"error"),await oe(se.error),F(!1);return}}}}catch(T){console.error("[Menu] Error checking delivery availability:",T)}}const Fr=e?`${R}/api/orders/${e}/kot`:`${R}/api/orders`;let Z;try{Z=await Zt(Fr,S,{headers:{"Content-Type":"application/json"}},{maxRetries:2,retryDelay:1500,timeout:3e4,shouldRetry:(T,P)=>T.message?.includes("timeout")||T.message?.includes("Network error")||T.message?.includes("Failed to fetch")||T.message?.includes("CORS")?(console.log(`[Menu] Retrying order creation (attempt ${P+1}/2)...`),!0):T.status>=400&&T.status<500?!1:T.status>=500?!0:P<1})}catch(T){console.error("[Menu] Order creation failed after retries:",T);const P=T.message||"Failed to create order. Please check your connection and try again.";Z={ok:!1,status:0,statusText:"Network Error",json:async()=>({message:P}),text:async()=>P,headers:new Headers}}let D;try{if((Z.headers?.get?.("content-type")||"").includes("application/json"))D=await Z.json();else{const P=await Z.text().catch(()=>"");if(P)try{D=JSON.parse(P)}catch{D={message:P||"Unknown error"}}else D={message:"No response from server"}}}catch(T){console.error("[Menu] Failed to parse response:",T);try{D={message:await Z.text().catch(()=>"Unknown error")||"Failed to parse server response"}}catch{D={message:"Failed to parse server response"}}}const Xt=Z.ok&&D?._id;if(console.log("[Menu] Order creation response:",{ok:Z.ok,status:Z.status,hasOrderId:!!D?._id,orderId:D?._id,orderCreated:Xt}),Xt)console.log("[Menu] Order created successfully:",D._id);else{if(Y(2,"error"),Z.status===403){const T=D?.message||"Access denied. Please try refreshing the page.";T.includes("assigned to another guest")||T.includes("table")?alert(`⚠️ ${T}

Please scan the table QR code again or contact staff for assistance.`):alert(`❌ ${T}`)}else if(Z.status===400){const T=D?.message||D?.error||"Invalid request. Please check your order and try again.";console.error("[Menu] Order save failed (400 Bad Request):",{status:Z.status,statusText:Z.statusText,error:D,payload:S,itemsCount:S.items?.length,serviceType:S.serviceType,hasSessionToken:!!S.sessionToken,hasTableId:!!S.tableId,hasTableNumber:!!S.tableNumber});let P=T;D?.message?.includes("No items supplied")?P="Your cart is empty. Please add items before placing an order.":D?.message?.includes("Session token is required")?P="Session token is missing. Please scan the table QR code again.":D?.message?.includes("Table selection is required")?P="Table information is missing. Please scan the table QR code again.":D?.message?.includes("Invalid order items")&&(P="Some items in your cart are invalid. Please refresh the page and try again."),alert(`❌ ${P}`)}else{const T=D?.message||D?.error||"Failed to save order.";console.error("[Menu] Order save failed:",{status:Z.status,statusText:Z.statusText,error:D,payload:S}),alert(`❌ ${T}`)}await oe(se.error),F(!1),he(!1);return}if(console.log("[Menu] Proceeding with order success flow for order:",D._id),Y(2,"done"),Y(3,"active"),await oe(se.kitchen),Y(3,"done"),s?(localStorage.setItem("terra_orderId_TAKEAWAY",D._id),localStorage.removeItem(Ye),ze(null),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),D.sessionToken?(localStorage.setItem("terra_takeaway_sessionToken",D.sessionToken),console.log("[Menu] Stored takeaway sessionToken from order response:",D.sessionToken)):a&&(localStorage.setItem("terra_takeaway_sessionToken",a),console.log("[Menu] Stored generated takeaway sessionToken:",a))):(localStorage.setItem("terra_orderId",D._id),localStorage.setItem("terra_orderId_DINE_IN",D._id),localStorage.removeItem("terra_orderId_TAKEAWAY")),H(D._id),J(D.status||"Confirmed"),Q(new Date().toISOString()),X(D),s?(localStorage.setItem("terra_orderStatus_TAKEAWAY",D.status||"Confirmed"),localStorage.setItem("terra_orderStatusUpdatedAt_TAKEAWAY",new Date().toISOString())):(localStorage.setItem("terra_orderStatus_DINE_IN",D.status||"Confirmed"),localStorage.setItem("terra_orderStatusUpdatedAt_DINE_IN",new Date().toISOString())),D&&(D.takeawayToken||D.serviceType==="TAKEAWAY")&&ae(D),s||(ie({}),localStorage.removeItem("terra_cart"),localStorage.removeItem("terra_cart_DINE_IN"),localStorage.removeItem("terra_cart_TAKEAWAY")),he(!1),console.log("[Menu] Order created and stored:",{orderId:D._id,serviceType:x,storedInLocalStorage:{generic:x==="DINE_IN"?localStorage.getItem("terra_orderId"):null,dineIn:x==="DINE_IN"?localStorage.getItem("terra_orderId_DINE_IN"):null,takeaway:s?localStorage.getItem("terra_orderId_TAKEAWAY"):null}}),Y(4,"active"),Y(4,"done"),s){F(!1),o("/payment");return}F(!1)}catch(r){Y(2,"error"),alert("❌ Server Error"),console.error(r),await oe(se.error),F(!1),he(!1)}},Cr=async()=>{if(Oe){try{ge.current&&(ge.current.stop(),ge.current=null)}catch(e){console.warn("Error stopping recognition:",e)}Se(!1);return}if(!("webkitSpeechRecognition"in window)&&!("SpeechRecognition"in window)){alert("Your browser doesn't support voice input. Please use the menu buttons to order.");return}try{const e=window.SpeechRecognition||window.webkitSpeechRecognition,r=new e;ge.current=r,r.continuous=!1,r.interimResults=!1,r.maxAlternatives=3,r.lang=Gt(),r.onstart=()=>{Se(!0),Ue(""),console.log("🎤 Voice recognition started")},r.onresult=async i=>{const n=i.results[0][0].transcript;console.log("📝 Transcribed:",n),Ue(n),Se(!1),et(!0);try{await Lr(n,{speakFeedback:!1})}catch{}finally{et(!1)}},r.onerror=i=>{console.error("Voice recognition error:",i.error),Se(!1),et(!1),ge.current=null,i.error==="no-speech"?alert("No speech detected. Please try again."):i.error==="not-allowed"?alert("Microphone permission denied. Please allow microphone access."):alert("Voice recognition error. Please try again or use menu buttons.")},r.onend=()=>{Se(!1),ge.current=null},Se(!0),r.start()}catch(e){console.error("Error starting voice recognition:",e),alert("Failed to start voice input. Please try again or use menu buttons."),Se(!1)}};c.useEffect(()=>()=>{if(ge.current){try{ge.current.stop()}catch{}ge.current=null}if(it.current){try{it.current.stop()}catch{}it.current=null}typeof window<"u"&&"speechSynthesis"in window&&window.speechSynthesis.cancel()},[]);const Or=()=>{ie({}),localStorage.removeItem("terra_cart")},Dr=async()=>{if(!(!O||tt)){he(!0),kt(!0);try{if((localStorage.getItem(q)||"DINE_IN")==="TAKEAWAY"){const h=k||localStorage.getItem("terra_orderId_TAKEAWAY")||localStorage.getItem("terra_orderId"),a=localStorage.getItem("terra_takeaway_sessionToken")||localStorage.getItem("terra_sessionToken");if(!h){alert("No active order found. Please create a new order.");return}try{const l=await fetch(`${R}/api/orders/${h}`);if(l.ok){const m=await l.json();if(m.status&&["Paid","Cancelled","Returned","Completed"].includes(m.status)){alert("This order has been completed. Please create a new order.");return}H(h),localStorage.setItem("terra_orderId_TAKEAWAY",h),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),J(m.status||O||"Confirmed"),localStorage.setItem("terra_orderStatus_TAKEAWAY",m.status||O||"Confirmed"),m.updatedAt&&(Q(m.updatedAt),localStorage.setItem("terra_orderStatusUpdatedAt_TAKEAWAY",m.updatedAt)),ie({}),localStorage.removeItem("terra_cart"),localStorage.removeItem("terra_cart_TAKEAWAY"),alert("You can continue adding items to your takeaway order.");return}else{alert("Order not found. Please create a new order.");return}}catch{alert("Unable to verify order. Please try again or contact staff.");return}}const r=localStorage.getItem("terra_selectedTable"),i=Fe||localStorage.getItem("terra_sessionToken");if(!r||!i){alert("We couldn't detect your table. Please scan the table QR again or contact staff.");return}let n=null;if(k)try{const h=await fetch(`${R}/api/orders/${k}`);h.ok&&(n=await h.json())}catch{}const u=JSON.parse(r),s=u.qrSlug||localStorage.getItem("terra_scanToken"),d=localStorage.getItem("terra_sessionToken")||i,E=new URLSearchParams;d&&E.set("sessionToken",d);const I=`${R}/api/tables/lookup/${s}${E.toString()?`?${E.toString()}`:""}`;let N=await fetch(I),f=await N.json().catch(()=>({}));if(N.status===423){const h=f?.table?.sessionToken;if(h&&h===d)console.log("[Menu] Table is occupied by current session, proceeding");else{const a=f?.message||"Table is currently assigned to another guest.";if(d){console.warn("Stale session detected, retrying table lookup without session token."),localStorage.removeItem("terra_sessionToken"),ee(null);const m=new URLSearchParams().toString(),v=`${R}/api/tables/lookup/${s}${m?`?${m}`:""}`,p=await fetch(v),A=await p.json().catch(()=>({}));if(!p.ok)throw new Error(A?.message||a||"Unable to refresh table session. Please ask staff for help.");N=p,f=A}else throw new Error(a)}}else if(!N.ok)throw new Error(f?.message||"Failed to refresh table session. Please ask staff for help.");if(f.sessionToken){const h=Fe||localStorage.getItem("terra_sessionToken"),a=f.sessionToken;a!==h&&(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_previousOrder"),localStorage.removeItem("terra_previousOrderDetail"),localStorage.removeItem("terra_lastPaidOrderId"),H(null),J(null),Q(null),ce(null),ae(null),["DINE_IN","TAKEAWAY"].forEach(l=>{localStorage.removeItem(`terra_cart_${l}`),localStorage.removeItem(`terra_orderId_${l}`),localStorage.removeItem(`terra_orderStatus_${l}`),localStorage.removeItem(`terra_orderStatusUpdatedAt_${l}`)})),localStorage.setItem("terra_sessionToken",a),ee(a)}f.table&&(localStorage.setItem("terra_selectedTable",JSON.stringify(f.table)),ct(f.table)),(f.table?.status||"AVAILABLE")==="AVAILABLE"?localStorage.removeItem("terra_waitToken"):f.waitlist?.token?localStorage.setItem("terra_waitToken",f.waitlist.token):localStorage.removeItem("terra_waitToken");const j=f.table||u;if(f.order){const h=localStorage.getItem(q)||"DINE_IN";if(f.order.serviceType&&f.order.serviceType!==h){console.log(`[Menu] Ignoring order from table lookup - serviceType mismatch: order is ${f.order.serviceType}, current is ${h}`);return}H(f.order._id),h==="TAKEAWAY"?(localStorage.setItem("terra_orderId_TAKEAWAY",f.order._id),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN")):(localStorage.setItem("terra_orderId",f.order._id),localStorage.setItem("terra_orderId_DINE_IN",f.order._id),localStorage.removeItem("terra_orderId_TAKEAWAY")),J(f.order.status||O||"Confirmed"),f.order.updatedAt&&(Q(f.order.updatedAt),localStorage.setItem("terra_orderStatusUpdatedAt",f.order.updatedAt)),ce(null)}else k?console.log("No order returned from table lookup, keeping existing order status"):(qe({status:O||"Completed",updatedAt:fe||new Date().toISOString(),tableNumber:j?.number??j?.tableNumber??null,tableSlug:j?.qrSlug??s??null,tableInfo:j}),J(null),Q(null),H(null),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"));n&&ae(n),alert("You can continue adding items to your order.")}catch(e){console.error("handleOrderAgain error",e),alert(e.message||"Unable to resume ordering. Please contact staff.")}finally{kt(!1),he(!1)}}},Pr=()=>{if(!(x==="TAKEAWAY"?k||localStorage.getItem("terra_orderId_TAKEAWAY")||localStorage.getItem("terra_orderId"):k||localStorage.getItem("terra_orderId"))){alert("No active order found.");return}Ut("Cancel"),ft(""),Ee(!0)},Mr=()=>{if(!k){alert("No active order found.");return}Ut("Return"),ft(""),Ee(!0)},Rr=async()=>{if(!je.trim()){alert("Please enter a reason.");return}Lt(!0);try{if(xe==="Cancel"){rt(!0);const e=x==="TAKEAWAY"?k||localStorage.getItem("terra_orderId_TAKEAWAY")||localStorage.getItem("terra_orderId"):k||localStorage.getItem("terra_orderId");let r=null;if(x==="TAKEAWAY"){if(r=localStorage.getItem("terra_takeaway_sessionToken")||localStorage.getItem("terra_sessionToken"),!r)try{const d=await fetch(`${R}/api/orders/${e}`);if(d.ok){const E=await d.json();E?.sessionToken&&(r=E.sessionToken,localStorage.setItem("terra_takeaway_sessionToken",r))}}catch(d){console.warn("[Menu] Failed to fetch order to get sessionToken:",d)}}else r=localStorage.getItem("terra_sessionToken");const i=await fetch(`${R}/api/orders/${e}/customer-status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"Cancelled",sessionToken:r||void 0,reason:je})}),n=await i.json().catch(()=>({}));if(!i.ok)throw new Error(n?.message||"Failed to cancel order");const u=n?._id?n:null,s=u?.updatedAt||new Date().toISOString();qe({orderId:u?._id,status:"Cancelled",updatedAt:s,tableNumber:u?.tableNumber??U?.number??U?.tableNumber??null,tableSlug:u?.table?.qrSlug??U?.qrSlug??localStorage.getItem("terra_scanToken")??null,tableInfo:u?.table||U}),u&&ae(u),J("Cancelled"),Q(s),X(u||{status:"Cancelled",cancellationReason:je,updatedAt:s,serviceType:x}),H(null),x==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.setItem("terra_orderStatus_TAKEAWAY","Cancelled"),localStorage.setItem("terra_orderStatusUpdatedAt_TAKEAWAY",s),localStorage.removeItem("terra_cart_TAKEAWAY"),localStorage.setItem("terra_orderStatus","Cancelled"),localStorage.setItem("terra_orderStatusUpdatedAt",s),localStorage.removeItem("terra_takeaway_customerName"),localStorage.removeItem("terra_takeaway_customerMobile"),localStorage.removeItem("terra_takeaway_customerEmail"),console.log("[Menu] Cleared takeaway customer data after order cancellation")):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.setItem("terra_orderStatus","Cancelled"),localStorage.setItem("terra_orderStatusUpdatedAt",s),localStorage.setItem("terra_orderStatus_DINE_IN","Cancelled"),localStorage.setItem("terra_orderStatusUpdatedAt_DINE_IN",s),localStorage.removeItem("terra_cart")),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_cart"),x==="TAKEAWAY"&&(localStorage.removeItem("terra_waitToken"),console.log("[Menu] Cleared waitlist state for cancelled takeaway order")),ie({}),he(!1),alert("Your order has been cancelled."),rt(!1)}else if(xe==="Return"){at(!0);const e=x==="TAKEAWAY"?k||localStorage.getItem("terra_orderId_TAKEAWAY")||localStorage.getItem("terra_orderId"):k||localStorage.getItem("terra_orderId");let r=null;if(x==="TAKEAWAY"){if(r=localStorage.getItem("terra_takeaway_sessionToken")||localStorage.getItem("terra_sessionToken"),!r&&e)try{const d=await fetch(`${R}/api/orders/${e}`);if(d.ok){const E=await d.json();E?.sessionToken&&(r=E.sessionToken,localStorage.setItem("terra_takeaway_sessionToken",r))}}catch(d){console.warn("[Menu] Failed to fetch order to get sessionToken for return:",d)}}else r=localStorage.getItem("terra_sessionToken");const i=await fetch(`${R}/api/orders/${e}/customer-status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"Returned",sessionToken:r||void 0,reason:je})}),n=await i.json().catch(()=>({}));if(!i.ok)throw new Error(n?.message||"Failed to return order");const u=n?._id?n:null,s=u?.updatedAt||new Date().toISOString();qe({orderId:u?._id,status:"Returned",updatedAt:s,tableNumber:u?.tableNumber??U?.number??U?.tableNumber??null,tableSlug:u?.table?.qrSlug??U?.qrSlug??localStorage.getItem("terra_scanToken")??null,tableInfo:u?.table||U}),u&&ae(u),J("Returned"),Q(s),X(u||{status:"Returned",cancellationReason:je,updatedAt:s,serviceType:x}),H(null),x==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.setItem("terra_orderStatus_TAKEAWAY","Returned"),localStorage.setItem("terra_orderStatusUpdatedAt_TAKEAWAY",s),localStorage.setItem("terra_orderStatus","Returned"),localStorage.setItem("terra_orderStatusUpdatedAt",s)):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.setItem("terra_orderStatus","Returned"),localStorage.setItem("terra_orderStatusUpdatedAt",s),localStorage.setItem("terra_orderStatus_DINE_IN","Returned"),localStorage.setItem("terra_orderStatusUpdatedAt_DINE_IN",s)),localStorage.removeItem("terra_cart"),ie({}),he(!1),x==="TAKEAWAY"&&(localStorage.removeItem("terra_waitToken"),localStorage.removeItem("terra_takeaway_customerName"),localStorage.removeItem("terra_takeaway_customerMobile"),localStorage.removeItem("terra_takeaway_customerEmail")),alert("Your order has been marked as returned."),at(!1)}Ee(!1)}catch(e){alert(e.message||`Unable to ${xe.toLowerCase()} order.`),xe==="Cancel"&&rt(!1),xe==="Return"&&at(!1)}finally{Lt(!1)}},Wr=async()=>{if(!k){alert("No active order found.");return}if(await window.confirm("Confirm that payment has been completed for this order?")){xt(!0);try{const e=localStorage.getItem("terra_sessionToken"),r=await fetch(`${R}/api/orders/${k}/confirm-payment`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentMethod:"CASH",sessionToken:x==="DINE_IN"&&e||void 0})}),i=await r.json().catch(()=>({}));if(!r.ok)throw new Error(i?.message||"Failed to confirm payment");const n=i?._id?i:null,u=n?.updatedAt||new Date().toISOString();qe({orderId:n?._id,status:"Paid",updatedAt:u,tableNumber:n?.tableNumber??U?.number??U?.tableNumber??null,tableSlug:n?.table?.qrSlug??U?.qrSlug??localStorage.getItem("terra_scanToken")??null,tableInfo:n?.table||U}),n&&ae(n),J("Paid"),Q(u),localStorage.setItem("terra_orderStatus","Paid"),localStorage.setItem("terra_orderStatusUpdatedAt",u),localStorage.setItem("terra_lastPaidOrderId",k),alert("Payment confirmed successfully!")}catch(e){console.error("handleConfirmPayment error",e),alert(e.message||"Unable to confirm payment. Please contact staff.")}finally{xt(!1)}}},ht=c.useCallback(async()=>{if(!k){alert("We couldn't locate your order. Please contact staff.");return}try{Be(!0);const e=await fetch(`${R}/api/orders/${k}`),r=await e.json().catch(()=>({}));if(!e.ok)throw new Error(r?.message||"Failed to load invoice details.");console.log("📄 Invoice order data:",{orderId:r._id,franchiseId:r.franchiseId,cafeId:r.cafeId,franchise:r.franchise,cafe:r.cafe}),ut(r),dt(!0)}catch(e){console.error("Invoice fetch failed",e),alert(e.message||"Unable to load invoice. Please contact staff.")}finally{Be(!1)}},[k]),Qt=c.useCallback(()=>{dt(!1),ut(null),Ne(!1),gt(!1),Be(!1)},[]);c.useCallback(()=>{if(!(!Pe.current||!y||mt)){Ne(!0);try{const e=document.createElement("iframe");e.style.position="fixed",e.style.right="0",e.style.bottom="0",e.style.width="0",e.style.height="0",e.style.border="0",e.style.visibility="hidden",e.setAttribute("sandbox","allow-same-origin allow-scripts allow-modals"),document.body.appendChild(e);const r=e.contentWindow?.document;if(!r){Ne(!1),document.body.removeChild(e),alert("Print preview failed to open. Please check your browser settings.");return}r.open(),r.write(`
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>${We||"Invoice"}</title>
          <style>
            * { box-sizing: border-box; }
            body {
              font-family: 'Segoe UI', Arial, sans-serif;
              margin: 0;
              padding: 32px;
              background: #ffffff;
              color: #1f2933;
            }
            h1, h2, h3, h4 { margin: 0; }
            table { border-collapse: collapse; width: 100%; }
            th, td { padding: 8px; border-bottom: 1px solid #e5e7eb; }
            th { text-align: left; color: #475569; font-weight: 600; }
            .invoice-shell {
              max-width: 720px;
              margin: 0 auto;
              padding: 24px;
              border: 1px solid #d2d6dc;
              border-radius: 12px;
            }
            @media print {
              body { padding: 0; }
              .invoice-shell { border: none; }
            }
          </style>
        </head>
        <body>
          <div class="invoice-shell">
            ${Pe.current.innerHTML}
          </div>
        </body>
      </html>
    `),r.close(),e.onload=function(){setTimeout(()=>{try{e.contentWindow?.focus(),e.contentWindow?.print()}catch(i){console.error("Print failed:",i),alert("Print failed. Please try using your browser's print function (Ctrl+P).")}finally{setTimeout(()=>{document.body.contains(e)&&document.body.removeChild(e),Ne(!1)},500)}},250)},setTimeout(()=>{mt&&document.body.contains(e)&&(document.body.removeChild(e),Ne(!1),console.warn("Print timeout - iframe failed to load"))},5e3)}catch(e){console.error("Print setup failed:",e),Ne(!1),alert("Failed to initialize print. Please try again or use Ctrl+P.")}}},[We,y,mt]);const Kr=c.useCallback(async()=>{if(!Pe.current||!y||Ve)return;gt(!0);let e=null;try{e=document.createElement("div"),e.style.position="fixed",e.style.left="-10000px",e.style.top="0",e.style.width=`${ar}px`,e.style.background="#ffffff",e.style.padding="0",e.style.margin="0",e.style.pointerEvents="none",e.style.opacity="0",e.style.zIndex="-1";const r=Pe.current.cloneNode(!0);r.style.width="100%",r.style.maxWidth="100%",r.style.margin="0",r.style.borderRadius="0",r.style.boxShadow="none",e.appendChild(r),document.body.appendChild(e),await new Promise(m=>{window.requestAnimationFrame(()=>m())});const i=r.scrollWidth||e.scrollWidth||ar,n=Math.max(r.scrollHeight||e.scrollHeight||1,1),s=(await ra(r,{scale:Oa(),useCORS:!0,logging:!1,backgroundColor:"#ffffff",scrollX:0,scrollY:0,windowWidth:i,windowHeight:n,width:i,height:n,onclone:m=>{m.querySelectorAll(".invoice-preview, .invoice-preview *").forEach(p=>{const A=window.getComputedStyle(p);["color","backgroundColor","borderColor"].forEach(W=>{const B=A[W];B&&B.includes("oklch")&&(p.style[W]="#000000",W==="backgroundColor"&&(p.style[W]="transparent"))})})}})).toDataURL("image/png"),d=new aa("p","mm","a4"),E=d.internal.pageSize.getWidth(),I=d.internal.pageSize.getHeight(),N=10,f=E-N*2,w=d.getImageProperties(s),j=w.height/w.width,h=f*j;let a=h,l=N;for(d.addImage(s,"PNG",N,l,f,h),a-=I-N*2;a>0;)d.addPage(),l=N-(h-a),d.addImage(s,"PNG",N,l,f,h),a-=I-N*2;Pa(d,`${We||"invoice"}.pdf`)}catch(r){console.error("Invoice download failed",r),alert("Failed to generate invoice PDF. Please try again.")}finally{e&&document.body.contains(e)&&document.body.removeChild(e),gt(!1)}},[We,y,Ve]);c.useCallback(async()=>{if(["Preparing","Ready","Served","Finalized","Paid"].includes(O)){await ht();return}if(O==="Returned"||O==="Cancelled"){alert(O==="Returned"?"This order has already been returned.":"This order has been cancelled.");return}o("/billing")},[O,ht,o]);const Yr=c.useCallback(()=>{$&&(Be(!1),ut($),dt(!0))},[$]),Gt=()=>{const e=localStorage.getItem("language")||"en";return e==="hi"?"hi-IN":e==="mr"?"mr-IN":e==="gu"?"gu-IN":"en-IN"},Ie=(e,r)=>{if(!(!e||typeof window>"u"||!("speechSynthesis"in window)))try{const i=new SpeechSynthesisUtterance(e);i.lang=Gt(),i.rate=.95,i.pitch=1,i.onend=()=>{},window.speechSynthesis.cancel(),window.speechSynthesis.speak(i)}catch{}},bt=e=>(e||"").toLowerCase().replace(/[.,!?]/g," ").replace(/\s+/g," ").trim(),$r=e=>{const r={one:1,two:2,three:3,four:4,five:5,six:6,seven:7,eight:8,nine:9,ten:10,ek:1,do:2,teen:3,char:4,paanch:5,che:6,saat:7,aath:8,nau:9,das:10},i=bt(e);if(r[i]!==void 0)return r[i];const n=parseInt(i,10);return Number.isNaN(n)?0:n},Ur=e=>{const r={addedItems:[],notFound:[]};if(!e)return r;const i={...ke.current||{}},n=Array.isArray(me)&&me.length>0?me:Object.values(ye).length>0?Object.values(ye):ea.map(d=>({...d,isAvailable:!0})),u=e.replace(/\b(and|aur|plus|with)\b/gi,",").replace(/[;|]/g,",").split(",").map(d=>d.trim()).filter(Boolean),s=d=>bt(d).replace(/[^a-z0-9\s]/g,"");return u.forEach(d=>{let E=1,I=d.replace(/^(add|order|please add|please|i want|give me|mujhe|mala|mane)\s+/i,"").trim();const N=I.match(/^(\d+)\s*(x|times)?\s+(.+)$/i);if(N)E=parseInt(N[1],10)||1,I=N[3].trim();else{const j=I.match(/^(one|two|three|four|five|six|seven|eight|nine|ten|ek|do|teen|char|paanch|che|saat|aath|nau|das)\s+(.+)$/i);j&&(E=$r(j[1])||1,I=j[2].trim())}if(!I)return;const f=s(I),w=n.find(j=>j?.name&&s(j.name)===f)||n.find(j=>{if(!j?.name)return!1;const h=s(j.name);return h.includes(f)||f.includes(h)});w&&w.isAvailable!==!1?(i[w.name]=(i[w.name]||0)+E,r.addedItems.push({name:w.name,qty:E})):r.notFound.push(I)}),ke.current=i,ie(i),r},Lr=async(e,{speakFeedback:r=!1,allowStop:i=!1}={})=>{const n=bt(e);if(!n)return r&&Ie("I could not hear you clearly. Please try again."),{type:"empty"};const u=h=>h.some(a=>n.includes(a)),s=["stop","assistant stop","close assistant","stop listening"],d=["confirm order","place order","order now","checkout","submit order","confirm my order","ऑर्डर कन्फर्म","ऑर्डर करो","ऑर्डर प्लेस","ऑર્ડર कન્ફર્મ","ઓર્ડર મૂકો"],E=["open cart","show cart","go to cart","cart kholo","कार्ट","કાર્ટ"],I=["clear cart","empty cart","reset cart","remove all","cart clear","कार्ट खाली","કાર્ટ ખાલી"];if(i&&u(s))return r&&Ie("Blind assistant stopped."),{type:"stop"};if(u(I))return Or(),Ue(""),r?Ie("Cart has been cleared."):alert("Cart cleared."),{type:"clear"};if(u(E))return r&&Ie("Opening cart."),o("/cart"),{type:"cart"};if(u(d))return Object.keys(ke.current||{}).length===0?(r?Ie(St||"Your cart is empty."):alert(St),{type:"place-empty"}):(r&&Ie("Placing your order now."),await Ht(),{type:"place"});const{addedItems:N,notFound:f}=Ur(e),w=N.length,j=N.map(({name:h,qty:a})=>`${a}x ${h}`).join(", ");if(j&&Ue(j),w>0)r?Ie(`Added ${w} item${w>1?"s":""} to your cart.`):f.length>0&&alert(`✅ Added ${w} item(s) to cart.
⚠️ Not found in menu: ${f.join(", ")}`);else if(f.length>0){const h=`Could not find in menu: ${f.join(", ")}. Try saying item names as shown in the menu.`;r?Ie(h):alert(h)}return{type:"items",addedItems:N,notFound:f}};return c.useEffect(()=>{const r=(localStorage.getItem(q)||"DINE_IN")==="TAKEAWAY";let i=null;if(r?i=k||localStorage.getItem("terra_orderId_TAKEAWAY"):i=k||localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),!i){const a=r?localStorage.getItem("terra_orderStatus_TAKEAWAY")||localStorage.getItem("terra_orderStatus"):localStorage.getItem("terra_orderStatus_DINE_IN")||localStorage.getItem("terra_orderStatus"),l=r?localStorage.getItem("terra_orderStatusUpdatedAt_TAKEAWAY")||localStorage.getItem("terra_orderStatusUpdatedAt"):localStorage.getItem("terra_orderStatusUpdatedAt_DINE_IN")||localStorage.getItem("terra_orderStatusUpdatedAt");rr.includes(a||"")?(J(a),Q(l||null)):(J(null),Q(null)),X(null);return}if(jt)return;let n,u,s=!1,d=null;const E=a=>a==null?null:typeof a=="string"?a:typeof a=="object"&&a._id?String(a._id):String(a),I=a=>{if(!n||a==null)return;const l=E(a);!l||d===l||(n.emit("join:cart",l),d=l)},N=async()=>{try{const a=localStorage.getItem(q)||"DINE_IN";let l=null;if(a==="TAKEAWAY"?l=k||localStorage.getItem("terra_orderId_TAKEAWAY"):l=k||localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),!l){X(null);return}const m=localStorage.getItem("terra_sessionToken");let v;try{v=await fetch(`${R}/api/orders/${l}`,{signal:AbortSignal.timeout(5e3)})}catch{s||(console.warn("[Menu] Backend server appears to be offline. Will retry automatically."),s=!0);return}if(s&&(s=!1),!v.ok){v.status===404&&(console.warn("Order not found (404), clearing order data"),a==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.removeItem("terra_orderStatus_TAKEAWAY"),localStorage.removeItem("terra_orderStatusUpdatedAt_TAKEAWAY")):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN")),H(null),J(null),Q(null),X(null));return}let p;try{p=await v.json()}catch(te){console.error("[Menu] Failed to parse order status response as JSON:",te);return}if(!p)return;const A=localStorage.getItem("terra_serviceType")||"DINE_IN",W=A==="TAKEAWAY";if(p.serviceType&&p.serviceType!==A){console.log(`[Menu] Ignoring order update - serviceType mismatch: order is ${p.serviceType}, current is ${A}`);return}const B=W&&localStorage.getItem("terra_takeaway_sessionToken")||m;if(W){if(B&&p.sessionToken&&p.sessionToken!==B)return}else if(B&&p.sessionToken&&p.sessionToken!==B){localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN"),localStorage.removeItem("terra_cart_DINE_IN"),localStorage.removeItem("terra_previousOrder"),localStorage.removeItem("terra_previousOrderDetail"),H(null),J(null),Q(null),X(null),ce(null),ae(null);return}if(X(p),p.cartId&&I(p.cartId),W&&ae(p),p?.status){if((W?localStorage.getItem("terra_orderStatus_TAKEAWAY")||localStorage.getItem("terra_orderStatus"):localStorage.getItem("terra_orderStatus_DINE_IN")||localStorage.getItem("terra_orderStatus"))===p.status&&O===p.status)return;const S=new Date().toISOString();J(p.status),Q(S),W?(localStorage.setItem("terra_orderStatus_TAKEAWAY",p.status),localStorage.setItem("terra_orderStatusUpdatedAt_TAKEAWAY",S),localStorage.setItem("terra_orderStatus",p.status),localStorage.setItem("terra_orderStatusUpdatedAt",S)):(localStorage.setItem("terra_orderStatus_DINE_IN",p.status),localStorage.setItem("terra_orderStatusUpdatedAt_DINE_IN",S),localStorage.setItem("terra_orderStatus",p.status),localStorage.setItem("terra_orderStatusUpdatedAt",S))}}catch{}};N(),u=setInterval(N,1e4);try{n=ta(R,{transports:["websocket","polling"],reconnection:!0,reconnectionDelay:1e3,reconnectionDelayMax:5e3,reconnectionAttempts:5,timeout:6e4,connectTimeout:6e4,autoConnect:!0,forceNew:!1});let a=!1;n.on("connect",()=>{a=!1,s=!1;const l=we?.cartId,m=localStorage.getItem("terra_takeaway_cartId");let v=null;try{const p=JSON.parse(localStorage.getItem(_e)||"{}"),A=p.cartId||p.cafeId;v=typeof A=="object"&&A?._id?A._id:A}catch{v=null}I(l||m||v)}),n.on("connect_error",l=>{a||(console.warn("[Menu] Socket connection error - backend may be offline. Will retry automatically."),a=!0)}),n.on("disconnect",l=>{})}catch(a){console.warn("[Menu] Failed to create socket connection:",a),n=null}const f=a=>{const l=localStorage.getItem(q)||"DINE_IN";let m=null;if(l==="TAKEAWAY"?m=k||localStorage.getItem("terra_orderId_TAKEAWAY"):m=k||localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),String(a?._id||"")===String(m||"")&&a?.status&&a?.serviceType===l){if(localStorage.getItem("terra_orderStatus")===a.status&&O===a.status)return;if(l==="TAKEAWAY"&&a.sessionToken){const A=localStorage.getItem("terra_takeaway_sessionToken")||localStorage.getItem("terra_sessionToken");if(A&&a.sessionToken!==A)return}const p=new Date().toISOString();J(a.status),Q(p),X(a),a.cartId&&I(a.cartId),localStorage.setItem("terra_orderStatus",a.status),localStorage.setItem("terra_orderStatusUpdatedAt",p),l==="TAKEAWAY"?(localStorage.setItem("terra_orderStatus_TAKEAWAY",a.status),localStorage.setItem("terra_orderStatusUpdatedAt_TAKEAWAY",p)):(localStorage.setItem("terra_orderStatus_DINE_IN",a.status),localStorage.setItem("terra_orderStatusUpdatedAt_DINE_IN",p))}},w=a=>{if(!a)return;const l=localStorage.getItem(q)||"DINE_IN";let m=null;l==="TAKEAWAY"?m=k||localStorage.getItem("terra_orderId_TAKEAWAY"):m=k||localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId");const v=a.orderId||a.order?._id;if(!v||String(v)!==String(m||""))return;const p=a.status||a.order?.status||"Confirmed",A=new Date().toISOString();if(J(p),Q(A),localStorage.setItem("terra_orderStatus",p),localStorage.setItem("terra_orderStatusUpdatedAt",A),l==="TAKEAWAY"?(localStorage.setItem("terra_orderStatus_TAKEAWAY",p),localStorage.setItem("terra_orderStatusUpdatedAt_TAKEAWAY",A)):(localStorage.setItem("terra_orderStatus_DINE_IN",p),localStorage.setItem("terra_orderStatusUpdatedAt_DINE_IN",A)),a.order&&typeof a.order=="object"){X(a.order),a.order.cartId&&I(a.order.cartId);return}a.assignedStaff&&X(W=>{const B=W?{...W}:{_id:v};return B.status=p,B.assignedStaff=a.assignedStaff,B.acceptedBy||(B.acceptedBy={employeeId:a.assignedStaff.id||null,employeeName:a.assignedStaff.name||null,employeeRole:a.assignedStaff.role||null,disability:{hasDisability:!!a.assignedStaff.disability,type:a.assignedStaff.disability||null}}),B})},j=a=>{const l=localStorage.getItem(q)||"DINE_IN";let m=null;l==="TAKEAWAY"?m=k||localStorage.getItem("terra_orderId_TAKEAWAY"):m=k||localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),a?.id===m&&(J(null),H(null),X(null),l==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.removeItem("terra_orderStatus_TAKEAWAY"),localStorage.removeItem("terra_orderStatusUpdatedAt_TAKEAWAY")):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN")))},h=a=>{const l=U||(()=>{try{const de=localStorage.getItem("terra_selectedTable");return de?JSON.parse(de):null}catch{return null}})();if(!l)return;const m=a.id||a._id,v=l.id||l._id,p=m&&v&&String(m)===String(v),A=a.number&&l.number&&String(a.number)===String(l.number);if(!p&&!A)return;console.log("[Menu] Table status updated via socket:",a.status,"Previous status:",l.status);const W={...l,status:a.status,currentOrder:a.currentOrder||null,sessionToken:a.sessionToken||l.sessionToken};ct(W),localStorage.setItem("terra_selectedTable",JSON.stringify(W));const B=localStorage.getItem("terra_orderId")||localStorage.getItem("terra_orderId_DINE_IN"),te=localStorage.getItem("terra_orderStatus")||localStorage.getItem("terra_orderStatus_DINE_IN"),S=B&&(!te||!["Paid","Cancelled","Returned","Completed"].includes(te)),Te=rr.includes(te||"");a.status==="AVAILABLE"&&(!S&&!Te?(console.log("[Menu] Table became AVAILABLE via socket - clearing waitlist state and order data (user has no active order)"),localStorage.removeItem("terra_waitToken"),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_cart"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_previousOrder"),localStorage.removeItem("terra_previousOrderDetail"),["DINE_IN","TAKEAWAY"].forEach(de=>{localStorage.removeItem(`terra_cart_${de}`),localStorage.removeItem(`terra_orderId_${de}`),localStorage.removeItem(`terra_orderStatus_${de}`),localStorage.removeItem(`terra_orderStatusUpdatedAt_${de}`)}),H(null),J(null),X(null),console.log("[Menu] Cleared all order data for new customer")):console.log(Te?"[Menu] Table became AVAILABLE but preserving final customer order status":"[Menu] Table became AVAILABLE but user has active order - preserving order data"))};return n&&(n.on("orderUpdated",f),n.on("order:status:updated",f),n.on("ORDER_ACCEPTED",w),n.on("orderDeleted",j),n.on("table:status:updated",h)),()=>{u&&clearInterval(u),n&&(n.off("orderUpdated",f),n.off("order:status:updated",f),n.off("ORDER_ACCEPTED",w),n.off("orderDeleted",j),n.off("table:status:updated",h),n.disconnect())}},[k,jt,x]),c.useEffect(()=>{const e=localStorage.getItem(q)||"DINE_IN";if(e==="TAKEAWAY"?k||localStorage.getItem("terra_orderId_TAKEAWAY")||localStorage.getItem("terra_orderId"):k||localStorage.getItem("terra_orderId")){const i=e==="TAKEAWAY"&&localStorage.getItem("terra_orderStatus_TAKEAWAY")||localStorage.getItem("terra_orderStatus"),n=e==="TAKEAWAY"&&localStorage.getItem("terra_orderStatusUpdatedAt_TAKEAWAY")||localStorage.getItem("terra_orderStatusUpdatedAt");i&&(i!==O&&(console.log("[Menu] Syncing orderStatus from localStorage:",i),J(i)),n&&n!==fe&&Q(n))}},[k,O,fe]),c.useEffect(()=>{const e=localStorage.getItem(q)||"DINE_IN";let r=null;if(e==="TAKEAWAY"?r=localStorage.getItem("terra_orderId_TAKEAWAY"):r=localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),r&&r!==k&&(console.log("[Menu] Restoring activeOrderId on mount:",r,"serviceType:",e),H(r)),r&&!O){const i=e==="TAKEAWAY"&&localStorage.getItem("terra_orderStatus_TAKEAWAY")||localStorage.getItem("terra_orderStatus"),n=e==="TAKEAWAY"&&localStorage.getItem("terra_orderStatusUpdatedAt_TAKEAWAY")||localStorage.getItem("terra_orderStatusUpdatedAt");i&&(J(i),n&&Q(n))}},[]),c.useEffect(()=>{if(!k){X(null);return}let e=!1;return(async()=>{try{const i=await fetch(`${R}/api/orders/${k}`,{signal:AbortSignal.timeout(5e3)});if(!i.ok)return;const n=await i.json();if(e||!n)return;const u=localStorage.getItem(q)||"DINE_IN";if(n.serviceType&&n.serviceType!==u)return;X(n)}catch{}})(),()=>{e=!0}},[k,x]),c.useEffect(()=>{if(_.get("action")==="confirm"&&!ve){if(Ae||Object.keys(ye).length===0){console.error("[Menu] Auto-confirm aborted: Menu data missing or error",{menuCatalogSize:Object.keys(ye).length,menuError:Ae});const r=new URLSearchParams(_);r.delete("action"),C(r),alert(Ae?"Cannot place order automatically: "+Ae:"Cannot place order automatically: Menu prices not loaded. Please try again manually.");return}const e=new URLSearchParams(_);e.delete("action"),C(e),F(!0),Ht()}},[_,ve,ye,Ae]),t.jsxs("div",{className:`menu-root ${pe?"accessibility-mode":""}`,children:[t.jsx("div",{className:"background-image",style:{backgroundImage:`url(${Hr})`}}),t.jsx("div",{className:"overlay"}),t.jsx(Qr,{accessibilityMode:pe,onClickCart:()=>o("/cart"),cartCount:Mt}),t.jsx("div",{className:"content-wrapper",children:t.jsx("div",{className:"main-container",children:t.jsxs("div",{className:"panels-container",children:[t.jsxs("div",{className:"left-panel",children:[t.jsxs("div",{className:"order-header-section",children:[t.jsxs("div",{className:"order-header-info",children:[t.jsx("div",{className:"order-header-badge",children:x==="DINE_IN"?t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"order-header-icon",children:"📍"}),t.jsx("span",{children:U?.number?`${b("dineIn","Dine-In")} - ${b("table","Table")} ${U.number}`:b("dineIn","Dine-In")})]}):t.jsx("span",{children:b("takeaway","Takeaway")})}),x==="DINE_IN"&&t.jsxs("div",{className:"guest-count-badge",children:[t.jsx("span",{className:"guest-icon",children:"👥"}),t.jsx("span",{children:U?.seats||U?.capacity||2})]})]}),x==="TAKEAWAY"&&Qe&&t.jsxs("span",{className:"token-badge",children:[b("token","Token"),":"," ",t.jsx("strong",{children:Qe})]})]}),t.jsx("button",{type:"button",onClick:Cr,className:`voice-button ${Oe?"recording":""}`,"aria-pressed":Oe,"aria-label":xr,disabled:ve,children:Oe?t.jsx(qr,{}):t.jsx(Jr,{})}),t.jsx("p",{className:"instruction-text",children:ve?b("loadingMenu","Loading menu...")||"Loading menu...":gr?kr:Oe?Nr:wr}),!ve&&t.jsx("div",{className:"contact-us-row",style:{marginTop:"8px",fontSize:"13px",display:"flex",flexWrap:"wrap",gap:"8px",justifyContent:"center",alignItems:"center"},children:t.jsx("button",{type:"button",onClick:()=>o(`/contact-us${nt?`?cartId=${encodeURIComponent(nt)}`:""}`,{state:{cartId:nt||null,contact:Ir||null,hasCartContext:_r}}),className:"action-button",style:{minWidth:"160px",padding:"8px 14px"},children:b("contactUs","Contact us")})}),Tt&&t.jsxs("p",{className:"ai-ordered-text",children:[Tr," ",t.jsx("span",{className:"order-text-italic",children:Tt})]}),O&&t.jsxs("div",{className:"order-status-card",children:[t.jsx("h4",{className:"order-summary-title",children:"Order Status"}),x==="TAKEAWAY"&&Qe&&t.jsxs("div",{className:"mb-3 p-2 bg-blue-50 border border-blue-200 rounded-lg",children:[t.jsxs("div",{className:"text-sm font-semibold text-blue-700",children:["Your Token:"," ",t.jsx("span",{className:"text-lg font-bold",children:Qe})]}),t.jsx("div",{className:"text-xs text-blue-600 mt-1",children:"Please keep this token for reference"})]}),t.jsx("div",{className:"order-status-section",children:t.jsx(ka,{status:O,updatedAt:fe,reason:we?.cancellationReason||$?.cancellationReason,serviceType:x,tableLabel:x==="DINE_IN"&&U?.number?`Dine-In | Table ${U.number}`:null})}),Ce?.name&&t.jsxs("div",{className:"mt-3 p-3 bg-green-50 border border-green-200 rounded-lg text-center",children:[t.jsxs("p",{className:"text-green-800 font-medium",children:["Your order is being handled by ",Ce.name]}),Ce.role&&t.jsxs("p",{className:"text-sm text-gray-700 mt-1",children:["Role: ",Ce.role]}),Ce.disability&&t.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:["Disability Support: ",Ce.disability]})]}),t.jsxs("div",{className:"button-group status-actions",children:[(()=>{const e=(O||"").toLowerCase();return["paid","completed"].includes(e)&&ja.includes(O)?t.jsx("button",{className:"reset-button return-button",onClick:Mr,disabled:Nt,children:Nt?"Processing...":"Return Order"}):xa.includes(O)?t.jsx("button",{className:"reset-button cancel-button",onClick:Pr,disabled:wt,children:wt?"Cancelling...":"Cancel Order"}):O==="Returned"||O==="Cancelled"?t.jsx("button",{className:"billing-button billing-button-disabled",disabled:!0,children:O==="Returned"?"Order Returned":"Order Cancelled"}):null})(),["Pending","Placed","Confirmed","Preparing","Ready","Served","Finalized","Completed","Paid"].includes(O)?t.jsx("button",{className:"billing-button",onClick:ht,disabled:$t,children:$t?"Opening...":"View Invoice"}):null,t.jsx("button",{className:"confirm-button",onClick:Dr,disabled:tt||O&&!Ea.includes(O),children:tt?"Please wait...":"Order More"}),(()=>{const e=(O||"").toLowerCase();if(["Finalized","Completed"].includes(O))return t.jsx("button",{className:"billing-button",onClick:Wr,disabled:Et,children:Et?"Confirming...":"Confirm Payment"});if(O!=="Returned"&&O!=="Cancelled"&&!["paid","completed"].includes(e))return t.jsx("button",{className:"complete-payment-button",onClick:()=>{o("/billing")},children:"Payment"});if(["paid","completed"].includes(e)){const r=k||localStorage.getItem("terra_orderId")||localStorage.getItem("terra_lastPaidOrderId");return ir(r)?null:t.jsx("button",{className:"feedback-button",onClick:()=>{o("/feedback",{state:{orderId:r}})},children:"Share Feedback"})}return null})()]})]}),$&&t.jsxs("div",{className:"order-status-card previous-order-detail-card",style:{padding:"12px",fontSize:"0.9rem"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"8px"},children:[t.jsx("h4",{className:"order-summary-title",style:{margin:0,fontSize:"1rem"},children:"Last Order"}),$.status&&t.jsx("span",{className:"meta-chip status-chip",style:{fontSize:"0.75rem",padding:"4px 8px"},children:$.status})]}),t.jsxs("div",{style:{display:"flex",gap:"8px",marginBottom:"8px",flexWrap:"wrap",fontSize:"0.8rem"},children:[Vt&&t.jsx("span",{className:"meta-chip",style:{fontSize:"0.75rem",padding:"2px 6px"},children:Vt}),_t&&t.jsx("span",{className:"meta-chip",style:{fontSize:"0.75rem",padding:"2px 6px"},children:_t?_t.toLocaleDateString():"N/A"})]}),He?.name&&t.jsxs("div",{style:{marginBottom:"8px",padding:"8px",borderRadius:"8px",background:"#ecfdf5",border:"1px solid #bbf7d0",fontSize:"0.8rem"},children:[t.jsx("strong",{children:"Handled by:"})," ",He.name,He.role&&t.jsxs("span",{children:[" (",He.role,")"]})]}),t.jsx("div",{style:{marginBottom:"8px",fontSize:"0.85rem"},children:t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontWeight:"600"},children:[t.jsxs("span",{children:["Total: ₹",$e(Bt?.totalAmount||0)]}),t.jsxs("span",{children:[Bt?.totalItems||0," items"]})]})}),t.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[t.jsx("button",{className:"invoice-action-btn download w-full sm:w-auto",onClick:Yr,style:{padding:"6px 12px",fontSize:"0.85rem"},children:"View Invoice"}),$._id&&!ir($._id)&&t.jsx("button",{className:"feedback-button w-full sm:w-auto",onClick:()=>{const e=$._id;o("/feedback",{state:{orderId:e}})},style:{backgroundColor:"#10b981",color:"#ffffff",border:"1px solid #059669",fontWeight:"600",padding:"6px 12px",fontSize:"0.85rem"},children:"Feedback"})]})]})]}),t.jsxs("div",{className:"right-panel",children:[t.jsx("h3",{className:"manual-entry-title",children:Ar}),t.jsx("input",{type:"text",placeholder:Er,value:Le,onChange:e=>pr(e.target.value),className:"search-input"}),Ae&&!ve&&t.jsx("div",{className:"menu-warning",children:Ae}),ve?t.jsx("div",{className:"menu-loading-message",children:"Loading menu, please wait..."}):Le.trim()?Rt.length>0?t.jsx("div",{className:"search-results",children:Rt.map(e=>t.jsx(mr,{item:e,onAdd:qt,onRemove:Jt,count:le[e.name]||0,lang:V},e._id||e.name))}):t.jsx("div",{className:"search-no-results",children:"No matching items found. Try another keyword."}):t.jsx("div",{className:"category-container",children:be.length===0?t.jsx("div",{className:"search-no-results",children:"Menu is not configured yet. Please contact the administrator."}):t.jsx(t.Fragment,{children:(Array.isArray(be)?be:[]).map((e,r)=>t.jsx(Ka,{defaultOpen:r===0,category:e?.name||"Unnamed Category",items:Array.isArray(e?.items)?e.items:[],cart:le,onAdd:qt,onRemove:Jt,lang:V},e?._id||e?.name||Math.random()))})})]})]})})}),hr&&t.jsx("div",{className:"invoice-modal-overlay",onClick:Qt,children:t.jsxs("div",{className:"invoice-modal",role:"dialog","aria-modal":"true",onClick:e=>e.stopPropagation(),children:[t.jsxs("div",{className:"invoice-modal-header",children:[t.jsxs("div",{children:[t.jsx("h3",{children:"Invoice"}),y&&t.jsxs("div",{className:"invoice-meta",children:[t.jsx("span",{children:`Order #${y._id||"—"}`}),Ke&&t.jsx("span",{children:Ke.toLocaleString()})]})]}),t.jsxs("div",{className:"invoice-modal-actions",children:[t.jsx("button",{onClick:Kr,disabled:!y||Ve,className:"invoice-action-btn download",children:Ve?"Preparing…":"Download"}),t.jsx("button",{onClick:Qt,className:"invoice-close-btn","aria-label":"Close invoice modal",children:"✕"})]})]}),t.jsxs("div",{ref:Pe,className:"invoice-preview",children:[t.jsxs("div",{className:"invoice-top",children:[t.jsxs("div",{children:[t.jsx("div",{className:"brand-name",children:y?.cafe?.cafeName||y?.cafe?.name||"Terra Cart"}),t.jsx("div",{className:"brand-address",children:y?.cafe?.address||y?.franchise?.address||"—"}),(y?.franchise?.fssaiNumber||y?.franchise?.fssai||y?.cafe?.fssaiNumber||y?.cafe?.fssai)&&t.jsxs("div",{className:"brand-address",children:["FSSAI No:"," ",y.franchise?.fssaiNumber||y.franchise?.fssai||y.cafe?.fssaiNumber||y.cafe?.fssai]}),(y?.franchise?.gstNumber||y?.cafe?.gstNumber)&&t.jsxs("div",{className:"brand-address",children:["FSSAI No:"," ",y.franchise?.gstNumber||y.cafe?.gstNumber]})]}),t.jsxs("div",{className:"invoice-meta-block",children:[t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Invoice No:"}),t.jsx("span",{children:We||"—"})]}),y?.serviceType==="TAKEAWAY"&&y?.takeawayToken&&t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Token:"}),t.jsx("span",{className:"font-bold text-blue-600",children:y.takeawayToken})]}),Ke&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Date:"}),t.jsx("span",{children:Ke.toLocaleDateString()})]}),t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Time:"}),t.jsx("span",{children:Ke.toLocaleTimeString()})]})]})]})]}),t.jsxs("div",{className:"invoice-billed",children:[t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Service:"}),t.jsx("span",{children:yr})]}),t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Table:"}),t.jsxs("span",{children:[y?.serviceType==="TAKEAWAY"?"Takeaway Counter":vr||"—",Ft?` · ${Ft}`:""]})]}),y?.serviceType==="TAKEAWAY"&&(y.customerName||y.customerMobile)&&t.jsxs(t.Fragment,{children:[y.customerName&&t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Customer Name:"}),t.jsx("span",{children:y.customerName})]}),y.customerMobile&&t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Mobile Number:"}),t.jsx("span",{children:y.customerMobile})]})]}),y?.specialInstructions&&t.jsxs("div",{className:"meta-line",style:{marginTop:"8px",borderTop:"1px dashed #e5e7eb",paddingTop:"4px"},children:[t.jsx("span",{style:{color:"#d97706",fontWeight:"bold"},children:"Note:"}),t.jsx("span",{style:{fontStyle:"italic"},children:y.specialInstructions})]})]}),t.jsxs("table",{className:"invoice-table",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"Item"}),t.jsx("th",{children:"Qty"}),t.jsx("th",{children:"Price (₹)"}),t.jsx("th",{className:"align-right",children:"Amount (₹)"})]})}),t.jsx("tbody",{children:Je.length>0?Je.map(e=>t.jsxs("tr",{children:[t.jsx("td",{children:t.jsxs("div",{className:"flex flex-col gap-0.5",children:[t.jsx("span",{children:e.name}),e.returned&&t.jsxs("span",{className:"invoice-returned-note",children:["Returned ",e.returnedQuantity]})]})}),t.jsx("td",{children:e.quantity>0?e.quantity:"—"}),t.jsxs("td",{children:["₹",$e(e.unitPrice)]}),t.jsx("td",{className:"align-right",children:e.quantity>0?`₹${$e(e.amount)}`:"Returned"})]},e.name)):t.jsx("tr",{children:t.jsx("td",{colSpan:4,className:"empty-row",children:"No items found"})})})]}),t.jsxs("div",{className:"invoice-totals",children:[t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Total Items"}),t.jsx("span",{children:It.totalItems})]}),t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Subtotal"}),t.jsxs("span",{children:["₹",$e(It.subtotal)]})]}),t.jsxs("div",{className:"meta-line total",children:[t.jsx("span",{children:"Total"}),t.jsxs("span",{children:["₹",$e(It.totalAmount)]})]})]}),t.jsx("div",{className:"invoice-footer",children:"Thank you for dining with Terra Cart. We hope to see you again!"})]})]})}),br&&t.jsx("div",{className:"invoice-modal-overlay",onClick:()=>Ee(!1),children:t.jsxs("div",{className:"invoice-modal reason-modal",style:{maxWidth:"24rem",maxHeight:"auto",height:"auto"},onClick:e=>e.stopPropagation(),children:[t.jsxs("div",{className:"invoice-modal-header",children:[t.jsx("div",{children:t.jsx("h3",{children:xe==="Cancel"?"Cancel Order":"Return Order"})}),t.jsx("button",{onClick:()=>Ee(!1),className:"invoice-close-btn",children:"✕"})]}),t.jsxs("div",{style:{paddingTop:"0.25rem"},children:[t.jsx("p",{style:{marginTop:0,marginBottom:"0.5rem",fontSize:"0.9rem",color:"#666"},children:"Please provide a reason:"}),t.jsx("textarea",{style:{width:"100%",padding:"0.75rem",border:"1px solid #ddd",borderRadius:"0.5rem",minHeight:"100px",fontSize:"0.9rem",marginBottom:"1rem",fontFamily:"inherit",resize:"vertical",boxSizing:"border-box"},placeholder:"e.g. Changed my mind, Taking too long...",value:je,onChange:e=>ft(e.target.value)}),t.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:"0.5rem"},children:[t.jsx("button",{className:"reset-button",style:{width:"auto",flex:"1"},onClick:()=>Ee(!1),disabled:pt,children:"Close"}),t.jsx("button",{className:"confirm-button",style:{width:"auto",flex:"1"},onClick:Rr,disabled:pt,children:pt?"Processing...":"Confirm"})]})]})]})}),Object.keys(le).length>0&&!fr&&t.jsx("div",{className:"menu-cart-footer",children:t.jsxs("div",{className:"menu-cart-footer-inner",children:[t.jsxs("div",{style:{display:"flex",flexDirection:"column"},children:[t.jsxs("span",{style:{fontWeight:"bold",fontSize:"1.1rem",color:"#333"},children:[Mt," Items"]}),t.jsxs("span",{style:{color:"#666",fontSize:"0.9rem"},children:["Total: ₹",Sr.toFixed(2)]})]}),t.jsx("button",{onClick:()=>o("/cart"),style:{backgroundColor:"#ff6b35",color:"white",padding:"12px 24px",borderRadius:"50px",fontWeight:"bold",fontSize:"1rem",border:"none",cursor:"pointer",boxShadow:"0 4px 6px rgba(255, 107, 53, 0.3)"},children:"View Cart →"})]})}),t.jsx(Xr,{open:G,steps:ue,title:"Processing your order"})]})}const ro=Object.freeze(Object.defineProperty({__proto__:null,default:Ya},Symbol.toStringTag,{value:"Module"}));export{ro as M,ka as O};
