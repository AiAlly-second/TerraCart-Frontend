import{r as l,j as t,u as dr,c as ur,f as mr,a as gr,b as pr}from"./vendor-react-D1Ov3a92.js";import{r as _r,H as fr}from"./page-Billing.jsx-CvG5gaYx.js";import{a as Ir}from"./vendor-CB8mghnX.js";import{P as Sr,a as hr,b as br,p as xt,m as vr}from"./page-CartPage.jsx-BFJaz61i.js";/* empty css                          */import{l as yr}from"./vendor-socket-DJ_CsPWr.js";import{h as Ar,E as Tr}from"./vendor-pdf-KWoZMcRy.js";import{m as kr}from"./vendor-motion-DMcOTFRV.js";const wr="http://localhost:5050".replace(/\/$/,""),tt="translation_service_unavailable",rt="translation_service_check_timestamp",Nr=6e4,Er=()=>{try{const n=sessionStorage.getItem(tt),g=sessionStorage.getItem(rt);if(n==="true"&&g){const y=Date.now(),O=parseInt(g,10);if(y-O<Nr)return!0}}catch{}return!1},jt=()=>{try{sessionStorage.setItem(tt,"true"),sessionStorage.setItem(rt,Date.now().toString())}catch{}},xr=()=>{try{sessionStorage.removeItem(tt),sessionStorage.removeItem(rt)}catch{}},jr=async(n,g)=>{if(Er())return n;try{const y=await Ir.post(`${wr}/api/translate`,{text:n,targetLang:g},{validateStatus:()=>!0,timeout:1500,transformRequest:[O=>O],transformResponse:[O=>O]});if(y.status===200&&y.data?.translatedText){xr();const O=y.data.translatedText;return O.match(/as\s+"(.*?)"/)?.[1]||O||n}else return jt(),n}catch(y){return(y.code==="ECONNREFUSED"||y.code==="ERR_NETWORK"||y.code==="ECONNABORTED"||y.message==="Network Error"||y.message?.includes("ERR_CONNECTION_REFUSED")||y.message?.includes("timeout"))&&jt(),n}},Pt=n=>{const[g,y]=l.useState(n),[O,D]=l.useState(!1);return l.useEffect(()=>{const P=localStorage.getItem("language")||"en";P==="en"?(y(n),D(!1)):(D(!0),jr(n,P).then(_=>{y(_),D(!1)}).catch(_=>{y(n),D(!1)}))},[n]),[g,O]},Or={manualEntry:"Menu",smartServe:"Smart Serve",aiOrdered:"AI Ordered:",orderSummary:"Order Summary:",confirm:"Confirm",speakOrder:"Speak Order",processingVoice:"Processing your voice...",cartEmpty:"Cart is empty",resetOrder:"Reset Order",tapToStop:"Tap to Stop",tapToOrder:"Tap to Order",searchPlaceholder:"Search item...",resetOrderBtn:"Reset Order",recordVoiceAria:"Record voice order",processSteps:{checkingOrder:"Checking your order",confirmingItems:"Confirming items & price",placingOrder:"Placing your order",sendingToKitchen:"Sending to kitchen",preparingDetails:"Preparing order details"},dineIn:"Dine-In",table:"Table",takeaway:"Takeaway",callWaiter:"Call Waiter",requestWater:"Request Water",vegOnly:"Veg Only",popular:"Popular",spicy:"Spicy",token:"Token"},Cr={manualEntry:"मेनू",smartServe:"स्मार्ट सर्व",aiOrdered:"एआई द्वारा ऑर्डर:",orderSummary:"ऑर्डर सारांश:",confirm:"पुष्टि करें",speakOrder:"ऑर्डर सुनाएं",processingVoice:"आपकी आवाज़ प्रोसेस हो रही है...",cartEmpty:"कार्ट खाली है",resetOrder:"ऑर्डर रीसेट करें",tapToStop:"रोकने के लिए टैप करें",tapToOrder:"ऑर्डर करने के लिए टैप करें",searchPlaceholder:"आइटम खोजें...",resetOrderBtn:"ऑर्डर रीसेट करें",recordVoiceAria:"आवाज़ से ऑर्डर रिकॉर्ड करें",processSteps:{checkingOrder:"आपका ऑर्डर चेक कर रहे हैं",confirmingItems:"आइटम और कीमत की पुष्टि",placingOrder:"ऑर्डर प्लेस कर रहे हैं",sendingToKitchen:"किचन को भेज रहे हैं",preparingDetails:"ऑर्डर विवरण तैयार"},dineIn:"डाइन-इन",table:"टेबल",takeaway:"टेकअवे",callWaiter:"वेटर को बुलाएं",requestWater:"पानी मांगें",vegOnly:"केवल शाकाहारी",popular:"लोकप्रिय",spicy:"मसालेदार",token:"टोकन"},Dr={manualEntry:"मेनू",smartServe:"स्मार्ट सर्व",aiOrdered:"एआय ने ऑर्डर केले:",orderSummary:"ऑर्डर सारांश:",confirm:"निश्चित करा",speakOrder:"ऑर्डर बोला",processingVoice:"तुमचा आवाज प्रोसेस होत आहे...",cartEmpty:"कार्ट रिकामे आहे",resetOrder:"ऑर्डर रीसेट करा",tapToStop:"थांबवण्यासाठी टॅप करा",tapToOrder:"ऑर्डर करण्यासाठी टॅप करा",searchPlaceholder:"वस्तू शोधा...",resetOrderBtn:"ऑर्डर रीसेट करा",recordVoiceAria:"आवाज रेकॉर्ड करा",processSteps:{checkingOrder:"तुमची ऑर्डर तपासत आहे",confirmingItems:"वस्तू आणि किंमत निश्चित करत आहे",placingOrder:"ऑर्डर देत आहे",sendingToKitchen:"किचनला पाठवत आहे",preparingDetails:"ऑर्डर तपशील तयार"},dineIn:"डाइन-इन",table:"टेबल",takeaway:"टेकअवे",callWaiter:"वेटरला बोलवा",requestWater:"पाणी मागवा",vegOnly:"फक्त शाकाहारी",popular:"लोकप्रिय",spicy:"तिखट",token:"टोकन"},Pr={manualEntry:"મેનુ",smartServe:"સ્માર્ટ સર્વ",aiOrdered:"એઆઈ દ્વારા ઓર્ડર:",orderSummary:"ઓર્ડર સારાંશ:",confirm:"પુષ્ટિ કરો",speakOrder:"ઓર્ડર બોલો",processingVoice:"તમારો અવાજ પ્રોસેસ થઈ રહ્યો છે...",cartEmpty:"કાર્ટ ખાલી છે",resetOrder:"ઓર્ડર રીસેટ કરો",tapToStop:"રોકવા માટે ટૅપ કરો",tapToOrder:"ઓર્ડર કરવા માટે ટૅપ કરો",searchPlaceholder:"વસ્તુ શોધો...",resetOrderBtn:"ઓર્ડર રીસેટ કરો",recordVoiceAria:"અવાજ રેકોર્ડ કરો",processSteps:{checkingOrder:"તમારો ઓર્ડર તપાસી રહ્યા છીએ",confirmingItems:"વસ્તુઓ અને કિંમતની પુષ્ટિ",placingOrder:"ઓર્ડર આપી રહ્યા છીએ",sendingToKitchen:"કિચનમાં મોકલી રહ્યા છીએ",preparingDetails:"ઓર્ડર વિગતો તૈયાર"},dineIn:"ડાઇન-ઇન",table:"ટેબલ",takeaway:"ટેકઅવે",callWaiter:"વેટરને બોલાવો",requestWater:"પાણી મંગાવો",vegOnly:"માત્ર શાકાहारी",popular:"લોકપ્રિય",spicy:"મસાલેદાર",token:"ટોકન"},Mr={en:Or,hi:Cr,mr:Dr,gu:Pr},Wr={categories:{all_time_hit:"All Time Hit",mini_thali:"Mini Thali",fries:"Fries",starters:"Starters",veg_starters:"Veg Starters",tandoor_specials:"Tandoor Specials",maharashtrian:"Maharashtrian",punjabi:"Punjabi",paneer_specials:"Paneer Specials",rice:"Rice",roti:"Roti",dal:"Dal",chinese:"Chinese",thali:"Thali",desserts:"Desserts",beverages:"Beverages",street_snacks:"Street Snacks",north_indian_curries:"North Indian Curries",breads_rice:"Breads & Rice",regional_specials:"Regional Specials",desserts_beverages:"Desserts & Beverages",main_course:"Main Course"},items:{veg_sandwich:"Veg Sandwich",dosa:"Dosa",peanut_curry:"Peanut Curry",misal:"Misal",paneer_junglee_sandwich:"Paneer Junglee Sandwich",mumbai_sandwich:"Mumbai Sandwich",terra_wada_pav:"Terra Wada Pav",gluten_free_dosai:"Gluten Free Dosai",kothimbir_wadi:"Kothimbir Wadi",bombay_pav_bhaji:"Bombay Pav Bhaji",pizza_bomb:"Pizza Bomb",mini_batata_wada:"Mini Batata Wada",appe_chutney:"Appe & Chutney",namaste_misal_pav_dahi:"Namaste Misal Pav & Dahi",chola_kulcha:"Chola Kulcha",rajma_chawal:"Rajma Chawal",dal_makhni_jeera_rice:"Dal Makhni Jeera Rice",veg_korma_paratha:"Veg Korma & Malbori Paratha",dal_khichadi_dahi:"Dal Fry Rice / Dal Khichadi Dahi",schezwan_rice_manchurian:"Schezwan Rice & Manchurian",mumbai_vada_pav:"Mumbai Vada Pav",punjabi_samosa_chaat:"Punjabi Samosa Chaat",paneer_kathi_roll:"Paneer Kathi Roll",paneer_butter_masala:"Paneer Butter Masala",amritsari_chole:"Amritsari Chole",dal_tadka:"Dal Tadka",garlic_butter_naan:"Garlic Butter Naan",tandoori_roti:"Tandoori Roti",veg_dum_biryani:"Veg Dum Biryani",hyderabadi_chicken_65:"Hyderabadi Chicken 65",goan_fish_curry:"Goan Fish Curry",kerala_parotta_combo:"Kerala Parotta Combo",classic_gulab_jamun:"Classic Gulab Jamun",kulfi_falooda:"Kulfi Falooda",masala_chaas:"Masala Chaas"}},Rr={categories:{all_time_hit:"हमेशा पसंदीदा",mini_thali:"मिनी थाली",fries:"फ्राइज़",starters:"स्टार्टर्स",veg_starters:"शाकाहारी स्टार्टर",tandoor_specials:"तंदूरी स्पेशल",maharashtrian:"महाराष्ट्रीयन",punjabi:"पंजाबी",paneer_specials:"पनीर स्पेशल",rice:"चावल",roti:"रोटी",dal:"दाल",chinese:"चाइनीज़",thali:"थाली",desserts:"मिठाई",beverages:"पेय",street_snacks:"स्ट्रीट स्नैक्स",north_indian_curries:"उत्तर भारतीय करी",breads_rice:"रोटियाँ और चावल",regional_specials:"क्षेत्रीय विशेष",desserts_beverages:"डेसर्ट और पेय",main_course:"मुख्य भोजन"},items:{veg_sandwich:"वेज सैंडविच",dosa:"डोसा",peanut_curry:"पीनट करी",misal:"मिसल",paneer_junglee_sandwich:"पनीर जंगली सैंडविच",mumbai_sandwich:"मुंबई सैंडविच",terra_wada_pav:"टेरा वडा पाव",gluten_free_dosai:"ग्लूटेन फ्री डोसा",kothimbir_wadi:"कोथिंबीर वड़ी",bombay_pav_bhaji:"बॉम्बे पाव भाजी",pizza_bomb:"पिज़्ज़ा बॉम्ब",mini_batata_wada:"मिनी बटाटा वडा",appe_chutney:"अप्पे और चटनी",namaste_misal_pav_dahi:"नमस्ते मिसल पाव और दही",chola_kulcha:"छोला कुलचा",rajma_chawal:"राजमा चावल",dal_makhni_jeera_rice:"दाल मखनी जीरा चावल",veg_korma_paratha:"वेज कोरमा और पराठा",dal_khichadi_dahi:"दाल खिचड़ी दही",schezwan_rice_manchurian:"सिचुआन चावल और मंचूरियन",mumbai_vada_pav:"मुंबई वडा पाव",punjabi_samosa_chaat:"पंजाबी समोसा चाट",paneer_kathi_roll:"पनीर काठी रोल",paneer_butter_masala:"पनीर बटर मसाला",amritsari_chole:"अमृतसरी छोले",dal_tadka:"दाल तड़का",garlic_butter_naan:"गार्लिक बटर नान",tandoori_roti:"तंदूरी रोटी",veg_dum_biryani:"वेज दम बिरयानी",hyderabadi_chicken_65:"हैद्राबादी चिकन 65",goan_fish_curry:"गोअन फिश करी",kerala_parotta_combo:"केरल परोटा कॉम्बो",classic_gulab_jamun:"क्लासिक गुलाब जामुन",kulfi_falooda:"कुल्फी फालूदा",masala_chaas:"मसाला छाछ"}},Kr={categories:{all_time_hit:"सर्वकालीन हिट",mini_thali:"मिनी थाळी",fries:"फ्राईज",starters:"स्टार्टर्स",veg_starters:"व्हेज स्टार्टर",tandoor_specials:"तंदूर स्पेशल",maharashtrian:"महाराष्ट्रीयन",punjabi:"पंजाबी",paneer_specials:"पनीर स्पेशल",rice:"भात",roti:"पोळी",dal:"डाळ",chinese:"चायनीज",thali:"थाळी",desserts:"गोड पदार्थ",beverages:"पेय",street_snacks:"स्ट्रीट स्नॅक्स",north_indian_curries:"उत्तर भारतीय करी",breads_rice:"पोळी आणि भात",regional_specials:"प्रादेशिक स्पेशल",desserts_beverages:"डेझर्ट आणि पेय",main_course:"मुख्य जेवण"},items:{veg_sandwich:"व्हेज सँडविच",dosa:"डोसा",peanut_curry:"शेंगदाणा आमटी",misal:"मिसळ",paneer_junglee_sandwich:"पनीर जंगलि सँडविच",mumbai_sandwich:"मुंबई सँडविच",terra_wada_pav:"टेरा वडा पाव",gluten_free_dosai:"ग्लूटेन फ्री डोसा",kothimbir_wadi:"कोथिंबीर वडी",bombay_pav_bhaji:"बॉम्बे पाव भाजी",pizza_bomb:"पिझ्झा बॉम्ब",mini_batata_wada:"मिनी बटाटा वडा",appe_chutney:"अप्पे आणि चटणी",namaste_misal_pav_dahi:"नमस्ते मिसळ पाव आणि दही",chola_kulcha:"छोला कुलचा",rajma_chawal:"राजमा भात",dal_makhni_jeera_rice:"डाळ मखनी जिरा भात",veg_korma_paratha:"व्हेज कोरमा आणि पराठा",dal_khichadi_dahi:"डाळ खिचडी दही",schezwan_rice_manchurian:"सिचुआन भात आणि मंचुरियन",mumbai_vada_pav:"मुंबई वडा पाव",punjabi_samosa_chaat:"पंजाबी समोसा चाट",paneer_kathi_roll:"पनीर काठी रोल",paneer_butter_masala:"पनीर बटर मसाला",amritsari_chole:"अमृतसरी छोले",dal_tadka:"दाल तडका",garlic_butter_naan:"गार्लिक बटर नान",tandoori_roti:"तंदूरी रोटी",veg_dum_biryani:"व्हेज दम बिर्याणी",hyderabadi_chicken_65:"हैद्राबादी चिकन 65",goan_fish_curry:"गोअन फिश करी",kerala_parotta_combo:"केरळ परोटा कॉम्बो",classic_gulab_jamun:"क्लासिक गुलाब जामुन",kulfi_falooda:"कुल्फी फालूदा",masala_chaas:"मसाला ताक"}},Yr={categories:{all_time_hit:"Succès intemporel",mini_thali:"Mini Thali",fries:"Frites",starters:"Entrées",veg_starters:"Entrées végétariennes",tandoor_specials:"Spécialités Tandoor",maharashtrian:"Maharashtrien",punjabi:"Punjabi",paneer_specials:"Spécial Paneer",rice:"Riz",roti:"Pain",dal:"Lentilles",chinese:"Chinois",thali:"Thali",desserts:"Desserts",beverages:"Boissons"},items:{veg_sandwich:"Sandwich Végétarien",paneer_junglee_sandwich:"Sandwich Paneer Junglee",mumbai_sandwich:"Sandwich Mumbai",terra_wada_pav:"Terra Wada Pav",gluten_free_dosai:"Dosai sans gluten",kothimbir_wadi:"Kothimbir Wadi",bombay_pav_bhaji:"Pav Bhaji de Bombay",pizza_bomb:"Pizza Bomb",mini_batata_wada:"Mini Batata Wada",appe_chutney:"Appe & Chutney",namaste_misal_pav_dahi:"Namaste Misal Pav & Yaourt",chola_kulcha:"Chola Kulcha",rajma_chawal:"Rajma Chawal",dal_makhni_jeera_rice:"Dal Makhni Riz au Cumin",veg_korma_paratha:"Korma Végétarien & Paratha",dal_khichadi_dahi:"Dal Khichadi & Yaourt",schezwan_rice_manchurian:"Riz Schezwan & Manchurian"}},$r={categories:{all_time_hit:"ઓલ ટાઇમ હિટ",mini_thali:"મિની થાળી",fries:"ફ્રાઈસ",starters:"સ્ટાર્ટર્સ",veg_starters:"વેજ સ્ટાર્ટર્સ",tandoor_specials:"તંદૂર સ્પેશિયલ",maharashtrian:"મહારાષ્ટ્રીયન",punjabi:"પંજાબી",paneer_specials:"પનીર સ્પેશિયલ",rice:"ભાત",roti:"રોટલી",dal:"દાળ",chinese:"ચાઈનીઝ",thali:"થાળી",desserts:"મીઠાઈ",beverages:"પીણાં",street_snacks:"સ્ટ્રીટ સ્નેક્સ",north_indian_curries:"ઉત્તર ભારતીય કરી",breads_rice:"રોટલી અને ભાત",regional_specials:"પ્રાદેશિક સ્પેશિયલ",desserts_beverages:"ડેઝર્ટ અને પીણાં",main_course:"મુખ્ય ભોજન"},items:{veg_sandwich:"વેજ સેન્ડવીચ",dosa:"ઢોસા",peanut_curry:"સીંગની કઢી",misal:"મિસળ",paneer_junglee_sandwich:"પનીર જંગલી સેન્ડવીચ",mumbai_sandwich:"મુંબઈ સેન્ડવીચ",terra_wada_pav:"ટેરા વડા પાવ",gluten_free_dosai:"ગ્લુટેન ફ્રી ઢોસા",kothimbir_wadi:"કોથમીર વડી",bombay_pav_bhaji:"બોમ્બે પાવ ભાજી",pizza_bomb:"પીઝા બોમ્બ",mini_batata_wada:"મિની બટાટા વડા",appe_chutney:"અપ્પે અને ચટણી",namaste_misal_pav_dahi:"નમસ્તે મિસળ પાવ અને દહીં",chola_kulcha:"છોલે કુલચા",rajma_chawal:"રાજમા ચાવલ",dal_makhni_jeera_rice:"દાલ મખની જીરા રાઇસ",veg_korma_paratha:"વેજ કોરમા અને પરાઠા",dal_khichadi_dahi:"દાલ ખીચડી દહીં",schezwan_rice_manchurian:"શેઝવાન રાઇસ અને મંચુરિયન",mumbai_vada_pav:"મુંબઈ વડા પાવ",punjabi_samosa_chaat:"પંજાબી સમોસા ચાટ",paneer_kathi_roll:"પનીર કાઠી રોલ",paneer_butter_masala:"પનીર બટર મસાલા",amritsari_chole:"અમૃતસરી છોલે",dal_tadka:"દાલ તડકા",garlic_butter_naan:"ગાર્લિક બટર નાન",tandoori_roti:"તંદૂરી રોટી",veg_dum_biryani:"વેજ દમ બિરયાની",hyderabadi_chicken_65:"હૈદરાબાદી ચિકન 65",goan_fish_curry:"ગોલ્ડન ફિશ કરી",kerala_parotta_combo:"કેરળ પરોટા કોમ્બો",classic_gulab_jamun:"ક્લાસિક ગુલાબ જાંબુ",kulfi_falooda:"કુલ્ફી ફાલુદા",masala_chaas:"મસાલા છાશ"}},Ye={en:Wr,hi:Rr,mr:Kr,fr:Yr,gu:$r},Ur={DINE_IN:[{key:"placed",label:"Order Placed"},{key:"preparing",label:"Preparing"},{key:"done",label:"Done"}],TAKEAWAY:[{key:"placed",label:"Order Placed"},{key:"preparing",label:"Preparing"},{key:"done",label:"Done"}]},Lr={Pending:0,Confirmed:0,Preparing:1,Ready:1,Served:1,Finalized:1,Paid:2,Cancelled:-1,Returned:-1},Fr={Pending:0,Confirmed:0,Accept:1,Accepted:1,"Being Prepared":1,BeingPrepared:1,Completed:1,Paid:2,Exit:2,Cancelled:-1,Returned:-1};function qr(n){return Ur[n==="TAKEAWAY"?"TAKEAWAY":"DINE_IN"]}function zr(n){if(n==null||n==="")return"Pending";const g=String(n).trim();return g==="Accept"?"Accepted":g==="BeingPrepared"?"Being Prepared":g}function Br(n,g){const y=(n??"").toString().trim();if(g==="TAKEAWAY"){const D=zr(y),P=Fr[D];return P!==void 0&&P>=0?P:0}const O=Lr[y];return O!==void 0&&O>=0?O:0}function Vr({status:n="Pending",className:g="",updatedAt:y,serviceType:O="DINE_IN",tableLabel:D}){const P=qr(O),_=n??"Pending",$=Br(_,O),R=y?new Date(y).toLocaleTimeString():null;return["Cancelled","Returned"].includes(_)?t.jsx("div",{className:`order-status-timeline ${g}`,children:t.jsxs("div",{className:"order-status-timeline-step order-status-step-completed",children:[t.jsx("div",{className:"order-status-dot order-status-dot-completed"}),t.jsxs("div",{className:"order-status-step-content",children:[t.jsx("span",{className:"order-status-step-label",children:_}),R&&t.jsxs("span",{className:"order-status-step-meta",children:["Updated ",R]})]})]})}):t.jsxs("div",{className:`order-status-timeline ${g}`,children:[R&&t.jsxs("div",{className:"order-status-updated-meta",children:["Updated ",R]}),P.map((Q,re)=>{const U=re<$,ie=re===$,ae=re>$,H=re===P.length-1,ne=re===0&&D?D:Q.label;return t.jsx("div",{className:"order-status-timeline-step-wrapper",children:t.jsxs("div",{className:"order-status-timeline-step",children:[t.jsxs("div",{className:"order-status-step-left",children:[t.jsx("div",{className:`order-status-dot ${U?"order-status-dot-completed":""} ${ie?"order-status-dot-active":""} ${ae?"order-status-dot-pending":""}`,children:U&&t.jsx("svg",{className:"order-status-check",viewBox:"0 0 12 12",fill:"none",stroke:"white",strokeWidth:"2.5",strokeLinecap:"round",children:t.jsx("path",{d:"M2 6l3 3 5-6"})})}),!H&&t.jsx("div",{className:"order-status-line"})]}),t.jsxs("div",{className:"order-status-step-content",children:[t.jsx("span",{className:`order-status-step-label ${ie?"order-status-step-label-active":""} ${ae?"order-status-step-label-pending":""}`,children:ne}),ie&&R&&t.jsxs("span",{className:"order-status-step-meta",children:["Updated ",R]})]})]})},Q.key)})]})}const M="https://api.terracart.in".replace(/\/$/,""),Jr=n=>n?n.startsWith("http://")||n.startsWith("https://")?n:n.startsWith("/")?`${M}${n}`:`${M}/uploads/${n}`:"/defaultImg.jpg",F="terra_serviceType",ve="terra_selectedTable",Qr=["Pending","Confirmed","Preparing","Ready","Served","Completed","Paid","Returned","Cancelled"],Hr=["Pending","Confirmed","Preparing","Ready","Served","Finalized","Completed"],Gr=["Paid"],Xr=n=>{if(n==null)return 0;const g=Number(n);return Number.isNaN(g)?0:g/100},Ee=n=>{const g=Number(n);return Number.isNaN(g)?"0.00":g.toFixed(2)},Ot=n=>{if(!n)return"INV-NA";const g=new Date(n.createdAt||Date.now()).toISOString().slice(0,10).replace(/-/g,""),y=(n.cartId||n._id||"").toString().slice(-6).toUpperCase();return`INV-${g}-${y}`},et=n=>{if(!n)return[];const g=new Map;return(Array.isArray(n.kotLines)?n.kotLines:[]).forEach(D=>{(D?.items||[]).forEach(P=>{if(!P)return;const _=P.name||"Item",$=Number(P.quantity)||0,R=Xr(P.price||0),K=!!P.returned;g.has(_)||g.set(_,{name:_,unitPrice:R,activeQuantity:0,returnedQuantity:0,totalQuantity:0,amount:0,returned:!1});const Q=g.get(_);Q.totalQuantity+=$,K?(Q.returnedQuantity+=$,Q.returned=!0):(Q.activeQuantity+=$,Q.amount+=R*$),Q.unitPrice||(Q.unitPrice=R)})}),(n.selectedAddons||[]).forEach(D=>{const P=`(+) ${D.name}`,_=1,$=Number(D.price)||0;g.has(P)||g.set(P,{name:P,unitPrice:$,activeQuantity:0,returnedQuantity:0,totalQuantity:0,amount:0,returned:!1});const R=g.get(P);R.totalQuantity+=_,R.activeQuantity+=_,R.amount+=$*_}),Array.from(g.values()).map(D=>({...D,quantity:D.activeQuantity}))},Ct=(n,g)=>{if(!n)return{subtotal:0,gst:0,totalAmount:0,totalItems:0};const y=Array.isArray(g)?g:et(n)||[],O=y.reduce(($,R)=>{if(!R)return $;const K=Number(R.amount)||0;return $+K},0),D=Number(O.toFixed(2));return{subtotal:D,gst:0,totalAmount:D,totalItems:y.reduce(($,R)=>R?$+(Number(R.quantity)||0):$,0)}},Dt=n=>{if(!n)return null;const g=n.paidAt||n.updatedAt||n.createdAt;if(!g)return null;const y=new Date(g);return Number.isNaN(y.getTime())?null:y},Zr=n=>{const g={};return n.forEach(y=>{(y.items||[]).forEach(O=>{g[O.name]=O})}),g},Mt=({item:n,onAdd:g,onRemove:y,count:O,lang:D})=>{if(!n)return null;const P=D||localStorage.getItem("language")||"en";let _=null;if(Ye[P]?.items){const Q=n.name?.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"");_=Ye[P].items[Q]}const[$]=Pt(n.name||""),R=_||$,K=n.isAvailable!==!1;return t.jsxs(kr.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.5},className:`item-card group ${K?"":"unavailable"}`,children:[t.jsx("div",{className:"item-image-container",children:t.jsx("img",{src:Jr(n?.image),alt:n?.name||"Menu item",className:"item-image"})}),t.jsxs("div",{className:"item-info-section",children:[t.jsx("h4",{className:"item-name",children:R||n?.name||"Unnamed Item"}),t.jsxs("p",{className:"item-price",children:["₹",n?.price||0]}),!K&&t.jsx("span",{className:"item-status-badge unavailable",children:"Not available"})]}),t.jsx("div",{className:"item-footer",children:t.jsxs("div",{className:"item-controls",children:[t.jsx("button",{"aria-label":`Remove one ${n?.name||"item"}`,className:"quantity-button",onClick:()=>n?.name&&y(n.name),disabled:!O,children:"-"}),t.jsx("span",{className:"item-count",children:O||0}),t.jsx("button",{"aria-label":`Add one ${n?.name||"item"}`,className:`quantity-button ${K?"":"disabled"}`,onClick:()=>n&&g(n),disabled:!K,title:K?void 0:"Currently unavailable",children:"+"})]})})]})},ea=({category:n,items:g,cart:y,onAdd:O,onRemove:D,lang:P,defaultOpen:_=!1})=>{if(!n)return null;const $=P||localStorage.getItem("language")||"en";let R=null;if(Ye[$]?.categories){const ae=n?.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"");R=Ye[$].categories[ae]}const[K]=Pt(n||""),Q=R||K,[re,U]=l.useState(_),ie=Array.isArray(g)?g:[];return t.jsxs("div",{className:"category-wrapper",children:[t.jsxs("button",{onClick:()=>U(ae=>!ae),className:"category-button",children:[Q||n," ",t.jsx("span",{children:re?"▲":"▼"})]}),re&&t.jsx("div",{className:"category-items",children:ie.map((ae,H)=>t.jsx(Mt,{item:ae,onAdd:O,onRemove:D,count:y[ae?.name]||0,lang:$},ae?._id||`${n}-${H}`))})]})};function ta(){const n=dr(),g=ur(),[y,O]=mr(),[D,P]=l.useState(localStorage.getItem("language")||"en");l.useEffect(()=>{const e=()=>{P(localStorage.getItem("language")||"en")};return window.addEventListener("storage",e),window.addEventListener("language-change",e),()=>{window.removeEventListener("storage",e),window.removeEventListener("language-change",e)}},[]);const _=(e,r)=>{if(!e)return r;const s=e.split(".");let o=Mr[D];for(const u of s)o=o?.[u];return o||r},$=[{label:_("processSteps.checkingOrder","Checking your order"),state:"pending"},{label:_("processSteps.confirmingItems","Confirming items & price"),state:"pending"},{label:_("processSteps.placingOrder","Placing your order"),state:"pending"},{label:_("processSteps.sendingToKitchen","Sending to kitchen"),state:"pending"},{label:_("processSteps.preparingDetails","Preparing order details"),state:"pending"}],[R,K]=l.useState(!1),[Q,re]=l.useState($),U=(e,r)=>re(s=>s.map((o,u)=>u===e?{...o,state:r}:o)),[ie,ae]=l.useState(localStorage.getItem("accessibilityMode")==="true"),[H,ne]=l.useState(()=>{const e=localStorage.getItem("terra_cart");return e?JSON.parse(e):{}});l.useEffect(()=>{localStorage.setItem("terra_cart",JSON.stringify(H))},[H]);const[ye,de]=l.useState(!1),[at,xe]=l.useState(""),[Wt,je]=l.useState(!1),[$e,ot]=l.useState(!1),[st,Ue]=l.useState(!1),[nt,Le]=l.useState(!1),[lt,it]=l.useState(!1),[ct,ue]=l.useState(!1),[ra,dt]=l.useState(null),[Rt,aa]=l.useState(!1),[Oe,Kt]=l.useState(""),[me,ut]=l.useState([]),[ge,mt]=l.useState({}),[_e,Fe]=l.useState(!0),[pe,gt]=l.useState(null),oe=l.useMemo(()=>!Array.isArray(me)||me.length===0?[]:me.flatMap(e=>e?(Array.isArray(e.items)?e.items:[]).map(r=>({...r,categoryName:e?.name||"Menu"})):[]),[me]),{cartTotal:Yt,cartItemCount:pt}=l.useMemo(()=>{let e=0,r=0;return Object.entries(H).forEach(([s,o])=>{r+=o;const u=oe.find(d=>d.name===s);u&&(e+=(u.price||0)*o)}),{cartTotal:e,cartItemCount:r}},[H,oe]),_t=l.useMemo(()=>{const e=Oe.trim().toLowerCase();return e?!Array.isArray(oe)||oe.length===0?[]:oe.filter(r=>r?.name?r.name.toLowerCase().includes(e)||(r.description||"").toLowerCase().includes(e)||(r.tags||[]).some(s=>s&&s.toLowerCase().includes(e)):!1):[]},[oe,Oe]),fe=l.useRef(null),Ae=l.useRef(null),[T,q]=l.useState(()=>{const e=localStorage.getItem(F)||"DINE_IN";let r=null;return e==="TAKEAWAY"?r=localStorage.getItem("terra_orderId_TAKEAWAY"):r=localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),r||null}),[N,z]=l.useState(()=>(localStorage.getItem(F)||"DINE_IN")==="TAKEAWAY"&&localStorage.getItem("terra_orderStatus_TAKEAWAY")||localStorage.getItem("terra_orderStatus")||null),[le,J]=l.useState(()=>(localStorage.getItem(F)||"DINE_IN")==="TAKEAWAY"&&localStorage.getItem("terra_orderStatusUpdatedAt_TAKEAWAY")||localStorage.getItem("terra_orderStatusUpdatedAt")||null),[j,Te]=l.useState(()=>localStorage.getItem("terra_takeaway_only")==="true"?"TAKEAWAY":localStorage.getItem(F)||"DINE_IN"),[Y,qe]=l.useState(()=>{try{const e=localStorage.getItem(ve);return e?JSON.parse(e):null}catch(e){return console.warn("Invalid table selection cache",e),null}}),[Ce,G]=l.useState(()=>localStorage.getItem("terra_sessionToken"));l.useEffect(()=>{(async()=>{if((localStorage.getItem(F)||"DINE_IN")==="TAKEAWAY")return;const s=localStorage.getItem("terra_orderId"),o=localStorage.getItem("terra_sessionToken");if(!(!s||!o))try{const u=await fetch(`${M}/api/orders/${s}`);if(!u.ok){u.status===404?(console.log("[Menu] Active order not found (404), clearing order data"),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"),q(null),z(null),J(null)):console.warn("[Menu] Error verifying order (non-404), keeping existing status:",u.status);return}let d;try{d=await u.json()}catch(c){console.error("[Menu] Failed to parse order response as JSON:",c);return}if(!d)return;d.sessionToken&&d.sessionToken!==o&&(console.log("[Menu] Clearing stale dine-in order data for old session"),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_previousOrder"),localStorage.removeItem("terra_previousOrderDetail"),q(null),z(null),J(null))}catch(u){console.warn("[Menu] Error verifying active order session (network error), keeping existing status:",u)}})()},[]),l.useEffect(()=>{const e=localStorage.getItem("terra_sessionToken"),r=Ce,s=localStorage.getItem(F)||"DINE_IN";e&&r&&e!==r&&(s!=="TAKEAWAY"&&(console.log("[Menu] SessionToken changed - clearing old dine-in order data"),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_previousOrder"),localStorage.removeItem("terra_previousOrderDetail"),localStorage.removeItem("terra_lastPaidOrderId"),localStorage.removeItem("terra_cart_DINE_IN"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN"),q(null),z(null),J(null)),G(e))},[Ce]),l.useEffect(()=>{const e=localStorage.getItem(F)||"DINE_IN";let r=null;e==="TAKEAWAY"?r=localStorage.getItem("terra_orderId_TAKEAWAY"):r=localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),r&&r!==T?q(r):!r&&T&&q(null)},[j,T]),l.useEffect(()=>{},[j,n]);const[oa]=l.useState(()=>localStorage.getItem("terra_takeaway_customerName")||""),[sa]=l.useState(()=>localStorage.getItem("terra_takeaway_customerMobile")||""),[na]=l.useState(()=>localStorage.getItem("terra_takeaway_customerEmail")||""),[ke,ft]=l.useState(()=>{try{const e=localStorage.getItem("terra_previousOrder");return e?JSON.parse(e):null}catch(e){return console.warn("Invalid previous order cache",e),localStorage.removeItem("terra_previousOrder"),null}}),[W,It]=l.useState(()=>{try{const e=localStorage.getItem("terra_previousOrderDetail");return e?JSON.parse(e):null}catch(e){return console.warn("Invalid previous order detail cache",e),localStorage.removeItem("terra_previousOrderDetail"),null}}),[$t,ze]=l.useState(!1),[S,Be]=l.useState(null),[St,De]=l.useState(!1),[Ve,Ie]=l.useState(!1),[Pe,Je]=l.useState(!1),[Ut,Se]=l.useState(!1),[he,ht]=l.useState(null),[Me,Qe]=l.useState(""),[He,bt]=l.useState(!1),se=l.useCallback(e=>{e?(ft(e),localStorage.setItem("terra_previousOrder",JSON.stringify(e))):(ft(null),localStorage.removeItem("terra_previousOrder"))},[]),Z=l.useCallback(e=>{e?(It(e),localStorage.setItem("terra_previousOrderDetail",JSON.stringify(e))):(It(null),localStorage.removeItem("terra_previousOrderDetail"))},[]),We=l.useCallback((e={})=>{const r=e.orderId||T;if(!r)return;const s=e.status||N||"Confirmed",o=e.updatedAt||le||new Date().toISOString(),u=e.tableInfo||Y||(()=>{try{const k=localStorage.getItem(ve);return k?JSON.parse(k):null}catch{return null}})(),d=e.tableNumber??u?.number??u?.tableNumber??null,c=e.tableSlug??u?.qrSlug??localStorage.getItem("terra_scanToken")??null;se({orderId:r,status:s,updatedAt:o,tableNumber:d,tableSlug:c})},[T,N,le,Y,se]),we=l.useMemo(()=>S?Ot(S):null,[S]),Re=l.useMemo(()=>et(S),[S]),Ge=l.useMemo(()=>S?Ct(S,Re):{subtotal:0,gst:0,totalAmount:0,totalItems:0},[S,Re]),Lt=l.useMemo(()=>S?S.serviceType==="TAKEAWAY"?"Takeaway":"Dine-In":"",[S]),Ft=S?.table?.number??S?.tableNumber??null,vt=S?.table?.name??null,Ne=l.useMemo(()=>Dt(S),[S]),yt=l.useMemo(()=>et(W),[W]),At=l.useMemo(()=>W?Ct(W,yt):{subtotal:0,gst:0,totalAmount:0,totalItems:0},[W,yt]),Xe=l.useMemo(()=>Dt(W),[W]),Tt=l.useMemo(()=>W?Ot(W):null,[W]),qt=_("manualEntry","Menu");_("smartServe","Smart Serve");const zt=_("aiOrdered","AI Ordered:");_("orderSummary","Order Summary:"),_("confirm","Confirm"),_("speakOrder","Speak Order");const Bt=_("processingVoice","Processing your voice..."),Vt=_("cartEmpty","Cart is empty");_("resetOrderBtn","Reset Order");const Jt=_("tapToOrder","Tap to Order"),Qt=_("tapToStop","Tap to Stop"),Ht=_("searchPlaceholder","Search item..."),Gt=_("recordVoiceAria","Record voice order");l.useEffect(()=>{N?localStorage.setItem("terra_orderStatus",N):localStorage.removeItem("terra_orderStatus"),le?localStorage.setItem("terra_orderStatusUpdatedAt",le):localStorage.removeItem("terra_orderStatusUpdatedAt")},[N,le]),l.useEffect(()=>{N&&T&&ke&&se(null),N&&T&&W&&Z(null)},[N,T,ke,W,se,Z]),l.useEffect(()=>{if(!ke&&!W)return;const e=localStorage.getItem("terra_scanToken"),r=ke?.tableSlug;if(r&&e&&r!==e){se(null),Z(null);return}!r&&W?.table?.qrSlug&&e&&W.table.qrSlug!==e&&(se(null),Z(null))},[ke,W,se,Z]),l.useEffect(()=>{const e=localStorage.getItem(F),r=localStorage.getItem("terra_takeaway_only")==="true";if((localStorage.getItem("terra_orderId_TAKEAWAY")||r)&&e!=="TAKEAWAY"){console.log("[Menu] Detected takeaway order or takeaway-only mode on refresh, setting serviceType to TAKEAWAY"),Te("TAKEAWAY"),localStorage.setItem(F,"TAKEAWAY");return}g.state?.serviceType?(Te(g.state.serviceType),localStorage.setItem(F,g.state.serviceType)):e?Te(e):r&&(console.log("[Menu] Detected takeaway-only QR flow, setting serviceType to TAKEAWAY"),Te("TAKEAWAY"),localStorage.setItem(F,"TAKEAWAY")),g.state?.table&&(qe(g.state.table),localStorage.setItem(ve,JSON.stringify(g.state.table)))},[g.state,Te]),l.useEffect(()=>{let e=!1;const r=async()=>{if((localStorage.getItem(F)||g.state?.serviceType||"DINE_IN")!=="DINE_IN")return!0;const d=localStorage.getItem("terra_orderId")||localStorage.getItem("terra_orderId_DINE_IN"),c=localStorage.getItem("terra_orderStatus")||localStorage.getItem("terra_orderStatus_DINE_IN"),k=d&&c&&!["Paid","Cancelled","Returned","Completed"].includes(c);if(k&&d)try{const I=await fetch(`${M}/api/orders/${d}`);if(I.ok){const h=await I.json();if(h.status&&!["Paid","Cancelled","Returned","Completed"].includes(h.status))return console.log("[Menu] User has verified active order - allowing access, skipping waitlist check"),!0}}catch(I){if(console.warn("[Menu] Failed to verify order on backend:",I),k)return console.log("[Menu] Order verification failed but order exists in storage - allowing access"),!0}const w=localStorage.getItem("terra_sessionToken"),A=localStorage.getItem("terra_selectedTable");if(w&&A)try{const I=JSON.parse(A);if(I.sessionToken===w)return console.log("[Menu] User has matching sessionToken - allowing access, skipping waitlist check"),!0;const h=I.qrSlug||localStorage.getItem("terra_scanToken");if(h)try{const v=await fetch(`${M}/api/tables/lookup/${h}?sessionToken=${w}`);if(v.ok){const m=await v.json();if(m?.table?.sessionToken===w||m?.table?.activeOrder)return console.log("[Menu] Backend confirms user owns table session - allowing access"),!0}}catch(v){if(console.warn("[Menu] Failed to verify table session on backend:",v),I.sessionToken===w)return!0}}catch(I){console.warn("[Menu] Failed to check sessionToken:",I)}const a=localStorage.getItem("terra_waitToken");if(k&&a)return console.log("[Menu] User has active order but also has waitlist token - clearing waitlist token"),localStorage.removeItem("terra_waitToken"),!0;if(!a)return!0;try{const I=await fetch(`${M}/api/waitlist/status?token=${a}`);if(I.ok){const h=await I.json();if(h.status==="WAITING")return console.log("[Menu] User is in WAITING status - blocking menu access"),alert("You are currently in the waitlist. Please wait for your turn. You will be notified when the table is ready."),n("/secondpage"),!1;if(h.status==="NOTIFIED"||h.status==="SEATED")return!0}}catch(I){console.error("[Menu] Failed to check waitlist status:",I)}return!0},s=async()=>{try{if((localStorage.getItem(F)||g.state?.serviceType||"DINE_IN")==="TAKEAWAY")return;const d=localStorage.getItem("terra_selectedTable");let c=localStorage.getItem("terra_sessionToken");const k=localStorage.getItem("terra_scanToken");if(!d||!k)return;const w=JSON.parse(d),A=w.id||w._id;if(!A)return;let a=!0;try{const f=w.qrSlug||k;if(f){const p=await fetch(`${M}/api/tables/lookup/${f}${c?`?sessionToken=${c}`:""}`).catch(C=>{throw console.warn("[Menu] Network error during table lookup:",C),C});if(p.status===423){let C={};try{C=await p.json()}catch(i){console.warn("[Menu] Failed to parse 423 response (expected for occupied tables):",i)}console.log("[Menu] Table lookup returned 423 (Locked - expected for occupied tables) - handling gracefully");const L=localStorage.getItem("terra_orderId")||localStorage.getItem("terra_orderId_DINE_IN");if(L)try{const i=await fetch(`${M}/api/orders/${L}`);if(i.ok){const B=await i.json();if((B.table?.toString()||B.tableId?.toString())===A?.toString()){B.sessionToken&&(c=B.sessionToken,localStorage.setItem("terra_sessionToken",c),G(c),console.log("[Menu] Table is locked but user has active order - using order's sessionToken:",c)),console.log("[Menu] Table is already occupied by user's active order - skipping markTableOccupied"),a=!1;return}}}catch(i){console.warn("[Menu] Failed to verify order when table is locked:",i)}if(C?.table){const i={...w,...C.table,qrSlug:w.qrSlug||C.table.qrSlug};if(localStorage.setItem("terra_selectedTable",JSON.stringify(i)),C.table.sessionToken){const B=C.table.sessionToken;if(B===c)console.log("[Menu] Table is locked but sessionToken matches - we own this table"),localStorage.setItem("terra_sessionToken",c),G(c),a=!0;else{const ce=localStorage.getItem("terra_sessionToken");if(ce&&ce===B)console.log("[Menu] Table is locked but stored sessionToken matches table's token - we own this table"),c=ce,localStorage.setItem("terra_sessionToken",c),G(c),a=!0;else{console.warn("[Menu] Table is locked and sessionToken doesn't match - table belongs to another user"),a=!1;return}}}else if(c)console.log("[Menu] Table is locked and no sessionToken in response, but we have one - proceeding (backend will validate)"),a=!0;else{console.warn("[Menu] Table is locked and no sessionToken available - table belongs to another user"),a=!1;return}}else if(c)console.log("[Menu] Table is locked and no table data in response, but we have sessionToken - proceeding (backend will validate)"),a=!0;else{console.warn("[Menu] Table is locked and user has no active order for this table - skipping markTableOccupied"),a=!1;return}}if(p.ok){const C=await p.json();if(C?.table){const L=C.table,i=L.sessionToken,B={...w,...L,qrSlug:w.qrSlug||L.qrSlug};if(localStorage.setItem("terra_selectedTable",JSON.stringify(B)),i&&i!==c){const ce=localStorage.getItem("terra_orderId")||localStorage.getItem("terra_orderId_DINE_IN");if(ce)try{const be=await fetch(`${M}/api/orders/${ce}`);if(be.ok){const V=await be.json();(V.table?.toString()||V.tableId?.toString())===A?.toString()?V.sessionToken?(c=V.sessionToken,localStorage.setItem("terra_sessionToken",c),G(c),console.log("[Menu] Using order's sessionToken:",c)):(c=i,localStorage.setItem("terra_sessionToken",c),G(c),console.log("[Menu] Using backend table's sessionToken:",c)):(console.warn("[Menu] User has order but not for this table - skipping markTableOccupied"),a=!1)}}catch(be){console.warn("[Menu] Failed to verify order:",be),c=i,localStorage.setItem("terra_sessionToken",c),G(c)}else console.warn("[Menu] Table has different sessionToken and user has no active order - skipping markTableOccupied"),a=!1}else i&&i===c?console.log("[Menu] SessionToken matches - proceeding with markTableOccupied"):i||console.log("[Menu] Table has no sessionToken - proceeding with markTableOccupied")}}}}catch(f){f?.status!==423&&console.warn("[Menu] Failed to refresh table status before markTableOccupied:",f)}if(!a)return;const I=localStorage.getItem("terra_orderId")||localStorage.getItem("terra_orderId_DINE_IN"),h=localStorage.getItem("terra_orderStatus")||localStorage.getItem("terra_orderStatus_DINE_IN");if(I&&h&&!["Paid","Cancelled","Returned","Completed"].includes(h)&&I)try{const f=await fetch(`${M}/api/orders/${I}`);if(f.ok){const p=await f.json();if(p.status&&!["Paid","Cancelled","Returned","Completed"].includes(p.status)&&(p.table?.toString()===A?.toString()||p.tableId?.toString()===A?.toString())){console.log("[Menu] User has active order for this table - skipping markTableOccupied"),p.sessionToken&&(localStorage.setItem("terra_sessionToken",p.sessionToken),G(p.sessionToken));return}}}catch(f){console.warn("[Menu] Failed to verify order before markTableOccupied:",f)}let m;try{m=await xt(`${M}/api/tables/${A}/occupy`,{sessionToken:c||void 0},{headers:{"Content-Type":"application/json"}},{maxRetries:2,retryDelay:1e3,timeout:15e3,shouldRetry:(f,p)=>f.message?.includes("timeout")||f.message?.includes("Network error")||f.message?.includes("Failed to fetch")||f.message?.includes("CORS")?!0:f.status>=400&&f.status<500?!1:f.status>=500?!0:p<1})}catch(f){console.warn("[Menu] Failed to mark table as occupied after retries:",f),m={ok:!1,status:0,json:async()=>({}),text:async()=>f.message||"Network error"}}if(m.ok){const f=await m.json().catch(()=>null);if(f?.table){const p=f.table.sessionToken||c,C={...w,status:f.table.status||"OCCUPIED",sessionToken:p};localStorage.setItem("terra_selectedTable",JSON.stringify(C)),p&&p!==c&&(localStorage.setItem("terra_sessionToken",p),G(p),console.log("[Menu] Updated sessionToken after marking table occupied:",p))}else w.status="OCCUPIED",localStorage.setItem("terra_selectedTable",JSON.stringify(w))}else{const f=await m.text().catch(()=>"Unknown error");if(console.warn("Failed to mark table as occupied:",f),m.status===423)try{const p=w.qrSlug||localStorage.getItem("terra_scanToken");if(p){const C=await fetch(`${M}/api/tables/lookup/${p}?sessionToken=${c||""}`);if(C.ok){const L=await C.json().catch(()=>({}));if(L?.table?.sessionToken){const i=L.table.sessionToken;localStorage.setItem("terra_sessionToken",i),G(i),console.log("[Menu] Table already occupied by us, updated sessionToken:",i)}}}}catch(p){console.warn("Failed to refresh table status:",p)}}}catch(u){console.warn("Error marking table as occupied:",u)}};return(async()=>{try{if(Fe(!0),gt(null),!await r()){Fe(!1);return}await s();let d="";const c=localStorage.getItem("terra_selectedCartId");if(c)d=c,console.log("[Menu] Using selected cart ID for menu:",d);else{const h=localStorage.getItem("terra_takeaway_cartId");if(h)d=h,console.log("[Menu] Using takeaway QR cart ID for menu:",d);else try{let v=localStorage.getItem("terra_selectedTable");v||(v=localStorage.getItem(ve)||"{}");const m=JSON.parse(v);d=m.cartId||m.cafeId||"",console.log("[Menu] Table data for cartId lookup:",{hasTableData:!!v,tableDataKeys:m?Object.keys(m):[],cartId:m.cartId,cafeId:m.cafeId,foundCartId:d}),d?console.log("[Menu] Using table cart ID for menu:",d):console.warn("[Menu] No cartId or cafeId found in table data:",m)}catch(v){console.error("[Menu] Error parsing table data:",v),console.log("[Menu] No cart ID found, loading default menu")}}const k=d?`${M}/api/menu/public?cartId=${d}`:`${M}/api/menu/public`;console.log("[Menu] Loading menu from:",k,{hasCartId:!!d,cartId:d,serviceType:j});const w=await fetch(k);if(!w.ok)throw new Error(`Menu fetch failed with status ${w.status}`);let A;try{A=await w.json()}catch(h){console.error("[Menu] Failed to parse menu response as JSON:",h);const v=await w.text().catch(()=>"Unknown error");throw new Error(`Invalid menu response format: ${v.substring(0,100)}`)}if(e)return;const a=(Array.isArray(A)?A:[]).map(h=>h?{...h,name:h.name||"Menu",items:(Array.isArray(h.items)?h.items:[]).map(v=>v?{...v,isAvailable:v.isAvailable!==!1,categoryName:h.name||"Menu"}:null).filter(Boolean)}:null).filter(Boolean),I=Zr(a);ut(a),mt(I),dt(h=>h||Array.isArray(a)&&a.length>0&&a[0]?.name||null)}catch(u){if(console.error("Menu fetch error",u),e)return;ut([]),mt({}),dt(null),gt("Trying to connect to live menu... please check your network or ask staff.")}finally{e||Fe(!1)}})(),()=>{e=!0}},[]);const kt=e=>{const r=typeof e=="string"?e:e?.name;if(!r)return;const s=ge[r]||e;if(s&&s.isAvailable===!1){alert(`${s.name} is currently unavailable.`);return}ne(o=>({...o,[r]:(o[r]||0)+1}))},wt=e=>{ne(r=>{const s=(r[e]||0)-1;if(s<=0){const{[e]:o,...u}=r;return u}return{...r,[e]:s}})},ee=e=>new Promise(r=>setTimeout(r,e)),te={validate:1e3,order:1e3,beforeSend:1e3,kitchen:1e3,summary:1e3,error:1e3},Xt=async()=>{if(Object.keys(H).length===0)return K(!1),alert(Vt);if(j==="DINE_IN"&&!T&&!Y){K(!1),alert("We couldn't detect your table. Please scan the table QR again or contact staff before placing an order.");return}await Zt()},Zt=async()=>{let e=T;if(e)try{const r=await fetch(`${M}/api/orders/${e}`);if(r.ok){const s=await r.json();["Paid","Cancelled","Returned"].includes(s.status)&&(console.log("[Menu] Existing order is in blocked status, creating new order instead:",s.status),e=null,q(null),j==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.removeItem("terra_orderStatus_TAKEAWAY"),localStorage.removeItem("terra_orderStatusUpdatedAt_TAKEAWAY")):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN")))}else console.log("[Menu] Could not fetch existing order, creating new order"),e=null,q(null),j==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.removeItem("terra_orderStatus_TAKEAWAY"),localStorage.removeItem("terra_orderStatusUpdatedAt_TAKEAWAY")):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN"))}catch(r){console.warn("[Menu] Error checking existing order, creating new order:",r),e=null,q(null),j==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.removeItem("terra_orderStatus_TAKEAWAY"),localStorage.removeItem("terra_orderStatusUpdatedAt_TAKEAWAY")):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN"))}re($.map((r,s)=>{let o=r.label;switch(s){case 0:o=_("processSteps.checkingOrder","Checking your order");break;case 1:o=_("processSteps.confirmingItems","Confirming items & price");break;case 2:o=_("processSteps.placingOrder","Placing your order");break;case 3:o=_("processSteps.sendingToKitchen","Sending to kitchen");break;case 4:o=_("processSteps.preparingDetails","Preparing order details");break}return{...r,label:o,state:"pending"}})),K(!0);try{U(0,"active"),await ee(te.validate),U(0,"done"),U(1,"active"),await ee(te.order),U(1,"done"),U(2,"active"),await ee(te.beforeSend);let r=Y;const s=j!=="DINE_IN"&&localStorage.getItem("terra_orderType")||null,o=j!=="DINE_IN"?localStorage.getItem("terra_customerLocation"):null;let u=null;if(o)try{u=JSON.parse(o)}catch(b){console.warn("[Menu] Failed to parse customerLocation from localStorage:",b),u=null}const d=j==="TAKEAWAY"||s==="PICKUP"||s==="DELIVERY",c=d&&(localStorage.getItem("terra_takeaway_customerName")||localStorage.getItem("terra_customerName"))||"",k=d&&(localStorage.getItem("terra_takeaway_customerMobile")||localStorage.getItem("terra_customerMobile"))||"",w=d&&(localStorage.getItem("terra_takeaway_customerEmail")||localStorage.getItem("terra_customerEmail"))||"";let A=null;if(j==="TAKEAWAY"){const b=localStorage.getItem("terra_takeaway_cartId");if(b)A=b;else try{const x=JSON.parse(localStorage.getItem(ve)||"{}");let X=x.cartId||x.cafeId||null;X&&(typeof X=="object"&&X._id?A=X._id:typeof X=="string"?A=X:A=String(X)),console.log("[Menu] Using cartId from table data for takeaway:",A)}catch(x){console.warn("[Menu] Could not get cartId from table data for takeaway order:",x)}}let a=null;j==="TAKEAWAY"?(a=localStorage.getItem("terra_takeaway_sessionToken"),a?console.log("[Menu] Using existing takeaway sessionToken (unified for both flows):",a):(a=`TAKEAWAY-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("terra_takeaway_sessionToken",a),console.log("[Menu] Generated new takeaway sessionToken (unified for both flows):",a))):(a=localStorage.getItem("terra_sessionToken"),a||(a=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("terra_sessionToken",a),G(a),console.log("[Menu] Generated new DINE_IN sessionToken:",a)));const I=localStorage.getItem("terra_specialInstructions")||null,h=localStorage.getItem("terra_selectedCartId")||A,v=h||(()=>{try{const b=JSON.parse(localStorage.getItem(ve)||"{}"),x=b.cartId||b.cafeId;if(typeof x=="string")return x;if(x&&typeof x=="object"&&x._id)return x._id;if(x!=null)return String(x)}catch{}return""})(),m=localStorage.getItem("terra_cart_addons")||"{}";let f=[];try{const b=JSON.parse(m);Array.isArray(b)?f=b:v&&Array.isArray(b[v])&&(f=b[v])}catch{f=[]}const p=JSON.parse(localStorage.getItem("terra_global_addons")||"[]"),C=Array.isArray(p)&&p.length>0?p:hr,L=f.map(b=>{const x=C.find(X=>X.id===b);return x?{addonId:b,name:x.name,price:x.price}:null}).filter(Boolean),i=br(H,{serviceType:s?s==="PICKUP"?"PICKUP":"DELIVERY":j,orderType:s==="PICKUP"||s==="DELIVERY"?s:void 0,tableId:r?.id||r?._id||Y?.id||Y?._id,tableNumber:r?.number??r?.tableNumber??Y?.number??Y?.tableNumber,menuCatalog:ge,sessionToken:a,customerName:d&&c?.trim()?c.trim():void 0,customerMobile:d&&k?.trim()?k.trim():void 0,customerEmail:d&&w?.trim()?w.trim():void 0,cartId:j==="TAKEAWAY"||s?h||A:void 0,customerLocation:u,specialInstructions:I,selectedAddons:L});if(!i.items||!Array.isArray(i.items)||i.items.length===0){console.error("[Menu] Invalid order payload - no items:",i),alert("❌ Your cart is empty. Please add items before placing an order."),U(2,"error"),await ee(te.error),K(!1);return}const B=i.items.filter(b=>!b.name||typeof b.quantity!="number"||b.quantity<=0||typeof b.price!="number"||b.price<0);if(B.length>0){console.error("[Menu] Invalid order payload - invalid items:",B),alert("❌ Some items in your cart are invalid. Please refresh the page and try again."),U(2,"error"),await ee(te.error),K(!1);return}if(i.serviceType==="DINE_IN"&&!i.sessionToken&&(a?i.sessionToken=a:(i.sessionToken=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("terra_sessionToken",i.sessionToken),G(i.sessionToken))),i.serviceType==="PICKUP"||i.serviceType==="DELIVERY"||i.orderType==="PICKUP"||i.orderType==="DELIVERY"){if(!i.customerName||!i.customerName.trim()){alert("❌ Customer name is required for "+(i.orderType||i.serviceType)+" orders. Please provide your name."),U(2,"error"),await ee(te.error),K(!1);return}if(!i.customerMobile||!i.customerMobile.trim()){alert("❌ Customer mobile number is required for "+(i.orderType||i.serviceType)+" orders. Please provide your mobile number."),U(2,"error"),await ee(te.error),K(!1);return}}if(i.serviceType==="DELIVERY"||i.orderType==="DELIVERY"){if(!i.customerLocation||!i.customerLocation.latitude||!i.customerLocation.longitude){alert("❌ Delivery location is required. Please go back and provide your delivery address."),U(2,"error"),await ee(te.error),K(!1);return}if(!i.cartId){alert("❌ Store selection is required for delivery. Please go back and select a store."),U(2,"error"),await ee(te.error),K(!1);return}try{const b=await fetch(`${M}/api/carts/${i.cartId}?latitude=${i.customerLocation.latitude}&longitude=${i.customerLocation.longitude}&orderType=DELIVERY`);if(b.ok){const x=await b.json();if(x.success&&x.data){const X=x.data;if(!X.canDeliver){let Ke=`❌ Delivery not available!

`;X.distance!==null?Ke+=`You are ${X.distance.toFixed(2)} km away, but maximum delivery radius is ${X.deliveryRadius||5} km.

`:Ke+=`Delivery is not enabled for this store or the store location is not configured.

`,Ke+="Please select a different store or choose Pickup instead.",alert(Ke),U(2,"error"),await ee(te.error),K(!1);return}}}}catch(b){console.error("[Menu] Error checking delivery availability:",b)}}const be=e?`${M}/api/orders/${e}/kot`:`${M}/api/orders`;let V;try{V=await xt(be,i,{headers:{"Content-Type":"application/json"}},{maxRetries:2,retryDelay:1500,timeout:3e4,shouldRetry:(b,x)=>b.message?.includes("timeout")||b.message?.includes("Network error")||b.message?.includes("Failed to fetch")||b.message?.includes("CORS")?(console.log(`[Menu] Retrying order creation (attempt ${x+1}/2)...`),!0):b.status>=400&&b.status<500?!1:b.status>=500?!0:x<1})}catch(b){console.error("[Menu] Order creation failed after retries:",b);const x=b.message||"Failed to create order. Please check your connection and try again.";V={ok:!1,status:0,statusText:"Network Error",json:async()=>({message:x}),text:async()=>x,headers:new Headers}}let E;try{if((V.headers?.get?.("content-type")||"").includes("application/json"))E=await V.json();else{const x=await V.text().catch(()=>"");if(x)try{E=JSON.parse(x)}catch{E={message:x||"Unknown error"}}else E={message:"No response from server"}}}catch(b){console.error("[Menu] Failed to parse response:",b);try{E={message:await V.text().catch(()=>"Unknown error")||"Failed to parse server response"}}catch{E={message:"Failed to parse server response"}}}const Et=V.ok&&E?._id;if(console.log("[Menu] Order creation response:",{ok:V.ok,status:V.status,hasOrderId:!!E?._id,orderId:E?._id,orderCreated:Et}),Et)console.log("[Menu] Order created successfully:",E._id);else{if(U(2,"error"),V.status===403){const b=E?.message||"Access denied. Please try refreshing the page.";b.includes("assigned to another guest")||b.includes("table")?alert(`⚠️ ${b}

Please scan the table QR code again or contact staff for assistance.`):alert(`❌ ${b}`)}else if(V.status===400){const b=E?.message||E?.error||"Invalid request. Please check your order and try again.";console.error("[Menu] Order save failed (400 Bad Request):",{status:V.status,statusText:V.statusText,error:E,payload:i,itemsCount:i.items?.length,serviceType:i.serviceType,hasSessionToken:!!i.sessionToken,hasTableId:!!i.tableId,hasTableNumber:!!i.tableNumber});let x=b;E?.message?.includes("No items supplied")?x="Your cart is empty. Please add items before placing an order.":E?.message?.includes("Session token is required")?x="Session token is missing. Please scan the table QR code again.":E?.message?.includes("Table selection is required")?x="Table information is missing. Please scan the table QR code again.":E?.message?.includes("Invalid order items")&&(x="Some items in your cart are invalid. Please refresh the page and try again."),alert(`❌ ${x}`)}else{const b=E?.message||E?.error||"Failed to save order.";console.error("[Menu] Order save failed:",{status:V.status,statusText:V.statusText,error:E,payload:i}),alert(`❌ ${b}`)}await ee(te.error),K(!1),ue(!1);return}console.log("[Menu] Proceeding with order success flow for order:",E._id),U(2,"done"),U(3,"active"),await ee(te.kitchen),U(3,"done"),j==="TAKEAWAY"?(localStorage.setItem("terra_orderId_TAKEAWAY",E._id),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),E.sessionToken?(localStorage.setItem("terra_takeaway_sessionToken",E.sessionToken),console.log("[Menu] Stored takeaway sessionToken from order response:",E.sessionToken)):a&&(localStorage.setItem("terra_takeaway_sessionToken",a),console.log("[Menu] Stored generated takeaway sessionToken:",a))):(localStorage.setItem("terra_orderId",E._id),localStorage.setItem("terra_orderId_DINE_IN",E._id),localStorage.removeItem("terra_orderId_TAKEAWAY")),q(E._id),z(E.status||"Confirmed"),J(new Date().toISOString()),j==="TAKEAWAY"?(localStorage.setItem("terra_orderStatus_TAKEAWAY",E.status||"Confirmed"),localStorage.setItem("terra_orderStatusUpdatedAt_TAKEAWAY",new Date().toISOString())):(localStorage.setItem("terra_orderStatus_DINE_IN",E.status||"Confirmed"),localStorage.setItem("terra_orderStatusUpdatedAt_DINE_IN",new Date().toISOString())),E&&(E.takeawayToken||E.serviceType==="TAKEAWAY")&&Z(E),ne({}),localStorage.removeItem("terra_cart"),localStorage.removeItem("terra_cart_DINE_IN"),localStorage.removeItem("terra_cart_TAKEAWAY"),ue(!1),console.log("[Menu] Order created and stored:",{orderId:E._id,serviceType:j,storedInLocalStorage:{generic:j==="DINE_IN"?localStorage.getItem("terra_orderId"):null,dineIn:j==="DINE_IN"?localStorage.getItem("terra_orderId_DINE_IN"):null,takeaway:j==="TAKEAWAY"?localStorage.getItem("terra_orderId_TAKEAWAY"):null}}),U(4,"active"),U(4,"done"),K(!1)}catch(r){U(2,"error"),alert("❌ Server Error"),console.error(r),await ee(te.error),K(!1),ue(!1)}},er=async()=>{if(ye){try{fe.current&&(fe.current.stop(),fe.current=null)}catch(e){console.warn("Error stopping recognition:",e)}de(!1);return}if(!("webkitSpeechRecognition"in window)&&!("SpeechRecognition"in window)){alert("Your browser doesn't support voice input. Please use the menu buttons to order.");return}try{const e=window.SpeechRecognition||window.webkitSpeechRecognition,r=new e;fe.current=r,r.continuous=!1,r.interimResults=!1;const s=localStorage.getItem("language")||"en";r.lang=s==="en"?"en-US":s==="hi"?"hi-IN":"en-US",r.onstart=()=>{de(!0),xe(""),console.log("🎤 Voice recognition started")},r.onresult=o=>{const u=o.results[0][0].transcript;if(console.log("📝 Transcribed:",u),xe(u),de(!1),je(!0),!Array.isArray(oe)||oe.length===0){console.warn("⚠️ Menu items not loaded yet, cannot add items to cart"),alert("Menu is still loading. Please wait a moment and try again."),je(!1);return}const{addedItems:d,notFound:c}=cr(u),k=d.length,w=d.map(({name:A,qty:a})=>`${a}x ${A}`).join(", ");w&&xe(w),k>0?(console.log(`✅ Voice order: added ${k} item(s) to cart`),c.length>0&&alert(`✅ Added ${k} item(s) to cart.
⚠️ Not found in menu: ${c.join(", ")}`)):d.length===0&&c.length>0?alert(`Could not find in menu: ${c.join(", ")}. Try saying item names as shown in the menu.`):u.trim()||xe(""),je(!1)},r.onerror=o=>{console.error("Voice recognition error:",o.error),de(!1),je(!1),fe.current=null,o.error==="no-speech"?alert("No speech detected. Please try again."):o.error==="not-allowed"?alert("Microphone permission denied. Please allow microphone access."):alert("Voice recognition error. Please try again or use menu buttons.")},r.onend=()=>{de(!1),fe.current=null},de(!0),r.start()}catch(e){console.error("Error starting voice recognition:",e),alert("Failed to start voice input. Please try again or use menu buttons."),de(!1)}},tr=async()=>{if(!(!N||$e)){ue(!0),ot(!0);try{if((localStorage.getItem(F)||"DINE_IN")==="TAKEAWAY"){const v=T||localStorage.getItem("terra_orderId_TAKEAWAY")||localStorage.getItem("terra_orderId"),m=localStorage.getItem("terra_takeaway_sessionToken")||localStorage.getItem("terra_sessionToken");if(!v){alert("No active order found. Please create a new order.");return}try{const f=await fetch(`${M}/api/orders/${v}`);if(f.ok){const p=await f.json();if(p.status&&["Paid","Cancelled","Returned","Completed"].includes(p.status)){alert("This order has been completed. Please create a new order.");return}q(v),localStorage.setItem("terra_orderId_TAKEAWAY",v),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),z(p.status||N||"Confirmed"),localStorage.setItem("terra_orderStatus_TAKEAWAY",p.status||N||"Confirmed"),p.updatedAt&&(J(p.updatedAt),localStorage.setItem("terra_orderStatusUpdatedAt_TAKEAWAY",p.updatedAt)),ne({}),localStorage.removeItem("terra_cart"),localStorage.removeItem("terra_cart_TAKEAWAY"),alert("You can continue adding items to your takeaway order.");return}else{alert("Order not found. Please create a new order.");return}}catch{alert("Unable to verify order. Please try again or contact staff.");return}}const r=localStorage.getItem("terra_selectedTable"),s=Ce||localStorage.getItem("terra_sessionToken");if(!r||!s){alert("We couldn't detect your table. Please scan the table QR again or contact staff.");return}let o=null;if(T)try{const v=await fetch(`${M}/api/orders/${T}`);v.ok&&(o=await v.json())}catch{}const u=JSON.parse(r),d=u.qrSlug||localStorage.getItem("terra_scanToken"),c=localStorage.getItem("terra_sessionToken")||s,k=new URLSearchParams;c&&k.set("sessionToken",c);const w=`${M}/api/tables/lookup/${d}${k.toString()?`?${k.toString()}`:""}`;let A=await fetch(w),a=await A.json().catch(()=>({}));if(A.status===423){const v=a?.table?.sessionToken;if(v&&v===c)console.log("[Menu] Table is occupied by current session, proceeding");else{const m=a?.message||"Table is currently assigned to another guest.";if(c){console.warn("Stale session detected, retrying table lookup without session token."),localStorage.removeItem("terra_sessionToken"),G(null);const p=new URLSearchParams().toString(),C=`${M}/api/tables/lookup/${d}${p?`?${p}`:""}`,L=await fetch(C),i=await L.json().catch(()=>({}));if(!L.ok)throw new Error(i?.message||m||"Unable to refresh table session. Please ask staff for help.");A=L,a=i}else throw new Error(m)}}else if(!A.ok)throw new Error(a?.message||"Failed to refresh table session. Please ask staff for help.");if(a.sessionToken){const v=Ce||localStorage.getItem("terra_sessionToken"),m=a.sessionToken;m!==v&&(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_previousOrder"),localStorage.removeItem("terra_previousOrderDetail"),localStorage.removeItem("terra_lastPaidOrderId"),q(null),z(null),J(null),se(null),Z(null),["DINE_IN","TAKEAWAY"].forEach(f=>{localStorage.removeItem(`terra_cart_${f}`),localStorage.removeItem(`terra_orderId_${f}`),localStorage.removeItem(`terra_orderStatus_${f}`),localStorage.removeItem(`terra_orderStatusUpdatedAt_${f}`)})),localStorage.setItem("terra_sessionToken",m),G(m)}a.table&&(localStorage.setItem("terra_selectedTable",JSON.stringify(a.table)),qe(a.table)),(a.table?.status||"AVAILABLE")==="AVAILABLE"?localStorage.removeItem("terra_waitToken"):a.waitlist?.token?localStorage.setItem("terra_waitToken",a.waitlist.token):localStorage.removeItem("terra_waitToken");const h=a.table||u;if(a.order){const v=localStorage.getItem(F)||"DINE_IN";if(a.order.serviceType&&a.order.serviceType!==v){console.log(`[Menu] Ignoring order from table lookup - serviceType mismatch: order is ${a.order.serviceType}, current is ${v}`);return}q(a.order._id),v==="TAKEAWAY"?(localStorage.setItem("terra_orderId_TAKEAWAY",a.order._id),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN")):(localStorage.setItem("terra_orderId",a.order._id),localStorage.setItem("terra_orderId_DINE_IN",a.order._id),localStorage.removeItem("terra_orderId_TAKEAWAY")),z(a.order.status||N||"Confirmed"),a.order.updatedAt&&(J(a.order.updatedAt),localStorage.setItem("terra_orderStatusUpdatedAt",a.order.updatedAt)),se(null)}else T?console.log("No order returned from table lookup, keeping existing order status"):(We({status:N||"Completed",updatedAt:le||new Date().toISOString(),tableNumber:h?.number??h?.tableNumber??null,tableSlug:h?.qrSlug??d??null,tableInfo:h}),z(null),J(null),q(null),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"));o&&Z(o),alert("You can continue adding items to your order.")}catch(e){console.error("handleOrderAgain error",e),alert(e.message||"Unable to resume ordering. Please contact staff.")}finally{ot(!1),ue(!1)}}},rr=()=>{if(!(j==="TAKEAWAY"?T||localStorage.getItem("terra_orderId_TAKEAWAY")||localStorage.getItem("terra_orderId"):T||localStorage.getItem("terra_orderId"))){alert("No active order found.");return}ht("Cancel"),Qe(""),Se(!0)},ar=()=>{if(!T){alert("No active order found.");return}ht("Return"),Qe(""),Se(!0)},or=async()=>{if(!Me.trim()){alert("Please enter a reason.");return}bt(!0);try{if(he==="Cancel"){Ue(!0);const e=j==="TAKEAWAY"?T||localStorage.getItem("terra_orderId_TAKEAWAY")||localStorage.getItem("terra_orderId"):T||localStorage.getItem("terra_orderId");let r=null;if(j==="TAKEAWAY"){if(r=localStorage.getItem("terra_takeaway_sessionToken")||localStorage.getItem("terra_sessionToken"),!r)try{const c=await fetch(`${M}/api/orders/${e}`);if(c.ok){const k=await c.json();k?.sessionToken&&(r=k.sessionToken,localStorage.setItem("terra_takeaway_sessionToken",r))}}catch(c){console.warn("[Menu] Failed to fetch order to get sessionToken:",c)}}else r=localStorage.getItem("terra_sessionToken");const s=await fetch(`${M}/api/orders/${e}/customer-status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"Cancelled",sessionToken:r||void 0,reason:Me})}),o=await s.json().catch(()=>({}));if(!s.ok)throw new Error(o?.message||"Failed to cancel order");const u=o?._id?o:null,d=u?.updatedAt||new Date().toISOString();We({orderId:u?._id,status:"Cancelled",updatedAt:d,tableNumber:u?.tableNumber??Y?.number??Y?.tableNumber??null,tableSlug:u?.table?.qrSlug??Y?.qrSlug??localStorage.getItem("terra_scanToken")??null,tableInfo:u?.table||Y}),u&&Z(u),z(null),J(null),q(null),j==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.removeItem("terra_orderStatus_TAKEAWAY"),localStorage.removeItem("terra_orderStatusUpdatedAt_TAKEAWAY"),localStorage.removeItem("terra_cart_TAKEAWAY"),localStorage.removeItem("terra_takeaway_customerName"),localStorage.removeItem("terra_takeaway_customerMobile"),localStorage.removeItem("terra_takeaway_customerEmail"),console.log("[Menu] Cleared takeaway customer data after order cancellation")):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_cart")),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_cart"),j==="TAKEAWAY"&&(localStorage.removeItem("terra_waitToken"),console.log("[Menu] Cleared waitlist state for cancelled takeaway order")),ne({}),ue(!1),alert("Your order has been cancelled."),Ue(!1)}else if(he==="Return"){Le(!0);const e=localStorage.getItem("terra_sessionToken"),r=await fetch(`${M}/api/orders/${T}/customer-status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"Returned",sessionToken:j==="DINE_IN"&&e||void 0,reason:Me})}),s=await r.json().catch(()=>({}));if(!r.ok)throw new Error(s?.message||"Failed to return order");const o=s?._id?s:null,u=o?.updatedAt||new Date().toISOString();We({orderId:o?._id,status:"Returned",updatedAt:u,tableNumber:o?.tableNumber??Y?.number??Y?.tableNumber??null,tableSlug:o?.table?.qrSlug??Y?.qrSlug??localStorage.getItem("terra_scanToken")??null,tableInfo:o?.table||Y}),o&&Z(o),z("Returned"),J(u),q(null),j==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.removeItem("terra_orderStatus_TAKEAWAY"),localStorage.removeItem("terra_orderStatusUpdatedAt_TAKEAWAY")):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN")),localStorage.removeItem("terra_cart"),ne({}),ue(!1),j==="TAKEAWAY"&&(localStorage.removeItem("terra_waitToken"),localStorage.removeItem("terra_takeaway_customerName"),localStorage.removeItem("terra_takeaway_customerMobile"),localStorage.removeItem("terra_takeaway_customerEmail")),alert("Your order has been marked as returned."),Le(!1)}Se(!1)}catch(e){alert(e.message||`Unable to ${he.toLowerCase()} order.`),he==="Cancel"&&Ue(!1),he==="Return"&&Le(!1)}finally{bt(!1)}},sr=async()=>{if(!T){alert("No active order found.");return}if(await window.confirm("Confirm that payment has been completed for this order?")){it(!0);try{const e=localStorage.getItem("terra_sessionToken"),r=await fetch(`${M}/api/orders/${T}/confirm-payment`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentMethod:"CASH",sessionToken:j==="DINE_IN"&&e||void 0})}),s=await r.json().catch(()=>({}));if(!r.ok)throw new Error(s?.message||"Failed to confirm payment");const o=s?._id?s:null,u=o?.updatedAt||new Date().toISOString();We({orderId:o?._id,status:"Paid",updatedAt:u,tableNumber:o?.tableNumber??Y?.number??Y?.tableNumber??null,tableSlug:o?.table?.qrSlug??Y?.qrSlug??localStorage.getItem("terra_scanToken")??null,tableInfo:o?.table||Y}),o&&Z(o),z("Paid"),J(u),localStorage.setItem("terra_orderStatus","Paid"),localStorage.setItem("terra_orderStatusUpdatedAt",u),localStorage.setItem("terra_lastPaidOrderId",T),alert("Payment confirmed successfully!")}catch(e){console.error("handleConfirmPayment error",e),alert(e.message||"Unable to confirm payment. Please contact staff.")}finally{it(!1)}}},Ze=l.useCallback(async()=>{if(!T){alert("We couldn't locate your order. Please contact staff.");return}try{De(!0);const e=await fetch(`${M}/api/orders/${T}`),r=await e.json().catch(()=>({}));if(!e.ok)throw new Error(r?.message||"Failed to load invoice details.");console.log("📄 Invoice order data:",{orderId:r._id,franchiseId:r.franchiseId,cafeId:r.cafeId,franchise:r.franchise,cafe:r.cafe}),Be(r),ze(!0)}catch(e){console.error("Invoice fetch failed",e),alert(e.message||"Unable to load invoice. Please contact staff.")}finally{De(!1)}},[T]),Nt=l.useCallback(()=>{ze(!1),Be(null),Ie(!1),Je(!1),De(!1)},[]);l.useCallback(()=>{if(!(!Ae.current||!S||Ve)){Ie(!0);try{const e=document.createElement("iframe");e.style.position="fixed",e.style.right="0",e.style.bottom="0",e.style.width="0",e.style.height="0",e.style.border="0",e.style.visibility="hidden",e.setAttribute("sandbox","allow-same-origin allow-scripts allow-modals"),document.body.appendChild(e);const r=e.contentWindow?.document;if(!r){Ie(!1),document.body.removeChild(e),alert("Print preview failed to open. Please check your browser settings.");return}r.open(),r.write(`
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>${we||"Invoice"}</title>
          <style>
            * { box-sizing: border-box; }
            body {
              font-family: 'Segoe UI', Arial, sans-serif;
              margin: 0;
              padding: 32px;
              background: #ffffff;
              color: #1f2933;
            }
            h1, h2, h3, h4 { margin: 0; }
            table { border-collapse: collapse; width: 100%; }
            th, td { padding: 8px; border-bottom: 1px solid #e5e7eb; }
            th { text-align: left; color: #475569; font-weight: 600; }
            .invoice-shell {
              max-width: 720px;
              margin: 0 auto;
              padding: 24px;
              border: 1px solid #d2d6dc;
              border-radius: 12px;
            }
            @media print {
              body { padding: 0; }
              .invoice-shell { border: none; }
            }
          </style>
        </head>
        <body>
          <div class="invoice-shell">
            ${Ae.current.innerHTML}
          </div>
        </body>
      </html>
    `),r.close(),e.onload=function(){setTimeout(()=>{try{e.contentWindow?.focus(),e.contentWindow?.print()}catch(s){console.error("Print failed:",s),alert("Print failed. Please try using your browser's print function (Ctrl+P).")}finally{setTimeout(()=>{document.body.contains(e)&&document.body.removeChild(e),Ie(!1)},500)}},250)},setTimeout(()=>{Ve&&document.body.contains(e)&&(document.body.removeChild(e),Ie(!1),console.warn("Print timeout - iframe failed to load"))},5e3)}catch(e){console.error("Print setup failed:",e),Ie(!1),alert("Failed to initialize print. Please try again or use Ctrl+P.")}}},[we,S,Ve]);const nr=l.useCallback(async()=>{if(!(!Ae.current||!S||Pe)){Je(!0);try{const r=(await Ar(Ae.current,{scale:window.devicePixelRatio||2,useCORS:!0,backgroundColor:"#ffffff",onclone:h=>{h.querySelectorAll("*").forEach(m=>{const f=window.getComputedStyle(m);["color","backgroundColor","borderColor"].forEach(p=>{const C=f[p];C&&C.includes("oklch")&&(m.style[p]="#000000",p==="backgroundColor"&&(m.style[p]="transparent"))})})}})).toDataURL("image/png"),s=new Tr("p","mm","a4"),o=s.internal.pageSize.getWidth(),u=s.internal.pageSize.getHeight(),d=10,c=o-d*2,k=s.getImageProperties(r),w=k.height/k.width,A=c*w;let a=A,I=d;for(s.addImage(r,"PNG",d,I,c,A),a-=u-d*2;a>0;)s.addPage(),I=d-(A-a),s.addImage(r,"PNG",d,I,c,A),a-=u-d*2;s.save(`${we||"invoice"}.pdf`)}catch(e){console.error("Invoice download failed",e),alert("Failed to generate invoice PDF. Please try again.")}finally{Je(!1)}}},[we,S,Pe]);l.useCallback(async()=>{if(["Preparing","Ready","Served","Finalized","Paid"].includes(N)){await Ze();return}if(N==="Returned"||N==="Cancelled"){alert(N==="Returned"?"This order has already been returned.":"This order has been cancelled.");return}n("/billing")},[N,Ze,n]);const lr=l.useCallback(()=>{W&&(De(!1),Be(W),ze(!0))},[W]),ir=e=>{const r={one:1,two:2,three:3,four:4,five:5,six:6,seven:7,eight:8,nine:9,ten:10,ek:1,do:2,teen:3,char:4,paanch:5,che:6,saat:7,aath:8,nau:9,das:10},s=(e||"").toLowerCase().trim();if(r[s]!==void 0)return r[s];const o=parseInt(s,10);return Number.isNaN(o)?0:o},cr=e=>{const r={addedItems:[],notFound:[]};if(!e)return r;const s={...H},o=Array.isArray(oe)&&oe.length>0?oe:Object.values(ge).length>0?Object.values(ge):vr.map(d=>({...d,isAvailable:!0}));return e.split(/[,;]/).map(d=>d.trim()).filter(Boolean).forEach(d=>{let c=1,k=d;const w=d.match(/^(\d+)\s+(.+)$/);if(w)c=parseInt(w[1],10)||1,k=w[2].trim();else{const a=d.match(/^(one|two|three|four|five|six|seven|eight|nine|ten|ek|do|teen|char|paanch|che|saat|aath|nau|das)\s+(.+)$/i);a&&(c=ir(a[1])||1,k=a[2].trim())}if(!k)return;const A=o.find(a=>a?.name&&a.name.toLowerCase()===k.toLowerCase())||o.find(a=>a?.name&&(a.name.toLowerCase().includes(k.toLowerCase())||k.toLowerCase().includes(a.name.toLowerCase())));A&&A.isAvailable!==!1?(s[A.name]=(s[A.name]||0)+c,r.addedItems.push({name:A.name,qty:c})):r.notFound.push(k)}),ne(s),r};return l.useEffect(()=>{const r=(localStorage.getItem(F)||"DINE_IN")==="TAKEAWAY";let s=null;if(r?s=T||localStorage.getItem("terra_orderId_TAKEAWAY"):s=T||localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),!s){z(null),J(null);return}if(ct)return;let o,u,d=!1;const c=async()=>{try{const a=localStorage.getItem(F)||"DINE_IN";let I=null;if(a==="TAKEAWAY"?I=T||localStorage.getItem("terra_orderId_TAKEAWAY"):I=T||localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),!I)return;const h=localStorage.getItem("terra_sessionToken");let v;try{v=await fetch(`${M}/api/orders/${I}`,{signal:AbortSignal.timeout(5e3)})}catch{d||(console.warn("[Menu] Backend server appears to be offline. Will retry automatically."),d=!0);return}if(d&&(d=!1),!v.ok){v.status===404&&(console.warn("Order not found (404), clearing order data"),a==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.removeItem("terra_orderStatus_TAKEAWAY"),localStorage.removeItem("terra_orderStatusUpdatedAt_TAKEAWAY")):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN")),q(null),z(null),J(null));return}let m;try{m=await v.json()}catch(L){console.error("[Menu] Failed to parse order status response as JSON:",L);return}if(!m)return;const f=localStorage.getItem("terra_serviceType")||"DINE_IN",p=f==="TAKEAWAY";if(m.serviceType&&m.serviceType!==f){console.log(`[Menu] Ignoring order update - serviceType mismatch: order is ${m.serviceType}, current is ${f}`);return}const C=p&&localStorage.getItem("terra_takeaway_sessionToken")||h;if(p){if(C&&m.sessionToken&&m.sessionToken!==C)return}else if(C&&m.sessionToken&&m.sessionToken!==C){localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN"),localStorage.removeItem("terra_cart_DINE_IN"),localStorage.removeItem("terra_previousOrder"),localStorage.removeItem("terra_previousOrderDetail"),q(null),z(null),J(null),se(null),Z(null);return}if(p&&Z(m),m?.status){if((p?localStorage.getItem("terra_orderStatus_TAKEAWAY")||localStorage.getItem("terra_orderStatus"):localStorage.getItem("terra_orderStatus_DINE_IN")||localStorage.getItem("terra_orderStatus"))===m.status&&N===m.status)return;const i=new Date().toISOString();z(m.status),J(i),p?(localStorage.setItem("terra_orderStatus_TAKEAWAY",m.status),localStorage.setItem("terra_orderStatusUpdatedAt_TAKEAWAY",i),localStorage.setItem("terra_orderStatus",m.status),localStorage.setItem("terra_orderStatusUpdatedAt",i)):(localStorage.setItem("terra_orderStatus_DINE_IN",m.status),localStorage.setItem("terra_orderStatusUpdatedAt_DINE_IN",i),localStorage.setItem("terra_orderStatus",m.status),localStorage.setItem("terra_orderStatusUpdatedAt",i))}}catch{}};c(),u=setInterval(c,2e4);try{o=yr(M,{transports:["websocket","polling"],reconnection:!0,reconnectionDelay:1e3,reconnectionDelayMax:5e3,reconnectionAttempts:5,timeout:6e4,connectTimeout:6e4,autoConnect:!0,forceNew:!1});let a=!1;o.on("connect",()=>{a=!1,d=!1}),o.on("connect_error",I=>{a||(console.warn("[Menu] Socket connection error - backend may be offline. Will retry automatically."),a=!0)}),o.on("disconnect",I=>{})}catch(a){console.warn("[Menu] Failed to create socket connection:",a),o=null}const k=a=>{const I=localStorage.getItem(F)||"DINE_IN";let h=null;if(I==="TAKEAWAY"?h=T||localStorage.getItem("terra_orderId_TAKEAWAY"):h=T||localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),a?._id===h&&a?.status&&a?.serviceType===I){if(localStorage.getItem("terra_orderStatus")===a.status&&N===a.status)return;if(I==="TAKEAWAY"&&a.sessionToken){const f=localStorage.getItem("terra_takeaway_sessionToken")||localStorage.getItem("terra_sessionToken");if(f&&a.sessionToken!==f)return}const m=new Date().toISOString();z(a.status),J(m),localStorage.setItem("terra_orderStatus",a.status),localStorage.setItem("terra_orderStatusUpdatedAt",m),I==="TAKEAWAY"?(localStorage.setItem("terra_orderStatus_TAKEAWAY",a.status),localStorage.setItem("terra_orderStatusUpdatedAt_TAKEAWAY",m)):(localStorage.setItem("terra_orderStatus_DINE_IN",a.status),localStorage.setItem("terra_orderStatusUpdatedAt_DINE_IN",m))}},w=a=>{const I=localStorage.getItem(F)||"DINE_IN";let h=null;I==="TAKEAWAY"?h=T||localStorage.getItem("terra_orderId_TAKEAWAY"):h=T||localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),a?.id===h&&(z(null),q(null),I==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.removeItem("terra_orderStatus_TAKEAWAY"),localStorage.removeItem("terra_orderStatusUpdatedAt_TAKEAWAY")):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN")))},A=a=>{const I=Y||(()=>{try{const B=localStorage.getItem("terra_selectedTable");return B?JSON.parse(B):null}catch{return null}})();if(!I)return;const h=a.id||a._id,v=I.id||I._id,m=h&&v&&String(h)===String(v),f=a.number&&I.number&&String(a.number)===String(I.number);if(!m&&!f)return;console.log("[Menu] Table status updated via socket:",a.status,"Previous status:",I.status);const p={...I,status:a.status,currentOrder:a.currentOrder||null,sessionToken:a.sessionToken||I.sessionToken};qe(p),localStorage.setItem("terra_selectedTable",JSON.stringify(p));const C=localStorage.getItem("terra_orderId")||localStorage.getItem("terra_orderId_DINE_IN"),L=localStorage.getItem("terra_orderStatus")||localStorage.getItem("terra_orderStatus_DINE_IN"),i=C&&L&&!["Paid","Cancelled","Returned","Completed"].includes(L);a.status==="AVAILABLE"&&(i?console.log("[Menu] Table became AVAILABLE but user has active order - preserving order data"):(console.log("[Menu] Table became AVAILABLE via socket - clearing waitlist state and order data (user has no active order)"),localStorage.removeItem("terra_waitToken"),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_cart"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_previousOrder"),localStorage.removeItem("terra_previousOrderDetail"),["DINE_IN","TAKEAWAY"].forEach(B=>{localStorage.removeItem(`terra_cart_${B}`),localStorage.removeItem(`terra_orderId_${B}`),localStorage.removeItem(`terra_orderStatus_${B}`),localStorage.removeItem(`terra_orderStatusUpdatedAt_${B}`)}),q(null),z(null),console.log("[Menu] Cleared all order data for new customer")))};return o&&(o.on("orderUpdated",k),o.on("orderDeleted",w),o.on("table:status:updated",A)),()=>{u&&clearInterval(u),o&&!r&&(o.off("orderUpdated",k),o.off("orderDeleted",w),o.off("table:status:updated",A),o.disconnect())}},[T,ct]),l.useEffect(()=>{const e=localStorage.getItem(F)||"DINE_IN";if(e==="TAKEAWAY"?T||localStorage.getItem("terra_orderId_TAKEAWAY")||localStorage.getItem("terra_orderId"):T||localStorage.getItem("terra_orderId")){const s=e==="TAKEAWAY"&&localStorage.getItem("terra_orderStatus_TAKEAWAY")||localStorage.getItem("terra_orderStatus"),o=e==="TAKEAWAY"&&localStorage.getItem("terra_orderStatusUpdatedAt_TAKEAWAY")||localStorage.getItem("terra_orderStatusUpdatedAt");s&&(s!==N&&(console.log("[Menu] Syncing orderStatus from localStorage:",s),z(s)),o&&o!==le&&J(o))}},[T,N,le]),l.useEffect(()=>{const e=localStorage.getItem(F)||"DINE_IN";let r=null;if(e==="TAKEAWAY"?r=localStorage.getItem("terra_orderId_TAKEAWAY"):r=localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),r&&r!==T&&(console.log("[Menu] Restoring activeOrderId on mount:",r,"serviceType:",e),q(r)),r&&!N){const s=e==="TAKEAWAY"&&localStorage.getItem("terra_orderStatus_TAKEAWAY")||localStorage.getItem("terra_orderStatus"),o=e==="TAKEAWAY"&&localStorage.getItem("terra_orderStatusUpdatedAt_TAKEAWAY")||localStorage.getItem("terra_orderStatusUpdatedAt");s&&(z(s),o&&J(o))}},[]),l.useEffect(()=>{if(y.get("action")==="confirm"&&!_e){if(pe||Object.keys(ge).length===0){console.error("[Menu] Auto-confirm aborted: Menu data missing or error",{menuCatalogSize:Object.keys(ge).length,menuError:pe});const r=new URLSearchParams(y);r.delete("action"),O(r),alert(pe?"Cannot place order automatically: "+pe:"Cannot place order automatically: Menu prices not loaded. Please try again manually.");return}const e=new URLSearchParams(y);e.delete("action"),O(e),K(!0),Xt()}},[y,_e,ge,pe]),t.jsxs("div",{className:`menu-root ${ie?"accessibility-mode":""}`,children:[t.jsx("div",{className:"background-image",style:{backgroundImage:`url(${_r})`}}),t.jsx("div",{className:"overlay"}),t.jsx(fr,{accessibilityMode:ie,onClickCart:()=>n("/cart"),cartCount:pt}),t.jsx("div",{className:"content-wrapper",children:t.jsx("div",{className:"main-container",children:t.jsxs("div",{className:"panels-container",children:[t.jsxs("div",{className:"left-panel",children:[t.jsxs("div",{className:"order-header-section",children:[t.jsxs("div",{className:"order-header-info",children:[t.jsx("div",{className:"order-header-badge",children:j==="DINE_IN"?t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"order-header-icon",children:"📍"}),t.jsx("span",{children:Y?.number?`${_("dineIn","Dine-In")} - ${_("table","Table")} ${Y.number}`:_("dineIn","Dine-In")})]}):t.jsx("span",{children:_("takeaway","Takeaway")})}),j==="DINE_IN"&&t.jsxs("div",{className:"guest-count-badge",children:[t.jsx("span",{className:"guest-icon",children:"👥"}),t.jsx("span",{children:Y?.seats||Y?.capacity||2})]})]}),j==="TAKEAWAY"&&W?.takeawayToken&&t.jsxs("span",{className:"token-badge",children:[_("token","Token"),":"," ",t.jsx("strong",{children:W.takeawayToken})]})]}),t.jsx("button",{type:"button",onClick:er,className:`voice-button ${ye?"recording":""}`,"aria-pressed":ye,"aria-label":Gt,disabled:_e,children:ye?t.jsx(gr,{}):t.jsx(pr,{})}),t.jsx("p",{className:"instruction-text",children:_e?_("loadingMenu","Loading menu...")||"Loading menu...":Wt?Bt:ye?Qt:Jt}),j==="DINE_IN"&&t.jsxs("div",{className:"action-buttons-row",children:[t.jsx("button",{onClick:async()=>{try{const e=localStorage.getItem("terra_selectedTable");if(!e){alert("Please select a table first");return}const r=JSON.parse(e),s=r.id||r._id,o=localStorage.getItem("terra_orderId")||null,u="https://api.terracart.in".replace(/\/$/,"");if((await fetch(`${u}/api/customer-requests`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tableId:s,requestType:"assistance",customerNotes:"Call Waiter",...o&&{orderId:o}})})).ok)alert("✅ Waiter called! Someone will be with you shortly.");else throw new Error("Failed to send request")}catch(e){console.error("Error calling waiter:",e),alert("❌ Failed to call waiter. Please try again.")}},className:"action-button call-waiter-button",children:_("callWaiter","Call Waiter")}),T?t.jsxs("button",{onClick:async()=>{try{const e=localStorage.getItem("terra_selectedTable");if(!e){alert("Please select a table first");return}const r=JSON.parse(e),s=r.id||r._id,o=localStorage.getItem("terra_orderId")||null,u="https://api.terracart.in".replace(/\/$/,"");if((await fetch(`${u}/api/customer-requests`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tableId:s,requestType:"bill",customerNotes:"Request Bill",...o&&{orderId:o}})})).ok)alert("✅ Bill requested! Someone will bring it shortly.");else throw new Error("Failed to send request")}catch(e){console.error("Error requesting bill:",e),alert("❌ Failed to request bill. Please try again.")}},className:"action-button request-bill-button",children:["🧾 ",_("requestBill","Request Bill")]}):t.jsxs("button",{onClick:async()=>{try{const e=localStorage.getItem("terra_selectedTable");if(!e){alert("Please select a table first");return}const r=JSON.parse(e),s=r.id||r._id,o=localStorage.getItem("terra_orderId")||null,u="https://api.terracart.in".replace(/\/$/,"");if((await fetch(`${u}/api/customer-requests`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tableId:s,requestType:"water",customerNotes:"Request Water",...o&&{orderId:o}})})).ok)alert("✅ Water requested! Someone will bring it shortly.");else throw new Error("Failed to send request")}catch(e){console.error("Error requesting water:",e),alert("❌ Failed to request water. Please try again.")}},className:"action-button request-water-button",children:["💧 ",_("requestWater","Request Water")]})]}),at&&t.jsxs("p",{className:"ai-ordered-text",children:[zt," ",t.jsx("span",{className:"order-text-italic",children:at})]}),N&&t.jsxs("div",{className:"order-status-card",children:[t.jsx("h4",{className:"order-summary-title",children:"Order Status"}),j==="TAKEAWAY"&&W?.takeawayToken&&t.jsxs("div",{className:"mb-3 p-2 bg-blue-50 border border-blue-200 rounded-lg",children:[t.jsxs("div",{className:"text-sm font-semibold text-blue-700",children:["Your Token:"," ",t.jsx("span",{className:"text-lg font-bold",children:W.takeawayToken})]}),t.jsx("div",{className:"text-xs text-blue-600 mt-1",children:"Please keep this token for reference"})]}),t.jsx("div",{className:"order-status-section",children:t.jsx(Vr,{status:N,updatedAt:le,serviceType:j,tableLabel:j==="DINE_IN"&&Y?.number?`Dine-In | Table ${Y.number}`:null})}),t.jsxs("div",{className:"button-group status-actions",children:[(()=>{const e=(N||"").toLowerCase();return["paid","completed"].includes(e)&&Gr.includes(N)?t.jsx("button",{className:"reset-button return-button",onClick:ar,disabled:nt,children:nt?"Processing...":"Return Order"}):Hr.includes(N)?t.jsx("button",{className:"reset-button cancel-button",onClick:rr,disabled:st,children:st?"Cancelling...":"Cancel Order"}):N==="Returned"||N==="Cancelled"?t.jsx("button",{className:"billing-button billing-button-disabled",disabled:!0,children:N==="Returned"?"Order Returned":"Order Cancelled"}):null})(),["Confirmed","Preparing","Ready","Served","Finalized","Completed","Paid"].includes(N)?t.jsx("button",{className:"billing-button",onClick:Ze,disabled:St,children:St?"Opening...":"View Invoice"}):null,t.jsx("button",{className:"confirm-button",onClick:tr,disabled:$e||N&&!Qr.includes(N),children:$e?"Please wait...":"Order More"}),(()=>{const e=(N||"").toLowerCase();return["Finalized","Completed"].includes(N)?t.jsx("button",{className:"billing-button",onClick:sr,disabled:lt,children:lt?"Confirming...":"Confirm Payment"}):N!=="Returned"&&N!=="Cancelled"&&!["paid","completed"].includes(e)?t.jsx("button",{className:"complete-payment-button",onClick:()=>{n("/billing")},children:"Payment"}):["paid","completed"].includes(e)?t.jsx("button",{className:"feedback-button",onClick:()=>{const r=T||localStorage.getItem("terra_orderId")||localStorage.getItem("terra_lastPaidOrderId");n("/feedback",{state:{orderId:r}})},children:"Share Feedback"}):null})()]})]}),W&&t.jsxs("div",{className:"order-status-card previous-order-detail-card",style:{padding:"12px",fontSize:"0.9rem"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"8px"},children:[t.jsx("h4",{className:"order-summary-title",style:{margin:0,fontSize:"1rem"},children:"Last Order"}),W.status&&t.jsx("span",{className:"meta-chip status-chip",style:{fontSize:"0.75rem",padding:"4px 8px"},children:W.status})]}),t.jsxs("div",{style:{display:"flex",gap:"8px",marginBottom:"8px",flexWrap:"wrap",fontSize:"0.8rem"},children:[Tt&&t.jsx("span",{className:"meta-chip",style:{fontSize:"0.75rem",padding:"2px 6px"},children:Tt}),Xe&&t.jsx("span",{className:"meta-chip",style:{fontSize:"0.75rem",padding:"2px 6px"},children:Xe?Xe.toLocaleDateString():"N/A"})]}),t.jsx("div",{style:{marginBottom:"8px",fontSize:"0.85rem"},children:t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontWeight:"600"},children:[t.jsxs("span",{children:["Total: ₹",Ee(At?.totalAmount||0)]}),t.jsxs("span",{children:[At?.totalItems||0," items"]})]})}),t.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[t.jsx("button",{className:"invoice-action-btn download w-full sm:w-auto",onClick:lr,style:{padding:"6px 12px",fontSize:"0.85rem"},children:"View Invoice"}),W._id&&t.jsx("button",{className:"feedback-button w-full sm:w-auto",onClick:()=>{const e=W._id;n("/feedback",{state:{orderId:e}})},style:{backgroundColor:"#10b981",color:"#ffffff",border:"1px solid #059669",fontWeight:"600",padding:"6px 12px",fontSize:"0.85rem"},children:"Feedback"})]})]})]}),t.jsxs("div",{className:"right-panel",children:[t.jsx("h3",{className:"manual-entry-title",children:qt}),t.jsx("input",{type:"text",placeholder:Ht,value:Oe,onChange:e=>Kt(e.target.value),className:"search-input"}),pe&&!_e&&t.jsx("div",{className:"menu-warning",children:pe}),_e?t.jsx("div",{className:"menu-loading-message",children:"Loading menu, please wait..."}):Oe.trim()?_t.length>0?t.jsx("div",{className:"search-results",children:_t.map(e=>t.jsx(Mt,{item:e,onAdd:kt,onRemove:wt,count:H[e.name]||0,lang:D},e._id||e.name))}):t.jsx("div",{className:"search-no-results",children:"No matching items found. Try another keyword."}):t.jsx("div",{className:"category-container",children:me.length===0?t.jsx("div",{className:"search-no-results",children:"Menu is not configured yet. Please contact the administrator."}):t.jsx(t.Fragment,{children:(Array.isArray(me)?me:[]).map((e,r)=>t.jsx(ea,{defaultOpen:r===0,category:e?.name||"Unnamed Category",items:Array.isArray(e?.items)?e.items:[],cart:H,onAdd:kt,onRemove:wt,lang:D},e?._id||e?.name||Math.random()))})})]})]})})}),$t&&t.jsx("div",{className:"invoice-modal-overlay",onClick:Nt,children:t.jsxs("div",{className:"invoice-modal",role:"dialog","aria-modal":"true",onClick:e=>e.stopPropagation(),children:[t.jsxs("div",{className:"invoice-modal-header",children:[t.jsxs("div",{children:[t.jsx("h3",{children:"Invoice"}),S&&t.jsxs("div",{className:"invoice-meta",children:[t.jsx("span",{children:`Order #${S._id||"—"}`}),Ne&&t.jsx("span",{children:Ne.toLocaleString()})]})]}),t.jsxs("div",{className:"invoice-modal-actions",children:[t.jsx("button",{onClick:nr,disabled:!S||Pe,className:"invoice-action-btn download",children:Pe?"Preparing…":"Download"}),t.jsx("button",{onClick:Nt,className:"invoice-close-btn","aria-label":"Close invoice modal",children:"✕"})]})]}),t.jsxs("div",{ref:Ae,className:"invoice-preview",children:[t.jsxs("div",{className:"invoice-top",children:[t.jsxs("div",{children:[t.jsx("div",{className:"brand-name",children:S?.cafe?.cafeName||S?.cafe?.name||"Terra Cart"}),t.jsx("div",{className:"brand-address",children:S?.cafe?.address||S?.franchise?.address||"123 Main Street, City"}),(S?.franchise?.fssaiNumber||S?.franchise?.fssai||S?.cafe?.fssaiNumber||S?.cafe?.fssai)&&t.jsxs("div",{className:"brand-address",children:["FSSAI No:"," ",S.franchise?.fssaiNumber||S.franchise?.fssai||S.cafe?.fssaiNumber||S.cafe?.fssai]}),(S?.franchise?.gstNumber||S?.cafe?.gstNumber)&&t.jsxs("div",{className:"brand-address",children:["FSSAI No:"," ",S.franchise?.gstNumber||S.cafe?.gstNumber]})]}),t.jsxs("div",{className:"invoice-meta-block",children:[t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Invoice No:"}),t.jsx("span",{children:we||"—"})]}),S?.serviceType==="TAKEAWAY"&&S?.takeawayToken&&t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Token:"}),t.jsx("span",{className:"font-bold text-blue-600",children:S.takeawayToken})]}),Ne&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Date:"}),t.jsx("span",{children:Ne.toLocaleDateString()})]}),t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Time:"}),t.jsx("span",{children:Ne.toLocaleTimeString()})]})]})]})]}),t.jsxs("div",{className:"invoice-billed",children:[t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Service:"}),t.jsx("span",{children:Lt})]}),t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Table:"}),t.jsxs("span",{children:[S?.serviceType==="TAKEAWAY"?"Takeaway Counter":Ft||"—",vt?` · ${vt}`:""]})]}),S?.serviceType==="TAKEAWAY"&&(S.customerName||S.customerMobile)&&t.jsxs(t.Fragment,{children:[S.customerName&&t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Customer Name:"}),t.jsx("span",{children:S.customerName})]}),S.customerMobile&&t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Mobile Number:"}),t.jsx("span",{children:S.customerMobile})]})]}),S?.specialInstructions&&t.jsxs("div",{className:"meta-line",style:{marginTop:"8px",borderTop:"1px dashed #e5e7eb",paddingTop:"4px"},children:[t.jsx("span",{style:{color:"#d97706",fontWeight:"bold"},children:"Note:"}),t.jsx("span",{style:{fontStyle:"italic"},children:S.specialInstructions})]})]}),t.jsxs("table",{className:"invoice-table",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"Item"}),t.jsx("th",{children:"Qty"}),t.jsx("th",{children:"Price (₹)"}),t.jsx("th",{className:"align-right",children:"Amount (₹)"})]})}),t.jsx("tbody",{children:Re.length>0?Re.map(e=>t.jsxs("tr",{children:[t.jsx("td",{children:t.jsxs("div",{className:"flex flex-col gap-0.5",children:[t.jsx("span",{children:e.name}),e.returned&&t.jsxs("span",{className:"invoice-returned-note",children:["Returned ",e.returnedQuantity]})]})}),t.jsx("td",{children:e.quantity>0?e.quantity:"—"}),t.jsxs("td",{children:["₹",Ee(e.unitPrice)]}),t.jsx("td",{className:"align-right",children:e.quantity>0?`₹${Ee(e.amount)}`:"Returned"})]},e.name)):t.jsx("tr",{children:t.jsx("td",{colSpan:4,className:"empty-row",children:"No items found"})})})]}),t.jsxs("div",{className:"invoice-totals",children:[t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Total Items"}),t.jsx("span",{children:Ge.totalItems})]}),t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Subtotal"}),t.jsxs("span",{children:["₹",Ee(Ge.subtotal)]})]}),t.jsxs("div",{className:"meta-line total",children:[t.jsx("span",{children:"Total"}),t.jsxs("span",{children:["₹",Ee(Ge.totalAmount)]})]})]}),t.jsx("div",{className:"invoice-footer",children:"Thank you for dining with Terra Cart. We hope to see you again!"})]})]})}),Ut&&t.jsx("div",{className:"invoice-modal-overlay",onClick:()=>Se(!1),children:t.jsxs("div",{className:"invoice-modal",style:{maxWidth:"24rem",maxHeight:"auto",height:"auto"},onClick:e=>e.stopPropagation(),children:[t.jsxs("div",{className:"invoice-modal-header",children:[t.jsx("div",{children:t.jsx("h3",{children:he==="Cancel"?"Cancel Order":"Return Order"})}),t.jsx("button",{onClick:()=>Se(!1),className:"invoice-close-btn",children:"✕"})]}),t.jsxs("div",{children:[t.jsx("p",{style:{marginBottom:"0.5rem",fontSize:"0.9rem",color:"#666"},children:"Please provide a reason:"}),t.jsx("textarea",{style:{width:"100%",padding:"0.75rem",border:"1px solid #ddd",borderRadius:"0.5rem",minHeight:"100px",fontSize:"0.9rem",marginBottom:"1rem",fontFamily:"inherit",resize:"vertical",boxSizing:"border-box"},placeholder:"e.g. Changed my mind, Taking too long...",value:Me,onChange:e=>Qe(e.target.value)}),t.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:"0.5rem"},children:[t.jsx("button",{className:"reset-button",style:{width:"auto",flex:"1"},onClick:()=>Se(!1),disabled:He,children:"Close"}),t.jsx("button",{className:"confirm-button",style:{width:"auto",flex:"1"},onClick:or,disabled:He,children:He?"Processing...":"Confirm"})]})]})]})}),Object.keys(H).length>0&&!Rt&&t.jsx("div",{className:"menu-cart-footer",children:t.jsxs("div",{className:"menu-cart-footer-inner",children:[t.jsxs("div",{style:{display:"flex",flexDirection:"column"},children:[t.jsxs("span",{style:{fontWeight:"bold",fontSize:"1.1rem",color:"#333"},children:[pt," Items"]}),t.jsxs("span",{style:{color:"#666",fontSize:"0.9rem"},children:["Total: ₹",Yt.toFixed(2)]})]}),t.jsx("button",{onClick:()=>n("/cart"),style:{backgroundColor:"#ff6b35",color:"white",padding:"12px 24px",borderRadius:"50px",fontWeight:"bold",fontSize:"1rem",border:"none",cursor:"pointer",boxShadow:"0 4px 6px rgba(255, 107, 53, 0.3)"},children:"View Cart →"})]})}),t.jsx(Sr,{open:R,steps:Q,title:"Processing your order"})]})}const _a=Object.freeze(Object.defineProperty({__proto__:null,default:ta},Symbol.toStringTag,{value:"Module"}));export{_a as M,Vr as O};
