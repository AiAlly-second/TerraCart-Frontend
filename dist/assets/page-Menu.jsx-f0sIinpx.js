import{r as l,j as t,u as dr,c as ur,f as mr,a as gr,b as pr}from"./vendor-react-D1Ov3a92.js";import{r as _r,H as fr}from"./page-Billing.jsx-A-1Xpv46.js";import{a as Ir}from"./vendor-CB8mghnX.js";import{P as Sr,a as hr,b as br,p as xt,m as yr}from"./page-CartPage.jsx-B3iSWPr5.js";/* empty css                          */import{l as vr}from"./vendor-socket-DJ_CsPWr.js";import{h as Ar,E as kr}from"./vendor-pdf-KWoZMcRy.js";import{m as Tr}from"./vendor-motion-DMcOTFRV.js";const wr="http://localhost:5050".replace(/\/$/,""),tt="translation_service_unavailable",rt="translation_service_check_timestamp",Nr=6e4,Er=()=>{try{const n=sessionStorage.getItem(tt),I=sessionStorage.getItem(rt);if(n==="true"&&I){const v=Date.now(),j=parseInt(I,10);if(v-j<Nr)return!0}}catch{}return!1},jt=()=>{try{sessionStorage.setItem(tt,"true"),sessionStorage.setItem(rt,Date.now().toString())}catch{}},xr=()=>{try{sessionStorage.removeItem(tt),sessionStorage.removeItem(rt)}catch{}},jr=async(n,I)=>{if(Er())return n;try{const v=await Ir.post(`${wr}/api/translate`,{text:n,targetLang:I},{validateStatus:()=>!0,timeout:1500,transformRequest:[j=>j],transformResponse:[j=>j]});if(v.status===200&&v.data?.translatedText){xr();const j=v.data.translatedText;return j.match(/as\s+"(.*?)"/)?.[1]||j||n}else return jt(),n}catch(v){return(v.code==="ECONNREFUSED"||v.code==="ERR_NETWORK"||v.code==="ECONNABORTED"||v.message==="Network Error"||v.message?.includes("ERR_CONNECTION_REFUSED")||v.message?.includes("timeout"))&&jt(),n}},Pt=n=>{const[I,v]=l.useState(n),[j,O]=l.useState(!1);return l.useEffect(()=>{const K=localStorage.getItem("language")||"en";K==="en"?(v(n),O(!1)):(O(!0),jr(n,K).then(p=>{v(p),O(!1)}).catch(p=>{v(n),O(!1)}))},[n]),[I,j]},Cr={manualEntry:"Menu",smartServe:"Smart Serve",aiOrdered:"AI Ordered:",orderSummary:"Order Summary:",confirm:"Confirm",speakOrder:"Speak Order",processingVoice:"Processing your voice...",cartEmpty:"Cart is empty",resetOrder:"Reset Order",tapToStop:"Tap to Stop",tapToOrder:"Tap to Order",searchPlaceholder:"Search item...",resetOrderBtn:"Reset Order",recordVoiceAria:"Record voice order",processSteps:{checkingOrder:"Checking your order",confirmingItems:"Confirming items & price",placingOrder:"Placing your order",sendingToKitchen:"Sending to kitchen",preparingDetails:"Preparing order details"},dineIn:"Dine-In",table:"Table",takeaway:"Takeaway",callWaiter:"Call Waiter",requestWater:"Request Water",vegOnly:"Veg Only",popular:"Popular",spicy:"Spicy",token:"Token"},Or={manualEntry:"मेनू",smartServe:"स्मार्ट सर्व",aiOrdered:"एआई द्वारा ऑर्डर:",orderSummary:"ऑर्डर सारांश:",confirm:"पुष्टि करें",speakOrder:"ऑर्डर सुनाएं",processingVoice:"आपकी आवाज़ प्रोसेस हो रही है...",cartEmpty:"कार्ट खाली है",resetOrder:"ऑर्डर रीसेट करें",tapToStop:"रोकने के लिए टैप करें",tapToOrder:"ऑर्डर करने के लिए टैप करें",searchPlaceholder:"आइटम खोजें...",resetOrderBtn:"ऑर्डर रीसेट करें",recordVoiceAria:"आवाज़ से ऑर्डर रिकॉर्ड करें",processSteps:{checkingOrder:"आपका ऑर्डर चेक कर रहे हैं",confirmingItems:"आइटम और कीमत की पुष्टि",placingOrder:"ऑर्डर प्लेस कर रहे हैं",sendingToKitchen:"किचन को भेज रहे हैं",preparingDetails:"ऑर्डर विवरण तैयार"},dineIn:"डाइन-इन",table:"टेबल",takeaway:"टेकअवे",callWaiter:"वेटर को बुलाएं",requestWater:"पानी मांगें",vegOnly:"केवल शाकाहारी",popular:"लोकप्रिय",spicy:"मसालेदार",token:"टोकन"},Dr={manualEntry:"मेनू",smartServe:"स्मार्ट सर्व",aiOrdered:"एआय ने ऑर्डर केले:",orderSummary:"ऑर्डर सारांश:",confirm:"निश्चित करा",speakOrder:"ऑर्डर बोला",processingVoice:"तुमचा आवाज प्रोसेस होत आहे...",cartEmpty:"कार्ट रिकामे आहे",resetOrder:"ऑर्डर रीसेट करा",tapToStop:"थांबवण्यासाठी टॅप करा",tapToOrder:"ऑर्डर करण्यासाठी टॅप करा",searchPlaceholder:"वस्तू शोधा...",resetOrderBtn:"ऑर्डर रीसेट करा",recordVoiceAria:"आवाज रेकॉर्ड करा",processSteps:{checkingOrder:"तुमची ऑर्डर तपासत आहे",confirmingItems:"वस्तू आणि किंमत निश्चित करत आहे",placingOrder:"ऑर्डर देत आहे",sendingToKitchen:"किचनला पाठवत आहे",preparingDetails:"ऑर्डर तपशील तयार"},dineIn:"डाइन-इन",table:"टेबल",takeaway:"टेकअवे",callWaiter:"वेटरला बोलवा",requestWater:"पाणी मागवा",vegOnly:"फक्त शाकाहारी",popular:"लोकप्रिय",spicy:"तिखट",token:"टोकन"},Pr={manualEntry:"મેનુ",smartServe:"સ્માર્ટ સર્વ",aiOrdered:"એઆઈ દ્વારા ઓર્ડર:",orderSummary:"ઓર્ડર સારાંશ:",confirm:"પુષ્ટિ કરો",speakOrder:"ઓર્ડર બોલો",processingVoice:"તમારો અવાજ પ્રોસેસ થઈ રહ્યો છે...",cartEmpty:"કાર્ટ ખાલી છે",resetOrder:"ઓર્ડર રીસેટ કરો",tapToStop:"રોકવા માટે ટૅપ કરો",tapToOrder:"ઓર્ડર કરવા માટે ટૅપ કરો",searchPlaceholder:"વસ્તુ શોધો...",resetOrderBtn:"ઓર્ડર રીસેટ કરો",recordVoiceAria:"અવાજ રેકોર્ડ કરો",processSteps:{checkingOrder:"તમારો ઓર્ડર તપાસી રહ્યા છીએ",confirmingItems:"વસ્તુઓ અને કિંમતની પુષ્ટિ",placingOrder:"ઓર્ડર આપી રહ્યા છીએ",sendingToKitchen:"કિચનમાં મોકલી રહ્યા છીએ",preparingDetails:"ઓર્ડર વિગતો તૈયાર"},dineIn:"ડાઇન-ઇન",table:"ટેબલ",takeaway:"ટેકઅવે",callWaiter:"વેટરને બોલાવો",requestWater:"પાણી મંગાવો",vegOnly:"માત્ર શાકાहारी",popular:"લોકપ્રિય",spicy:"મસાલેદાર",token:"ટોકન"},Mr={en:Cr,hi:Or,mr:Dr,gu:Pr},Wr={categories:{all_time_hit:"All Time Hit",mini_thali:"Mini Thali",fries:"Fries",starters:"Starters",veg_starters:"Veg Starters",tandoor_specials:"Tandoor Specials",maharashtrian:"Maharashtrian",punjabi:"Punjabi",paneer_specials:"Paneer Specials",rice:"Rice",roti:"Roti",dal:"Dal",chinese:"Chinese",thali:"Thali",desserts:"Desserts",beverages:"Beverages",street_snacks:"Street Snacks",north_indian_curries:"North Indian Curries",breads_rice:"Breads & Rice",regional_specials:"Regional Specials",desserts_beverages:"Desserts & Beverages",main_course:"Main Course"},items:{veg_sandwich:"Veg Sandwich",dosa:"Dosa",peanut_curry:"Peanut Curry",misal:"Misal",paneer_junglee_sandwich:"Paneer Junglee Sandwich",mumbai_sandwich:"Mumbai Sandwich",terra_wada_pav:"Terra Wada Pav",gluten_free_dosai:"Gluten Free Dosai",kothimbir_wadi:"Kothimbir Wadi",bombay_pav_bhaji:"Bombay Pav Bhaji",pizza_bomb:"Pizza Bomb",mini_batata_wada:"Mini Batata Wada",appe_chutney:"Appe & Chutney",namaste_misal_pav_dahi:"Namaste Misal Pav & Dahi",chola_kulcha:"Chola Kulcha",rajma_chawal:"Rajma Chawal",dal_makhni_jeera_rice:"Dal Makhni Jeera Rice",veg_korma_paratha:"Veg Korma & Malbori Paratha",dal_khichadi_dahi:"Dal Fry Rice / Dal Khichadi Dahi",schezwan_rice_manchurian:"Schezwan Rice & Manchurian",mumbai_vada_pav:"Mumbai Vada Pav",punjabi_samosa_chaat:"Punjabi Samosa Chaat",paneer_kathi_roll:"Paneer Kathi Roll",paneer_butter_masala:"Paneer Butter Masala",amritsari_chole:"Amritsari Chole",dal_tadka:"Dal Tadka",garlic_butter_naan:"Garlic Butter Naan",tandoori_roti:"Tandoori Roti",veg_dum_biryani:"Veg Dum Biryani",hyderabadi_chicken_65:"Hyderabadi Chicken 65",goan_fish_curry:"Goan Fish Curry",kerala_parotta_combo:"Kerala Parotta Combo",classic_gulab_jamun:"Classic Gulab Jamun",kulfi_falooda:"Kulfi Falooda",masala_chaas:"Masala Chaas"}},Rr={categories:{all_time_hit:"हमेशा पसंदीदा",mini_thali:"मिनी थाली",fries:"फ्राइज़",starters:"स्टार्टर्स",veg_starters:"शाकाहारी स्टार्टर",tandoor_specials:"तंदूरी स्पेशल",maharashtrian:"महाराष्ट्रीयन",punjabi:"पंजाबी",paneer_specials:"पनीर स्पेशल",rice:"चावल",roti:"रोटी",dal:"दाल",chinese:"चाइनीज़",thali:"थाली",desserts:"मिठाई",beverages:"पेय",street_snacks:"स्ट्रीट स्नैक्स",north_indian_curries:"उत्तर भारतीय करी",breads_rice:"रोटियाँ और चावल",regional_specials:"क्षेत्रीय विशेष",desserts_beverages:"डेसर्ट और पेय",main_course:"मुख्य भोजन"},items:{veg_sandwich:"वेज सैंडविच",dosa:"डोसा",peanut_curry:"पीनट करी",misal:"मिसल",paneer_junglee_sandwich:"पनीर जंगली सैंडविच",mumbai_sandwich:"मुंबई सैंडविच",terra_wada_pav:"टेरा वडा पाव",gluten_free_dosai:"ग्लूटेन फ्री डोसा",kothimbir_wadi:"कोथिंबीर वड़ी",bombay_pav_bhaji:"बॉम्बे पाव भाजी",pizza_bomb:"पिज़्ज़ा बॉम्ब",mini_batata_wada:"मिनी बटाटा वडा",appe_chutney:"अप्पे और चटनी",namaste_misal_pav_dahi:"नमस्ते मिसल पाव और दही",chola_kulcha:"छोला कुलचा",rajma_chawal:"राजमा चावल",dal_makhni_jeera_rice:"दाल मखनी जीरा चावल",veg_korma_paratha:"वेज कोरमा और पराठा",dal_khichadi_dahi:"दाल खिचड़ी दही",schezwan_rice_manchurian:"सिचुआन चावल और मंचूरियन",mumbai_vada_pav:"मुंबई वडा पाव",punjabi_samosa_chaat:"पंजाबी समोसा चाट",paneer_kathi_roll:"पनीर काठी रोल",paneer_butter_masala:"पनीर बटर मसाला",amritsari_chole:"अमृतसरी छोले",dal_tadka:"दाल तड़का",garlic_butter_naan:"गार्लिक बटर नान",tandoori_roti:"तंदूरी रोटी",veg_dum_biryani:"वेज दम बिरयानी",hyderabadi_chicken_65:"हैद्राबादी चिकन 65",goan_fish_curry:"गोअन फिश करी",kerala_parotta_combo:"केरल परोटा कॉम्बो",classic_gulab_jamun:"क्लासिक गुलाब जामुन",kulfi_falooda:"कुल्फी फालूदा",masala_chaas:"मसाला छाछ"}},$r={categories:{all_time_hit:"सर्वकालीन हिट",mini_thali:"मिनी थाळी",fries:"फ्राईज",starters:"स्टार्टर्स",veg_starters:"व्हेज स्टार्टर",tandoor_specials:"तंदूर स्पेशल",maharashtrian:"महाराष्ट्रीयन",punjabi:"पंजाबी",paneer_specials:"पनीर स्पेशल",rice:"भात",roti:"पोळी",dal:"डाळ",chinese:"चायनीज",thali:"थाळी",desserts:"गोड पदार्थ",beverages:"पेय",street_snacks:"स्ट्रीट स्नॅक्स",north_indian_curries:"उत्तर भारतीय करी",breads_rice:"पोळी आणि भात",regional_specials:"प्रादेशिक स्पेशल",desserts_beverages:"डेझर्ट आणि पेय",main_course:"मुख्य जेवण"},items:{veg_sandwich:"व्हेज सँडविच",dosa:"डोसा",peanut_curry:"शेंगदाणा आमटी",misal:"मिसळ",paneer_junglee_sandwich:"पनीर जंगलि सँडविच",mumbai_sandwich:"मुंबई सँडविच",terra_wada_pav:"टेरा वडा पाव",gluten_free_dosai:"ग्लूटेन फ्री डोसा",kothimbir_wadi:"कोथिंबीर वडी",bombay_pav_bhaji:"बॉम्बे पाव भाजी",pizza_bomb:"पिझ्झा बॉम्ब",mini_batata_wada:"मिनी बटाटा वडा",appe_chutney:"अप्पे आणि चटणी",namaste_misal_pav_dahi:"नमस्ते मिसळ पाव आणि दही",chola_kulcha:"छोला कुलचा",rajma_chawal:"राजमा भात",dal_makhni_jeera_rice:"डाळ मखनी जिरा भात",veg_korma_paratha:"व्हेज कोरमा आणि पराठा",dal_khichadi_dahi:"डाळ खिचडी दही",schezwan_rice_manchurian:"सिचुआन भात आणि मंचुरियन",mumbai_vada_pav:"मुंबई वडा पाव",punjabi_samosa_chaat:"पंजाबी समोसा चाट",paneer_kathi_roll:"पनीर काठी रोल",paneer_butter_masala:"पनीर बटर मसाला",amritsari_chole:"अमृतसरी छोले",dal_tadka:"दाल तडका",garlic_butter_naan:"गार्लिक बटर नान",tandoori_roti:"तंदूरी रोटी",veg_dum_biryani:"व्हेज दम बिर्याणी",hyderabadi_chicken_65:"हैद्राबादी चिकन 65",goan_fish_curry:"गोअन फिश करी",kerala_parotta_combo:"केरळ परोटा कॉम्बो",classic_gulab_jamun:"क्लासिक गुलाब जामुन",kulfi_falooda:"कुल्फी फालूदा",masala_chaas:"मसाला ताक"}},Kr={categories:{all_time_hit:"Succès intemporel",mini_thali:"Mini Thali",fries:"Frites",starters:"Entrées",veg_starters:"Entrées végétariennes",tandoor_specials:"Spécialités Tandoor",maharashtrian:"Maharashtrien",punjabi:"Punjabi",paneer_specials:"Spécial Paneer",rice:"Riz",roti:"Pain",dal:"Lentilles",chinese:"Chinois",thali:"Thali",desserts:"Desserts",beverages:"Boissons"},items:{veg_sandwich:"Sandwich Végétarien",paneer_junglee_sandwich:"Sandwich Paneer Junglee",mumbai_sandwich:"Sandwich Mumbai",terra_wada_pav:"Terra Wada Pav",gluten_free_dosai:"Dosai sans gluten",kothimbir_wadi:"Kothimbir Wadi",bombay_pav_bhaji:"Pav Bhaji de Bombay",pizza_bomb:"Pizza Bomb",mini_batata_wada:"Mini Batata Wada",appe_chutney:"Appe & Chutney",namaste_misal_pav_dahi:"Namaste Misal Pav & Yaourt",chola_kulcha:"Chola Kulcha",rajma_chawal:"Rajma Chawal",dal_makhni_jeera_rice:"Dal Makhni Riz au Cumin",veg_korma_paratha:"Korma Végétarien & Paratha",dal_khichadi_dahi:"Dal Khichadi & Yaourt",schezwan_rice_manchurian:"Riz Schezwan & Manchurian"}},Yr={categories:{all_time_hit:"ઓલ ટાઇમ હિટ",mini_thali:"મિની થાળી",fries:"ફ્રાઈસ",starters:"સ્ટાર્ટર્સ",veg_starters:"વેજ સ્ટાર્ટર્સ",tandoor_specials:"તંદૂર સ્પેશિયલ",maharashtrian:"મહારાષ્ટ્રીયન",punjabi:"પંજાબી",paneer_specials:"પનીર સ્પેશિયલ",rice:"ભાત",roti:"રોટલી",dal:"દાળ",chinese:"ચાઈનીઝ",thali:"થાળી",desserts:"મીઠાઈ",beverages:"પીણાં",street_snacks:"સ્ટ્રીટ સ્નેક્સ",north_indian_curries:"ઉત્તર ભારતીય કરી",breads_rice:"રોટલી અને ભાત",regional_specials:"પ્રાદેશિક સ્પેશિયલ",desserts_beverages:"ડેઝર્ટ અને પીણાં",main_course:"મુખ્ય ભોજન"},items:{veg_sandwich:"વેજ સેન્ડવીચ",dosa:"ઢોસા",peanut_curry:"સીંગની કઢી",misal:"મિસળ",paneer_junglee_sandwich:"પનીર જંગલી સેન્ડવીચ",mumbai_sandwich:"મુંબઈ સેન્ડવીચ",terra_wada_pav:"ટેરા વડા પાવ",gluten_free_dosai:"ગ્લુટેન ફ્રી ઢોસા",kothimbir_wadi:"કોથમીર વડી",bombay_pav_bhaji:"બોમ્બે પાવ ભાજી",pizza_bomb:"પીઝા બોમ્બ",mini_batata_wada:"મિની બટાટા વડા",appe_chutney:"અપ્પે અને ચટણી",namaste_misal_pav_dahi:"નમસ્તે મિસળ પાવ અને દહીં",chola_kulcha:"છોલે કુલચા",rajma_chawal:"રાજમા ચાવલ",dal_makhni_jeera_rice:"દાલ મખની જીરા રાઇસ",veg_korma_paratha:"વેજ કોરમા અને પરાઠા",dal_khichadi_dahi:"દાલ ખીચડી દહીં",schezwan_rice_manchurian:"શેઝવાન રાઇસ અને મંચુરિયન",mumbai_vada_pav:"મુંબઈ વડા પાવ",punjabi_samosa_chaat:"પંજાબી સમોસા ચાટ",paneer_kathi_roll:"પનીર કાઠી રોલ",paneer_butter_masala:"પનીર બટર મસાલા",amritsari_chole:"અમૃતસરી છોલે",dal_tadka:"દાલ તડકા",garlic_butter_naan:"ગાર્લિક બટર નાન",tandoori_roti:"તંદૂરી રોટી",veg_dum_biryani:"વેજ દમ બિરયાની",hyderabadi_chicken_65:"હૈદરાબાદી ચિકન 65",goan_fish_curry:"ગોલ્ડન ફિશ કરી",kerala_parotta_combo:"કેરળ પરોટા કોમ્બો",classic_gulab_jamun:"ક્લાસિક ગુલાબ જાંબુ",kulfi_falooda:"કુલ્ફી ફાલુદા",masala_chaas:"મસાલા છાશ"}},$e={en:Wr,hi:Rr,mr:$r,fr:Kr,gu:Yr},Mt=[{key:"Pending",label:"Order Placed",index:0},{key:"Confirmed",label:"Order Confirmed",index:1},{key:"Preparing",label:"Preparing Order",index:2},{key:"Ready",label:"Ready to Serve",index:3},{key:"Served",label:"Served",index:4},{key:"Finalized",label:"Finalized",index:5},{key:"Paid",label:"Paid",index:6}],Wt=[{key:"Pending",label:"Order Placed",index:0},{key:"Accepted",label:"Accepted",index:1},{key:"Being Prepared",label:"Being Prepared",index:2},{key:"BeingPrepared",label:"Being Prepared",index:2},{key:"Completed",label:"Completed",index:3},{key:"Paid",label:"Paid",index:4}],Ur=["Pending","Confirmed","Preparing","Ready","Served","Finalized","Paid"],Lr=["Pending","Accepted","Being Prepared","Completed","Paid"];function Fr(n){const I=n==="TAKEAWAY"?Wt:Mt;return(n==="TAKEAWAY"?Lr:Ur).map(j=>I.find(O=>O.key===j)).filter(Boolean)}function qr(n,I){const v=I==="TAKEAWAY"?Wt:Mt,j=v.find(p=>p.key===n);if(j!=null)return j.index;const O=v.filter(p=>p.index>=0);return Math.max(...O.map(p=>p.index),-1)}function zr({status:n="Pending",className:I="",updatedAt:v,serviceType:j="DINE_IN",tableLabel:O}){const K=Fr(j),p=qr(n,j),P=v?new Date(v).toLocaleTimeString():null;return["Cancelled","Returned"].includes(n)?t.jsx("div",{className:`order-status-timeline ${I}`,children:t.jsxs("div",{className:"order-status-timeline-step order-status-step-completed",children:[t.jsx("div",{className:"order-status-dot order-status-dot-completed"}),t.jsxs("div",{className:"order-status-step-content",children:[t.jsx("span",{className:"order-status-step-label",children:n}),P&&t.jsxs("span",{className:"order-status-step-meta",children:["Updated ",P]})]})]})}):t.jsxs("div",{className:`order-status-timeline ${I}`,children:[P&&t.jsxs("div",{className:"order-status-updated-meta",children:["Updated ",P]}),K.map((D,H)=>{const ne=D.index,Y=p>ne,ie=p===ne,ae=p<ne,G=H===K.length-1,oe=H===0&&O?O:D.label;return t.jsx("div",{className:"order-status-timeline-step-wrapper",children:t.jsxs("div",{className:"order-status-timeline-step",children:[t.jsxs("div",{className:"order-status-step-left",children:[t.jsx("div",{className:`order-status-dot ${Y?"order-status-dot-completed":""} ${ie?"order-status-dot-active":""} ${ae?"order-status-dot-pending":""}`,children:Y&&t.jsx("svg",{className:"order-status-check",viewBox:"0 0 12 12",fill:"none",stroke:"white",strokeWidth:"2.5",strokeLinecap:"round",children:t.jsx("path",{d:"M2 6l3 3 5-6"})})}),!G&&t.jsx("div",{className:"order-status-line"})]}),t.jsxs("div",{className:"order-status-step-content",children:[t.jsx("span",{className:`order-status-step-label ${ie?"order-status-step-label-active":""} ${ae?"order-status-step-label-pending":""}`,children:oe}),ie&&P&&t.jsxs("span",{className:"order-status-step-meta",children:["Updated ",P]})]})]})},D.key)})]})}const W="https://api.terracart.in".replace(/\/$/,""),Ze="http://localhost:5050".replace(/\/$/,""),Br=n=>n?n.startsWith("http://")||n.startsWith("https://")?n:n.startsWith("/")?`${W}${n}`:`${W}/uploads/${n}`:"/defaultImg.jpg",q="terra_serviceType",we="terra_selectedTable",Vr=["Pending","Confirmed","Preparing","Ready","Served","Completed","Paid","Returned","Cancelled"],Jr=["Pending","Confirmed","Preparing","Ready","Served","Finalized","Completed"],Qr=["Paid"],Hr=n=>{if(n==null)return 0;const I=Number(n);return Number.isNaN(I)?0:I/100},Ne=n=>{const I=Number(n);return Number.isNaN(I)?"0.00":I.toFixed(2)},Ct=n=>{if(!n)return"INV-NA";const I=new Date(n.createdAt||Date.now()).toISOString().slice(0,10).replace(/-/g,""),v=(n.cartId||n._id||"").toString().slice(-6).toUpperCase();return`INV-${I}-${v}`},et=n=>{if(!n)return[];const I=new Map;return(Array.isArray(n.kotLines)?n.kotLines:[]).forEach(O=>{(O?.items||[]).forEach(K=>{if(!K)return;const p=K.name||"Item",P=Number(K.quantity)||0,F=Hr(K.price||0),D=!!K.returned;I.has(p)||I.set(p,{name:p,unitPrice:F,activeQuantity:0,returnedQuantity:0,totalQuantity:0,amount:0,returned:!1});const H=I.get(p);H.totalQuantity+=P,D?(H.returnedQuantity+=P,H.returned=!0):(H.activeQuantity+=P,H.amount+=F*P),H.unitPrice||(H.unitPrice=F)})}),(n.selectedAddons||[]).forEach(O=>{const K=`(+) ${O.name}`,p=1,P=Number(O.price)||0;I.has(K)||I.set(K,{name:K,unitPrice:P,activeQuantity:0,returnedQuantity:0,totalQuantity:0,amount:0,returned:!1});const F=I.get(K);F.totalQuantity+=p,F.activeQuantity+=p,F.amount+=P*p}),Array.from(I.values()).map(O=>({...O,quantity:O.activeQuantity}))},Ot=(n,I)=>{if(!n)return{subtotal:0,gst:0,totalAmount:0,totalItems:0};const v=Array.isArray(I)?I:et(n)||[],j=v.reduce((P,F)=>{if(!F)return P;const D=Number(F.amount)||0;return P+D},0),O=Number(j.toFixed(2));return{subtotal:O,gst:0,totalAmount:O,totalItems:v.reduce((P,F)=>F?P+(Number(F.quantity)||0):P,0)}},Dt=n=>{if(!n)return null;const I=n.paidAt||n.updatedAt||n.createdAt;if(!I)return null;const v=new Date(I);return Number.isNaN(v.getTime())?null:v},Gr=n=>{const I={};return n.forEach(v=>{(v.items||[]).forEach(j=>{I[j.name]=j})}),I},Rt=({item:n,onAdd:I,onRemove:v,count:j,lang:O})=>{if(!n)return null;const K=O||localStorage.getItem("language")||"en";let p=null;if($e[K]?.items){const H=n.name?.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"");p=$e[K].items[H]}const[P]=Pt(n.name||""),F=p||P,D=n.isAvailable!==!1;return t.jsxs(Tr.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.5},className:`item-card group ${D?"":"unavailable"}`,children:[t.jsx("div",{className:"item-image-container",children:t.jsx("img",{src:Br(n?.image),alt:n?.name||"Menu item",className:"item-image"})}),t.jsxs("div",{className:"item-info-section",children:[t.jsx("h4",{className:"item-name",children:F||n?.name||"Unnamed Item"}),t.jsxs("p",{className:"item-price",children:["₹",n?.price||0]}),!D&&t.jsx("span",{className:"item-status-badge unavailable",children:"Not available"})]}),t.jsx("div",{className:"item-footer",children:t.jsxs("div",{className:"item-controls",children:[t.jsx("button",{"aria-label":`Remove one ${n?.name||"item"}`,className:"quantity-button",onClick:()=>n?.name&&v(n.name),disabled:!j,children:"-"}),t.jsx("span",{className:"item-count",children:j||0}),t.jsx("button",{"aria-label":`Add one ${n?.name||"item"}`,className:`quantity-button ${D?"":"disabled"}`,onClick:()=>n&&I(n),disabled:!D,title:D?void 0:"Currently unavailable",children:"+"})]})})]})},Xr=({category:n,items:I,cart:v,onAdd:j,onRemove:O,lang:K,defaultOpen:p=!1})=>{if(!n)return null;const P=K||localStorage.getItem("language")||"en";let F=null;if($e[P]?.categories){const ae=n?.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"");F=$e[P].categories[ae]}const[D]=Pt(n||""),H=F||D,[ne,Y]=l.useState(p),ie=Array.isArray(I)?I:[];return t.jsxs("div",{className:"category-wrapper",children:[t.jsxs("button",{onClick:()=>Y(ae=>!ae),className:"category-button",children:[H||n," ",t.jsx("span",{children:ne?"▲":"▼"})]}),ne&&t.jsx("div",{className:"category-items",children:ie.map((ae,G)=>t.jsx(Rt,{item:ae,onAdd:j,onRemove:O,count:v[ae?.name]||0,lang:P},ae?._id||`${n}-${G}`))})]})};function Zr(){const n=dr(),I=ur(),[v,j]=mr(),[O,K]=l.useState(localStorage.getItem("language")||"en");l.useEffect(()=>{const e=()=>{K(localStorage.getItem("language")||"en")};return window.addEventListener("storage",e),window.addEventListener("language-change",e),()=>{window.removeEventListener("storage",e),window.removeEventListener("language-change",e)}},[]);const p=(e,r)=>{if(!e)return r;const s=e.split(".");let o=Mr[O];for(const c of s)o=o?.[c];return o||r},P=[{label:p("processSteps.checkingOrder","Checking your order"),state:"pending"},{label:p("processSteps.confirmingItems","Confirming items & price"),state:"pending"},{label:p("processSteps.placingOrder","Placing your order"),state:"pending"},{label:p("processSteps.sendingToKitchen","Sending to kitchen"),state:"pending"},{label:p("processSteps.preparingDetails","Preparing order details"),state:"pending"}],[F,D]=l.useState(!1),[H,ne]=l.useState(P),Y=(e,r)=>ne(s=>s.map((o,c)=>c===e?{...o,state:r}:o)),[ie,ae]=l.useState(localStorage.getItem("accessibilityMode")==="true"),[G,oe]=l.useState(()=>{const e=localStorage.getItem("terra_cart");return e?JSON.parse(e):{}});l.useEffect(()=>{localStorage.setItem("terra_cart",JSON.stringify(G))},[G]);const[he,ge]=l.useState(!1),[at,pe]=l.useState(""),[$t,Ee]=l.useState(!1),[Ke,ot]=l.useState(!1),[st,Ye]=l.useState(!1),[nt,Ue]=l.useState(!1),[lt,it]=l.useState(!1),[ct,ce]=l.useState(!1),[ea,dt]=l.useState(null),[Kt,ta]=l.useState(!1),[xe,Yt]=l.useState(""),[de,ut]=l.useState([]),[_e,mt]=l.useState({}),[je,Le]=l.useState(!0),[ue,gt]=l.useState(null),J=l.useMemo(()=>!Array.isArray(de)||de.length===0?[]:de.flatMap(e=>e?(Array.isArray(e.items)?e.items:[]).map(r=>({...r,categoryName:e?.name||"Menu"})):[]),[de]),{cartTotal:Ut,cartItemCount:pt}=l.useMemo(()=>{let e=0,r=0;return Object.entries(G).forEach(([s,o])=>{r+=o;const c=J.find(d=>d.name===s);c&&(e+=(c.price||0)*o)}),{cartTotal:e,cartItemCount:r}},[G,J]),_t=l.useMemo(()=>{const e=xe.trim().toLowerCase();return e?!Array.isArray(J)||J.length===0?[]:J.filter(r=>r?.name?r.name.toLowerCase().includes(e)||(r.description||"").toLowerCase().includes(e)||(r.tags||[]).some(s=>s&&s.toLowerCase().includes(e)):!1):[]},[J,xe]),be=l.useRef(null),ye=l.useRef(null),[w,z]=l.useState(()=>{const e=localStorage.getItem(q)||"DINE_IN";let r=null;return e==="TAKEAWAY"?r=localStorage.getItem("terra_orderId_TAKEAWAY"):r=localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),r||null}),[E,B]=l.useState(()=>(localStorage.getItem(q)||"DINE_IN")==="TAKEAWAY"&&localStorage.getItem("terra_orderStatus_TAKEAWAY")||localStorage.getItem("terra_orderStatus")||null),[le,Q]=l.useState(()=>(localStorage.getItem(q)||"DINE_IN")==="TAKEAWAY"&&localStorage.getItem("terra_orderStatusUpdatedAt_TAKEAWAY")||localStorage.getItem("terra_orderStatusUpdatedAt")||null),[N,ve]=l.useState(()=>localStorage.getItem("terra_takeaway_only")==="true"?"TAKEAWAY":localStorage.getItem(q)||"DINE_IN"),[$,Fe]=l.useState(()=>{try{const e=localStorage.getItem(we);return e?JSON.parse(e):null}catch(e){return console.warn("Invalid table selection cache",e),null}}),[Ce,X]=l.useState(()=>localStorage.getItem("terra_sessionToken"));l.useEffect(()=>{(async()=>{if((localStorage.getItem(q)||"DINE_IN")==="TAKEAWAY")return;const s=localStorage.getItem("terra_orderId"),o=localStorage.getItem("terra_sessionToken");if(!(!s||!o))try{const c=await fetch(`${W}/api/orders/${s}`);if(!c.ok){c.status===404?(console.log("[Menu] Active order not found (404), clearing order data"),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"),z(null),B(null),Q(null)):console.warn("[Menu] Error verifying order (non-404), keeping existing status:",c.status);return}let d;try{d=await c.json()}catch(i){console.error("[Menu] Failed to parse order response as JSON:",i);return}if(!d)return;d.sessionToken&&d.sessionToken!==o&&(console.log("[Menu] Clearing stale dine-in order data for old session"),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_previousOrder"),localStorage.removeItem("terra_previousOrderDetail"),z(null),B(null),Q(null))}catch(c){console.warn("[Menu] Error verifying active order session (network error), keeping existing status:",c)}})()},[]),l.useEffect(()=>{const e=localStorage.getItem("terra_sessionToken"),r=Ce,s=localStorage.getItem(q)||"DINE_IN";e&&r&&e!==r&&(s!=="TAKEAWAY"&&(console.log("[Menu] SessionToken changed - clearing old dine-in order data"),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_previousOrder"),localStorage.removeItem("terra_previousOrderDetail"),localStorage.removeItem("terra_lastPaidOrderId"),localStorage.removeItem("terra_cart_DINE_IN"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN"),z(null),B(null),Q(null)),X(e))},[Ce]),l.useEffect(()=>{const e=localStorage.getItem(q)||"DINE_IN";let r=null;e==="TAKEAWAY"?r=localStorage.getItem("terra_orderId_TAKEAWAY"):r=localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),r&&r!==w?z(r):!r&&w&&z(null)},[N,w]),l.useEffect(()=>{if(N==="DINE_IN")return;const e=!!localStorage.getItem("terra_scanToken")||!!localStorage.getItem("terra_selectedTable"),r=!!(typeof window<"u"&&new URLSearchParams(window.location.search).get("table")),s=localStorage.getItem("terra_takeaway_only")==="true";if(N==="TAKEAWAY"&&((e||r)&&!s))return;const c=localStorage.getItem("terra_takeaway_customerName");(!c||!c.trim())&&(console.warn(`[Menu] Missing customer name for ${N} order - redirecting to SecondPage`),n("/secondpage",{replace:!0}))},[N,n]);const[ra]=l.useState(()=>localStorage.getItem("terra_takeaway_customerName")||""),[aa]=l.useState(()=>localStorage.getItem("terra_takeaway_customerMobile")||""),[oa]=l.useState(()=>localStorage.getItem("terra_takeaway_customerEmail")||""),[Ae,ft]=l.useState(()=>{try{const e=localStorage.getItem("terra_previousOrder");return e?JSON.parse(e):null}catch(e){return console.warn("Invalid previous order cache",e),localStorage.removeItem("terra_previousOrder"),null}}),[R,It]=l.useState(()=>{try{const e=localStorage.getItem("terra_previousOrderDetail");return e?JSON.parse(e):null}catch(e){return console.warn("Invalid previous order detail cache",e),localStorage.removeItem("terra_previousOrderDetail"),null}}),[Lt,qe]=l.useState(!1),[A,ze]=l.useState(null),[St,Oe]=l.useState(!1),[Be,fe]=l.useState(!1),[De,Ve]=l.useState(!1),[Ft,Ie]=l.useState(!1),[Se,ht]=l.useState(null),[Pe,Je]=l.useState(""),[Qe,bt]=l.useState(!1),se=l.useCallback(e=>{e?(ft(e),localStorage.setItem("terra_previousOrder",JSON.stringify(e))):(ft(null),localStorage.removeItem("terra_previousOrder"))},[]),ee=l.useCallback(e=>{e?(It(e),localStorage.setItem("terra_previousOrderDetail",JSON.stringify(e))):(It(null),localStorage.removeItem("terra_previousOrderDetail"))},[]),Me=l.useCallback((e={})=>{const r=e.orderId||w;if(!r)return;const s=e.status||E||"Confirmed",o=e.updatedAt||le||new Date().toISOString(),c=e.tableInfo||$||(()=>{try{const x=localStorage.getItem(we);return x?JSON.parse(x):null}catch{return null}})(),d=e.tableNumber??c?.number??c?.tableNumber??null,i=e.tableSlug??c?.qrSlug??localStorage.getItem("terra_scanToken")??null;se({orderId:r,status:s,updatedAt:o,tableNumber:d,tableSlug:i})},[w,E,le,$,se]),ke=l.useMemo(()=>A?Ct(A):null,[A]),We=l.useMemo(()=>et(A),[A]),He=l.useMemo(()=>A?Ot(A,We):{subtotal:0,gst:0,totalAmount:0,totalItems:0},[A,We]),qt=l.useMemo(()=>A?A.serviceType==="TAKEAWAY"?"Takeaway":"Dine-In":"",[A]),zt=A?.table?.number??A?.tableNumber??null,yt=A?.table?.name??null,Te=l.useMemo(()=>Dt(A),[A]),vt=l.useMemo(()=>et(R),[R]),At=l.useMemo(()=>R?Ot(R,vt):{subtotal:0,gst:0,totalAmount:0,totalItems:0},[R,vt]),Ge=l.useMemo(()=>Dt(R),[R]),kt=l.useMemo(()=>R?Ct(R):null,[R]),Bt=p("manualEntry","Menu");p("smartServe","Smart Serve");const Vt=p("aiOrdered","AI Ordered:");p("orderSummary","Order Summary:"),p("confirm","Confirm"),p("speakOrder","Speak Order");const Jt=p("processingVoice","Processing your voice..."),Qt=p("cartEmpty","Cart is empty");p("resetOrderBtn","Reset Order");const Ht=p("tapToOrder","Tap to Order"),Gt=p("tapToStop","Tap to Stop"),Xt=p("searchPlaceholder","Search item..."),Zt=p("recordVoiceAria","Record voice order");l.useEffect(()=>{E?localStorage.setItem("terra_orderStatus",E):localStorage.removeItem("terra_orderStatus"),le?localStorage.setItem("terra_orderStatusUpdatedAt",le):localStorage.removeItem("terra_orderStatusUpdatedAt")},[E,le]),l.useEffect(()=>{E&&w&&Ae&&se(null),E&&w&&R&&ee(null)},[E,w,Ae,R,se,ee]),l.useEffect(()=>{if(!Ae&&!R)return;const e=localStorage.getItem("terra_scanToken"),r=Ae?.tableSlug;if(r&&e&&r!==e){se(null),ee(null);return}!r&&R?.table?.qrSlug&&e&&R.table.qrSlug!==e&&(se(null),ee(null))},[Ae,R,se,ee]),l.useEffect(()=>{const e=localStorage.getItem(q),r=localStorage.getItem("terra_takeaway_only")==="true";if((localStorage.getItem("terra_orderId_TAKEAWAY")||r)&&e!=="TAKEAWAY"){console.log("[Menu] Detected takeaway order or takeaway-only mode on refresh, setting serviceType to TAKEAWAY"),ve("TAKEAWAY"),localStorage.setItem(q,"TAKEAWAY");return}I.state?.serviceType?(ve(I.state.serviceType),localStorage.setItem(q,I.state.serviceType)):e?ve(e):r&&(console.log("[Menu] Detected takeaway-only QR flow, setting serviceType to TAKEAWAY"),ve("TAKEAWAY"),localStorage.setItem(q,"TAKEAWAY")),I.state?.table&&(Fe(I.state.table),localStorage.setItem(we,JSON.stringify(I.state.table)))},[I.state,ve]),l.useEffect(()=>{let e=!1;const r=async()=>{if((localStorage.getItem(q)||I.state?.serviceType||"DINE_IN")!=="DINE_IN")return!0;const d=localStorage.getItem("terra_orderId")||localStorage.getItem("terra_orderId_DINE_IN"),i=localStorage.getItem("terra_orderStatus")||localStorage.getItem("terra_orderStatus_DINE_IN"),x=d&&i&&!["Paid","Cancelled","Returned","Completed"].includes(i);if(x&&d)try{const g=await fetch(`${W}/api/orders/${d}`);if(g.ok){const m=await g.json();if(m.status&&!["Paid","Cancelled","Returned","Completed"].includes(m.status))return console.log("[Menu] User has verified active order - allowing access, skipping waitlist check"),!0}}catch(g){if(console.warn("[Menu] Failed to verify order on backend:",g),x)return console.log("[Menu] Order verification failed but order exists in storage - allowing access"),!0}const y=localStorage.getItem("terra_sessionToken"),f=localStorage.getItem("terra_selectedTable");if(y&&f)try{const g=JSON.parse(f);if(g.sessionToken===y)return console.log("[Menu] User has matching sessionToken - allowing access, skipping waitlist check"),!0;const m=g.qrSlug||localStorage.getItem("terra_scanToken");if(m)try{const b=await fetch(`${W}/api/tables/lookup/${m}?sessionToken=${y}`);if(b.ok){const _=await b.json();if(_?.table?.sessionToken===y||_?.table?.activeOrder)return console.log("[Menu] Backend confirms user owns table session - allowing access"),!0}}catch(b){if(console.warn("[Menu] Failed to verify table session on backend:",b),g.sessionToken===y)return!0}}catch(g){console.warn("[Menu] Failed to check sessionToken:",g)}const a=localStorage.getItem("terra_waitToken");if(x&&a)return console.log("[Menu] User has active order but also has waitlist token - clearing waitlist token"),localStorage.removeItem("terra_waitToken"),!0;if(!a)return!0;try{const g=await fetch(`${W}/api/waitlist/status?token=${a}`);if(g.ok){const m=await g.json();if(m.status==="WAITING")return console.log("[Menu] User is in WAITING status - blocking menu access"),alert("You are currently in the waitlist. Please wait for your turn. You will be notified when the table is ready."),n("/secondpage"),!1;if(m.status==="NOTIFIED"||m.status==="SEATED")return!0}}catch(g){console.error("[Menu] Failed to check waitlist status:",g)}return!0},s=async()=>{try{if((localStorage.getItem(q)||I.state?.serviceType||"DINE_IN")==="TAKEAWAY")return;const d=localStorage.getItem("terra_selectedTable");let i=localStorage.getItem("terra_sessionToken");const x=localStorage.getItem("terra_scanToken");if(!d||!x)return;const y=JSON.parse(d),f=y.id||y._id;if(!f)return;let a=!0;try{const h=y.qrSlug||x;if(h){const S=await fetch(`${W}/api/tables/lookup/${h}${i?`?sessionToken=${i}`:""}`).catch(u=>{throw console.warn("[Menu] Network error during table lookup:",u),u});if(S.status===423){let u={};try{u=await S.json()}catch(C){console.warn("[Menu] Failed to parse 423 response (expected for occupied tables):",C)}console.log("[Menu] Table lookup returned 423 (Locked - expected for occupied tables) - handling gracefully");const U=localStorage.getItem("terra_orderId")||localStorage.getItem("terra_orderId_DINE_IN");if(U)try{const C=await fetch(`${W}/api/orders/${U}`);if(C.ok){const V=await C.json();if((V.table?.toString()||V.tableId?.toString())===f?.toString()){V.sessionToken&&(i=V.sessionToken,localStorage.setItem("terra_sessionToken",i),X(i),console.log("[Menu] Table is locked but user has active order - using order's sessionToken:",i)),console.log("[Menu] Table is already occupied by user's active order - skipping markTableOccupied"),a=!1;return}}}catch(C){console.warn("[Menu] Failed to verify order when table is locked:",C)}if(u?.table){const C={...y,...u.table,qrSlug:y.qrSlug||u.table.qrSlug};if(localStorage.setItem("terra_selectedTable",JSON.stringify(C)),u.table.sessionToken){const V=u.table.sessionToken;if(V===i)console.log("[Menu] Table is locked but sessionToken matches - we own this table"),localStorage.setItem("terra_sessionToken",i),X(i),a=!0;else{const L=localStorage.getItem("terra_sessionToken");if(L&&L===V)console.log("[Menu] Table is locked but stored sessionToken matches table's token - we own this table"),i=L,localStorage.setItem("terra_sessionToken",i),X(i),a=!0;else{console.warn("[Menu] Table is locked and sessionToken doesn't match - table belongs to another user"),a=!1;return}}}else if(i)console.log("[Menu] Table is locked and no sessionToken in response, but we have one - proceeding (backend will validate)"),a=!0;else{console.warn("[Menu] Table is locked and no sessionToken available - table belongs to another user"),a=!1;return}}else if(i)console.log("[Menu] Table is locked and no table data in response, but we have sessionToken - proceeding (backend will validate)"),a=!0;else{console.warn("[Menu] Table is locked and user has no active order for this table - skipping markTableOccupied"),a=!1;return}}if(S.ok){const u=await S.json();if(u?.table){const U=u.table,C=U.sessionToken,V={...y,...U,qrSlug:y.qrSlug||U.qrSlug};if(localStorage.setItem("terra_selectedTable",JSON.stringify(V)),C&&C!==i){const L=localStorage.getItem("terra_orderId")||localStorage.getItem("terra_orderId_DINE_IN");if(L)try{const k=await fetch(`${W}/api/orders/${L}`);if(k.ok){const me=await k.json();(me.table?.toString()||me.tableId?.toString())===f?.toString()?me.sessionToken?(i=me.sessionToken,localStorage.setItem("terra_sessionToken",i),X(i),console.log("[Menu] Using order's sessionToken:",i)):(i=C,localStorage.setItem("terra_sessionToken",i),X(i),console.log("[Menu] Using backend table's sessionToken:",i)):(console.warn("[Menu] User has order but not for this table - skipping markTableOccupied"),a=!1)}}catch(k){console.warn("[Menu] Failed to verify order:",k),i=C,localStorage.setItem("terra_sessionToken",i),X(i)}else console.warn("[Menu] Table has different sessionToken and user has no active order - skipping markTableOccupied"),a=!1}else C&&C===i?console.log("[Menu] SessionToken matches - proceeding with markTableOccupied"):C||console.log("[Menu] Table has no sessionToken - proceeding with markTableOccupied")}}}}catch(h){h?.status!==423&&console.warn("[Menu] Failed to refresh table status before markTableOccupied:",h)}if(!a)return;const g=localStorage.getItem("terra_orderId")||localStorage.getItem("terra_orderId_DINE_IN"),m=localStorage.getItem("terra_orderStatus")||localStorage.getItem("terra_orderStatus_DINE_IN");if(g&&m&&!["Paid","Cancelled","Returned","Completed"].includes(m)&&g)try{const h=await fetch(`${W}/api/orders/${g}`);if(h.ok){const S=await h.json();if(S.status&&!["Paid","Cancelled","Returned","Completed"].includes(S.status)&&(S.table?.toString()===f?.toString()||S.tableId?.toString()===f?.toString())){console.log("[Menu] User has active order for this table - skipping markTableOccupied"),S.sessionToken&&(localStorage.setItem("terra_sessionToken",S.sessionToken),X(S.sessionToken));return}}}catch(h){console.warn("[Menu] Failed to verify order before markTableOccupied:",h)}let _;try{_=await xt(`${W}/api/tables/${f}/occupy`,{sessionToken:i||void 0},{headers:{"Content-Type":"application/json"}},{maxRetries:2,retryDelay:1e3,timeout:15e3,shouldRetry:(h,S)=>h.message?.includes("timeout")||h.message?.includes("Network error")||h.message?.includes("Failed to fetch")||h.message?.includes("CORS")?!0:h.status>=400&&h.status<500?!1:h.status>=500?!0:S<1})}catch(h){console.warn("[Menu] Failed to mark table as occupied after retries:",h),_={ok:!1,status:0,json:async()=>({}),text:async()=>h.message||"Network error"}}if(_.ok){const h=await _.json().catch(()=>null);if(h?.table){const S=h.table.sessionToken||i,u={...y,status:h.table.status||"OCCUPIED",sessionToken:S};localStorage.setItem("terra_selectedTable",JSON.stringify(u)),S&&S!==i&&(localStorage.setItem("terra_sessionToken",S),X(S),console.log("[Menu] Updated sessionToken after marking table occupied:",S))}else y.status="OCCUPIED",localStorage.setItem("terra_selectedTable",JSON.stringify(y))}else{const h=await _.text().catch(()=>"Unknown error");if(console.warn("Failed to mark table as occupied:",h),_.status===423)try{const S=y.qrSlug||localStorage.getItem("terra_scanToken");if(S){const u=await fetch(`${W}/api/tables/lookup/${S}?sessionToken=${i||""}`);if(u.ok){const U=await u.json().catch(()=>({}));if(U?.table?.sessionToken){const C=U.table.sessionToken;localStorage.setItem("terra_sessionToken",C),X(C),console.log("[Menu] Table already occupied by us, updated sessionToken:",C)}}}}catch(S){console.warn("Failed to refresh table status:",S)}}}catch(c){console.warn("Error marking table as occupied:",c)}};return(async()=>{try{if(Le(!0),gt(null),!await r()){Le(!1);return}await s();let d="";const i=localStorage.getItem("terra_selectedCartId");if(i)d=i,console.log("[Menu] Using selected cart ID for menu:",d);else{const m=localStorage.getItem("terra_takeaway_cartId");if(m)d=m,console.log("[Menu] Using takeaway QR cart ID for menu:",d);else try{let b=localStorage.getItem("terra_selectedTable");b||(b=localStorage.getItem(we)||"{}");const _=JSON.parse(b);d=_.cartId||_.cafeId||"",console.log("[Menu] Table data for cartId lookup:",{hasTableData:!!b,tableDataKeys:_?Object.keys(_):[],cartId:_.cartId,cafeId:_.cafeId,foundCartId:d}),d?console.log("[Menu] Using table cart ID for menu:",d):console.warn("[Menu] No cartId or cafeId found in table data:",_)}catch(b){console.error("[Menu] Error parsing table data:",b),console.log("[Menu] No cart ID found, loading default menu")}}const x=d?`${W}/api/menu/public?cartId=${d}`:`${W}/api/menu/public`;console.log("[Menu] Loading menu from:",x,{hasCartId:!!d,cartId:d,serviceType:N});const y=await fetch(x);if(!y.ok)throw new Error(`Menu fetch failed with status ${y.status}`);let f;try{f=await y.json()}catch(m){console.error("[Menu] Failed to parse menu response as JSON:",m);const b=await y.text().catch(()=>"Unknown error");throw new Error(`Invalid menu response format: ${b.substring(0,100)}`)}if(e)return;const a=(Array.isArray(f)?f:[]).map(m=>m?{...m,name:m.name||"Menu",items:(Array.isArray(m.items)?m.items:[]).map(b=>b?{...b,isAvailable:b.isAvailable!==!1,categoryName:m.name||"Menu"}:null).filter(Boolean)}:null).filter(Boolean),g=Gr(a);ut(a),mt(g),dt(m=>m||Array.isArray(a)&&a.length>0&&a[0]?.name||null)}catch(c){if(console.error("Menu fetch error",c),e)return;ut([]),mt({}),dt(null),gt("Trying to connect to live menu... please check your network or ask staff.")}finally{e||Le(!1)}})(),()=>{e=!0}},[]);const Tt=e=>{const r=typeof e=="string"?e:e?.name;if(!r)return;const s=_e[r]||e;if(s&&s.isAvailable===!1){alert(`${s.name} is currently unavailable.`);return}oe(o=>({...o,[r]:(o[r]||0)+1}))},wt=e=>{oe(r=>{const s=(r[e]||0)-1;if(s<=0){const{[e]:o,...c}=r;return c}return{...r,[e]:s}})},te=e=>new Promise(r=>setTimeout(r,e)),re={validate:1e3,order:1e3,beforeSend:1e3,kitchen:1e3,summary:1e3,error:1e3},er=async()=>{if(Object.keys(G).length===0)return D(!1),alert(Qt);if(N==="DINE_IN"&&!w&&!$){D(!1),alert("We couldn't detect your table. Please scan the table QR again or contact staff before placing an order.");return}await tr()},tr=async()=>{let e=w;if(e)try{const r=await fetch(`${W}/api/orders/${e}`);if(r.ok){const s=await r.json();["Paid","Cancelled","Returned"].includes(s.status)&&(console.log("[Menu] Existing order is in blocked status, creating new order instead:",s.status),e=null,z(null),N==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.removeItem("terra_orderStatus_TAKEAWAY"),localStorage.removeItem("terra_orderStatusUpdatedAt_TAKEAWAY")):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN")))}else console.log("[Menu] Could not fetch existing order, creating new order"),e=null,z(null),N==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.removeItem("terra_orderStatus_TAKEAWAY"),localStorage.removeItem("terra_orderStatusUpdatedAt_TAKEAWAY")):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN"))}catch(r){console.warn("[Menu] Error checking existing order, creating new order:",r),e=null,z(null),N==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.removeItem("terra_orderStatus_TAKEAWAY"),localStorage.removeItem("terra_orderStatusUpdatedAt_TAKEAWAY")):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN"))}ne(P.map((r,s)=>{let o=r.label;switch(s){case 0:o=p("processSteps.checkingOrder","Checking your order");break;case 1:o=p("processSteps.confirmingItems","Confirming items & price");break;case 2:o=p("processSteps.placingOrder","Placing your order");break;case 3:o=p("processSteps.sendingToKitchen","Sending to kitchen");break;case 4:o=p("processSteps.preparingDetails","Preparing order details");break}return{...r,label:o,state:"pending"}})),D(!0);try{Y(0,"active"),await te(re.validate),Y(0,"done"),Y(1,"active"),await te(re.order),Y(1,"done"),Y(2,"active"),await te(re.beforeSend);let r=$;const s=N!=="DINE_IN"&&localStorage.getItem("terra_orderType")||null,o=N!=="DINE_IN"?localStorage.getItem("terra_customerLocation"):null;let c=null;if(o)try{c=JSON.parse(o)}catch(T){console.warn("[Menu] Failed to parse customerLocation from localStorage:",T),c=null}const d=N==="TAKEAWAY"||s==="PICKUP"||s==="DELIVERY",i=d&&(localStorage.getItem("terra_takeaway_customerName")||localStorage.getItem("terra_customerName"))||"",x=d&&(localStorage.getItem("terra_takeaway_customerMobile")||localStorage.getItem("terra_customerMobile"))||"",y=d&&(localStorage.getItem("terra_takeaway_customerEmail")||localStorage.getItem("terra_customerEmail"))||"";let f=null;if(N==="TAKEAWAY"){const T=localStorage.getItem("terra_takeaway_cartId");if(T)f=T;else try{const M=JSON.parse(localStorage.getItem(we)||"{}");let Z=M.cartId||M.cafeId||null;Z&&(typeof Z=="object"&&Z._id?f=Z._id:typeof Z=="string"?f=Z:f=String(Z)),console.log("[Menu] Using cartId from table data for takeaway:",f)}catch(M){console.warn("[Menu] Could not get cartId from table data for takeaway order:",M)}}let a=null;N==="TAKEAWAY"?(a=localStorage.getItem("terra_takeaway_sessionToken"),a?console.log("[Menu] Using existing takeaway sessionToken (unified for both flows):",a):(a=`TAKEAWAY-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("terra_takeaway_sessionToken",a),console.log("[Menu] Generated new takeaway sessionToken (unified for both flows):",a))):(a=localStorage.getItem("terra_sessionToken"),a||(a=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("terra_sessionToken",a),X(a),console.log("[Menu] Generated new DINE_IN sessionToken:",a)));const g=localStorage.getItem("terra_specialInstructions")||null,m=localStorage.getItem("terra_selectedCartId")||f,b=JSON.parse(localStorage.getItem("terra_cart_addons")||"[]"),_=JSON.parse(localStorage.getItem("terra_global_addons")||"[]"),h=Array.isArray(_)&&_.length>0?_:hr,S=b.map(T=>{const M=h.find(Z=>Z.id===T);return M?{addonId:T,name:M.name,price:M.price}:null}).filter(Boolean),u=br(G,{serviceType:s?s==="PICKUP"?"PICKUP":"DELIVERY":N,orderType:s==="PICKUP"||s==="DELIVERY"?s:void 0,tableId:r?.id||r?._id||$?.id||$?._id,tableNumber:r?.number??r?.tableNumber??$?.number??$?.tableNumber,menuCatalog:_e,sessionToken:a,customerName:d&&i?.trim()?i.trim():void 0,customerMobile:d&&x?.trim()?x.trim():void 0,customerEmail:d&&y?.trim()?y.trim():void 0,cartId:N==="TAKEAWAY"||s?m||f:void 0,customerLocation:c,specialInstructions:g,selectedAddons:S});if(!u.items||!Array.isArray(u.items)||u.items.length===0){console.error("[Menu] Invalid order payload - no items:",u),alert("❌ Your cart is empty. Please add items before placing an order."),Y(2,"error"),await te(re.error),D(!1);return}const U=u.items.filter(T=>!T.name||typeof T.quantity!="number"||T.quantity<=0||typeof T.price!="number"||T.price<0);if(U.length>0){console.error("[Menu] Invalid order payload - invalid items:",U),alert("❌ Some items in your cart are invalid. Please refresh the page and try again."),Y(2,"error"),await te(re.error),D(!1);return}if(u.serviceType==="DINE_IN"&&!u.sessionToken&&(a?u.sessionToken=a:(u.sessionToken=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("terra_sessionToken",u.sessionToken),X(u.sessionToken))),u.serviceType==="PICKUP"||u.serviceType==="DELIVERY"||u.orderType==="PICKUP"||u.orderType==="DELIVERY"){if(!u.customerName||!u.customerName.trim()){alert("❌ Customer name is required for "+(u.orderType||u.serviceType)+" orders. Please provide your name."),Y(2,"error"),await te(re.error),D(!1);return}if(!u.customerMobile||!u.customerMobile.trim()){alert("❌ Customer mobile number is required for "+(u.orderType||u.serviceType)+" orders. Please provide your mobile number."),Y(2,"error"),await te(re.error),D(!1);return}}if(u.serviceType==="DELIVERY"||u.orderType==="DELIVERY"){if(!u.customerLocation||!u.customerLocation.latitude||!u.customerLocation.longitude){alert("❌ Delivery location is required. Please go back and provide your delivery address."),Y(2,"error"),await te(re.error),D(!1);return}if(!u.cartId){alert("❌ Store selection is required for delivery. Please go back and select a store."),Y(2,"error"),await te(re.error),D(!1);return}try{const T=await fetch(`${W}/api/carts/${u.cartId}?latitude=${u.customerLocation.latitude}&longitude=${u.customerLocation.longitude}&orderType=DELIVERY`);if(T.ok){const M=await T.json();if(M.success&&M.data){const Z=M.data;if(!Z.canDeliver){let Re=`❌ Delivery not available!

`;Z.distance!==null?Re+=`You are ${Z.distance.toFixed(2)} km away, but maximum delivery radius is ${Z.deliveryRadius||5} km.

`:Re+=`Delivery is not enabled for this store or the store location is not configured.

`,Re+="Please select a different store or choose Pickup instead.",alert(Re),Y(2,"error"),await te(re.error),D(!1);return}}}}catch(T){console.error("[Menu] Error checking delivery availability:",T)}}const V=e?`${W}/api/orders/${e}/kot`:`${W}/api/orders`;let L;try{L=await xt(V,u,{headers:{"Content-Type":"application/json"}},{maxRetries:2,retryDelay:1500,timeout:3e4,shouldRetry:(T,M)=>T.message?.includes("timeout")||T.message?.includes("Network error")||T.message?.includes("Failed to fetch")||T.message?.includes("CORS")?(console.log(`[Menu] Retrying order creation (attempt ${M+1}/2)...`),!0):T.status>=400&&T.status<500?!1:T.status>=500?!0:M<1})}catch(T){console.error("[Menu] Order creation failed after retries:",T);const M=T.message||"Failed to create order. Please check your connection and try again.";L={ok:!1,status:0,statusText:"Network Error",json:async()=>({message:M}),text:async()=>M,headers:new Headers}}let k;try{if((L.headers?.get?.("content-type")||"").includes("application/json"))k=await L.json();else{const M=await L.text().catch(()=>"");if(M)try{k=JSON.parse(M)}catch{k={message:M||"Unknown error"}}else k={message:"No response from server"}}}catch(T){console.error("[Menu] Failed to parse response:",T);try{k={message:await L.text().catch(()=>"Unknown error")||"Failed to parse server response"}}catch{k={message:"Failed to parse server response"}}}const me=L.ok&&k?._id;if(console.log("[Menu] Order creation response:",{ok:L.ok,status:L.status,hasOrderId:!!k?._id,orderId:k?._id,orderCreated:me}),me)console.log("[Menu] Order created successfully:",k._id);else{if(Y(2,"error"),L.status===403){const T=k?.message||"Access denied. Please try refreshing the page.";T.includes("assigned to another guest")||T.includes("table")?alert(`⚠️ ${T}

Please scan the table QR code again or contact staff for assistance.`):alert(`❌ ${T}`)}else if(L.status===400){const T=k?.message||k?.error||"Invalid request. Please check your order and try again.";console.error("[Menu] Order save failed (400 Bad Request):",{status:L.status,statusText:L.statusText,error:k,payload:u,itemsCount:u.items?.length,serviceType:u.serviceType,hasSessionToken:!!u.sessionToken,hasTableId:!!u.tableId,hasTableNumber:!!u.tableNumber});let M=T;k?.message?.includes("No items supplied")?M="Your cart is empty. Please add items before placing an order.":k?.message?.includes("Session token is required")?M="Session token is missing. Please scan the table QR code again.":k?.message?.includes("Table selection is required")?M="Table information is missing. Please scan the table QR code again.":k?.message?.includes("Invalid order items")&&(M="Some items in your cart are invalid. Please refresh the page and try again."),alert(`❌ ${M}`)}else{const T=k?.message||k?.error||"Failed to save order.";console.error("[Menu] Order save failed:",{status:L.status,statusText:L.statusText,error:k,payload:u}),alert(`❌ ${T}`)}await te(re.error),D(!1),ce(!1);return}console.log("[Menu] Proceeding with order success flow for order:",k._id),Y(2,"done"),Y(3,"active"),await te(re.kitchen),Y(3,"done"),N==="TAKEAWAY"?(localStorage.setItem("terra_orderId_TAKEAWAY",k._id),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),k.sessionToken?(localStorage.setItem("terra_takeaway_sessionToken",k.sessionToken),console.log("[Menu] Stored takeaway sessionToken from order response:",k.sessionToken)):a&&(localStorage.setItem("terra_takeaway_sessionToken",a),console.log("[Menu] Stored generated takeaway sessionToken:",a))):(localStorage.setItem("terra_orderId",k._id),localStorage.setItem("terra_orderId_DINE_IN",k._id),localStorage.removeItem("terra_orderId_TAKEAWAY")),z(k._id),B(k.status||"Confirmed"),Q(new Date().toISOString()),N==="TAKEAWAY"?(localStorage.setItem("terra_orderStatus_TAKEAWAY",k.status||"Confirmed"),localStorage.setItem("terra_orderStatusUpdatedAt_TAKEAWAY",new Date().toISOString())):(localStorage.setItem("terra_orderStatus_DINE_IN",k.status||"Confirmed"),localStorage.setItem("terra_orderStatusUpdatedAt_DINE_IN",new Date().toISOString())),k&&(k.takeawayToken||k.serviceType==="TAKEAWAY")&&ee(k),oe({}),localStorage.removeItem("terra_cart"),localStorage.removeItem("terra_cart_DINE_IN"),localStorage.removeItem("terra_cart_TAKEAWAY"),ce(!1),console.log("[Menu] Order created and stored:",{orderId:k._id,serviceType:N,storedInLocalStorage:{generic:N==="DINE_IN"?localStorage.getItem("terra_orderId"):null,dineIn:N==="DINE_IN"?localStorage.getItem("terra_orderId_DINE_IN"):null,takeaway:N==="TAKEAWAY"?localStorage.getItem("terra_orderId_TAKEAWAY"):null}}),Y(4,"active"),Y(4,"done"),D(!1)}catch(r){Y(2,"error"),alert("❌ Server Error"),console.error(r),await te(re.error),D(!1),ce(!1)}},rr=async()=>{if(he){try{be.current&&(be.current.stop(),be.current=null)}catch(e){console.warn("Error stopping recognition:",e)}ge(!1);return}if(!("webkitSpeechRecognition"in window)&&!("SpeechRecognition"in window)){alert("Your browser doesn't support voice input. Please use the menu buttons to order.");return}try{const e=window.SpeechRecognition||window.webkitSpeechRecognition,r=new e;be.current=r,r.continuous=!1,r.interimResults=!1;const s=localStorage.getItem("language")||"en";r.lang=s==="en"?"en-US":s==="hi"?"hi-IN":"en-US",r.onstart=()=>{ge(!0),pe(""),console.log("🎤 Voice recognition started")},r.onresult=async o=>{const c=o.results[0][0].transcript;console.log("📝 Transcribed:",c),pe(c),ge(!1),Ee(!0);try{const d=await fetch(`${Ze}/parse-order-text`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:c}),signal:AbortSignal.timeout(1e4)});if(!d.ok){const x=await d.json().catch(()=>({}));throw new Error(x.error||`Backend returned ${d.status}`)}const i=await d.json();if(console.log("📦 Flask response:",i),i.items&&i.items.length>0){if(!Array.isArray(J)||J.length===0){console.warn("⚠️ Menu items not loaded yet, cannot add items to cart"),alert("Menu is still loading. Please wait a moment and try again."),Ee(!1);return}const x={...G};let y=0;if(i.items.forEach(f=>{const a=f.name;if(a){let g=J.find(m=>m?.name&&m.name.toLowerCase()===a.toLowerCase());g||(g=J.find(m=>m?.name&&(m.name.toLowerCase().includes(a.toLowerCase())||a.toLowerCase().includes(m.name.toLowerCase())))),!g&&f.original&&(g=J.find(m=>m?.name&&(m.name.toLowerCase()===f.original.toLowerCase()||m.name.toLowerCase().includes(f.original.toLowerCase())))),g&&g.isAvailable!==!1?(x[g.name]=(x[g.name]||0)+(f.quantity||1),y++,console.log(`✅ Added to cart: ${f.quantity||1}x ${g.name} (matched from: ${a})`)):console.warn(`⚠️ Item not found in menu: ${a}`,{availableItems:Array.isArray(J)?J.map(m=>m?.name).filter(Boolean).slice(0,5):[]})}}),y>0){oe(x);const f=i.items.filter(a=>!Array.isArray(J)||J.length===0?!1:J.find(m=>m?.name&&m.name.toLowerCase()===a.name?.toLowerCase())).map(a=>`${a.quantity||1}x ${a.name||"Unknown"}`).join(", ");if(pe(f),console.log(`✅ Successfully added ${y} item(s) to cart`),y===i.items.length)console.log("✅ All items added to cart successfully");else{const a=i.items.length-y;alert(`✅ Added ${y} item(s) to cart.
⚠️ ${a} item(s) could not be found in menu.`)}}else console.warn("⚠️ No items could be added to cart - items not found in menu"),console.warn("Flask returned items:",i.items),console.warn("Available menu items:",Array.isArray(J)?J.map(f=>f?.name).filter(Boolean).slice(0,10):[]),alert(`⚠️ Could not find these items in the menu:
${i.items.map(f=>f.name).join(", ")}

Please check the item names or use the menu buttons to add items.`),pe(c);if(i.unmatched&&i.unmatched.length>0){console.warn("⚠️ Unmatched items:",i.unmatched);const f=i.unmatched.map(a=>a.name).join(", ");alert(`⚠️ Could not match these items: ${f}`)}}else console.warn("⚠️ No items returned from Flask backend"),Et(c),pe(c)}catch(d){if(console.error("Order parsing failed:",d),console.error("Flask API URL used:",Ze),Et(c),pe(c),d.name==="TypeError"||d.message.includes("fetch")||d.message.includes("Failed to fetch")||d.message.includes("ERR_CONNECTION_REFUSED")){const i=`⚠️ Cannot connect to Flask backend server.

Current Flask URL: ${Ze}
Expected: http://localhost:5050

Please check:
1. Flask server is running on port 5050
2. Update frontend/.env file: VITE_FLASK_API_URL=http://localhost:5050
3. Restart frontend dev server after updating .env

Using basic parsing as fallback.`;alert(i)}else d.name==="AbortError"||d.message.includes("timeout")?alert("⏱️ Request timed out. Using basic parsing."):(console.error("Unexpected error:",d),alert(`Error processing order: ${d.message}

Using basic parsing as fallback.`))}finally{Ee(!1)}},r.onerror=o=>{console.error("Voice recognition error:",o.error),ge(!1),Ee(!1),o.error==="no-speech"?alert("No speech detected. Please try again."):o.error==="not-allowed"?alert("Microphone permission denied. Please allow microphone access."):alert("Voice recognition error. Please try again or use menu buttons.")},r.onend=()=>{ge(!1),be.current=null},r.start()}catch(e){console.error("Error starting voice recognition:",e),alert("Failed to start voice input. Please try again or use menu buttons."),ge(!1)}},ar=async()=>{if(!(!E||Ke)){ce(!0),ot(!0);try{if((localStorage.getItem(q)||"DINE_IN")==="TAKEAWAY"){const b=w||localStorage.getItem("terra_orderId_TAKEAWAY")||localStorage.getItem("terra_orderId"),_=localStorage.getItem("terra_takeaway_sessionToken")||localStorage.getItem("terra_sessionToken");if(!b){alert("No active order found. Please create a new order.");return}try{const h=await fetch(`${W}/api/orders/${b}`);if(h.ok){const S=await h.json();if(S.status&&["Paid","Cancelled","Returned","Completed"].includes(S.status)){alert("This order has been completed. Please create a new order.");return}z(b),localStorage.setItem("terra_orderId_TAKEAWAY",b),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),B(S.status||E||"Confirmed"),localStorage.setItem("terra_orderStatus_TAKEAWAY",S.status||E||"Confirmed"),S.updatedAt&&(Q(S.updatedAt),localStorage.setItem("terra_orderStatusUpdatedAt_TAKEAWAY",S.updatedAt)),oe({}),localStorage.removeItem("terra_cart"),localStorage.removeItem("terra_cart_TAKEAWAY"),alert("You can continue adding items to your takeaway order.");return}else{alert("Order not found. Please create a new order.");return}}catch{alert("Unable to verify order. Please try again or contact staff.");return}}const r=localStorage.getItem("terra_selectedTable"),s=Ce||localStorage.getItem("terra_sessionToken");if(!r||!s){alert("We couldn't detect your table. Please scan the table QR again or contact staff.");return}let o=null;if(w)try{const b=await fetch(`${W}/api/orders/${w}`);b.ok&&(o=await b.json())}catch{}const c=JSON.parse(r),d=c.qrSlug||localStorage.getItem("terra_scanToken"),i=localStorage.getItem("terra_sessionToken")||s,x=new URLSearchParams;i&&x.set("sessionToken",i);const y=`${W}/api/tables/lookup/${d}${x.toString()?`?${x.toString()}`:""}`;let f=await fetch(y),a=await f.json().catch(()=>({}));if(f.status===423){const b=a?.table?.sessionToken;if(b&&b===i)console.log("[Menu] Table is occupied by current session, proceeding");else{const _=a?.message||"Table is currently assigned to another guest.";if(i){console.warn("Stale session detected, retrying table lookup without session token."),localStorage.removeItem("terra_sessionToken"),X(null);const S=new URLSearchParams().toString(),u=`${W}/api/tables/lookup/${d}${S?`?${S}`:""}`,U=await fetch(u),C=await U.json().catch(()=>({}));if(!U.ok)throw new Error(C?.message||_||"Unable to refresh table session. Please ask staff for help.");f=U,a=C}else throw new Error(_)}}else if(!f.ok)throw new Error(a?.message||"Failed to refresh table session. Please ask staff for help.");if(a.sessionToken){const b=Ce||localStorage.getItem("terra_sessionToken"),_=a.sessionToken;_!==b&&(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_previousOrder"),localStorage.removeItem("terra_previousOrderDetail"),localStorage.removeItem("terra_lastPaidOrderId"),z(null),B(null),Q(null),se(null),ee(null),["DINE_IN","TAKEAWAY"].forEach(h=>{localStorage.removeItem(`terra_cart_${h}`),localStorage.removeItem(`terra_orderId_${h}`),localStorage.removeItem(`terra_orderStatus_${h}`),localStorage.removeItem(`terra_orderStatusUpdatedAt_${h}`)})),localStorage.setItem("terra_sessionToken",_),X(_)}a.table&&(localStorage.setItem("terra_selectedTable",JSON.stringify(a.table)),Fe(a.table)),(a.table?.status||"AVAILABLE")==="AVAILABLE"?localStorage.removeItem("terra_waitToken"):a.waitlist?.token?localStorage.setItem("terra_waitToken",a.waitlist.token):localStorage.removeItem("terra_waitToken");const m=a.table||c;if(a.order){const b=localStorage.getItem(q)||"DINE_IN";if(a.order.serviceType&&a.order.serviceType!==b){console.log(`[Menu] Ignoring order from table lookup - serviceType mismatch: order is ${a.order.serviceType}, current is ${b}`);return}z(a.order._id),b==="TAKEAWAY"?(localStorage.setItem("terra_orderId_TAKEAWAY",a.order._id),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN")):(localStorage.setItem("terra_orderId",a.order._id),localStorage.setItem("terra_orderId_DINE_IN",a.order._id),localStorage.removeItem("terra_orderId_TAKEAWAY")),B(a.order.status||E||"Confirmed"),a.order.updatedAt&&(Q(a.order.updatedAt),localStorage.setItem("terra_orderStatusUpdatedAt",a.order.updatedAt)),se(null)}else w?console.log("No order returned from table lookup, keeping existing order status"):(Me({status:E||"Completed",updatedAt:le||new Date().toISOString(),tableNumber:m?.number??m?.tableNumber??null,tableSlug:m?.qrSlug??d??null,tableInfo:m}),B(null),Q(null),z(null),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"));o&&ee(o),alert("You can continue adding items to your order.")}catch(e){console.error("handleOrderAgain error",e),alert(e.message||"Unable to resume ordering. Please contact staff.")}finally{ot(!1),ce(!1)}}},or=()=>{if(!(N==="TAKEAWAY"?w||localStorage.getItem("terra_orderId_TAKEAWAY")||localStorage.getItem("terra_orderId"):w||localStorage.getItem("terra_orderId"))){alert("No active order found.");return}ht("Cancel"),Je(""),Ie(!0)},sr=()=>{if(!w){alert("No active order found.");return}ht("Return"),Je(""),Ie(!0)},nr=async()=>{if(!Pe.trim()){alert("Please enter a reason.");return}bt(!0);try{if(Se==="Cancel"){Ye(!0);const e=N==="TAKEAWAY"?w||localStorage.getItem("terra_orderId_TAKEAWAY")||localStorage.getItem("terra_orderId"):w||localStorage.getItem("terra_orderId");let r=null;if(N==="TAKEAWAY"){if(r=localStorage.getItem("terra_takeaway_sessionToken")||localStorage.getItem("terra_sessionToken"),!r)try{const i=await fetch(`${W}/api/orders/${e}`);if(i.ok){const x=await i.json();x?.sessionToken&&(r=x.sessionToken,localStorage.setItem("terra_takeaway_sessionToken",r))}}catch(i){console.warn("[Menu] Failed to fetch order to get sessionToken:",i)}}else r=localStorage.getItem("terra_sessionToken");const s=await fetch(`${W}/api/orders/${e}/customer-status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"Cancelled",sessionToken:r||void 0,reason:Pe})}),o=await s.json().catch(()=>({}));if(!s.ok)throw new Error(o?.message||"Failed to cancel order");const c=o?._id?o:null,d=c?.updatedAt||new Date().toISOString();Me({orderId:c?._id,status:"Cancelled",updatedAt:d,tableNumber:c?.tableNumber??$?.number??$?.tableNumber??null,tableSlug:c?.table?.qrSlug??$?.qrSlug??localStorage.getItem("terra_scanToken")??null,tableInfo:c?.table||$}),c&&ee(c),B(null),Q(null),z(null),N==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.removeItem("terra_orderStatus_TAKEAWAY"),localStorage.removeItem("terra_orderStatusUpdatedAt_TAKEAWAY"),localStorage.removeItem("terra_cart_TAKEAWAY"),localStorage.removeItem("terra_takeaway_customerName"),localStorage.removeItem("terra_takeaway_customerMobile"),localStorage.removeItem("terra_takeaway_customerEmail"),console.log("[Menu] Cleared takeaway customer data after order cancellation")):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_cart")),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_cart"),N==="TAKEAWAY"&&(localStorage.removeItem("terra_waitToken"),console.log("[Menu] Cleared waitlist state for cancelled takeaway order")),oe({}),ce(!1),alert("Your order has been cancelled."),Ye(!1)}else if(Se==="Return"){Ue(!0);const e=localStorage.getItem("terra_sessionToken"),r=await fetch(`${W}/api/orders/${w}/customer-status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"Returned",sessionToken:N==="DINE_IN"&&e||void 0,reason:Pe})}),s=await r.json().catch(()=>({}));if(!r.ok)throw new Error(s?.message||"Failed to return order");const o=s?._id?s:null,c=o?.updatedAt||new Date().toISOString();Me({orderId:o?._id,status:"Returned",updatedAt:c,tableNumber:o?.tableNumber??$?.number??$?.tableNumber??null,tableSlug:o?.table?.qrSlug??$?.qrSlug??localStorage.getItem("terra_scanToken")??null,tableInfo:o?.table||$}),o&&ee(o),B("Returned"),Q(c),z(null),N==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.removeItem("terra_orderStatus_TAKEAWAY"),localStorage.removeItem("terra_orderStatusUpdatedAt_TAKEAWAY")):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN")),localStorage.removeItem("terra_cart"),oe({}),ce(!1),N==="TAKEAWAY"&&(localStorage.removeItem("terra_waitToken"),localStorage.removeItem("terra_takeaway_customerName"),localStorage.removeItem("terra_takeaway_customerMobile"),localStorage.removeItem("terra_takeaway_customerEmail")),alert("Your order has been marked as returned."),Ue(!1)}Ie(!1)}catch(e){alert(e.message||`Unable to ${Se.toLowerCase()} order.`),Se==="Cancel"&&Ye(!1),Se==="Return"&&Ue(!1)}finally{bt(!1)}},lr=async()=>{if(!w){alert("No active order found.");return}if(await window.confirm("Confirm that payment has been completed for this order?")){it(!0);try{const e=localStorage.getItem("terra_sessionToken"),r=await fetch(`${W}/api/orders/${w}/confirm-payment`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentMethod:"CASH",sessionToken:N==="DINE_IN"&&e||void 0})}),s=await r.json().catch(()=>({}));if(!r.ok)throw new Error(s?.message||"Failed to confirm payment");const o=s?._id?s:null,c=o?.updatedAt||new Date().toISOString();Me({orderId:o?._id,status:"Paid",updatedAt:c,tableNumber:o?.tableNumber??$?.number??$?.tableNumber??null,tableSlug:o?.table?.qrSlug??$?.qrSlug??localStorage.getItem("terra_scanToken")??null,tableInfo:o?.table||$}),o&&ee(o),B("Paid"),Q(c),localStorage.setItem("terra_orderStatus","Paid"),localStorage.setItem("terra_orderStatusUpdatedAt",c),localStorage.setItem("terra_lastPaidOrderId",w),alert("Payment confirmed successfully!")}catch(e){console.error("handleConfirmPayment error",e),alert(e.message||"Unable to confirm payment. Please contact staff.")}finally{it(!1)}}},Xe=l.useCallback(async()=>{if(!w){alert("We couldn't locate your order. Please contact staff.");return}try{Oe(!0);const e=await fetch(`${W}/api/orders/${w}`),r=await e.json().catch(()=>({}));if(!e.ok)throw new Error(r?.message||"Failed to load invoice details.");console.log("📄 Invoice order data:",{orderId:r._id,franchiseId:r.franchiseId,cafeId:r.cafeId,franchise:r.franchise,cafe:r.cafe}),ze(r),qe(!0)}catch(e){console.error("Invoice fetch failed",e),alert(e.message||"Unable to load invoice. Please contact staff.")}finally{Oe(!1)}},[w]),Nt=l.useCallback(()=>{qe(!1),ze(null),fe(!1),Ve(!1),Oe(!1)},[]);l.useCallback(()=>{if(!(!ye.current||!A||Be)){fe(!0);try{const e=document.createElement("iframe");e.style.position="fixed",e.style.right="0",e.style.bottom="0",e.style.width="0",e.style.height="0",e.style.border="0",e.style.visibility="hidden",e.setAttribute("sandbox","allow-same-origin allow-scripts allow-modals"),document.body.appendChild(e);const r=e.contentWindow?.document;if(!r){fe(!1),document.body.removeChild(e),alert("Print preview failed to open. Please check your browser settings.");return}r.open(),r.write(`
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>${ke||"Invoice"}</title>
          <style>
            * { box-sizing: border-box; }
            body {
              font-family: 'Segoe UI', Arial, sans-serif;
              margin: 0;
              padding: 32px;
              background: #ffffff;
              color: #1f2933;
            }
            h1, h2, h3, h4 { margin: 0; }
            table { border-collapse: collapse; width: 100%; }
            th, td { padding: 8px; border-bottom: 1px solid #e5e7eb; }
            th { text-align: left; color: #475569; font-weight: 600; }
            .invoice-shell {
              max-width: 720px;
              margin: 0 auto;
              padding: 24px;
              border: 1px solid #d2d6dc;
              border-radius: 12px;
            }
            @media print {
              body { padding: 0; }
              .invoice-shell { border: none; }
            }
          </style>
        </head>
        <body>
          <div class="invoice-shell">
            ${ye.current.innerHTML}
          </div>
        </body>
      </html>
    `),r.close(),e.onload=function(){setTimeout(()=>{try{e.contentWindow?.focus(),e.contentWindow?.print()}catch(s){console.error("Print failed:",s),alert("Print failed. Please try using your browser's print function (Ctrl+P).")}finally{setTimeout(()=>{document.body.contains(e)&&document.body.removeChild(e),fe(!1)},500)}},250)},setTimeout(()=>{Be&&document.body.contains(e)&&(document.body.removeChild(e),fe(!1),console.warn("Print timeout - iframe failed to load"))},5e3)}catch(e){console.error("Print setup failed:",e),fe(!1),alert("Failed to initialize print. Please try again or use Ctrl+P.")}}},[ke,A,Be]);const ir=l.useCallback(async()=>{if(!(!ye.current||!A||De)){Ve(!0);try{const r=(await Ar(ye.current,{scale:window.devicePixelRatio||2,useCORS:!0,backgroundColor:"#ffffff",onclone:m=>{m.querySelectorAll("*").forEach(_=>{const h=window.getComputedStyle(_);["color","backgroundColor","borderColor"].forEach(S=>{const u=h[S];u&&u.includes("oklch")&&(_.style[S]="#000000",S==="backgroundColor"&&(_.style[S]="transparent"))})})}})).toDataURL("image/png"),s=new kr("p","mm","a4"),o=s.internal.pageSize.getWidth(),c=s.internal.pageSize.getHeight(),d=10,i=o-d*2,x=s.getImageProperties(r),y=x.height/x.width,f=i*y;let a=f,g=d;for(s.addImage(r,"PNG",d,g,i,f),a-=c-d*2;a>0;)s.addPage(),g=d-(f-a),s.addImage(r,"PNG",d,g,i,f),a-=c-d*2;s.save(`${ke||"invoice"}.pdf`)}catch(e){console.error("Invoice download failed",e),alert("Failed to generate invoice PDF. Please try again.")}finally{Ve(!1)}}},[ke,A,De]);l.useCallback(async()=>{if(["Preparing","Ready","Served","Finalized","Paid"].includes(E)){await Xe();return}if(E==="Returned"||E==="Cancelled"){alert(E==="Returned"?"This order has already been returned.":"This order has been cancelled.");return}n("/billing")},[E,Xe,n]);const cr=l.useCallback(()=>{R&&(Oe(!1),ze(R),qe(!0))},[R]),Et=e=>{if(!e)return;const r={...G},s=Object.values(_e),o=s.length?s:yr.map(c=>({...c,isAvailable:!0}));e.split(",").map(c=>c.trim()).forEach(c=>{const d=c.match(/(\d+)\s+(.*)/);if(!d)return;const i=parseInt(d[1],10),x=d[2];if(!i||!x)return;const y=(Array.isArray(o)?o:[]).find(f=>f?.name&&f.name.toLowerCase()===x.toLowerCase())||(Array.isArray(o)?o:[]).find(f=>f?.name&&f.name.toLowerCase().includes(x.toLowerCase()));y&&y.isAvailable!==!1&&(r[y.name]=(r[y.name]||0)+i)}),oe(r)};return l.useEffect(()=>{const r=(localStorage.getItem(q)||"DINE_IN")==="TAKEAWAY";let s=null;if(r?s=w||localStorage.getItem("terra_orderId_TAKEAWAY"):s=w||localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),!s){B(null),Q(null);return}if(ct)return;let o,c,d=!1;const i=async()=>{try{const a=localStorage.getItem(q)||"DINE_IN";let g=null;if(a==="TAKEAWAY"?g=w||localStorage.getItem("terra_orderId_TAKEAWAY"):g=w||localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),!g)return;const m=localStorage.getItem("terra_sessionToken");let b;try{b=await fetch(`${W}/api/orders/${g}`,{signal:AbortSignal.timeout(5e3)})}catch{d||(console.warn("[Menu] Backend server appears to be offline. Will retry automatically."),d=!0);return}if(d&&(d=!1),!b.ok){b.status===404&&(console.warn("Order not found (404), clearing order data"),a==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.removeItem("terra_orderStatus_TAKEAWAY"),localStorage.removeItem("terra_orderStatusUpdatedAt_TAKEAWAY")):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN")),z(null),B(null),Q(null));return}let _;try{_=await b.json()}catch(U){console.error("[Menu] Failed to parse order status response as JSON:",U);return}if(!_)return;const h=localStorage.getItem("terra_serviceType")||"DINE_IN",S=h==="TAKEAWAY";if(_.serviceType&&_.serviceType!==h){console.log(`[Menu] Ignoring order update - serviceType mismatch: order is ${_.serviceType}, current is ${h}`);return}const u=S&&localStorage.getItem("terra_takeaway_sessionToken")||m;if(S){if(u&&_.sessionToken&&_.sessionToken!==u)return}else if(u&&_.sessionToken&&_.sessionToken!==u){localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN"),localStorage.removeItem("terra_cart_DINE_IN"),localStorage.removeItem("terra_previousOrder"),localStorage.removeItem("terra_previousOrderDetail"),z(null),B(null),Q(null),se(null),ee(null);return}if(S&&ee(_),_?.status){if((S?localStorage.getItem("terra_orderStatus_TAKEAWAY")||localStorage.getItem("terra_orderStatus"):localStorage.getItem("terra_orderStatus_DINE_IN")||localStorage.getItem("terra_orderStatus"))===_.status&&E===_.status)return;const C=new Date().toISOString();B(_.status),Q(C),S?(localStorage.setItem("terra_orderStatus_TAKEAWAY",_.status),localStorage.setItem("terra_orderStatusUpdatedAt_TAKEAWAY",C),localStorage.setItem("terra_orderStatus",_.status),localStorage.setItem("terra_orderStatusUpdatedAt",C)):(localStorage.setItem("terra_orderStatus_DINE_IN",_.status),localStorage.setItem("terra_orderStatusUpdatedAt_DINE_IN",C),localStorage.setItem("terra_orderStatus",_.status),localStorage.setItem("terra_orderStatusUpdatedAt",C))}}catch{}};i(),c=setInterval(i,2e4);try{o=vr(W,{transports:["websocket","polling"],reconnection:!0,reconnectionDelay:1e3,reconnectionDelayMax:5e3,reconnectionAttempts:5,timeout:6e4,connectTimeout:6e4,autoConnect:!0,forceNew:!1});let a=!1;o.on("connect",()=>{a=!1,d=!1}),o.on("connect_error",g=>{a||(console.warn("[Menu] Socket connection error - backend may be offline. Will retry automatically."),a=!0)}),o.on("disconnect",g=>{})}catch(a){console.warn("[Menu] Failed to create socket connection:",a),o=null}const x=a=>{const g=localStorage.getItem(q)||"DINE_IN";let m=null;if(g==="TAKEAWAY"?m=w||localStorage.getItem("terra_orderId_TAKEAWAY"):m=w||localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),a?._id===m&&a?.status&&a?.serviceType===g){if(localStorage.getItem("terra_orderStatus")===a.status&&E===a.status)return;if(g==="TAKEAWAY"&&a.sessionToken){const h=localStorage.getItem("terra_takeaway_sessionToken")||localStorage.getItem("terra_sessionToken");if(h&&a.sessionToken!==h)return}const _=new Date().toISOString();B(a.status),Q(_),localStorage.setItem("terra_orderStatus",a.status),localStorage.setItem("terra_orderStatusUpdatedAt",_),g==="TAKEAWAY"?(localStorage.setItem("terra_orderStatus_TAKEAWAY",a.status),localStorage.setItem("terra_orderStatusUpdatedAt_TAKEAWAY",_)):(localStorage.setItem("terra_orderStatus_DINE_IN",a.status),localStorage.setItem("terra_orderStatusUpdatedAt_DINE_IN",_))}},y=a=>{const g=localStorage.getItem(q)||"DINE_IN";let m=null;g==="TAKEAWAY"?m=w||localStorage.getItem("terra_orderId_TAKEAWAY"):m=w||localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),a?.id===m&&(B(null),z(null),g==="TAKEAWAY"?(localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.removeItem("terra_orderStatus_TAKEAWAY"),localStorage.removeItem("terra_orderStatusUpdatedAt_TAKEAWAY")):(localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_orderId_DINE_IN"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatus_DINE_IN"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_orderStatusUpdatedAt_DINE_IN")))},f=a=>{const g=$||(()=>{try{const V=localStorage.getItem("terra_selectedTable");return V?JSON.parse(V):null}catch{return null}})();if(!g)return;const m=a.id||a._id,b=g.id||g._id,_=m&&b&&String(m)===String(b),h=a.number&&g.number&&String(a.number)===String(g.number);if(!_&&!h)return;console.log("[Menu] Table status updated via socket:",a.status,"Previous status:",g.status);const S={...g,status:a.status,currentOrder:a.currentOrder||null,sessionToken:a.sessionToken||g.sessionToken};Fe(S),localStorage.setItem("terra_selectedTable",JSON.stringify(S));const u=localStorage.getItem("terra_orderId")||localStorage.getItem("terra_orderId_DINE_IN"),U=localStorage.getItem("terra_orderStatus")||localStorage.getItem("terra_orderStatus_DINE_IN"),C=u&&U&&!["Paid","Cancelled","Returned","Completed"].includes(U);a.status==="AVAILABLE"&&(C?console.log("[Menu] Table became AVAILABLE but user has active order - preserving order data"):(console.log("[Menu] Table became AVAILABLE via socket - clearing waitlist state and order data (user has no active order)"),localStorage.removeItem("terra_waitToken"),localStorage.removeItem("terra_orderId"),localStorage.removeItem("terra_cart"),localStorage.removeItem("terra_orderStatus"),localStorage.removeItem("terra_orderStatusUpdatedAt"),localStorage.removeItem("terra_previousOrder"),localStorage.removeItem("terra_previousOrderDetail"),["DINE_IN","TAKEAWAY"].forEach(V=>{localStorage.removeItem(`terra_cart_${V}`),localStorage.removeItem(`terra_orderId_${V}`),localStorage.removeItem(`terra_orderStatus_${V}`),localStorage.removeItem(`terra_orderStatusUpdatedAt_${V}`)}),z(null),B(null),console.log("[Menu] Cleared all order data for new customer")))};return o&&(o.on("orderUpdated",x),o.on("orderDeleted",y),o.on("table:status:updated",f)),()=>{c&&clearInterval(c),o&&!r&&(o.off("orderUpdated",x),o.off("orderDeleted",y),o.off("table:status:updated",f),o.disconnect())}},[w,ct]),l.useEffect(()=>{const e=localStorage.getItem(q)||"DINE_IN";if(e==="TAKEAWAY"?w||localStorage.getItem("terra_orderId_TAKEAWAY")||localStorage.getItem("terra_orderId"):w||localStorage.getItem("terra_orderId")){const s=e==="TAKEAWAY"&&localStorage.getItem("terra_orderStatus_TAKEAWAY")||localStorage.getItem("terra_orderStatus"),o=e==="TAKEAWAY"&&localStorage.getItem("terra_orderStatusUpdatedAt_TAKEAWAY")||localStorage.getItem("terra_orderStatusUpdatedAt");s&&(s!==E&&(console.log("[Menu] Syncing orderStatus from localStorage:",s),B(s)),o&&o!==le&&Q(o))}},[w,E,le]),l.useEffect(()=>{const e=localStorage.getItem(q)||"DINE_IN";let r=null;if(e==="TAKEAWAY"?r=localStorage.getItem("terra_orderId_TAKEAWAY"):r=localStorage.getItem("terra_orderId_DINE_IN")||localStorage.getItem("terra_orderId"),r&&r!==w&&(console.log("[Menu] Restoring activeOrderId on mount:",r,"serviceType:",e),z(r)),r&&!E){const s=e==="TAKEAWAY"&&localStorage.getItem("terra_orderStatus_TAKEAWAY")||localStorage.getItem("terra_orderStatus"),o=e==="TAKEAWAY"&&localStorage.getItem("terra_orderStatusUpdatedAt_TAKEAWAY")||localStorage.getItem("terra_orderStatusUpdatedAt");s&&(B(s),o&&Q(o))}},[]),l.useEffect(()=>{if(v.get("action")==="confirm"&&!je){if(ue||Object.keys(_e).length===0){console.error("[Menu] Auto-confirm aborted: Menu data missing or error",{menuCatalogSize:Object.keys(_e).length,menuError:ue});const r=new URLSearchParams(v);r.delete("action"),j(r),alert(ue?"Cannot place order automatically: "+ue:"Cannot place order automatically: Menu prices not loaded. Please try again manually.");return}const e=new URLSearchParams(v);e.delete("action"),j(e),D(!0),er()}},[v,je,_e,ue]),t.jsxs("div",{className:`menu-root ${ie?"accessibility-mode":""}`,children:[t.jsx("div",{className:"background-image",style:{backgroundImage:`url(${_r})`}}),t.jsx("div",{className:"overlay"}),t.jsx(fr,{accessibilityMode:ie,onClickCart:()=>n("/cart"),cartCount:pt}),t.jsx("div",{className:"content-wrapper",children:t.jsx("div",{className:"main-container",children:t.jsxs("div",{className:"panels-container",children:[t.jsxs("div",{className:"left-panel",children:[t.jsxs("div",{className:"order-header-section",children:[t.jsxs("div",{className:"order-header-info",children:[t.jsx("div",{className:"order-header-badge",children:N==="DINE_IN"?t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"order-header-icon",children:"📍"}),t.jsx("span",{children:$?.number?`${p("dineIn","Dine-In")} - ${p("table","Table")} ${$.number}`:p("dineIn","Dine-In")})]}):t.jsx("span",{children:p("takeaway","Takeaway")})}),N==="DINE_IN"&&t.jsxs("div",{className:"guest-count-badge",children:[t.jsx("span",{className:"guest-icon",children:"👥"}),t.jsx("span",{children:$?.seats||$?.capacity||2})]})]}),N==="TAKEAWAY"&&R?.takeawayToken&&t.jsxs("span",{className:"token-badge",children:[p("token","Token"),":"," ",t.jsx("strong",{children:R.takeawayToken})]})]}),t.jsx("button",{onClick:rr,className:`voice-button ${he?"recording":""}`,"aria-pressed":he,"aria-label":Zt,children:he?t.jsx(gr,{}):t.jsx(pr,{})}),t.jsx("p",{className:"instruction-text",children:$t?Jt:he?Gt:Ht}),N==="DINE_IN"&&t.jsxs("div",{className:"action-buttons-row",children:[t.jsx("button",{onClick:async()=>{try{const e=localStorage.getItem("terra_selectedTable");if(!e){alert("Please select a table first");return}const r=JSON.parse(e),s=r.id||r._id,o=localStorage.getItem("terra_orderId")||null,c="https://api.terracart.in".replace(/\/$/,"");if((await fetch(`${c}/api/customer-requests`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tableId:s,requestType:"assistance",customerNotes:"Call Waiter",...o&&{orderId:o}})})).ok)alert("✅ Waiter called! Someone will be with you shortly.");else throw new Error("Failed to send request")}catch(e){console.error("Error calling waiter:",e),alert("❌ Failed to call waiter. Please try again.")}},className:"action-button call-waiter-button",children:p("callWaiter","Call Waiter")}),w?t.jsxs("button",{onClick:async()=>{try{const e=localStorage.getItem("terra_selectedTable");if(!e){alert("Please select a table first");return}const r=JSON.parse(e),s=r.id||r._id,o=localStorage.getItem("terra_orderId")||null,c="https://api.terracart.in".replace(/\/$/,"");if((await fetch(`${c}/api/customer-requests`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tableId:s,requestType:"bill",customerNotes:"Request Bill",...o&&{orderId:o}})})).ok)alert("✅ Bill requested! Someone will bring it shortly.");else throw new Error("Failed to send request")}catch(e){console.error("Error requesting bill:",e),alert("❌ Failed to request bill. Please try again.")}},className:"action-button request-bill-button",children:["🧾 ",p("requestBill","Request Bill")]}):t.jsxs("button",{onClick:async()=>{try{const e=localStorage.getItem("terra_selectedTable");if(!e){alert("Please select a table first");return}const r=JSON.parse(e),s=r.id||r._id,o=localStorage.getItem("terra_orderId")||null,c="https://api.terracart.in".replace(/\/$/,"");if((await fetch(`${c}/api/customer-requests`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tableId:s,requestType:"water",customerNotes:"Request Water",...o&&{orderId:o}})})).ok)alert("✅ Water requested! Someone will bring it shortly.");else throw new Error("Failed to send request")}catch(e){console.error("Error requesting water:",e),alert("❌ Failed to request water. Please try again.")}},className:"action-button request-water-button",children:["💧 ",p("requestWater","Request Water")]})]}),at&&t.jsxs("p",{className:"ai-ordered-text",children:[Vt," ",t.jsx("span",{className:"order-text-italic",children:at})]}),E&&t.jsxs("div",{className:"order-status-card",children:[t.jsx("h4",{className:"order-summary-title",children:"Order Status"}),N==="TAKEAWAY"&&R?.takeawayToken&&t.jsxs("div",{className:"mb-3 p-2 bg-blue-50 border border-blue-200 rounded-lg",children:[t.jsxs("div",{className:"text-sm font-semibold text-blue-700",children:["Your Token:"," ",t.jsx("span",{className:"text-lg font-bold",children:R.takeawayToken})]}),t.jsx("div",{className:"text-xs text-blue-600 mt-1",children:"Please keep this token for reference"})]}),t.jsx("div",{className:"order-status-section",children:t.jsx(zr,{status:E,updatedAt:le,serviceType:N,tableLabel:N==="DINE_IN"&&$?.number?`Dine-In | Table ${$.number}`:null})}),t.jsxs("div",{className:"button-group status-actions",children:[(()=>{const e=(E||"").toLowerCase();return["paid","completed"].includes(e)&&Qr.includes(E)?t.jsx("button",{className:"reset-button return-button",onClick:sr,disabled:nt,children:nt?"Processing...":"Return Order"}):Jr.includes(E)?t.jsx("button",{className:"reset-button cancel-button",onClick:or,disabled:st,children:st?"Cancelling...":"Cancel Order"}):E==="Returned"||E==="Cancelled"?t.jsx("button",{className:"billing-button billing-button-disabled",disabled:!0,children:E==="Returned"?"Order Returned":"Order Cancelled"}):null})(),["Confirmed","Preparing","Ready","Served","Finalized","Completed","Paid"].includes(E)?t.jsx("button",{className:"billing-button",onClick:Xe,disabled:St,children:St?"Opening...":"View Invoice"}):null,t.jsx("button",{className:"confirm-button",onClick:ar,disabled:Ke||E&&!Vr.includes(E),children:Ke?"Please wait...":"Order More"}),(()=>{const e=(E||"").toLowerCase();return["Finalized","Completed"].includes(E)?t.jsx("button",{className:"billing-button",onClick:lr,disabled:lt,children:lt?"Confirming...":"Confirm Payment"}):E!=="Returned"&&E!=="Cancelled"&&!["paid","completed"].includes(e)?t.jsx("button",{className:"complete-payment-button",onClick:()=>{n("/billing")},children:"Payment"}):["paid","completed"].includes(e)?t.jsx("button",{className:"feedback-button",onClick:()=>{const r=w||localStorage.getItem("terra_orderId")||localStorage.getItem("terra_lastPaidOrderId");n("/feedback",{state:{orderId:r}})},children:"Share Feedback"}):null})()]})]}),R&&t.jsxs("div",{className:"order-status-card previous-order-detail-card",style:{padding:"12px",fontSize:"0.9rem"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"8px"},children:[t.jsx("h4",{className:"order-summary-title",style:{margin:0,fontSize:"1rem"},children:"Last Order"}),R.status&&t.jsx("span",{className:"meta-chip status-chip",style:{fontSize:"0.75rem",padding:"4px 8px"},children:R.status})]}),t.jsxs("div",{style:{display:"flex",gap:"8px",marginBottom:"8px",flexWrap:"wrap",fontSize:"0.8rem"},children:[kt&&t.jsx("span",{className:"meta-chip",style:{fontSize:"0.75rem",padding:"2px 6px"},children:kt}),Ge&&t.jsx("span",{className:"meta-chip",style:{fontSize:"0.75rem",padding:"2px 6px"},children:Ge?Ge.toLocaleDateString():"N/A"})]}),t.jsx("div",{style:{marginBottom:"8px",fontSize:"0.85rem"},children:t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontWeight:"600"},children:[t.jsxs("span",{children:["Total: ₹",Ne(At?.totalAmount||0)]}),t.jsxs("span",{children:[At?.totalItems||0," items"]})]})}),t.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[t.jsx("button",{className:"invoice-action-btn download w-full sm:w-auto",onClick:cr,style:{padding:"6px 12px",fontSize:"0.85rem"},children:"View Invoice"}),R._id&&t.jsx("button",{className:"feedback-button w-full sm:w-auto",onClick:()=>{const e=R._id;n("/feedback",{state:{orderId:e}})},style:{backgroundColor:"#10b981",color:"#ffffff",border:"1px solid #059669",fontWeight:"600",padding:"6px 12px",fontSize:"0.85rem"},children:"Feedback"})]})]})]}),t.jsxs("div",{className:"right-panel",children:[t.jsx("h3",{className:"manual-entry-title",children:Bt}),t.jsx("input",{type:"text",placeholder:Xt,value:xe,onChange:e=>Yt(e.target.value),className:"search-input"}),ue&&!je&&t.jsx("div",{className:"menu-warning",children:ue}),je?t.jsx("div",{className:"menu-loading-message",children:"Loading menu, please wait..."}):xe.trim()?_t.length>0?t.jsx("div",{className:"search-results",children:_t.map(e=>t.jsx(Rt,{item:e,onAdd:Tt,onRemove:wt,count:G[e.name]||0,lang:O},e._id||e.name))}):t.jsx("div",{className:"search-no-results",children:"No matching items found. Try another keyword."}):t.jsx("div",{className:"category-container",children:de.length===0?t.jsx("div",{className:"search-no-results",children:"Menu is not configured yet. Please contact the administrator."}):t.jsx(t.Fragment,{children:(Array.isArray(de)?de:[]).map((e,r)=>t.jsx(Xr,{defaultOpen:r===0,category:e?.name||"Unnamed Category",items:Array.isArray(e?.items)?e.items:[],cart:G,onAdd:Tt,onRemove:wt,lang:O},e?._id||e?.name||Math.random()))})})]})]})})}),Lt&&t.jsx("div",{className:"invoice-modal-overlay",onClick:Nt,children:t.jsxs("div",{className:"invoice-modal",role:"dialog","aria-modal":"true",onClick:e=>e.stopPropagation(),children:[t.jsxs("div",{className:"invoice-modal-header",children:[t.jsxs("div",{children:[t.jsx("h3",{children:"Invoice"}),A&&t.jsxs("div",{className:"invoice-meta",children:[t.jsx("span",{children:`Order #${A._id||"—"}`}),Te&&t.jsx("span",{children:Te.toLocaleString()})]})]}),t.jsxs("div",{className:"invoice-modal-actions",children:[t.jsx("button",{onClick:ir,disabled:!A||De,className:"invoice-action-btn download",children:De?"Preparing…":"Download"}),t.jsx("button",{onClick:Nt,className:"invoice-close-btn","aria-label":"Close invoice modal",children:"✕"})]})]}),t.jsxs("div",{ref:ye,className:"invoice-preview",children:[t.jsxs("div",{className:"invoice-top",children:[t.jsxs("div",{children:[t.jsx("div",{className:"brand-name",children:A?.cafe?.cafeName||A?.cafe?.name||"Terra Cart"}),t.jsx("div",{className:"brand-address",children:A?.cafe?.address||A?.franchise?.address||"123 Main Street, City"}),A?.franchise?.gstNumber?t.jsxs("div",{className:"brand-address",children:["GSTIN: ",A.franchise.gstNumber]}):A?.franchiseId?t.jsx("div",{className:"brand-address",style:{color:"#999",fontSize:"0.9em"},children:"GSTIN: Not configured"}):null]}),t.jsxs("div",{className:"invoice-meta-block",children:[t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Invoice No:"}),t.jsx("span",{children:ke||"—"})]}),A?.serviceType==="TAKEAWAY"&&A?.takeawayToken&&t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Token:"}),t.jsx("span",{className:"font-bold text-blue-600",children:A.takeawayToken})]}),Te&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Date:"}),t.jsx("span",{children:Te.toLocaleDateString()})]}),t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Time:"}),t.jsx("span",{children:Te.toLocaleTimeString()})]})]})]})]}),t.jsxs("div",{className:"invoice-billed",children:[t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Service:"}),t.jsx("span",{children:qt})]}),t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Table:"}),t.jsxs("span",{children:[A?.serviceType==="TAKEAWAY"?"Takeaway Counter":zt||"—",yt?` · ${yt}`:""]})]}),A?.serviceType==="TAKEAWAY"&&(A.customerName||A.customerMobile)&&t.jsxs(t.Fragment,{children:[A.customerName&&t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Customer Name:"}),t.jsx("span",{children:A.customerName})]}),A.customerMobile&&t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Mobile Number:"}),t.jsx("span",{children:A.customerMobile})]})]}),A?.specialInstructions&&t.jsxs("div",{className:"meta-line",style:{marginTop:"8px",borderTop:"1px dashed #e5e7eb",paddingTop:"4px"},children:[t.jsx("span",{style:{color:"#d97706",fontWeight:"bold"},children:"Note:"}),t.jsx("span",{style:{fontStyle:"italic"},children:A.specialInstructions})]})]}),t.jsxs("table",{className:"invoice-table",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"Item"}),t.jsx("th",{children:"Qty"}),t.jsx("th",{children:"Price (₹)"}),t.jsx("th",{className:"align-right",children:"Amount (₹)"})]})}),t.jsx("tbody",{children:We.length>0?We.map(e=>t.jsxs("tr",{children:[t.jsx("td",{children:t.jsxs("div",{className:"flex flex-col gap-0.5",children:[t.jsx("span",{children:e.name}),e.returned&&t.jsxs("span",{className:"invoice-returned-note",children:["Returned ",e.returnedQuantity]})]})}),t.jsx("td",{children:e.quantity>0?e.quantity:"—"}),t.jsxs("td",{children:["₹",Ne(e.unitPrice)]}),t.jsx("td",{className:"align-right",children:e.quantity>0?`₹${Ne(e.amount)}`:"Returned"})]},e.name)):t.jsx("tr",{children:t.jsx("td",{colSpan:4,className:"empty-row",children:"No items found"})})})]}),t.jsxs("div",{className:"invoice-totals",children:[t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Total Items"}),t.jsx("span",{children:He.totalItems})]}),t.jsxs("div",{className:"meta-line",children:[t.jsx("span",{children:"Subtotal"}),t.jsxs("span",{children:["₹",Ne(He.subtotal)]})]}),t.jsxs("div",{className:"meta-line total",children:[t.jsx("span",{children:"Total"}),t.jsxs("span",{children:["₹",Ne(He.totalAmount)]})]})]}),t.jsx("div",{className:"invoice-footer",children:"Thank you for dining with Terra Cart. We hope to see you again!"})]})]})}),Ft&&t.jsx("div",{className:"invoice-modal-overlay",onClick:()=>Ie(!1),children:t.jsxs("div",{className:"invoice-modal",style:{maxWidth:"24rem",maxHeight:"auto",height:"auto"},onClick:e=>e.stopPropagation(),children:[t.jsxs("div",{className:"invoice-modal-header",children:[t.jsx("div",{children:t.jsx("h3",{children:Se==="Cancel"?"Cancel Order":"Return Order"})}),t.jsx("button",{onClick:()=>Ie(!1),className:"invoice-close-btn",children:"✕"})]}),t.jsxs("div",{children:[t.jsx("p",{style:{marginBottom:"0.5rem",fontSize:"0.9rem",color:"#666"},children:"Please provide a reason:"}),t.jsx("textarea",{style:{width:"100%",padding:"0.75rem",border:"1px solid #ddd",borderRadius:"0.5rem",minHeight:"100px",fontSize:"0.9rem",marginBottom:"1rem",fontFamily:"inherit",resize:"vertical",boxSizing:"border-box"},placeholder:"e.g. Changed my mind, Taking too long...",value:Pe,onChange:e=>Je(e.target.value)}),t.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:"0.5rem"},children:[t.jsx("button",{className:"reset-button",style:{width:"auto",flex:"1"},onClick:()=>Ie(!1),disabled:Qe,children:"Close"}),t.jsx("button",{className:"confirm-button",style:{width:"auto",flex:"1"},onClick:nr,disabled:Qe,children:Qe?"Processing...":"Confirm"})]})]})]})}),Object.keys(G).length>0&&!Kt&&t.jsx("div",{className:"menu-cart-footer",children:t.jsxs("div",{className:"menu-cart-footer-inner",children:[t.jsxs("div",{style:{display:"flex",flexDirection:"column"},children:[t.jsxs("span",{style:{fontWeight:"bold",fontSize:"1.1rem",color:"#333"},children:[pt," Items"]}),t.jsxs("span",{style:{color:"#666",fontSize:"0.9rem"},children:["Total: ₹",Ut.toFixed(2)]})]}),t.jsx("button",{onClick:()=>n("/cart"),style:{backgroundColor:"#ff6b35",color:"white",padding:"12px 24px",borderRadius:"50px",fontWeight:"bold",fontSize:"1rem",border:"none",cursor:"pointer",boxShadow:"0 4px 6px rgba(255, 107, 53, 0.3)"},children:"View Cart →"})]})}),t.jsx(Sr,{open:F,steps:H,title:"Processing your order"})]})}const ga=Object.freeze(Object.defineProperty({__proto__:null,default:Zr},Symbol.toStringTag,{value:"Module"}));export{ga as M,zr as O};
