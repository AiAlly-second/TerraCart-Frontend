import{u as O,r as s,j as e,l as T,m as U,n as D,M,Q as R}from"./vendor-react-D1Ov3a92.js";/* empty css                         */import{m as P}from"./vendor-motion-DMcOTFRV.js";import"./vendor-CB8mghnX.js";const $={choosePayment:"Choose Payment Method",upiQR:"UPI QR",cashCard:"Cash / Card",payOnline:"Pay Online",markPaid:"Payment completed",markingPaid:"Updating payment...",markPaidHint:"Once the transaction is done, tap below so staff can verify it.",failedMarkPaid:"Failed to mark order as paid.",noOrderFound:"No order found for payment.",close:"Close",pendingPaymentTitle:"Payment in progress",cashPendingTitle:"Cash payment pending",onlineInstructions:"Scan the QR code with any UPI app or copy the payment string.",cashInstructions:"Please pay the amount at the counter. Staff will confirm once received.",cancelPayment:"Cancel payment",cancellingPayment:"Cancelling...",retryPayment:"Start a new payment",createOnline:"Pay with UPI / Online",createCash:"Pay with cash",resumePayment:"Resume payment",paidMessage:"Payment received! Taking you to confirmation…",viewOrder:"View order summary"},F={choosePayment:"भुगतान विधि चुनें",upiQR:"यूपीआई क्यूआर",cashCard:"नकद / कार्ड",payOnline:"ऑनलाइन भुगतान",markPaid:"भुगतान पूरा हुआ",markingPaid:"भुगतान अपडेट हो रहा है...",markPaidHint:"काउंटर पर भुगतान पूरा होने के बाद नीचे टैप करें ताकि स्टाफ को सूचना मिले।",failedMarkPaid:"ऑर्डर को भुगतान किया हुआ नहीं मार्क कर पाए।",noOrderFound:"भुगतान के लिए कोई ऑर्डर नहीं मिला।",close:"बंद करें",pendingPaymentTitle:"भुगतान प्रगति में",cashPendingTitle:"नकद भुगतान लंबित",onlineInstructions:"किसी भी UPI ऐप से क्यूआर कोड स्कैन करें या भुगतान विवरण कॉपी करें।",cashInstructions:"काउंटर पर राशि जमा करें। स्टाफ पुष्टि करेगा।",cancelPayment:"भुगतान रद्द करें",cancellingPayment:"भुगतान रद्द किया जा रहा है...",retryPayment:"नया भुगतान शुरू करें",createOnline:"यूपीआई / ऑनलाइन भुगतान",createCash:"नकद भुगतान",resumePayment:"भुगतान जारी रखें",paidMessage:"भुगतान प्राप्त हुआ! पुष्टि पृष्ठ पर ले जाया जा रहा है…",viewOrder:"ऑर्डर सारांश देखें"},Q={choosePayment:"पेमेंट पद्धत निवडा",upiQR:"यूपीआय QR",cashCard:"रोख / कार्ड",payOnline:"ऑनलाइन पेमेंट",markPaid:"पेमेंट पूर्ण केले",markingPaid:"पेमेंट अपडेट होत आहे...",markPaidHint:"काउंटरवर पेमेंट पूर्ण झाल्यावर खालील बटण टॅप करा जेणेकरून स्टाफला कळेल.",failedMarkPaid:"ऑर्डर पेमेंट झालेले मार्क करू शकलो नाही.",noOrderFound:"पेमेंटसाठी कोणताही ऑर्डर सापडला नाही.",close:"बंद करा",pendingPaymentTitle:"पेमेंट चालू आहे",cashPendingTitle:"रोख पेमेंट प्रतीक्षेत",onlineInstructions:"क्यूआर कोड स्कॅन करा किंवा पेमेंट स्ट्रिंग कॉपी करा.",cashInstructions:"कृपया रक्कम काउंटरवर भरा. स्टाफ पुष्टी करेल.",cancelPayment:"पेमेंट रद्द करा",cancellingPayment:"पेमेंट रद्द करत आहोत...",retryPayment:"नवीन पेमेंट सुरू करा",createOnline:"यूपीआय / ऑनलाइन पेमेंट",createCash:"रोखाने पेमेंट",resumePayment:"पेमेंट पुढे सुरू करा",paidMessage:"पेमेंट प्राप्त झाले! पुष्टी पृष्ठाकडे घेऊन जात आहोत…",viewOrder:"ऑर्डर सारांश पहा"},H={choosePayment:"ચુકવણી રીત પસંદ કરો",upiQR:"યુપીઆઇ QR",cashCard:"નગદ / કાર્ડ",payOnline:"ઓનલાઇન ચુકવણી",markPaid:"ચુકવણી પૂર્ણ થઇ",markingPaid:"ચુકવણી અપડેટ થાય છે...",markPaidHint:"કાઉન્ટર પર ચુકવણી પૂર્ણ કર્યા પછી સ્ટાફને જાણ કરવા નીચે ટચ કરો.",failedMarkPaid:"ઓર્ડરને ચૂકવેલ તરીકે માર્ક કરી શક્યા નથી.",noOrderFound:"ચુકવણી માટે કોઈ ઓર્ડર મળ્યો નથી.",close:"બંધ કરો",pendingPaymentTitle:"ચુકવણી ચાલુ છે",cashPendingTitle:"નಗદ ચુકવણી બાકી",onlineInstructions:"કોઈપણ UPI એપથી QR સ્કેન કરો અથવા ચુકવણી લખાણ કૉપી કરો.",cashInstructions:"કાઉન્ટર પર ચુકવણી કરો. સ્ટાફ તેની પુષ્ટિ કરશે.",cancelPayment:"ચુકવણી રદ કરો",cancellingPayment:"ચુકવણી રદ કરી રહ્યા છીએ...",retryPayment:"નવી ચુકવણી શરૂ કરો",createOnline:"UPI / ઑનલાઇન ચુકવણી",createCash:"નગદ ચૂકવણી",resumePayment:"ચુકવણી આગળ વધારવું",paidMessage:"ચુકવણી મળી ગઈ! કન્ફર્મેશન તરફ લઈ જઈ રહ્યા છીએ…",viewOrder:"ઓર્ડર સારાંશ જુઓ"},L={en:$,hi:F,mr:Q,gu:H},y="https://api.terracart.in".replace(/\/$/,"");function V(){const m=O(),[o,w]=s.useState(!1),[I,x]=s.useState(!1),[t,c]=s.useState(null),[v,N]=s.useState(!0),[u,p]=s.useState(null),[d,K]=s.useState(localStorage.getItem("accessibilityMode")==="true"),[g,k]=s.useState(!1),C=s.useMemo(()=>localStorage.getItem("language")||"en",[]),r=s.useCallback(a=>L[C]?.[a]||a,[C]);s.useMemo(()=>localStorage.getItem("terra_serviceType")||"DINE_IN",[]);const i=s.useMemo(()=>(localStorage.getItem("terra_serviceType")||"DINE_IN")==="TAKEAWAY"&&localStorage.getItem("terra_orderId_TAKEAWAY")||localStorage.getItem("terra_orderId"),[]),b=s.useMemo(()=>t&&t.status&&["PENDING","PROCESSING","CASH_PENDING"].includes(t.status),[t]),h=s.useCallback(async()=>{if(i)try{N(!0);const a=await fetch(`${y}/api/payments/order/${i}/latest`);if(a.status===404){c(null);return}if(!a.ok){const l=await a.json().catch(()=>({}));throw new Error(l.message||"Failed to fetch payment status")}const n=await a.json();c(n||null)}catch(a){a.message?.includes("404")||a.message?.includes("not found")||console.warn("Failed to fetch payment:",a),c(null)}finally{N(!1)}},[i]),j=s.useCallback(async()=>{try{const a=await fetch(`${y}/api/payment-qr/active`);if(a.status===404){p(null);return}if(!a.ok){p(null);return}const n=await a.json();p(n||null)}catch{p(null)}},[]),f=s.useCallback(()=>{if(g){console.log("[Payment] Payment already handled, skipping");return}if(k(!0),i){localStorage.setItem("terra_orderId",i),localStorage.setItem("terra_orderStatus","Paid"),localStorage.setItem("terra_orderStatusUpdatedAt",new Date().toISOString()),localStorage.setItem("terra_lastPaidOrderId",i);const a=localStorage.getItem("terra_serviceType")||"DINE_IN",n=localStorage.getItem("terra_orderType")||null,l=n==="PICKUP"||n==="DELIVERY";a==="TAKEAWAY"||a==="PICKUP"||a==="DELIVERY"?(localStorage.setItem("terra_orderId_TAKEAWAY",i),localStorage.setItem("terra_orderStatus_TAKEAWAY","Paid"),localStorage.setItem("terra_orderStatusUpdatedAt_TAKEAWAY",new Date().toISOString()),!l&&a==="TAKEAWAY"?(localStorage.removeItem("terra_takeaway_customerName"),localStorage.removeItem("terra_takeaway_customerMobile"),localStorage.removeItem("terra_takeaway_customerEmail"),console.log("[Payment] Cleared takeaway customer data after payment (regular TAKEAWAY order)")):console.log("[Payment] Preserved customer data for "+(n||a)+" order to allow reordering")):(localStorage.setItem("terra_orderId_DINE_IN",i),localStorage.setItem("terra_orderStatus_DINE_IN","Paid"),localStorage.setItem("terra_orderStatusUpdatedAt_DINE_IN",new Date().toISOString()))}localStorage.removeItem("terra_cart"),localStorage.setItem("terra_paymentCompleted","true"),console.log("[Payment] Payment completed - flag set for session clearing on next table scan"),m("/menu")},[i,m,g]);s.useEffect(()=>{if(!i){alert(r("noOrderFound")||"No order found for payment."),m("/menu");return}h(),j()},[i,h,j,m,r]),s.useEffect(()=>{if(!b)return;const a=setInterval(()=>{h()},1e4);return()=>clearInterval(a)},[b,h]),s.useEffect(()=>{t?.status==="PAID"&&!g&&f()},[t?.status,f,g]);const S=async a=>{if(i){w(!0);try{const n=await fetch(`${y}/api/payments/create`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({orderId:i,method:a})}),l=await n.json();if(!n.ok)throw new Error(l?.message||"Unable to create payment");c(l)}catch(n){alert(n.message||"Unable to create payment")}finally{w(!1)}}},A=async()=>{if(!(!t?.id||!await window.confirm(r("cancelPayment")||"Cancel current payment?"))){x(!0);try{const n=await fetch(`${y}/api/payments/${t.id}/cancel`,{method:"POST"});if(!n.ok){let l;try{l=await n.json()}catch{const _=await n.text().catch(()=>"Unknown error");throw new Error(`Failed to cancel payment: ${_}`)}throw new Error(l?.message||"Unable to cancel payment")}c(null)}catch(n){alert(n.message||"Unable to cancel payment")}finally{x(!1)}}},E=()=>{if(!t)return null;if(t.status==="PAID")return e.jsxs("div",{className:"payment-status-card success",children:[e.jsx("p",{className:"payment-status-title",children:r("paidMessage")}),e.jsx("button",{className:"payment-button primary",onClick:f,children:r("viewOrder")})]});if(["CANCELLED","FAILED"].includes(t?.status))return e.jsxs("div",{className:"payment-status-card warning",children:[e.jsx("p",{className:"payment-status-title",children:t?.status==="FAILED"?"Payment failed":"Payment cancelled"}),e.jsx("button",{className:"payment-button primary",onClick:()=>c(null),children:r("retryPayment")})]});const a=t?.method==="ONLINE",n=t?.method==="CASH"||t?.status==="CASH_PENDING";return e.jsxs("div",{className:"payment-status-card",children:[e.jsx("p",{className:"payment-status-title",children:r(n?"cashPendingTitle":"pendingPaymentTitle")}),e.jsx("p",{className:"payment-status-text",children:r(n?"cashInstructions":"onlineInstructions")}),a&&e.jsx("div",{className:"payment-qr-wrapper",children:u?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:`${y}${u.qrImageUrl}`,alt:"Payment QR Code",style:{maxWidth:"180px",maxHeight:"180px",width:"auto",height:"auto"}}),u.upiId&&e.jsxs("p",{className:"text-sm text-slate-600 mt-2",children:["UPI ID: ",e.jsx("strong",{children:u.upiId})]}),t?.upiPayload&&e.jsxs(e.Fragment,{children:[e.jsx("textarea",{className:"payment-qr-text",readOnly:!0,value:t.upiPayload,rows:3}),e.jsx("button",{className:"payment-button secondary",onClick:()=>t?.upiPayload&&navigator.clipboard.writeText(t.upiPayload),children:"Copy UPI string"})]})]}):t?.upiPayload?e.jsxs(e.Fragment,{children:[e.jsx(R,{value:t.upiPayload,size:180}),e.jsx("textarea",{className:"payment-qr-text",readOnly:!0,value:t.upiPayload,rows:3}),e.jsx("button",{className:"payment-button secondary",onClick:()=>t?.upiPayload&&navigator.clipboard.writeText(t.upiPayload),children:"Copy UPI string"})]}):null}),e.jsx("div",{className:"payment-action-buttons",children:e.jsx("button",{className:`payment-button danger ${I?"disabled":""}`,onClick:A,disabled:I,children:r(I?"cancellingPayment":"cancelPayment")})})]})};return e.jsxs("div",{className:`payment-container ${d?"accessibility-mode":""}`,children:[e.jsx("button",{onClick:()=>m(-1),className:`back-button ${d?"accessibility-mode":""}`,children:e.jsx(T,{size:18})}),e.jsxs(P.div,{initial:{y:40,opacity:0},animate:{y:0,opacity:1},transition:{duration:.6,ease:"easeOut"},className:`payment-card ${d?"accessibility-mode":""}`,children:[e.jsx("h2",{className:`payment-title ${d?"accessibility-mode":""}`,children:r("choosePayment")}),v?e.jsx("div",{className:"payment-status-card",children:e.jsx("p",{className:"payment-status-title",children:"Loading payment details…"})}):t?E():e.jsxs("div",{className:"payment-options",children:[e.jsx("p",{className:"payment-status-text",children:"Choose how you’d like to complete your payment."}),e.jsxs("div",{className:"payment-buttons",children:[e.jsxs(P.button,{whileHover:{scale:o?1:1.03},whileTap:{scale:o?1:.97},onClick:()=>S("ONLINE"),disabled:o,className:`payment-button ${d?"accessibility-mode":""}`,children:[e.jsx(U,{size:20}),o?"Starting...":r("createOnline")]}),e.jsxs(P.button,{whileHover:{scale:o?1:1.03},whileTap:{scale:o?1:.97},onClick:()=>S("CASH"),disabled:o,className:`payment-button ${d?"accessibility-mode":""}`,children:[e.jsx(D,{size:20}),o?"Starting...":r("createCash")]}),e.jsxs(P.button,{whileHover:{scale:o?1:1.03},whileTap:{scale:o?1:.97},onClick:()=>S("ONLINE"),disabled:o,className:`payment-button ${d?"accessibility-mode":""}`,children:[e.jsx(M,{size:20}),o?"Starting...":r("payOnline")]})]})]})]})]})}export{V as default};
