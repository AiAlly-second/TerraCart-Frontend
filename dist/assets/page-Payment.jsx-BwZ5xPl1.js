import{u as Y,r as s,j as e,l as F,m as H,n as L,Q as B}from"./vendor-react-BMxAjtiD.js";/* empty css                         */import{m as x}from"./vendor-motion-iT52ZrD2.js";import"./vendor-CB8mghnX.js";const G={choosePayment:"Choose Payment Method",upiQR:"UPI QR",cashCard:"Cash / Card",payOnline:"Pay Online",payNow:"Pay now",payWithPhonePe:"PhonePe",payWithPaytm:"Paytm",markPaid:"Payment completed",markingPaid:"Updating payment...",markPaidHint:"Once the transaction is done, tap below so staff can verify it.",failedMarkPaid:"Failed to mark order as paid.",noOrderFound:"No order found for payment.",close:"Close",pendingPaymentTitle:"Payment in progress",cashPendingTitle:"Cash payment pending",onlineInstructions:"Scan the QR code with any UPI app or copy the payment string.",cashInstructions:"Please pay the amount at the counter. Staff will confirm once received.",cancelPayment:"Cancel payment",cancellingPayment:"Cancelling...",retryPayment:"Start a new payment",createOnline:"Pay with UPI / Online",createCash:"Pay with cash",resumePayment:"Resume payment",paidMessage:"Payment received! Taking you to confirmation…",viewOrder:"View order summary"},V={choosePayment:"भुगतान विधि चुनें",upiQR:"यूपीआई क्यूआर",cashCard:"नकद / कार्ड",payOnline:"ऑनलाइन भुगतान",payNow:"अभी भुगतान करें",payWithPhonePe:"PhonePe",payWithPaytm:"Paytm",markPaid:"भुगतान पूरा हुआ",markingPaid:"भुगतान अपडेट हो रहा है...",markPaidHint:"काउंटर पर भुगतान पूरा होने के बाद नीचे टैप करें ताकि स्टाफ को सूचना मिले।",failedMarkPaid:"ऑर्डर को भुगतान किया हुआ नहीं मार्क कर पाए।",noOrderFound:"भुगतान के लिए कोई ऑर्डर नहीं मिला।",close:"बंद करें",pendingPaymentTitle:"भुगतान प्रगति में",cashPendingTitle:"नकद भुगतान लंबित",onlineInstructions:"किसी भी UPI ऐप से क्यूआर कोड स्कैन करें या भुगतान विवरण कॉपी करें।",cashInstructions:"काउंटर पर राशि जमा करें। स्टाफ पुष्टि करेगा।",cancelPayment:"भुगतान रद्द करें",cancellingPayment:"भुगतान रद्द किया जा रहा है...",retryPayment:"नया भुगतान शुरू करें",createOnline:"यूपीआई / ऑनलाइन भुगतान",createCash:"नकद भुगतान",resumePayment:"भुगतान जारी रखें",paidMessage:"भुगतान प्राप्त हुआ! पुष्टि पृष्ठ पर ले जाया जा रहा है…",viewOrder:"ऑर्डर सारांश देखें"},z={choosePayment:"पेमेंट पद्धत निवडा",upiQR:"यूपीआय QR",cashCard:"रोख / कार्ड",payOnline:"ऑनलाइन पेमेंट",payNow:"आता पेमेंट करा",payWithPhonePe:"PhonePe",payWithPaytm:"Paytm",markPaid:"पेमेंट पूर्ण केले",markingPaid:"पेमेंट अपडेट होत आहे...",markPaidHint:"काउंटरवर पेमेंट पूर्ण झाल्यावर खालील बटण टॅप करा जेणेकरून स्टाफला कळेल.",failedMarkPaid:"ऑर्डर पेमेंट झालेले मार्क करू शकलो नाही.",noOrderFound:"पेमेंटसाठी कोणताही ऑर्डर सापडला नाही.",close:"बंद करा",pendingPaymentTitle:"पेमेंट चालू आहे",cashPendingTitle:"रोख पेमेंट प्रतीक्षेत",onlineInstructions:"क्यूआर कोड स्कॅन करा किंवा पेमेंट स्ट्रिंग कॉपी करा.",cashInstructions:"कृपया रक्कम काउंटरवर भरा. स्टाफ पुष्टी करेल.",cancelPayment:"पेमेंट रद्द करा",cancellingPayment:"पेमेंट रद्द करत आहोत...",retryPayment:"नवीन पेमेंट सुरू करा",createOnline:"यूपीआय / ऑनलाइन पेमेंट",createCash:"रोखाने पेमेंट",resumePayment:"पेमेंट पुढे सुरू करा",paidMessage:"पेमेंट प्राप्त झाले! पुष्टी पृष्ठाकडे घेऊन जात आहोत…",viewOrder:"ऑर्डर सारांश पहा"},q={choosePayment:"ચુકવણી રીત પસંદ કરો",upiQR:"યુપીઆઇ QR",cashCard:"નગદ / કાર્ડ",payOnline:"ઓનલાઇન ચુકવણી",payNow:"હમણાં ચુકવણી કરો",payWithPhonePe:"PhonePe",payWithPaytm:"Paytm",markPaid:"ચુકવણી પૂર્ણ થઇ",markingPaid:"ચુકવણી અપડેટ થાય છે...",markPaidHint:"કાઉન્ટર પર ચુકવણી પૂર્ણ કર્યા પછી સ્ટાફને જાણ કરવા નીચે ટચ કરો.",failedMarkPaid:"ઓર્ડરને ચૂકવેલ તરીકે માર્ક કરી શક્યા નથી.",noOrderFound:"ચુકવણી માટે કોઈ ઓર્ડર મળ્યો નથી.",close:"બંધ કરો",pendingPaymentTitle:"ચુકવણી ચાલુ છે",cashPendingTitle:"નಗદ ચુકવણી બાકી",onlineInstructions:"કોઈપણ UPI એપથી QR સ્કેન કરો અથવા ચુકવણી લખાણ કૉપી કરો.",cashInstructions:"કાઉન્ટર પર ચુકવણી કરો. સ્ટાફ તેની પુષ્ટિ કરશે.",cancelPayment:"ચુકવણી રદ કરો",cancellingPayment:"ચુકવણી રદ કરી રહ્યા છીએ...",retryPayment:"નવી ચુકવણી શરૂ કરો",createOnline:"UPI / ઑનલાઇન ચુકવણી",createCash:"નગદ ચૂકવણી",resumePayment:"ચુકવણી આગળ વધારવું",paidMessage:"ચુકવણી મળી ગઈ! કન્ફર્મેશન તરફ લઈ જઈ રહ્યા છીએ…",viewOrder:"ઓર્ડર સારાંશ જુઓ"},J={en:G,hi:V,mr:z,gu:q},h="https://api.terracart.in".replace(/\/$/,"");function W(i){if(!i)return"";if(i.startsWith("http://")||i.startsWith("https://"))return i;const d=i.startsWith("/")?i:`/${i}`;return`${h}${d}`}function N(i,d){if(!i||typeof i!="string")return null;const g=i.match(/^(upi:\/\/pay\?)(.*)$/i);return g?`${d}://pay?${g[2]}`:null}function ne(){const i=Y(),[d,g]=s.useState(!1),[w,S]=s.useState(!1),[a,y]=s.useState(null),[$,A]=s.useState(!0),[f,b]=s.useState(null),[P,X]=s.useState(localStorage.getItem("accessibilityMode")==="true"),[u,U]=s.useState(!1),[D,_]=s.useState(!1),j=s.useMemo(()=>localStorage.getItem("language")||"en",[]),r=s.useCallback(t=>J[j]?.[t]||t,[j]),p=s.useMemo(()=>localStorage.getItem("terra_serviceType")||"DINE_IN",[]),o=s.useMemo(()=>(localStorage.getItem("terra_serviceType")||"DINE_IN")==="TAKEAWAY"&&localStorage.getItem("terra_orderId_TAKEAWAY")||localStorage.getItem("terra_orderId"),[]),v=s.useMemo(()=>a&&a.status&&["PENDING","PROCESSING","CASH_PENDING"].includes(a.status),[a]),C=s.useCallback(async()=>{if(o)try{A(!0);const t=await fetch(`${h}/api/payments/order/${o}/latest`);if(t.status===404){y(null);return}if(!t.ok){const l=await t.json().catch(()=>({}));throw new Error(l.message||"Failed to fetch payment status")}const n=await t.json();y(n||null)}catch(t){t.message?.includes("404")||t.message?.includes("not found")||console.warn("Failed to fetch payment:",t),y(null)}finally{A(!1)}},[o]),T=s.useCallback(()=>{const t=localStorage.getItem("terra_selectedCartId");if(t)return t;const n=localStorage.getItem("terra_takeaway_cartId");if(n)return n;const l=localStorage.getItem("terra_selectedTable")||localStorage.getItem("tableSelection");if(l)try{const c=JSON.parse(l);return c?.cartId||c?.cafeId||null}catch{return null}return null},[]),E=s.useCallback(async()=>{try{const t=new URLSearchParams;o&&t.set("orderId",o);const n=T();n&&t.set("cartId",n);const l=`${h}/api/payment-qr/active${t.toString()?`?${t.toString()}`:""}`,c=await fetch(l);if(c.status===404){b(null);return}if(!c.ok){b(null);return}const I=await c.json();b(I||null)}catch{b(null)}},[o,T]),k=s.useCallback(()=>{if(u){console.log("[Payment] Payment already handled, skipping");return}if(U(!0),o){localStorage.setItem("terra_orderId",o),localStorage.setItem("terra_orderStatus","Paid"),localStorage.setItem("terra_orderStatusUpdatedAt",new Date().toISOString()),localStorage.setItem("terra_lastPaidOrderId",o);const t=localStorage.getItem("terra_serviceType")||"DINE_IN",n=localStorage.getItem("terra_orderType")||null,l=n==="PICKUP"||n==="DELIVERY";t==="TAKEAWAY"||t==="PICKUP"||t==="DELIVERY"?(localStorage.setItem("terra_orderId_TAKEAWAY",o),localStorage.setItem("terra_orderStatus_TAKEAWAY","Paid"),localStorage.setItem("terra_orderStatusUpdatedAt_TAKEAWAY",new Date().toISOString()),!l&&t==="TAKEAWAY"?(localStorage.removeItem("terra_takeaway_customerName"),localStorage.removeItem("terra_takeaway_customerMobile"),localStorage.removeItem("terra_takeaway_customerEmail"),console.log("[Payment] Cleared takeaway customer data after payment (regular TAKEAWAY order)")):console.log("[Payment] Preserved customer data for "+(n||t)+" order to allow reordering")):(localStorage.setItem("terra_orderId_DINE_IN",o),localStorage.setItem("terra_orderStatus_DINE_IN","Paid"),localStorage.setItem("terra_orderStatusUpdatedAt_DINE_IN",new Date().toISOString()))}localStorage.removeItem("terra_cart"),localStorage.setItem("terra_paymentCompleted","true"),console.log("[Payment] Payment completed - flag set for session clearing on next table scan"),i("/menu")},[o,i,u]);s.useEffect(()=>{if(!o){alert(r("noOrderFound")||"No order found for payment."),i("/menu");return}C(),E()},[o,C,E,i,r]),s.useEffect(()=>{if(!v)return;const t=setInterval(()=>{C()},1e4);return()=>clearInterval(t)},[v,C]),s.useEffect(()=>{a?.status==="PAID"&&!u&&k()},[a?.status,k,u]);const O=async t=>{if(o){g(!0);try{const n=await fetch(`${h}/api/payments/create`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({orderId:o,method:t})}),l=await n.json();if(!n.ok)throw new Error(l?.message||"Unable to create payment");y(l)}catch(n){alert(n.message||"Unable to create payment")}finally{g(!1)}}},R=s.useCallback(async()=>{if(!(p==="TAKEAWAY"||p==="PICKUP"||p==="DELIVERY")||!o||u||a?.status==="PAID"){i("/menu");return}_(!0);try{const n=localStorage.getItem("terra_takeaway_sessionToken")||void 0,l=await fetch(`${h}/api/orders/${o}/customer-status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"Cancelled",sessionToken:n,reason:"Customer left payment without paying"})});if(!l.ok){const c=await l.json().catch(()=>({}));console.warn("[Payment] Cancel order failed:",c?.message||l.status)}}catch(n){console.warn("[Payment] Cancel order error:",n)}finally{localStorage.removeItem("terra_orderId_TAKEAWAY"),localStorage.removeItem("terra_orderStatus_TAKEAWAY"),localStorage.removeItem("terra_orderStatusUpdatedAt_TAKEAWAY"),localStorage.removeItem("terra_takeaway_sessionToken"),localStorage.getItem("terra_orderId")===o&&localStorage.removeItem("terra_orderId"),_(!1),i("/menu")}},[p,o,u,a?.status,i]),Q=async()=>{if(!(!a?.id||!await window.confirm(r("cancelPayment")||"Cancel current payment?"))){S(!0);try{const n=await fetch(`${h}/api/payments/${a.id}/cancel`,{method:"POST"});if(!n.ok){let l;try{l=await n.json()}catch{const I=await n.text().catch(()=>"Unknown error");throw new Error(`Failed to cancel payment: ${I}`)}throw new Error(l?.message||"Unable to cancel payment")}y(null)}catch(n){alert(n.message||"Unable to cancel payment")}finally{S(!1)}}},M=s.useCallback(async()=>{if(!a?.id){y(null);return}S(!0);try{await fetch(`${h}/api/payments/${a.id}/cancel`,{method:"POST"})}catch(t){console.warn("[Payment] Cancel payment on back:",t)}finally{y(null),S(!1)}},[a?.id]),K=()=>{if(!a)return null;if(a.status==="PAID")return e.jsxs("div",{className:"payment-status-card success",children:[e.jsx("p",{className:"payment-status-title",children:r("paidMessage")}),e.jsx("button",{className:"payment-button primary",onClick:k,children:r("viewOrder")})]});if(["CANCELLED","FAILED"].includes(a?.status))return e.jsxs("div",{className:"payment-status-card warning",children:[e.jsx("p",{className:"payment-status-title",children:a?.status==="FAILED"?"Payment failed":"Payment cancelled"}),e.jsx("button",{className:"payment-button primary",onClick:()=>y(null),children:r("retryPayment")})]});const t=a?.method==="ONLINE",n=a?.method==="CASH"||a?.status==="CASH_PENDING",l=t||n,c=!!f?.qrImageUrl,I=!!a?.upiPayload;return e.jsxs("div",{className:"payment-status-card",children:[e.jsx("p",{className:"payment-status-title",children:r(n?"cashPendingTitle":"pendingPaymentTitle")}),e.jsx("p",{className:"payment-status-text",children:r(n?"cashInstructions":"onlineInstructions")}),l&&(c||I)&&e.jsx("div",{className:"payment-qr-wrapper",children:c?e.jsxs(e.Fragment,{children:[t&&a?.upiPayload?e.jsx("button",{type:"button",className:"payment-qr-clickable",onClick:()=>{a?.upiPayload&&(window.location.href=a.upiPayload)},title:r("payNow"),children:e.jsx("img",{src:W(f.qrImageUrl),alt:"Payment QR Code",style:{maxWidth:"180px",maxHeight:"180px",width:"auto",height:"auto"}})}):e.jsx("img",{src:W(f.qrImageUrl),alt:"Payment QR Code",style:{maxWidth:"180px",maxHeight:"180px",width:"auto",height:"auto"}}),f.upiId&&e.jsxs("p",{className:"text-sm text-slate-600 mt-2",children:["UPI ID: ",e.jsx("strong",{children:f.upiId})]}),t&&a?.upiPayload&&e.jsxs("div",{className:"payment-upi-app-buttons",children:[e.jsx("button",{type:"button",className:"payment-button payment-button-upi-open",onClick:()=>{a?.upiPayload&&(window.location.href=a.upiPayload)},children:r("payNow")}),e.jsxs("div",{className:"payment-upi-app-row",children:[e.jsx("button",{type:"button",className:"payment-button payment-button-phonepe",onClick:()=>{const m=N(a.upiPayload,"phonepe");m&&(window.location.href=m)},children:r("payWithPhonePe")}),e.jsx("button",{type:"button",className:"payment-button payment-button-paytm",onClick:()=>{const m=N(a.upiPayload,"paytmmp");m&&(window.location.href=m)},children:r("payWithPaytm")})]})]})]}):t&&a?.upiPayload?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"payment-qr-clickable",onClick:()=>{a?.upiPayload&&(window.location.href=a.upiPayload)},title:r("payNow"),children:e.jsx(B,{value:a.upiPayload,size:180})}),e.jsxs("div",{className:"payment-upi-app-buttons",children:[e.jsx("button",{type:"button",className:"payment-button payment-button-upi-open",onClick:()=>{a?.upiPayload&&(window.location.href=a.upiPayload)},children:r("payNow")}),e.jsxs("div",{className:"payment-upi-app-row",children:[e.jsx("button",{type:"button",className:"payment-button payment-button-phonepe",onClick:()=>{const m=N(a.upiPayload,"phonepe");m&&(window.location.href=m)},children:r("payWithPhonePe")}),e.jsx("button",{type:"button",className:"payment-button payment-button-paytm",onClick:()=>{const m=N(a.upiPayload,"paytmmp");m&&(window.location.href=m)},children:r("payWithPaytm")})]})]})]}):null}),e.jsx("div",{className:"payment-action-buttons",children:e.jsx("button",{className:`payment-button danger ${w?"disabled":""}`,onClick:Q,disabled:w,children:r(w?"cancellingPayment":"cancelPayment")})})]})};return e.jsxs("div",{className:`payment-container ${P?"accessibility-mode":""}`,children:[e.jsx("button",{onClick:()=>{(p==="TAKEAWAY"||p==="PICKUP"||p==="DELIVERY")&&o&&!u?a?.id?M():R():i(-1)},disabled:D||w,className:`back-button ${P?"accessibility-mode":""}`,children:e.jsx(F,{size:18})}),e.jsxs(x.div,{initial:{y:40,opacity:0},animate:{y:0,opacity:1},transition:{duration:.6,ease:"easeOut"},className:`payment-card ${P?"accessibility-mode":""}`,children:[e.jsx("h2",{className:`payment-title ${P?"accessibility-mode":""}`,children:r("choosePayment")}),$?e.jsx("div",{className:"payment-status-card",children:e.jsx("p",{className:"payment-status-title",children:"Loading payment details…"})}):a?K():e.jsxs("div",{className:"payment-options",children:[e.jsx("p",{className:"payment-status-text",children:"Choose how you’d like to complete your payment."}),e.jsxs("div",{className:"payment-buttons",children:[e.jsxs(x.button,{whileHover:{scale:d?1:1.03},whileTap:{scale:d?1:.97},onClick:()=>O("ONLINE"),disabled:d,className:`payment-button ${P?"accessibility-mode":""}`,children:[e.jsx(H,{size:20}),d?"Starting...":r("createOnline")]}),e.jsxs(x.button,{whileHover:{scale:d?1:1.03},whileTap:{scale:d?1:.97},onClick:()=>O("CASH"),disabled:d,className:`payment-button ${P?"accessibility-mode":""}`,children:[e.jsx(L,{size:20}),d?"Starting...":r("createCash")]})]})]})]})]})}export{ne as default};
