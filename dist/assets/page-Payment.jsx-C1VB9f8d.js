import{u as B,r,j as e,l as G,m as J,n as X,M as Z,Q as ee}from"./vendor-react-ObuVvEbY.js";/* empty css                         */import{m as U}from"./vendor-motion-PmperX3c.js";const te="modulepreload",ae=function(c){return"/"+c},K={},ne=function(s,P,g){let y=Promise.resolve();if(P&&P.length>0){let v=function(i){return Promise.all(i.map(f=>Promise.resolve(f).then(l=>({status:"fulfilled",value:l}),l=>({status:"rejected",reason:l}))))};document.getElementsByTagName("link");const m=document.querySelector("meta[property=csp-nonce]"),u=m?.nonce||m?.getAttribute("nonce");y=v(P.map(i=>{if(i=ae(i),i in K)return;K[i]=!0;const f=i.endsWith(".css"),l=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${i}"]${l}`))return;const S=document.createElement("link");if(S.rel=f?"stylesheet":te,f||(S.as="script"),S.crossOrigin="",S.href=i,u&&S.setAttribute("nonce",u),document.head.appendChild(S),f)return new Promise((w,j)=>{S.addEventListener("load",w),S.addEventListener("error",()=>j(new Error(`Unable to preload CSS for ${i}`)))})}))}function a(m){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=m,window.dispatchEvent(u),!u.defaultPrevented)throw m}return y.then(m=>{for(const u of m||[])u.status==="rejected"&&a(u.reason);return s().catch(a)})},re={choosePayment:"Choose Payment Method",upiQR:"UPI QR",cashCard:"Cash / Card",payOnline:"Pay Online",markPaid:"Payment completed",markingPaid:"Updating payment...",markPaidHint:"Once the transaction is done, tap below so staff can verify it.",failedMarkPaid:"Failed to mark order as paid.",noOrderFound:"No order found for payment.",close:"Close",pendingPaymentTitle:"Payment in progress",cashPendingTitle:"Cash payment pending",onlineInstructions:"Scan the QR code with any UPI app or copy the payment string.",cashInstructions:"Please pay the amount at the counter. Staff will confirm once received.",cancelPayment:"Cancel payment",cancellingPayment:"Cancelling...",retryPayment:"Start a new payment",createOnline:"Pay with UPI / Online",createCash:"Pay with cash",resumePayment:"Resume payment",paidMessage:"Payment received! Taking you to confirmation…",viewOrder:"View order summary"},se={choosePayment:"भुगतान विधि चुनें",upiQR:"यूपीआई क्यूआर",cashCard:"नकद / कार्ड",payOnline:"ऑनलाइन भुगतान",markPaid:"भुगतान पूरा हुआ",markingPaid:"भुगतान अपडेट हो रहा है...",markPaidHint:"काउंटर पर भुगतान पूरा होने के बाद नीचे टैप करें ताकि स्टाफ को सूचना मिले।",failedMarkPaid:"ऑर्डर को भुगतान किया हुआ नहीं मार्क कर पाए।",noOrderFound:"भुगतान के लिए कोई ऑर्डर नहीं मिला।",close:"बंद करें",pendingPaymentTitle:"भुगतान प्रगति में",cashPendingTitle:"नकद भुगतान लंबित",onlineInstructions:"किसी भी UPI ऐप से क्यूआर कोड स्कैन करें या भुगतान विवरण कॉपी करें।",cashInstructions:"काउंटर पर राशि जमा करें। स्टाफ पुष्टि करेगा।",cancelPayment:"भुगतान रद्द करें",cancellingPayment:"भुगतान रद्द किया जा रहा है...",retryPayment:"नया भुगतान शुरू करें",createOnline:"यूपीआई / ऑनलाइन भुगतान",createCash:"नकद भुगतान",resumePayment:"भुगतान जारी रखें",paidMessage:"भुगतान प्राप्त हुआ! पुष्टि पृष्ठ पर ले जाया जा रहा है…",viewOrder:"ऑर्डर सारांश देखें"},ce={choosePayment:"पेमेंट पद्धत निवडा",upiQR:"यूपीआय QR",cashCard:"रोख / कार्ड",payOnline:"ऑनलाइन पेमेंट",markPaid:"पेमेंट पूर्ण केले",markingPaid:"पेमेंट अपडेट होत आहे...",markPaidHint:"काउंटरवर पेमेंट पूर्ण झाल्यावर खालील बटण टॅप करा जेणेकरून स्टाफला कळेल.",failedMarkPaid:"ऑर्डर पेमेंट झालेले मार्क करू शकलो नाही.",noOrderFound:"पेमेंटसाठी कोणताही ऑर्डर सापडला नाही.",close:"बंद करा",pendingPaymentTitle:"पेमेंट चालू आहे",cashPendingTitle:"रोख पेमेंट प्रतीक्षेत",onlineInstructions:"क्यूआर कोड स्कॅन करा किंवा पेमेंट स्ट्रिंग कॉपी करा.",cashInstructions:"कृपया रक्कम काउंटरवर भरा. स्टाफ पुष्टी करेल.",cancelPayment:"पेमेंट रद्द करा",cancellingPayment:"पेमेंट रद्द करत आहोत...",retryPayment:"नवीन पेमेंट सुरू करा",createOnline:"यूपीआय / ऑनलाइन पेमेंट",createCash:"रोखाने पेमेंट",resumePayment:"पेमेंट पुढे सुरू करा",paidMessage:"पेमेंट प्राप्त झाले! पुष्टी पृष्ठाकडे घेऊन जात आहोत…",viewOrder:"ऑर्डर सारांश पहा"},oe={choosePayment:"ચુકવણી રીત પસંદ કરો",upiQR:"યુપીઆઇ QR",cashCard:"નગદ / કાર્ડ",payOnline:"ઓનલાઇન ચુકવણી",markPaid:"ચુકવણી પૂર્ણ થઇ",markingPaid:"ચુકવણી અપડેટ થાય છે...",markPaidHint:"કાઉન્ટર પર ચુકવણી પૂર્ણ કર્યા પછી સ્ટાફને જાણ કરવા નીચે ટચ કરો.",failedMarkPaid:"ઓર્ડરને ચૂકવેલ તરીકે માર્ક કરી શક્યા નથી.",noOrderFound:"ચુકવણી માટે કોઈ ઓર્ડર મળ્યો નથી.",close:"બંધ કરો",pendingPaymentTitle:"ચુકવણી ચાલુ છે",cashPendingTitle:"નಗદ ચુકવણી બાકી",onlineInstructions:"કોઈપણ UPI એપથી QR સ્કેન કરો અથવા ચુકવણી લખાણ કૉપી કરો.",cashInstructions:"કાઉન્ટર પર ચુકવણી કરો. સ્ટાફ તેની પુષ્ટિ કરશે.",cancelPayment:"ચુકવણી રદ કરો",cancellingPayment:"ચુકવણી રદ કરી રહ્યા છીએ...",retryPayment:"નવી ચુકવણી શરૂ કરો",createOnline:"UPI / ઑનલાઇન ચુકવણી",createCash:"નગદ ચૂકવણી",resumePayment:"ચુકવણી આગળ વધારવું",paidMessage:"ચુકવણી મળી ગઈ! કન્ફર્મેશન તરફ લઈ જઈ રહ્યા છીએ…",viewOrder:"ઓર્ડર સારાંશ જુઓ"},ie={en:re,hi:se,mr:ce,gu:oe},O="https://api.terracart.in".replace(/\/$/,""),le=c=>{if(!c||typeof c!="string")return"";const s=c.match(/[?&]pa=([^&]+)/i);return s?decodeURIComponent(s[1]):""},de=c=>{if(!c)return[];const P=(c.match(/\d+(?:[.,]\d{1,2})?/g)||[]).map(g=>Number(g.replace(/,/g,""))).filter(g=>Number.isFinite(g)&&g>0&&g<1e6);return[...new Set(P)]},me=c=>{if(!c)return"";const s=[/utr[\s:.-]*([a-z0-9]{8,})/i,/upi[\s]*(?:ref(?:erence)?|id)?[\s:.-]*([a-z0-9]{8,})/i,/txn[\s]*(?:id|no|number)?[\s:.-]*([a-z0-9]{8,})/i,/ref(?:erence)?[\s]*(?:id|no|number)?[\s:.-]*([a-z0-9]{8,})/i];for(const g of s){const y=c.match(g);if(y?.[1])return y[1].toUpperCase()}const P=c.match(/\b\d{10,18}\b/);return P?P[0]:""},ue=({rawText:c,amount:s,upiId:P,orderId:g})=>{const y=String(c||"").toLowerCase(),a=Number(s||0),u=de(y).find(x=>Math.abs(x-a)<=1),v=["success","successful","paid","completed","debited","credited","transaction","upi"],i=["failed","failure","reversed","declined","pending"],f=v.reduce((x,_)=>x+(y.includes(_)?1:0),0),l=i.some(x=>y.includes(x)),S=String(P||"").trim().toLowerCase(),w=S.length>0&&y.includes(S),j=me(y),N=String(g||"").slice(-5).toLowerCase(),k=N.length>=4?y.includes(N):!1;let h=0;return u&&(h+=2),j&&(h+=1),w&&(h+=1),f>0&&(h+=1),k&&(h+=1),l&&(h-=2),{amountMatched:!!u,detectedAmount:u||null,referenceId:j,upiMatched:w,successCount:f,hasFailureKeyword:l,orderHintMatched:k,isValid:!!u&&h>=3&&!l}};function pe(){const c=B(),[s,P]=r.useState(!1),[g,y]=r.useState(!1),[a,m]=r.useState(null),[u,v]=r.useState(!0),[i,f]=r.useState(null),[l,S]=r.useState(localStorage.getItem("accessibilityMode")==="true"),[w,j]=r.useState(!1),[N,k]=r.useState(null),[h,x]=r.useState(""),[_,L]=r.useState(!1),[$,E]=r.useState(""),[b,T]=r.useState(null),D=r.useMemo(()=>localStorage.getItem("language")||"en",[]),p=r.useCallback(t=>ie[D]?.[t]||t,[D]);r.useMemo(()=>localStorage.getItem("terra_serviceType")||"DINE_IN",[]);const d=r.useMemo(()=>(localStorage.getItem("terra_serviceType")||"DINE_IN")==="TAKEAWAY"&&localStorage.getItem("terra_orderId_TAKEAWAY")||localStorage.getItem("terra_orderId"),[]),F=r.useMemo(()=>a&&a.status&&["PENDING","PROCESSING","CASH_PENDING"].includes(a.status),[a]),z=r.useMemo(()=>i?.upiId||le(a?.upiPayload),[i?.upiId,a?.upiPayload]),A=r.useCallback(async()=>{if(d)try{v(!0);const t=await fetch(`${O}/api/payments/order/${d}/latest`);if(t.status===404){m(null);return}if(!t.ok){const o=await t.json().catch(()=>({}));throw new Error(o.message||"Failed to fetch payment status")}const n=await t.json();m(n||null)}catch(t){t.message?.includes("404")||t.message?.includes("not found")||console.warn("Failed to fetch payment:",t),m(null)}finally{v(!1)}},[d]),Q=r.useCallback(()=>{const t=localStorage.getItem("terra_selectedCartId");if(t)return t;const n=localStorage.getItem("terra_takeaway_cartId");if(n)return n;const o=localStorage.getItem("terra_selectedTable")||localStorage.getItem("tableSelection");if(o)try{const I=JSON.parse(o);return I?.cartId||I?.cafeId||null}catch{return null}return null},[]),H=r.useCallback(async()=>{try{const t=new URLSearchParams;d&&t.set("orderId",d);const n=Q();n&&t.set("cartId",n);const o=`${O}/api/payment-qr/active${t.toString()?`?${t.toString()}`:""}`,I=await fetch(o);if(I.status===404){f(null);return}if(!I.ok){f(null);return}const C=await I.json();f(C||null)}catch{f(null)}},[d,Q]),R=r.useCallback(()=>{if(w){console.log("[Payment] Payment already handled, skipping");return}if(j(!0),d){localStorage.setItem("terra_orderId",d),localStorage.setItem("terra_orderStatus","Paid"),localStorage.setItem("terra_orderStatusUpdatedAt",new Date().toISOString()),localStorage.setItem("terra_lastPaidOrderId",d);const t=localStorage.getItem("terra_serviceType")||"DINE_IN",n=localStorage.getItem("terra_orderType")||null,o=n==="PICKUP"||n==="DELIVERY";t==="TAKEAWAY"||t==="PICKUP"||t==="DELIVERY"?(localStorage.setItem("terra_orderId_TAKEAWAY",d),localStorage.setItem("terra_orderStatus_TAKEAWAY","Paid"),localStorage.setItem("terra_orderStatusUpdatedAt_TAKEAWAY",new Date().toISOString()),!o&&t==="TAKEAWAY"?(localStorage.removeItem("terra_takeaway_customerName"),localStorage.removeItem("terra_takeaway_customerMobile"),localStorage.removeItem("terra_takeaway_customerEmail"),console.log("[Payment] Cleared takeaway customer data after payment (regular TAKEAWAY order)")):console.log("[Payment] Preserved customer data for "+(n||t)+" order to allow reordering")):(localStorage.setItem("terra_orderId_DINE_IN",d),localStorage.setItem("terra_orderStatus_DINE_IN","Paid"),localStorage.setItem("terra_orderStatusUpdatedAt_DINE_IN",new Date().toISOString()))}localStorage.removeItem("terra_cart"),localStorage.setItem("terra_paymentCompleted","true"),console.log("[Payment] Payment completed - flag set for session clearing on next table scan"),c("/menu")},[d,c,w]);r.useEffect(()=>{if(!d){alert(p("noOrderFound")||"No order found for payment."),c("/menu");return}A(),H()},[d,A,H,c,p]),r.useEffect(()=>{if(!F)return;const t=setInterval(()=>{A()},1e4);return()=>clearInterval(t)},[F,A]),r.useEffect(()=>{a?.status==="PAID"&&!w&&R()},[a?.status,R,w]),r.useEffect(()=>()=>{h&&URL.revokeObjectURL(h)},[h]),r.useEffect(()=>{k(null),x(""),E(""),T(null)},[a?.id]);const M=async t=>{if(d){P(!0);try{const n=await fetch(`${O}/api/payments/create`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({orderId:d,method:t})}),o=await n.json();if(!n.ok)throw new Error(o?.message||"Unable to create payment");m(o)}catch(n){alert(n.message||"Unable to create payment")}finally{P(!1)}}},Y=async()=>{if(!(!a?.id||!await window.confirm(p("cancelPayment")||"Cancel current payment?"))){y(!0);try{const n=await fetch(`${O}/api/payments/${a.id}/cancel`,{method:"POST"});if(!n.ok){let o;try{o=await n.json()}catch{const C=await n.text().catch(()=>"Unknown error");throw new Error(`Failed to cancel payment: ${C}`)}throw new Error(o?.message||"Unable to cancel payment")}m(null)}catch(n){alert(n.message||"Unable to cancel payment")}finally{y(!1)}}},W=t=>{const n=t.target.files?.[0]||null;if(h&&URL.revokeObjectURL(h),k(n),T(null),E(""),!n){x("");return}x(URL.createObjectURL(n))},q=async()=>{if(!N||!a){E("Please upload a receipt image first.");return}L(!0),E("");try{const n=await(await ne(()=>import("./vendor-BzqibXkm.js").then(C=>C.i),[])).recognize(N,"eng",{logger:()=>{}}),o=String(n?.data?.text||"").trim();if(!o)throw new Error("No readable text found in receipt image.");const I=ue({rawText:o,amount:a.amount,upiId:z,orderId:d});T({...I,rawText:o})}catch(t){T(null),E(t?.message||"Could not scan receipt. Please upload a clear screenshot.")}finally{L(!1)}},V=()=>{if(!a)return null;if(a.status==="PAID")return e.jsxs("div",{className:"payment-status-card success",children:[e.jsx("p",{className:"payment-status-title",children:p("paidMessage")}),e.jsx("button",{className:"payment-button primary",onClick:R,children:p("viewOrder")})]});if(["CANCELLED","FAILED"].includes(a?.status))return e.jsxs("div",{className:"payment-status-card warning",children:[e.jsx("p",{className:"payment-status-title",children:a?.status==="FAILED"?"Payment failed":"Payment cancelled"}),e.jsx("button",{className:"payment-button primary",onClick:()=>m(null),children:p("retryPayment")})]});const t=a?.method==="ONLINE",n=a?.method==="CASH"||a?.status==="CASH_PENDING",o=t||n,I=!!i?.qrImageUrl,C=!!a?.upiPayload;return e.jsxs("div",{className:"payment-status-card",children:[e.jsx("p",{className:"payment-status-title",children:p(n?"cashPendingTitle":"pendingPaymentTitle")}),e.jsx("p",{className:"payment-status-text",children:p(n?"cashInstructions":"onlineInstructions")}),o&&(I||C)&&e.jsx("div",{className:"payment-qr-wrapper",children:I?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:`${O}${i.qrImageUrl}`,alt:"Payment QR Code",style:{maxWidth:"180px",maxHeight:"180px",width:"auto",height:"auto"}}),i.upiId&&e.jsxs("p",{className:"text-sm text-slate-600 mt-2",children:["UPI ID: ",e.jsx("strong",{children:i.upiId})]}),t&&a?.upiPayload&&e.jsxs(e.Fragment,{children:[e.jsx("textarea",{className:"payment-qr-text",readOnly:!0,value:a.upiPayload,rows:3}),e.jsx("button",{className:"payment-button secondary",onClick:()=>a?.upiPayload&&navigator.clipboard.writeText(a.upiPayload),children:"Copy UPI string"})]})]}):t&&a?.upiPayload?e.jsxs(e.Fragment,{children:[e.jsx(ee,{value:a.upiPayload,size:180}),e.jsx("textarea",{className:"payment-qr-text",readOnly:!0,value:a.upiPayload,rows:3}),e.jsx("button",{className:"payment-button secondary",onClick:()=>a?.upiPayload&&navigator.clipboard.writeText(a.upiPayload),children:"Copy UPI string"})]}):null}),t&&e.jsxs("div",{className:"receipt-ocr-wrapper",children:[e.jsx("p",{className:"receipt-ocr-title",children:"Receipt Validation (OCR)"}),e.jsx("p",{className:"receipt-ocr-subtitle",children:"Upload your UPI payment receipt screenshot to auto-check if it looks valid."}),e.jsx("input",{type:"file",accept:"image/*",onChange:W,className:"receipt-file-input"}),h&&e.jsx("img",{src:h,alt:"Uploaded receipt preview",className:"receipt-preview-image"}),e.jsx("button",{type:"button",onClick:q,disabled:!N||_,className:`payment-button secondary ${!N||_?"disabled":""}`,children:_?"Scanning receipt...":"Scan receipt"}),$&&e.jsx("p",{className:"receipt-ocr-error",children:$}),b&&e.jsxs("div",{className:`receipt-ocr-result ${b.isValid?"valid":"review"}`,children:[e.jsx("p",{className:"receipt-ocr-result-title",children:b.isValid?"Receipt looks valid":"Receipt needs manual review"}),e.jsxs("div",{className:"receipt-ocr-checks",children:[e.jsxs("p",{children:["Amount match:"," ",e.jsx("strong",{children:b.amountMatched?`Yes (Rs ${Number(b.detectedAmount||0).toFixed(2)})`:"No"})]}),e.jsxs("p",{children:["Transaction reference:"," ",e.jsx("strong",{children:b.referenceId||"Not found"})]}),e.jsxs("p",{children:["UPI ID match:"," ",e.jsx("strong",{children:b.upiMatched?"Yes":"No"})]})]}),e.jsxs("details",{className:"receipt-ocr-text-block",children:[e.jsx("summary",{children:"View extracted text"}),e.jsx("pre",{children:b.rawText})]})]})]}),e.jsx("div",{className:"payment-action-buttons",children:e.jsx("button",{className:`payment-button danger ${g?"disabled":""}`,onClick:Y,disabled:g,children:p(g?"cancellingPayment":"cancelPayment")})})]})};return e.jsxs("div",{className:`payment-container ${l?"accessibility-mode":""}`,children:[e.jsx("button",{onClick:()=>c(-1),className:`back-button ${l?"accessibility-mode":""}`,children:e.jsx(G,{size:18})}),e.jsxs(U.div,{initial:{y:40,opacity:0},animate:{y:0,opacity:1},transition:{duration:.6,ease:"easeOut"},className:`payment-card ${l?"accessibility-mode":""}`,children:[e.jsx("h2",{className:`payment-title ${l?"accessibility-mode":""}`,children:p("choosePayment")}),u?e.jsx("div",{className:"payment-status-card",children:e.jsx("p",{className:"payment-status-title",children:"Loading payment details…"})}):a?V():e.jsxs("div",{className:"payment-options",children:[e.jsx("p",{className:"payment-status-text",children:"Choose how you’d like to complete your payment."}),e.jsxs("div",{className:"payment-buttons",children:[e.jsxs(U.button,{whileHover:{scale:s?1:1.03},whileTap:{scale:s?1:.97},onClick:()=>M("ONLINE"),disabled:s,className:`payment-button ${l?"accessibility-mode":""}`,children:[e.jsx(J,{size:20}),s?"Starting...":p("createOnline")]}),e.jsxs(U.button,{whileHover:{scale:s?1:1.03},whileTap:{scale:s?1:.97},onClick:()=>M("CASH"),disabled:s,className:`payment-button ${l?"accessibility-mode":""}`,children:[e.jsx(X,{size:20}),s?"Starting...":p("createCash")]}),e.jsxs(U.button,{whileHover:{scale:s?1:1.03},whileTap:{scale:s?1:.97},onClick:()=>M("ONLINE"),disabled:s,className:`payment-button ${l?"accessibility-mode":""}`,children:[e.jsx(Z,{size:20}),s?"Starting...":p("payOnline")]})]})]})]})]})}const fe=Object.freeze(Object.defineProperty({__proto__:null,default:pe},Symbol.toStringTag,{value:"Module"}));export{fe as P,ne as _};
